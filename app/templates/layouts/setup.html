<!-- File: app/templates/setup/layout.html -->
{% extends "base.html" %}

{% block title %}{{ super() }} - {{ setup_step_title or "Application Setup" }}{% endblock %}

{% block content %}
<div class="min-h-[calc(100vh-12rem)] flex items-center justify-center p-4">
    <div class="w-full max-w-4xl">
        <!-- Main Setup Flow -->
        <div class="bg-base-100 border border-base-300 rounded-xl shadow-lg overflow-hidden">
            <!-- Header Section -->
            <div class="bg-gradient-to-r from-primary/10 to-secondary/10 p-6 text-center border-b border-base-300">
                <div class="w-16 h-16 rounded-full bg-primary/20 flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-cog text-primary text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-base-content mb-2">{{ setup_page_title or "Application Setup" }}</h1>
                <p class="text-base-content/70 text-sm">
                    {% if setup_page_subtitle %}
                        {{ setup_page_subtitle }}
                    {% else %}
                        Configure <strong class="text-primary">{{ g.app_name or "MUM" }}</strong> for your environment
                    {% endif %}
                </p>
            </div>

            {% set setup_steps_list = [
                {'id': 'account', 'name': 'Owner Account', 'url': url_for('setup.account_setup'), 'icon': 'fa-user-shield'},
                {'id': 'plugins', 'name': 'Media Services', 'url': url_for('setup.plugins'), 'icon': 'fa-server'},
                {'id': 'app', 'name': 'App Config', 'url': url_for('setup.app_config'), 'icon': 'fa-cog'},
                {'id': 'discord', 'name': 'Discord', 'url': url_for('setup.discord_config'), 'icon': 'fa-brands fa-discord'},
                {'id': 'finish', 'name': 'Finish', 'url': '#', 'icon': 'fa-check'} 
            ] %}

            <!-- Content Section -->
            <div class="p-6 sm:p-8">
                <!-- Progress Steps -->
                {% if show_stepper | default(true) %}
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="font-medium text-base-content">Setup Progress</h2>
                            <span class="text-sm text-base-content/60">
                                {{ completed_steps|length if completed_steps else 0 }} of {{ setup_steps_list|length }} completed
                            </span>
                        </div>
                        <div class="flex items-center gap-2">
                            {% for step in setup_steps_list %}
                                {% set is_completed = step.id in (completed_steps or []) %}
                                {% set is_current = step.id == current_step_id %}
                                <div class="flex items-center flex-1">
                                    <div class="flex items-center gap-2 p-3 rounded-lg transition-colors
                                        {% if is_completed %}bg-primary/10 border border-primary/20
                                        {% elif is_current %}bg-warning/10 border border-warning/20
                                        {% else %}bg-base-200/50 border border-base-300{% endif %} flex-1 
                                        {% if is_completed and step.url != '#' %}cursor-pointer hover:bg-primary/15{% endif %}"
                                        {% if is_completed and step.url != '#' %}
                                            onclick="window.location.href='{{ step.url }}'"
                                            title="Go to {{ step.name }} (Completed)"
                                        {% endif %}>
                                        <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0
                                            {% if is_completed %}bg-primary text-primary-content
                                            {% elif is_current %}bg-warning text-warning-content
                                            {% else %}bg-base-300 text-base-content/60{% endif %}">
                                            {% if is_completed %}
                                                <i class="fa-solid fa-check text-xs"></i>
                                            {% elif is_current %}
                                                <i class="fa-solid fa-circle text-xs"></i>
                                            {% else %}
                                                <i class="{{ step.icon }} text-xs"></i>
                                            {% endif %}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <span class="text-xs font-medium block truncate
                                                {% if is_completed %}text-primary
                                                {% elif is_current %}text-warning
                                                {% else %}text-base-content/70{% endif %}">
                                                {{ step.name }}
                                            </span>
                                        </div>
                                    </div>
                                    {% if not loop.last %}
                                        <div class="w-3 h-0.5 mx-1
                                            {% if is_completed %}bg-primary
                                            {% else %}bg-base-300{% endif %}"></div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <!-- Step Content -->
                <div class="step-content">
                    {% block setup_content %}
                    <!-- Specific setup step content goes here -->
                    {% endblock setup_content %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const steps = document.querySelectorAll('.steps .step');
        let currentFound = false;
        let allPreviousCompleted = true; 

        steps.forEach(stepElement => {
            const isCompleted = stepElement.classList.contains('step-primary') && stepElement.title && stepElement.title.includes('(Completed)');
            const isCurrent = stepElement.classList.contains('step-primary') && !(stepElement.title && stepElement.title.includes('(Completed)'));

            if (isCurrent) {
                currentFound = true;
            } else if (!isCompleted && !currentFound) { // A previous step that is not completed
                allPreviousCompleted = false;
            }
        });

        currentFound = false; 

        steps.forEach(stepElement => {
            const isCompleted = stepElement.classList.contains('step-primary') && stepElement.title && stepElement.title.includes('(Completed)');
            const isCurrent = stepElement.classList.contains('step-primary') && !(stepElement.title && stepElement.title.includes('(Completed)'));

            if (isCurrent) {
                currentFound = true;
            } else if (isCompleted) {
                // Clickable if completed (handled by onclick attribute in HTML)
            } else { // Future steps
                if (!currentFound || !allPreviousCompleted) { 
                    stepElement.classList.add('step-disabled', 'cursor-not-allowed');
                    stepElement.classList.remove('cursor-pointer');
                    stepElement.onclick = (e) => e.preventDefault(); 
                    if (!(stepElement.title && stepElement.title.includes('(Not yet accessible)'))) {
                       stepElement.title = (stepElement.textContent || stepElement.innerText || "").trim() + ' (Not yet accessible)';
                    }
                } else {
                    if (!stepElement.classList.contains('cursor-pointer')) { // If not already made clickable by completion
                        stepElement.classList.add('step-disabled-future', 'cursor-default');
                        stepElement.classList.remove('cursor-pointer');
                        stepElement.onclick = (e) => e.preventDefault();
                    }
                }
            }
        });
    });
</script>
{% endblock %}