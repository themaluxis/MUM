{% extends "base.html" %}

{% block title %}Media Servers - {{ g.app_name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Media Servers</h1>
        <a href="{{ url_for('media_servers.add_server') }}" class="btn btn-primary">
            <i class="fas fa-plus mr-2"></i>Add Server
        </a>
    </div>

    {% if servers %}
    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {% for server in servers %}
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <h2 class="card-title">{{ server.name }}</h2>
                    <div class="badge badge-{{ 'success' if server.is_active else 'error' }}">
                        {{ 'Active' if server.is_active else 'Inactive' }}
                    </div>
                </div>
                
                <div class="space-y-2">
                    <div class="flex items-center">
                        <i class="fas fa-server mr-2 text-gray-500"></i>
                        <span class="text-sm">{{ server.service_type.value.title() }}</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-link mr-2 text-gray-500"></i>
                        <span class="text-sm truncate">{{ server.url }}</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-clock mr-2 text-gray-500"></i>
                        <span class="text-sm">
                            {% if server.last_sync_at %}
                                Last sync: {{ server.last_sync_at|format_datetime_human(False) }}
                            {% else %}
                                Never synced
                            {% endif %}
                        </span>
                    </div>
                </div>

                <div class="card-actions justify-end mt-4">
                    <div class="dropdown dropdown-end">
                        <label tabindex="0" class="btn btn-ghost btn-sm">
                            <i class="fas fa-ellipsis-v"></i>
                        </label>
                        <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                            <li>
                                <button onclick="testConnection({{ server.id }})" class="text-blue-600">
                                    <i class="fas fa-plug mr-2"></i>Test Connection
                                </button>
                            </li>
                            <li>
                                <button onclick="syncLibraries({{ server.id }})" class="text-green-600">
                                    <i class="fas fa-sync mr-2"></i>Sync Libraries
                                </button>
                            </li>
                            <li>
                                <button onclick="syncUsers({{ server.id }})" class="text-purple-600">
                                    <i class="fas fa-users mr-2"></i>Sync Users
                                </button>
                            </li>
                            <li>
                                <a href="{{ url_for('media_servers.edit_server', server_id=server.id) }}" class="text-yellow-600">
                                    <i class="fas fa-edit mr-2"></i>Edit
                                </a>
                            </li>
                            <li>
                                <button onclick="deleteServer({{ server.id }}, '{{ server.name }}')" class="text-red-600">
                                    <i class="fas fa-trash mr-2"></i>Delete
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-12">
        <i class="fas fa-server text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-600 mb-2">No Media Servers Configured</h3>
        <p class="text-gray-500 mb-6">Add your first media server to get started with MUM.</p>
        <a href="{{ url_for('media_servers.add_server') }}" class="btn btn-primary">
            <i class="fas fa-plus mr-2"></i>Add Your First Server
        </a>
    </div>
    {% endif %}
</div>

<!-- Delete confirmation modal -->
<div id="deleteModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Confirm Deletion</h3>
        <p class="py-4">Are you sure you want to delete the server "<span id="serverName"></span>"? This action cannot be undone.</p>
        <div class="modal-action">
            <form id="deleteForm" method="post">
                <button type="button" class="btn" onclick="closeDeleteModal()">Cancel</button>
                <button type="submit" class="btn btn-error">Delete</button>
            </form>
        </div>
    </div>
</div>

<script>
function testConnection(serverId) {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';
    btn.disabled = true;
    
    fetch(`/admin/api/servers/${serverId}/test`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Connection successful: ' + data.message, 'success');
            } else {
                showToast('Connection failed: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showToast('Error testing connection: ' + error.message, 'error');
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

function syncLibraries(serverId) {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Syncing...';
    btn.disabled = true;
    
    fetch(`/admin/api/servers/${serverId}/sync/libraries`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Libraries synced: ' + data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Sync failed: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showToast('Error syncing libraries: ' + error.message, 'error');
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

function syncUsers(serverId) {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Syncing...';
    btn.disabled = true;
    
    fetch(`/admin/api/servers/${serverId}/sync/users`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Users synced: ' + data.message, 'success');
            } else {
                showToast('Sync failed: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showToast('Error syncing users: ' + error.message, 'error');
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

function deleteServer(serverId, serverName) {
    document.getElementById('serverName').textContent = serverName;
    document.getElementById('deleteForm').action = `/admin/servers/${serverId}/delete`;
    document.getElementById('deleteModal').classList.add('modal-open');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('modal-open');
}

function showToast(message, type) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} fixed top-4 right-4 w-auto z-50`;
    toast.innerHTML = `
        <div>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}
</script>
{% endblock %}