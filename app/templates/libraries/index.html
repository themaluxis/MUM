<!-- File: app/templates/libraries/index.html -->
{% extends "base.html" %}

{% block title %}{{ super() }} - Libraries{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-2">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">All Libraries</h1>
        <div class="flex gap-2 mt-4 sm:mt-0">
            <button id="sync-libraries-btn" class="btn btn-primary btn-sm" 
                    hx-post="{{ url_for('libraries.sync_libraries') }}"
                    hx-indicator="#sync-spinner"
                    hx-on::before-request="showSyncLoading()"
                    hx-on::after-request="hideSyncLoading()">
                <span id="sync-spinner" class="loading loading-spinner loading-xs htmx-indicator"></span>
                <i class="fa-solid fa-sync-alt htmx-indicator-hide"></i>
                Sync Libraries
            </button>
        </div>
    </div>

    <div id="libraries-list-container">
        <div hx-get="{{ url_for('libraries.index') }}"
             hx-trigger="load"
             hx-target="#libraries-list-container"
             hx-swap="innerHTML">
            
            <div class="text-center p-8" id="initial-loading">
                <span class="loading loading-lg loading-spinner"></span>
                <p>Loading libraries...</p>
            </div>
        </div>
    </div>
</div>

<!-- Library Sync Results Modal -->
<dialog id="librarySyncResultModal" class="modal">
    <div id="librarySyncResultModalContainer">
        <!-- Modal content will be loaded here via HTMX -->
    </div>
</dialog>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Button state management for sync libraries
function showSyncLoading() {
    const btn = document.getElementById('sync-libraries-btn');
    if (btn) {
        btn.disabled = true;
        const spinner = btn.querySelector('#sync-spinner');
        const icon = btn.querySelector('.fa-sync-alt');
        const text = btn.lastChild;
        
        if (spinner) spinner.style.display = 'inline-block';
        if (icon) icon.style.display = 'none';
        if (text && text.nodeType === Node.TEXT_NODE) {
            text.textContent = ' Syncing...';
        }
    }
}

function hideSyncLoading() {
    const btn = document.getElementById('sync-libraries-btn');
    if (btn) {
        btn.disabled = false;
        const spinner = btn.querySelector('#sync-spinner');
        const icon = btn.querySelector('.fa-sync-alt');
        const text = btn.lastChild;
        
        if (spinner) spinner.style.display = 'none';
        if (icon) icon.style.display = 'inline';
        if (text && text.nodeType === Node.TEXT_NODE) {
            text.textContent = ' Sync Libraries';
        }
    }
}

// Handle library sync results modal
document.addEventListener('openLibrarySyncResultsModal', function() {
    librarySyncResultModal.showModal();
});

// Handle refreshLibrariesPage event by triggering HTMX refresh
document.addEventListener('refreshLibrariesPage', function() {
    // Trigger HTMX to reload the libraries container
    htmx.ajax('GET', '{{ url_for("libraries.index") }}', {
        target: '#libraries-list-container',
        swap: 'innerHTML'
    });
});

// Refresh page when sync results modal is closed
document.getElementById('librarySyncResultModal').addEventListener('close', function() {
    htmx.ajax('GET', '{{ url_for("libraries.index") }}', {
        target: '#libraries-list-container',
        swap: 'innerHTML'
    });
});
</script>
{% endblock %}