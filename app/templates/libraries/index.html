<!-- File: app/templates/libraries/index.html -->
{% extends "base.html" %}

{% block title %}{{ super() }} - Libraries{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-2">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">All Libraries</h1>
        <div class="flex gap-2 mt-4 sm:mt-0">
            <button id="sync-libraries-btn" class="btn btn-primary btn-sm" 
                    hx-post="{{ url_for('libraries.sync_libraries') }}"
                    hx-indicator="#sync-spinner"
                    hx-on::before-request="showSyncLoading()"
                    hx-on::after-request="hideSyncLoading()">
                <span id="sync-spinner" class="loading loading-spinner loading-xs htmx-indicator"></span>
                <i class="fa-solid fa-sync-alt htmx-indicator-hide"></i>
                Sync Libraries
            </button>
        </div>
    </div>

    <div id="libraries-list-container">
        <div hx-get="{{ url_for('libraries.index') }}"
             hx-trigger="load"
             hx-target="#libraries-list-container"
             hx-swap="innerHTML">
            
            <div class="text-center p-8" id="initial-loading">
                <span class="loading loading-lg loading-spinner"></span>
                <p>Loading libraries...</p>
            </div>
        </div>
    </div>
</div>

<!-- Library Sync Results Modal -->
<dialog id="librarySyncResultModal" class="modal">
    <div id="librarySyncResultModalContainer">
        <!-- Modal content will be loaded here via HTMX -->
    </div>
</dialog>

<!-- Library Raw Data Modal -->
<dialog id="library_raw_data_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-5xl bg-base-100 border border-base-300 shadow-2xl p-0">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-base-300">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-info/20 flex items-center justify-center">
                    <i class="fa-solid fa-database text-info text-lg"></i>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-base-content">Library Raw Data</h3>
                    <p class="text-sm text-base-content/60">View technical details and metadata</p>
                </div>
            </div>
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost hover:bg-base-200">
                    <i class="fa-solid fa-times"></i>
                </button>
            </form>
        </div>

        <!-- Content -->
        <div class="p-6">
            <!-- Info Card -->
            <div class="bg-base-200/50 rounded-lg p-4 mb-6 border border-base-300/50">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full bg-info/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                        <i class="fa-solid fa-info text-info text-sm"></i>
                    </div>
                    <div>
                        <h4 class="font-medium text-base-content mb-1">Library Information</h4>
                        <div class="text-sm text-base-content/70 leading-relaxed space-y-1">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-book text-primary text-xs"></i>
                                <strong>Library:</strong> <span id="modal_library_name"></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-server text-secondary text-xs"></i>
                                <strong>Server:</strong> <span id="modal_server_name"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Raw Data Section -->
            <div class="space-y-4 mb-6">
                <h4 class="font-medium text-base-content text-lg mb-3">
                    <i class="fa-solid fa-code text-secondary text-sm mr-2"></i>
                    Raw Data Output
                </h4>
                
                <div class="bg-base-200/30 rounded-lg border border-base-300/30 hover:border-base-300/60 transition-colors">
                    <div class="flex items-center justify-between p-3 border-b border-base-300/30 bg-base-200/50">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-file-code text-info text-sm"></i>
                            <span class="font-medium text-sm">JSON Data</span>
                        </div>
                        <button class="btn btn-xs btn-outline btn-info gap-1" onclick="copyRawDataToClipboard()">
                            <i class="fa-solid fa-copy text-xs"></i>
                            Copy
                        </button>
                    </div>
                    <div class="p-4">
                        <div class="bg-base-100 rounded-lg p-4 max-h-96 overflow-auto border border-base-300/30">
                            <pre id="modal_raw_data" class="text-xs whitespace-pre-wrap break-words font-mono text-base-content"></pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center justify-end gap-3 mt-8 pt-6 border-t border-base-300">
                <button type="button" class="btn btn-ghost" onclick="library_raw_data_modal.close()">
                    Cancel
                </button>
                <button type="button" class="btn btn-info gap-2" onclick="copyRawDataToClipboard()">
                    <i class="fa-solid fa-copy"></i>
                    Copy to Clipboard
                </button>
            </div>
        </div>
    </div>
</dialog>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Button state management for sync libraries
function showSyncLoading() {
    const btn = document.getElementById('sync-libraries-btn');
    if (btn) {
        btn.disabled = true;
        const spinner = btn.querySelector('#sync-spinner');
        const icon = btn.querySelector('.fa-sync-alt');
        const text = btn.lastChild;
        
        if (spinner) spinner.style.display = 'inline-block';
        if (icon) icon.style.display = 'none';
        if (text && text.nodeType === Node.TEXT_NODE) {
            text.textContent = ' Syncing...';
        }
    }
}

function hideSyncLoading() {
    const btn = document.getElementById('sync-libraries-btn');
    if (btn) {
        btn.disabled = false;
        
        // Check if button content was cleared and rebuild if necessary
        if (btn.innerHTML.trim() === '') {
            btn.innerHTML = `
                <span id="sync-spinner" class="loading loading-spinner loading-xs htmx-indicator"></span>
                <i class="fa-solid fa-sync-alt htmx-indicator-hide"></i>
                Sync Libraries
            `;
        } else {
            // Normal restoration if content still exists
            const spinner = btn.querySelector('#sync-spinner');
            const icon = btn.querySelector('.fa-sync-alt');
            const text = btn.lastChild;
            
            if (spinner) spinner.style.display = 'none';
            if (icon) icon.style.display = 'inline';
            if (text && text.nodeType === Node.TEXT_NODE) {
                text.textContent = ' Sync Libraries';
            }
        }
    }
}

// Handle library sync results modal
document.addEventListener('openLibrarySyncResultsModal', function() {
    librarySyncResultModal.showModal();
});

// Handle refreshLibrariesPage event by triggering HTMX refresh
document.addEventListener('refreshLibrariesPage', function() {
    // Trigger HTMX to reload the libraries container
    htmx.ajax('GET', '{{ url_for("libraries.index") }}', {
        target: '#libraries-list-container',
        swap: 'innerHTML'
    });
});

// Refresh page when sync results modal is closed
document.getElementById('librarySyncResultModal').addEventListener('close', function() {
    htmx.ajax('GET', '{{ url_for("libraries.index") }}', {
        target: '#libraries-list-container',
        swap: 'innerHTML'
    });
});

// Function to show library raw data modal
function showLibraryRawData(button) {
    try {
        const libraryName = button.getAttribute('data-library-name');
        const serverName = button.getAttribute('data-server-name');
        const libraryId = button.getAttribute('data-library-id');
        const serviceType = button.getAttribute('data-service-type');
        
        console.log('Modal debug:', { libraryName, serverName, libraryId, serviceType });
        
        // Get the raw data from the JSON script tag
        const dataScript = document.getElementById('library-data-' + libraryId);
        let rawData = {};
        
        if (dataScript) {
            try {
                rawData = JSON.parse(dataScript.textContent);
                console.log('Raw data keys:', Object.keys(rawData));
                console.log('Raw data sample:', rawData);
            } catch (parseError) {
                console.error('Error parsing library data:', parseError);
                rawData = { error: 'Could not parse library data', original: dataScript.textContent };
            }
        } else {
            console.error('No data script found for library-data-' + libraryId);
        }
        
        document.getElementById('modal_library_name').textContent = libraryName || 'Unknown';
        document.getElementById('modal_server_name').textContent = serverName || 'Unknown';
        document.getElementById('modal_raw_data').textContent = JSON.stringify(rawData, null, 2);
        document.getElementById('library_raw_data_modal').showModal();
    } catch (error) {
        console.error('Error showing library raw data:', error);
        alert('Error displaying library data: ' + error.message);
    }
}

// Function to copy raw data to clipboard
function copyRawDataToClipboard() {
    const rawDataElement = document.getElementById('modal_raw_data');
    if (rawDataElement) {
        const textToCopy = rawDataElement.textContent;
        navigator.clipboard.writeText(textToCopy).then(() => {
            // Show success feedback
            const copyButtons = document.querySelectorAll('button[onclick="copyRawDataToClipboard()"]');
            copyButtons.forEach(button => {
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fa-solid fa-check text-xs"></i> Copied!';
                button.classList.add('btn-success');
                button.classList.remove('btn-info', 'btn-outline');
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-info', 'btn-outline');
                }, 2000);
            });
        }).catch(err => {
            console.error('Failed to copy raw data: ', err);
            alert('Failed to copy data to clipboard');
        });
    }
}
</script>
{% endblock %}