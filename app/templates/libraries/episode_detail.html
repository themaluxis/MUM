{% extends "base.html" %}

{% block title %}{{ super() }} - {{ title }}{% endblock %}

{% block content %}
<!-- Episode Detail Page -->
{# Determine service-specific colors and gradients #}
{% if server.service_type.value == 'plex' %}
    {% set header_gradient = "bg-gradient-to-r from-plex/10 to-plex/20" %}
    {% set service_color = "plex" %}
    {% set service_icon = "fa-brands fa-plex" %}
    {% set service_name = "Plex" %}
{% elif server.service_type.value == 'jellyfin' %}
    {% set header_gradient = "bg-gradient-to-r from-jellyfin/10 to-jellyfin/20" %}
    {% set service_color = "jellyfin" %}
    {% set service_icon = "fa-solid fa-cube" %}
    {% set service_name = "Jellyfin" %}
{% elif server.service_type.value == 'emby' %}
    {% set header_gradient = "bg-gradient-to-r from-emby/10 to-emby/20" %}
    {% set service_color = "emby" %}
    {% set service_icon = "fa-solid fa-play-circle" %}
    {% set service_name = "Emby" %}
{% elif server.service_type.value == 'kavita' %}
    {% set header_gradient = "bg-gradient-to-r from-kavita/10 to-kavita/20" %}
    {% set service_color = "kavita" %}
    {% set service_icon = "fa-solid fa-book" %}
    {% set service_name = "Kavita" %}
{% elif server.service_type.value == 'audiobookshelf' %}
    {% set header_gradient = "bg-gradient-to-r from-audiobookshelf/10 to-audiobookshelf/20" %}
    {% set service_color = "audiobookshelf" %}
    {% set service_icon = "fa-solid fa-headphones" %}
    {% set service_name = "AudiobookShelf" %}
{% elif server.service_type.value == 'komga' %}
    {% set header_gradient = "bg-gradient-to-r from-komga/10 to-komga/20" %}
    {% set service_color = "komga" %}
    {% set service_icon = "fa-solid fa-book-open" %}
    {% set service_name = "Komga" %}
{% elif server.service_type.value == 'romm' %}
    {% set header_gradient = "bg-gradient-to-r from-romm/10 to-romm/20" %}
    {% set service_color = "romm" %}
    {% set service_icon = "fa-solid fa-gamepad" %}
    {% set service_name = "RomM" %}
{% else %}
    {% set header_gradient = "bg-gradient-to-r from-primary/10 to-secondary/10" %}
    {% set service_color = "primary" %}
    {% set service_icon = "fa-solid fa-server" %}
    {% set service_name = "Unknown Service" %}
{% endif %}

<div class="min-h-screen bg-base-100">

    <!-- Main Content Card -->
    <div class="container mx-auto px-4 pb-8">
        <div class="bg-base-100 border border-base-300 rounded-xl shadow-lg overflow-hidden">
            <!-- Hero Header Section -->
            <div class="bg-gradient-to-r from-primary/10 to-secondary/10 p-8 text-center border-b border-base-300">
                <div class="flex flex-col lg:flex-row items-center gap-8">
                    
                    <!-- Episode Poster -->
                    <div class="flex-shrink-0">
                        {% if episode_details.thumb %}
                            <div class="w-48 h-72 rounded-lg overflow-hidden shadow-lg bg-base-200">
                                <img src="{{ episode_details.thumb }}" 
                                     alt="{{ episode_details.title }}"
                                     class="w-full h-full object-cover"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <!-- Fallback poster -->
                                <div class="w-full h-full flex items-center justify-center text-6xl text-base-content/30" style="display: none;">
                                    <i class="fa-solid fa-tv"></i>
                                </div>
                            </div>
                        {% else %}
                            <!-- No poster available -->
                            <div class="w-48 h-72 rounded-lg bg-base-200 flex items-center justify-center text-6xl text-base-content/30">
                                <i class="fa-solid fa-tv"></i>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Episode Info -->
                    <div class="text-center lg:text-left space-y-4 flex-1">
                        <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl xl:text-7xl font-bold text-base-content break-words">{{ episode_details.title }}</h1>
                        
                        <div class="flex flex-wrap items-center justify-center lg:justify-start gap-3 text-sm">
                            <!-- Service Badge -->
                            {% if server.service_type.value == 'plex' %}
                                <span class="inline-flex items-center rounded-md bg-plex-50 dark:bg-plex-400/10 px-2 py-1 text-xs font-medium text-plex-700 dark:text-plex-400 ring-1 ring-inset ring-plex-600/20 dark:ring-plex-500/20 gap-1">
                                    <svg class="w-3 h-3" viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="transparent" stroke-linejoin="round" stroke-width="12"><path d="M22 25.5h48L116 94l-46 68.5H22L68.5 94Zm109.8 56L108 46l14-20.5h48zm-.3 23.5c10.979 17.625 25.52 38.875 38.5 49.5-11.149 13.635-34.323 32.278-62.5-14z"/></svg>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'jellyfin' %}
                                <span class="inline-flex items-center rounded-md bg-jellyfin-50 dark:bg-jellyfin-400/10 px-2 py-1 text-xs font-medium text-jellyfin-700 dark:text-jellyfin-400 ring-1 ring-inset ring-jellyfin-600/20 dark:ring-jellyfin-500/20 gap-1">
                                    <i class="fa-solid fa-cube w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'emby' %}
                                <span class="inline-flex items-center rounded-md bg-emby-50 dark:bg-emby-400/10 px-2 py-1 text-xs font-medium text-emby-700 dark:text-emby-400 ring-1 ring-inset ring-emby-600/20 dark:ring-emby-500/20 gap-1">
                                    <i class="fa-solid fa-play-circle w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'kavita' %}
                                <span class="inline-flex items-center rounded-md bg-kavita-50 dark:bg-kavita-400/10 px-2 py-1 text-xs font-medium text-kavita-700 dark:text-kavita-400 ring-1 ring-inset ring-kavita-600/20 dark:ring-kavita-500/20 gap-1">
                                    <i class="fa-solid fa-book w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'audiobookshelf' %}
                                <span class="inline-flex items-center rounded-md bg-audiobookshelf-50 dark:bg-audiobookshelf-400/10 px-2 py-1 text-xs font-medium text-audiobookshelf-700 dark:text-audiobookshelf-400 ring-1 ring-inset ring-audiobookshelf-600/20 dark:ring-audiobookshelf-500/20 gap-1">
                                    <i class="fa-solid fa-headphones w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'komga' %}
                                <span class="inline-flex items-center rounded-md bg-komga-50 dark:bg-komga-400/10 px-2 py-1 text-xs font-medium text-komga-700 dark:text-komga-400 ring-1 ring-inset ring-komga-600/20 dark:ring-komga-500/20 gap-1">
                                    <i class="fa-solid fa-book-open w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'romm' %}
                                <span class="inline-flex items-center rounded-md bg-romm-50 dark:bg-romm-400/10 px-2 py-1 text-xs font-medium text-romm-700 dark:text-romm-400 ring-1 ring-inset ring-romm-600/20 dark:ring-romm-500/20 gap-1">
                                    <i class="fa-solid fa-gamepad w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% else %}
                                <span class="inline-flex items-center rounded-md bg-gray-50 dark:bg-gray-400/10 px-2 py-1 text-xs font-medium text-gray-700 dark:text-gray-400 ring-1 ring-inset ring-gray-600/20 dark:ring-gray-500/20 gap-1">
                                    <i class="fa-solid fa-server w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% endif %}
                            
                            <!-- Server Badge -->
                            <span class="inline-flex items-center rounded-md bg-gray-50 dark:bg-gray-400/10 px-2 py-1 text-xs font-medium text-gray-700 dark:text-gray-400 ring-1 ring-inset ring-gray-600/20 dark:ring-gray-500/20 gap-1">
                                <i class="fa-solid fa-server w-3 h-3"></i>
                                {{ server.server_nickname }}
                            </span>
                            
                            <!-- Library Badge -->
                            <span class="inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-400/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-400 ring-1 ring-inset ring-blue-600/20 dark:ring-blue-500/20 gap-1">
                                <i class="fa-solid fa-folder w-3 h-3"></i>
                                {{ library.name }}
                            </span>
                            
                            <!-- Episode Type Badge -->
                            <span class="inline-flex items-center rounded-md bg-purple-50 dark:bg-purple-400/10 px-2 py-1 text-xs font-medium text-purple-700 dark:text-purple-400 ring-1 ring-inset ring-purple-600/20 dark:ring-purple-500/20 gap-1">
                                <i class="fa-solid fa-tv w-3 h-3"></i>
                                Episode
                            </span>
                            
                            <!-- Season/Episode Badge -->
                            {% if episode_details.season_number and episode_details.episode_number %}
                            <span class="inline-flex items-center rounded-md bg-orange-50 dark:bg-orange-400/10 px-2 py-1 text-xs font-medium text-orange-700 dark:text-orange-400 ring-1 ring-inset ring-orange-600/20 dark:ring-orange-500/20 gap-1">
                                <i class="fa-solid fa-list-ol w-3 h-3"></i>
                                S{{ "%02d"|format(episode_details.season_number) }}E{{ "%02d"|format(episode_details.episode_number) }}
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Summary -->
                        {% if episode_details.summary %}
                        <div class="text-left max-w-2xl">
                            <p class="text-sm text-base-content/70 leading-relaxed">{{ episode_details.summary }}</p>
                        </div>
                        {% endif %}
                        
                        <!-- Additional Info -->
                        <div class="flex flex-wrap gap-4 text-sm text-base-content/60 justify-center lg:justify-start">
                            {% if episode_details.rating %}
                            <div class="flex items-center gap-1">
                                <i class="fa-solid fa-star text-yellow-500"></i>
                                <span>{{ "%.1f"|format(episode_details.rating) }}</span>
                            </div>
                            {% endif %}
                            {% if episode_details.duration %}
                            <div class="flex items-center gap-1">
                                <i class="fa-solid fa-clock"></i>
                                <span>{{ (episode_details.duration // 60)|int }}m</span>
                            </div>
                            {% endif %}
                            {% if episode_details.air_date %}
                            <div class="flex items-center gap-1">
                                <i class="fa-solid fa-calendar"></i>
                                {% if episode_details.air_date is string %}
                                    <span>Aired {{ episode_details.air_date[:10] }}</span>
                                {% else %}
                                    <span>Aired {{ episode_details.air_date.strftime('%b %d, %Y') }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if episode_details.added_at %}
                            <div class="flex items-center gap-1">
                                <i class="fa-solid fa-plus"></i>
                                {% if episode_details.added_at is string %}
                                    <span>Added {{ episode_details.added_at[:10] }}</span>
                                {% else %}
                                    <span>Added {{ episode_details.added_at.strftime('%b %d, %Y') }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="overflow-x-auto border-b border-base-300">
                <div role="tablist" class="tabs tabs-border whitespace-nowrap flex-nowrap">
                    <a role="tab" href="{{ url_for('libraries.episode_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=tv_show_item.id, tv_show_slug=generate_url_slug(tv_show_item.title), episode_slug=generate_url_slug(episode_details.title), tab='overview') }}"
                       class="tab block h-[unset] pb-4 pt-4 pl-2.5 pr-2.5 {{ 'tab-active' if request.args.get('tab', 'overview') == 'overview' else '' }}">
                        <i class="fa-solid fa-info-circle mr-2"></i>Overview
                    </a>
                    <a role="tab" href="{{ url_for('libraries.episode_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=tv_show_item.id, tv_show_slug=generate_url_slug(tv_show_item.title), episode_slug=generate_url_slug(episode_details.title), tab='activity') }}"
                       class="tab block h-[unset] pb-4 pt-4 pl-2.5 pr-2.5 {{ 'tab-active' if request.args.get('tab') == 'activity' else '' }}">
                        <i class="fa-solid fa-chart-line mr-2"></i>Activity
                    </a>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                {% set active_tab = request.args.get('tab', 'overview') %}
                {% if active_tab == 'overview' %}
                    <!-- Overview Tab -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Episode Information -->
                        <div class="bg-base-200/50 rounded-lg p-6 border border-base-300">
                            <h3 class="text-lg font-semibold text-base-content mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-info-circle text-primary"></i>
                                Episode Information
                            </h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Title:</span>
                                    <span class="font-medium">{{ episode_details.title }}</span>
                                </div>
                                {% if episode_details.season_number and episode_details.episode_number %}
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Episode:</span>
                                    <span class="font-medium">Season {{ episode_details.season_number }}, Episode {{ episode_details.episode_number }}</span>
                                </div>
                                {% endif %}
                                {% if episode_details.rating %}
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Rating:</span>
                                    <span class="font-medium">{{ "%.1f"|format(episode_details.rating) }}/10</span>
                                </div>
                                {% endif %}
                                {% if episode_details.duration %}
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Duration:</span>
                                    <span class="font-medium">{{ (episode_details.duration // 60)|int }} minutes</span>
                                </div>
                                {% endif %}
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Show:</span>
                                    <span class="font-medium">
                                        <a href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=tv_show_item.id, slug=generate_url_slug(tv_show_item.title)) }}" class="text-primary hover:text-primary-focus">
                                            {{ tv_show_item.title }}
                                        </a>
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Library:</span>
                                    <span class="font-medium">{{ library.name }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Server:</span>
                                    <span class="font-medium">{{ server.server_nickname }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Service:</span>
                                    <span class="font-medium">{{ service_name }}</span>
                                </div>
                                {% if episode_details.id %}
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">External ID:</span>
                                    <span class="font-medium font-mono text-sm">{{ episode_details.id }}</span>
                                </div>
                                {% endif %}
                                {% if episode_details.air_date %}
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Air Date:</span>
                                    {% if episode_details.air_date is string %}
                                        <span class="font-medium">{{ episode_details.air_date[:10] }}</span>
                                    {% else %}
                                        <span class="font-medium">{{ episode_details.air_date.strftime('%Y-%m-%d') }}</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% if episode_details.added_at %}
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Added:</span>
                                    {% if episode_details.added_at is string %}
                                        <span class="font-medium">{{ episode_details.added_at[:19] }}</span>
                                    {% else %}
                                        <span class="font-medium">{{ episode_details.added_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Summary -->
                        {% if episode_details.summary %}
                        <div class="bg-base-200/50 rounded-lg p-6 border border-base-300">
                            <h3 class="text-lg font-semibold text-base-content mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-file-text text-primary"></i>
                                Summary
                            </h3>
                            <p class="text-sm text-base-content/70 leading-relaxed">{{ episode_details.summary }}</p>
                        </div>
                        {% endif %}
                    </div>

                {% elif active_tab == 'activity' %}
                    <!-- Activity Tab -->
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-semibold">
                                <i class="fa-solid fa-chart-line text-primary mr-2"></i>
                                Recent Activity
                            </h2>
                            
                            <!-- Days Filter -->
                            <div class="flex items-center gap-2">
                                <label for="days-filter" class="text-sm text-base-content/60">Last:</label>
                                <select id="days-filter" class="select select-bordered select-sm" onchange="updateDaysFilter()">
                                    <option value="7" {{ 'selected' if days_filter == 7 else '' }}>7 days</option>
                                    <option value="30" {{ 'selected' if days_filter == 30 else '' }}>30 days</option>
                                    <option value="90" {{ 'selected' if days_filter == 90 else '' }}>90 days</option>
                                    <option value="365" {{ 'selected' if days_filter == 365 else '' }}>1 year</option>
                                </select>
                            </div>
                        </div>

                        {% if streaming_history and streaming_history.items %}
                            <!-- Activity List -->
                            <div class="space-y-3">
                                {% for entry in streaming_history.items %}
                                <div class="bg-base-100 rounded-lg p-4 flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="avatar placeholder">
                                            <div class="bg-primary text-primary-content rounded-full w-10 h-10">
                                                <span class="text-sm">{{ entry.user_display_name[0].upper() if entry.user_display_name else 'U' }}</span>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="font-medium">{{ entry.user_display_name or 'Unknown User' }}</div>
                                            <div class="text-sm text-base-content/60">
                                                {{ entry.started_at.strftime('%b %d, %Y at %I:%M %p') }}
                                                {% if entry.duration_seconds %}
                                                    • {{ (entry.duration_seconds // 60) }}m {{ (entry.duration_seconds % 60) }}s
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-sm text-base-content/60">
                                        <span class="badge badge-{{ 'success' if entry.user_type == 'service' else 'info' }} badge-sm">
                                            {{ entry.user_type.title() }}
                                        </span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Pagination -->
                            {% if streaming_history.pages > 1 %}
                            <div class="flex justify-center mt-6">
                                <div class="join">
                                    {% if streaming_history.has_prev %}
                                        <a href="{{ url_for('libraries.episode_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=tv_show_item.id, tv_show_slug=generate_url_slug(tv_show_item.title), episode_slug=generate_url_slug(episode_details.title), tab='activity', page=streaming_history.page-1, days=days_filter) }}" 
                                           class="join-item btn btn-sm">
                                            <i class="fa-solid fa-chevron-left"></i>
                                        </a>
                                    {% endif %}
                                    
                                    {% set start_page = [1, streaming_history.page - 2] | max %}
                                    {% set end_page = [streaming_history.pages, streaming_history.page + 2] | min %}
                                    
                                    {% if start_page > 1 %}
                                        <a href="{{ url_for('libraries.episode_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=tv_show_item.id, tv_show_slug=generate_url_slug(tv_show_item.title), episode_slug=generate_url_slug(episode_details.title), tab='activity', page=1, days=days_filter) }}" 
                                           class="join-item btn btn-sm">1</a>
                                        {% if start_page > 2 %}
                                            <button class="join-item btn btn-sm btn-disabled">...</button>
                                        {% endif %}
                                    {% endif %}
                                    
                                    {% for page_num in range(start_page, end_page + 1) %}
                                        {% if page_num == streaming_history.page %}
                                            <button class="join-item btn btn-sm btn-active">{{ page_num }}</button>
                                        {% else %}
                                            <a href="{{ url_for('libraries.episode_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=tv_show_item.id, tv_show_slug=generate_url_slug(tv_show_item.title), episode_slug=generate_url_slug(episode_details.title), tab='activity', page=page_num, days=days_filter) }}" 
                                               class="join-item btn btn-sm">{{ page_num }}</a>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if end_page < streaming_history.pages %}
                                        {% if end_page < streaming_history.pages - 1 %}
                                            <button class="join-item btn btn-sm btn-disabled">...</button>
                                        {% endif %}
                                        <a href="{{ url_for('libraries.episode_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=tv_show_item.id, tv_show_slug=generate_url_slug(tv_show_item.title), episode_slug=generate_url_slug(episode_details.title), tab='activity', page=streaming_history.pages, days=days_filter) }}" 
                                           class="join-item btn btn-sm">{{ streaming_history.pages }}</a>
                                    {% endif %}
                                    
                                    {% if streaming_history.has_next %}
                                        <a href="{{ url_for('libraries.episode_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=tv_show_item.id, tv_show_slug=generate_url_slug(tv_show_item.title), episode_slug=generate_url_slug(episode_details.title), tab='activity', page=streaming_history.page+1, days=days_filter) }}" 
                                           class="join-item btn btn-sm">
                                            <i class="fa-solid fa-chevron-right"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}

                        {% else %}
                            <!-- No Activity -->
                            <div class="text-center py-12">
                                <div class="w-16 h-16 rounded-full bg-base-300 flex items-center justify-center mx-auto mb-4">
                                    <i class="fa-solid fa-chart-line text-2xl text-base-content/40"></i>
                                </div>
                                <h3 class="text-lg font-medium text-base-content mb-2">No Activity Found</h3>
                                <p class="text-sm text-base-content/60 max-w-md mx-auto">
                                    No streaming activity has been recorded for this episode in the selected time period.
                                </p>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<script>
function updateDaysFilter() {
    const daysSelect = document.getElementById('days-filter');
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('days', daysSelect.value);
    currentUrl.searchParams.set('page', '1'); // Reset to first page
    window.location.href = currentUrl.toString();
}
</script>
{% endblock %}