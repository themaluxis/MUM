<!-- File: app/templates/libraries/library_detail.html -->
{% extends "base.html" %}

{% block title %}{{ super() }} - {{ title }}{% endblock %}

{% block content %}
<!-- Library Detail Page -->
{# Determine service-specific colors and gradients #}
{% if server.service_type.value == 'plex' %}
    {% set header_gradient = "bg-gradient-to-r from-plex/10 to-plex/20" %}
    {% set service_color = "plex" %}
    {% set service_icon = "fa-brands fa-plex" %}
    {% set service_name = "Plex" %}
{% elif server.service_type.value == 'jellyfin' %}
    {% set header_gradient = "bg-gradient-to-r from-jellyfin/10 to-jellyfin/20" %}
    {% set service_color = "jellyfin" %}
    {% set service_icon = "fa-solid fa-cube" %}
    {% set service_name = "Jellyfin" %}
{% elif server.service_type.value == 'emby' %}
    {% set header_gradient = "bg-gradient-to-r from-emby/10 to-emby/20" %}
    {% set service_color = "emby" %}
    {% set service_icon = "fa-solid fa-play-circle" %}
    {% set service_name = "Emby" %}
{% elif server.service_type.value == 'kavita' %}
    {% set header_gradient = "bg-gradient-to-r from-kavita/10 to-kavita/20" %}
    {% set service_color = "kavita" %}
    {% set service_icon = "fa-solid fa-book" %}
    {% set service_name = "Kavita" %}
{% elif server.service_type.value == 'audiobookshelf' %}
    {% set header_gradient = "bg-gradient-to-r from-audiobookshelf/10 to-audiobookshelf/20" %}
    {% set service_color = "audiobookshelf" %}
    {% set service_icon = "fa-solid fa-headphones" %}
    {% set service_name = "AudiobookShelf" %}
{% elif server.service_type.value == 'komga' %}
    {% set header_gradient = "bg-gradient-to-r from-komga/10 to-komga/20" %}
    {% set service_color = "komga" %}
    {% set service_icon = "fa-solid fa-book-open" %}
    {% set service_name = "Komga" %}
{% elif server.service_type.value == 'romm' %}
    {% set header_gradient = "bg-gradient-to-r from-romm/10 to-romm/20" %}
    {% set service_color = "romm" %}
    {% set service_icon = "fa-solid fa-gamepad" %}
    {% set service_name = "RomM" %}
{% else %}
    {% set header_gradient = "bg-gradient-to-r from-primary/10 to-secondary/10" %}
    {% set service_color = "primary" %}
    {% set service_icon = "fa-solid fa-server" %}
    {% set service_name = "Unknown Service" %}
{% endif %}

<div class="min-h-screen bg-base-100">

    <!-- Main Content Card -->
    <div class="container mx-auto px-4 pb-8">
        <div class="bg-base-100 border border-base-300 rounded-xl shadow-lg overflow-hidden">
            <!-- Hero Header Section -->
            <div class="bg-gradient-to-r from-primary/10 to-secondary/10 p-8 text-center border-b border-base-300">
                <div class="flex flex-col items-center space-y-4">

                    <!-- Library Info -->
                    <div class="text-center space-y-2">
                        <h1 class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl xl:text-8xl font-bold text-base-content mb-5 break-words">{{ library.name }}</h1>
                        <div class="flex flex-wrap items-center justify-center gap-3 text-sm">
                            <!-- Service Badge -->
                            {% if server.service_type.value == 'plex' %}
                                <span class="inline-flex items-center rounded-md bg-plex-50 dark:bg-plex-400/10 px-2 py-1 text-xs font-medium text-plex-700 dark:text-plex-400 ring-1 ring-inset ring-plex-600/20 dark:ring-plex-500/20 gap-1">
                                    <svg class="w-3 h-3" viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="transparent" stroke-linejoin="round" stroke-width="12"><path d="M22 25.5h48L116 94l-46 68.5H22L68.5 94Zm109.8 56L108 46l14-20.5h48zm-.3 23.5c10.979 17.625 25.52 38.875 38.5 49.5-11.149 13.635-34.323 32.278-62.5-14z"/></svg>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'jellyfin' %}
                                <span class="inline-flex items-center rounded-md bg-jellyfin-50 dark:bg-jellyfin-400/10 px-2 py-1 text-xs font-medium text-jellyfin-700 dark:text-jellyfin-400 ring-1 ring-inset ring-jellyfin-600/20 dark:ring-jellyfin-500/20 gap-1">
                                    <i class="fa-solid fa-cube w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'emby' %}
                                <span class="inline-flex items-center rounded-md bg-emby-50 dark:bg-emby-400/10 px-2 py-1 text-xs font-medium text-emby-700 dark:text-emby-400 ring-1 ring-inset ring-emby-600/20 dark:ring-emby-500/20 gap-1">
                                    <i class="fa-solid fa-play-circle w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'kavita' %}
                                <span class="inline-flex items-center rounded-md bg-kavita-50 dark:bg-kavita-400/10 px-2 py-1 text-xs font-medium text-kavita-700 dark:text-kavita-400 ring-1 ring-inset ring-kavita-600/20 dark:ring-kavita-500/20 gap-1">
                                    <i class="fa-solid fa-book w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'audiobookshelf' %}
                                <span class="inline-flex items-center rounded-md bg-audiobookshelf-50 dark:bg-audiobookshelf-400/10 px-2 py-1 text-xs font-medium text-audiobookshelf-700 dark:text-audiobookshelf-400 ring-1 ring-inset ring-audiobookshelf-600/20 dark:ring-audiobookshelf-500/20 gap-1">
                                    <i class="fa-solid fa-headphones w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'komga' %}
                                <span class="inline-flex items-center rounded-md bg-komga-50 dark:bg-komga-400/10 px-2 py-1 text-xs font-medium text-komga-700 dark:text-komga-400 ring-1 ring-inset ring-komga-600/20 dark:ring-komga-500/20 gap-1">
                                    <i class="fa-solid fa-book-open w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'romm' %}
                                <span class="inline-flex items-center rounded-md bg-romm-50 dark:bg-romm-400/10 px-2 py-1 text-xs font-medium text-romm-700 dark:text-romm-400 ring-1 ring-inset ring-romm-600/20 dark:ring-romm-500/20 gap-1">
                                    <i class="fa-solid fa-gamepad w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% else %}
                                <span class="inline-flex items-center rounded-md bg-gray-50 dark:bg-gray-400/10 px-2 py-1 text-xs font-medium text-gray-700 dark:text-gray-400 ring-1 ring-inset ring-gray-600/20 dark:ring-gray-500/20 gap-1">
                                    <i class="fa-solid fa-server w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% endif %}
                            
                            <!-- Server Badge -->
                            <span class="inline-flex items-center rounded-md bg-gray-50 dark:bg-gray-400/10 px-2 py-1 text-xs font-medium text-gray-700 dark:text-gray-400 ring-1 ring-inset ring-gray-600/20 dark:ring-gray-500/20 gap-1">
                                <i class="fa-solid fa-server w-3 h-3"></i>
                                {{ server.server_nickname }}
                            </span>
                            
                            <!-- Library Type Badge -->
                            <span class="inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-400/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-400 ring-1 ring-inset ring-blue-600/20 dark:ring-blue-500/20 gap-1">
                                <i class="fa-solid fa-tag w-3 h-3"></i>
                                {{ library_stats.library_type }}
                            </span>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="overflow-x-auto border-b border-base-300">
                <div role="tablist" class="tabs tabs-border whitespace-nowrap flex-nowrap">
                    <a role="tab" href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=library.name, tab='overview') }}"
                       class="tab block h-[unset] pb-4 pt-4 pl-2.5 pr-2.5 {{ 'tab-active' if active_tab == 'overview' else '' }}">
                        <i class="fa-solid fa-info-circle mr-2"></i>Overview
                    </a>
                    <a role="tab" href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=library.name, tab='media') }}"
                       class="tab block h-[unset] pb-4 pt-4 pl-2.5 pr-2.5 {{ 'tab-active' if active_tab == 'media' else '' }}">
                        <i class="fa-solid fa-film mr-2"></i>Media
                    </a>
                    <a role="tab" href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=library.name, tab='stats') }}"
                       class="tab block h-[unset] pb-4 pt-4 pl-2.5 pr-2.5 {{ 'tab-active' if active_tab == 'stats' else '' }}">
                        <i class="fa-solid fa-chart-bar mr-2"></i>Stats
                    </a>
                    <a role="tab" href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=library.name, tab='activity') }}"
                       class="tab block h-[unset] pb-4 pt-4 pl-2.5 pr-2.5 {{ 'tab-active' if active_tab == 'activity' else '' }}">
                        <i class="fa-solid fa-history mr-2"></i>
                        Recent Activity
                    </a>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="p-8">
                {% if active_tab == 'overview' %}
                    <!-- Overview Tab -->
                    <div class="space-y-8">
                        <!-- Library Information -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Library Details -->
                            <div class="bg-base-200/50 rounded-lg p-6 border border-base-300">
                                <h3 class="text-lg font-semibold mb-4 flex items-center">
                                    <i class="fa-solid fa-info-circle text-info mr-2"></i>
                                    Library Details
                                </h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-base-content/60">Name:</span>
                                        <span class="font-medium">{{ library.name }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-base-content/60">Type:</span>
                                        <span class="font-medium">{{ library_stats.library_type }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-base-content/60">Server Nickname:</span>
                                        <span class="font-medium">{{ server.server_nickname }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-base-content/60">Server:</span>
                                        <span class="font-medium">{{ server.server_name or server.server_nickname }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-base-content/60">Service:</span>
                                        <span class="font-medium">{{ service_name }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-base-content/60">External ID:</span>
                                        <span class="font-medium font-mono text-sm">{{ library.external_id }}</span>
                                    </div>
                                    {% if library.last_scanned %}
                                    <div class="flex justify-between">
                                        <span class="text-base-content/60">Last Scanned:</span>
                                        <span class="font-medium">{{ library.last_scanned.strftime('%Y-%m-%d %H:%M') }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Popular Content -->
                            <div class="bg-base-200/50 rounded-lg p-6 border border-base-300">
                                <h3 class="text-lg font-semibold mb-4 flex items-center">
                                    <i class="fa-solid fa-star text-warning mr-2"></i>
                                    Most Popular Content
                                </h3>
                                {% if library_stats.popular_content %}
                                    <div class="space-y-3">
                                        {% for content in library_stats.popular_content %}
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium truncate mr-2">{{ content.media_title }}</span>
                                            <span class="text-sm bg-primary/20 text-primary px-2 py-1 rounded-full">
                                                {{ content.play_count }} plays
                                            </span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="text-base-content/60 text-center py-4">No streaming activity yet</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% elif active_tab == 'media' %}
                    <!-- Media Tab -->
                    <div class="space-y-6">
                        {% include 'libraries/partials/library_media_grid.html' %}
                    </div>
                {% elif active_tab == 'stats' %}
                    <!-- Stats Tab -->
                    <div class="space-y-6">
                        {% include 'libraries/partials/library_stats_chart.html' %}
                    </div>
                {% elif active_tab == 'activity' %}
                    <!-- Activity Tab -->
                    <div hx-get="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=library.name, tab='activity', days=days_filter or 30) }}"
                         hx-trigger="load"
                         hx-target="this"
                         hx-swap="innerHTML">
                        {% include 'libraries/partials/library_activity_tab.html' %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Library Content Sync Results Modal -->
<dialog id="library_content_sync_results_modal" class="modal modal-bottom sm:modal-middle">
    <!-- Modal content will be loaded here -->
</dialog>

{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Chart.js for the library stats chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Handle library content sync results modal
document.body.addEventListener('openLibraryContentSyncResultsModal', function() {
    const modal = document.getElementById('library_content_sync_results_modal');
    if (modal) {
        modal.showModal();
    }
});

// Refresh page when library content sync results modal is closed
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('library_content_sync_results_modal');
    if (modal) {
        modal.addEventListener('close', function() {
            // Check if we need to refresh the page
            if (modal.dataset.shouldRefresh === 'true') {
                window.location.reload();
                modal.dataset.shouldRefresh = 'false';
            }
        });
    }
});

// Handle refresh library page event
document.body.addEventListener('refreshLibraryPage', function() {
    const modal = document.getElementById('library_content_sync_results_modal');
    if (modal) {
        modal.dataset.shouldRefresh = 'true';
    }
});
</script>
{% endblock %}