<!-- File: app/templates/libraries/media_detail.html -->
{% extends "base.html" %}

{% block title %}{{ super() }} - {{ title }}{% endblock %}

{% block content %}
<!-- Media Detail Page -->
{# Determine service-specific colors and gradients #}
{% if server.service_type.value == 'plex' %}
    {% set header_gradient = "bg-gradient-to-r from-plex/10 to-plex/20" %}
    {% set service_color = "plex" %}
    {% set service_icon = "fa-brands fa-plex" %}
    {% set service_name = "Plex" %}
{% elif server.service_type.value == 'jellyfin' %}
    {% set header_gradient = "bg-gradient-to-r from-jellyfin/10 to-jellyfin/20" %}
    {% set service_color = "jellyfin" %}
    {% set service_icon = "fa-solid fa-cube" %}
    {% set service_name = "Jellyfin" %}
{% elif server.service_type.value == 'emby' %}
    {% set header_gradient = "bg-gradient-to-r from-emby/10 to-emby/20" %}
    {% set service_color = "emby" %}
    {% set service_icon = "fa-solid fa-play-circle" %}
    {% set service_name = "Emby" %}
{% elif server.service_type.value == 'kavita' %}
    {% set header_gradient = "bg-gradient-to-r from-kavita/10 to-kavita/20" %}
    {% set service_color = "kavita" %}
    {% set service_icon = "fa-solid fa-book" %}
    {% set service_name = "Kavita" %}
{% elif server.service_type.value == 'audiobookshelf' %}
    {% set header_gradient = "bg-gradient-to-r from-audiobookshelf/10 to-audiobookshelf/20" %}
    {% set service_color = "audiobookshelf" %}
    {% set service_icon = "fa-solid fa-headphones" %}
    {% set service_name = "AudiobookShelf" %}
{% elif server.service_type.value == 'komga' %}
    {% set header_gradient = "bg-gradient-to-r from-komga/10 to-komga/20" %}
    {% set service_color = "komga" %}
    {% set service_icon = "fa-solid fa-book-open" %}
    {% set service_name = "Komga" %}
{% elif server.service_type.value == 'romm' %}
    {% set header_gradient = "bg-gradient-to-r from-romm/10 to-romm/20" %}
    {% set service_color = "romm" %}
    {% set service_icon = "fa-solid fa-gamepad" %}
    {% set service_name = "RomM" %}
{% else %}
    {% set header_gradient = "bg-gradient-to-r from-primary/10 to-secondary/10" %}
    {% set service_color = "primary" %}
    {% set service_icon = "fa-solid fa-server" %}
    {% set service_name = "Unknown Service" %}
{% endif %}

<div class="min-h-screen bg-base-100">

    <!-- Main Content Card -->
    <div class="container mx-auto px-4 pb-8">
        <div class="bg-base-100 border border-base-300 rounded-xl shadow-lg overflow-hidden">
            <!-- Hero Header Section -->
            <div class="bg-gradient-to-r from-primary/10 to-secondary/10 p-8 text-center border-b border-base-300">
                <div class="flex flex-col lg:flex-row items-center gap-8">
                    
                    <!-- Media Poster -->
                    <div class="flex-shrink-0">
                        {% if media_details.thumb %}
                            <div class="w-48 h-72 rounded-lg overflow-hidden shadow-lg bg-base-200">
                                <img src="{{ media_details.thumb }}" 
                                     alt="{{ media_details.title }}"
                                     class="w-full h-full object-cover"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <!-- Fallback poster -->
                                <div class="w-full h-full flex items-center justify-center text-6xl text-base-content/30" style="display: none;">
                                    <i class="fa-solid fa-film"></i>
                                </div>
                            </div>
                        {% else %}
                            <!-- No poster available -->
                            <div class="w-48 h-72 rounded-lg bg-base-200 flex items-center justify-center text-6xl text-base-content/30">
                                <i class="fa-solid fa-film"></i>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Media Info -->
                    <div class="text-center lg:text-left space-y-4 flex-1">
                        <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl xl:text-7xl font-bold text-base-content break-words">{{ media_details.title }}</h1>
                        
                        <div class="flex flex-wrap items-center justify-center lg:justify-start gap-3 text-sm">
                            <!-- Service Badge -->
                            {% if server.service_type.value == 'plex' %}
                                <span class="inline-flex items-center rounded-md bg-plex-50 dark:bg-plex-400/10 px-2 py-1 text-xs font-medium text-plex-700 dark:text-plex-400 ring-1 ring-inset ring-plex-600/20 dark:ring-plex-500/20 gap-1">
                                    <svg class="w-3 h-3" viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="transparent" stroke-linejoin="round" stroke-width="12"><path d="M22 25.5h48L116 94l-46 68.5H22L68.5 94Zm109.8 56L108 46l14-20.5h48zm-.3 23.5c10.979 17.625 25.52 38.875 38.5 49.5-11.149 13.635-34.323 32.278-62.5-14z"/></svg>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'jellyfin' %}
                                <span class="inline-flex items-center rounded-md bg-jellyfin-50 dark:bg-jellyfin-400/10 px-2 py-1 text-xs font-medium text-jellyfin-700 dark:text-jellyfin-400 ring-1 ring-inset ring-jellyfin-600/20 dark:ring-jellyfin-500/20 gap-1">
                                    <i class="fa-solid fa-cube w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'emby' %}
                                <span class="inline-flex items-center rounded-md bg-emby-50 dark:bg-emby-400/10 px-2 py-1 text-xs font-medium text-emby-700 dark:text-emby-400 ring-1 ring-inset ring-emby-600/20 dark:ring-emby-500/20 gap-1">
                                    <i class="fa-solid fa-play-circle w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'kavita' %}
                                <span class="inline-flex items-center rounded-md bg-kavita-50 dark:bg-kavita-400/10 px-2 py-1 text-xs font-medium text-kavita-700 dark:text-kavita-400 ring-1 ring-inset ring-kavita-600/20 dark:ring-kavita-500/20 gap-1">
                                    <i class="fa-solid fa-book w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'audiobookshelf' %}
                                <span class="inline-flex items-center rounded-md bg-audiobookshelf-50 dark:bg-audiobookshelf-400/10 px-2 py-1 text-xs font-medium text-audiobookshelf-700 dark:text-audiobookshelf-400 ring-1 ring-inset ring-audiobookshelf-600/20 dark:ring-audiobookshelf-500/20 gap-1">
                                    <i class="fa-solid fa-headphones w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'komga' %}
                                <span class="inline-flex items-center rounded-md bg-komga-50 dark:bg-komga-400/10 px-2 py-1 text-xs font-medium text-komga-700 dark:text-komga-400 ring-1 ring-inset ring-komga-600/20 dark:ring-komga-500/20 gap-1">
                                    <i class="fa-solid fa-book-open w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% elif server.service_type.value == 'romm' %}
                                <span class="inline-flex items-center rounded-md bg-romm-50 dark:bg-romm-400/10 px-2 py-1 text-xs font-medium text-romm-700 dark:text-romm-400 ring-1 ring-inset ring-romm-600/20 dark:ring-romm-500/20 gap-1">
                                    <i class="fa-solid fa-gamepad w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% else %}
                                <span class="inline-flex items-center rounded-md bg-gray-50 dark:bg-gray-400/10 px-2 py-1 text-xs font-medium text-gray-700 dark:text-gray-400 ring-1 ring-inset ring-gray-600/20 dark:ring-gray-500/20 gap-1">
                                    <i class="fa-solid fa-server w-3 h-3"></i>
                                    {{ service_name }}
                                </span>
                            {% endif %}
                            
                            <!-- Server Badge -->
                            <span class="inline-flex items-center rounded-md bg-gray-50 dark:bg-gray-400/10 px-2 py-1 text-xs font-medium text-gray-700 dark:text-gray-400 ring-1 ring-inset ring-gray-600/20 dark:ring-gray-500/20 gap-1">
                                <i class="fa-solid fa-server w-3 h-3"></i>
                                {{ server.server_nickname }}
                            </span>
                            
                            <!-- Library Badge -->
                            <span class="inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-400/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-400 ring-1 ring-inset ring-blue-600/20 dark:ring-blue-500/20 gap-1">
                                <i class="fa-solid fa-folder w-3 h-3"></i>
                                {{ library.name }}
                            </span>
                            
                            <!-- Media Type Badge -->
                            {% if media_details.type %}
                            <span class="inline-flex items-center rounded-md bg-purple-50 dark:bg-purple-400/10 px-2 py-1 text-xs font-medium text-purple-700 dark:text-purple-400 ring-1 ring-inset ring-purple-600/20 dark:ring-purple-500/20 gap-1">
                                <i class="fa-solid fa-tag w-3 h-3"></i>
                                {{ media_details.type|title }}
                            </span>
                            {% endif %}
                            
                            <!-- Year Badge -->
                            {% if media_details.year %}
                            <span class="inline-flex items-center rounded-md bg-orange-50 dark:bg-orange-400/10 px-2 py-1 text-xs font-medium text-orange-700 dark:text-orange-400 ring-1 ring-inset ring-orange-600/20 dark:ring-orange-500/20 gap-1">
                                <i class="fa-solid fa-calendar w-3 h-3"></i>
                                {{ media_details.year }}
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Summary -->
                        {% if media_details.summary %}
                        <div class="text-left max-w-2xl">
                            <p class="text-sm text-base-content/70 leading-relaxed">{{ media_details.summary }}</p>
                        </div>
                        {% endif %}
                        
                        <!-- Additional Info -->
                        <div class="flex flex-wrap gap-4 text-sm text-base-content/60 justify-center lg:justify-start">
                            {% if media_details.rating %}
                            <div class="flex items-center gap-1">
                                <i class="fa-solid fa-star text-yellow-500"></i>
                                <span>{{ "%.1f"|format(media_details.rating) }}</span>
                            </div>
                            {% endif %}
                            {% if media_details.duration %}
                            <div class="flex items-center gap-1">
                                <i class="fa-solid fa-clock"></i>
                                <span>{{ format_media_duration(media_details.duration, server.service_type.value) }}</span>
                            </div>
                            {% endif %}
                            {% if media_details.added_at %}
                            <div class="flex items-center gap-1">
                                <i class="fa-solid fa-plus"></i>
                                {% if media_details.added_at is string %}
                                    <span>Added {{ media_details.added_at[:10] }}</span>
                                {% else %}
                                    <span>Added {{ media_details.added_at.strftime('%b %d, %Y') }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="overflow-x-auto border-b border-base-300">
                <div role="tablist" class="tabs tabs-border whitespace-nowrap flex-nowrap">
                    <a role="tab" href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=media_item.id, slug=generate_url_slug(media_details.title), tab='overview') }}"
                       class="tab block h-[unset] pb-4 pt-4 pl-2.5 pr-2.5 {{ 'tab-active' if active_tab == 'overview' else '' }}">
                        <i class="fa-solid fa-info-circle mr-2"></i>Overview
                    </a>
                    {% if library.library_type and library.library_type.lower() in ['show', 'tv', 'series', 'tvshows'] %}
                    <a role="tab" href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=media_item.id, slug=generate_url_slug(media_details.title), tab='episodes') }}"
                       class="tab block h-[unset] pb-4 pt-4 pl-2.5 pr-2.5 {{ 'tab-active' if active_tab == 'episodes' else '' }}">
                        <i class="fa-solid fa-list mr-2"></i>Episodes
                    </a>
                    {% endif %}
                    <a role="tab" href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=media_item.id, slug=generate_url_slug(media_details.title), tab='activity') }}"
                       class="tab block h-[unset] pb-4 pt-4 pl-2.5 pr-2.5 {{ 'tab-active' if active_tab == 'activity' else '' }}">
                        <i class="fa-solid fa-chart-line mr-2"></i>Activity
                    </a>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                {% if active_tab == 'overview' %}
                    <!-- Overview Tab -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Media Information -->
                        <div class="bg-base-200/50 rounded-lg p-6 border border-base-300">
                            <h3 class="text-lg font-semibold text-base-content mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-info-circle text-primary"></i>
                                Media Information
                            </h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Title:</span>
                                    <span class="font-medium">{{ media_details.title }}</span>
                                </div>
                                {% if media_details.type %}
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Type:</span>
                                    <span class="font-medium">{{ media_details.type|title }}</span>
                                </div>
                                {% endif %}
                                {% if media_details.year %}
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Year:</span>
                                    <span class="font-medium">{{ media_details.year }}</span>
                                </div>
                                {% endif %}
                                {% if media_details.rating %}
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Rating:</span>
                                    <span class="font-medium">{{ "%.1f"|format(media_details.rating) }}/10</span>
                                </div>
                                {% endif %}
                                {% if media_details.duration %}
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Duration:</span>
                                    <span class="font-medium">{{ format_media_duration(media_details.duration, server.service_type.value) }}</span>
                                </div>
                                {% endif %}
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Library:</span>
                                    <span class="font-medium">{{ library.name }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Server:</span>
                                    <span class="font-medium">{{ server.server_nickname }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Service:</span>
                                    <span class="font-medium">{{ service_name }}</span>
                                </div>
                                {% if media_details.external_id %}
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">
                                        {% if server.service_type.value.lower() == 'plex' and media_details.raw_data.external_id_type == 'ratingKey' %}
                                            External ID (ratingKey):
                                        {% else %}
                                            External ID:
                                        {% endif %}
                                    </span>
                                    <span class="font-medium font-mono text-sm">{{ media_details.external_id }}</span>
                                </div>
                                {% endif %}
                                {% if media_details.added_at %}
                                <div class="flex justify-between">
                                    <span class="text-base-content/60">Added:</span>
                                    {% if media_details.added_at is string %}
                                        <span class="font-medium">{{ media_details.added_at[:19] }}</span>
                                    {% else %}
                                        <span class="font-medium">{{ media_details.added_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                                
                                <!-- View Output Button -->
                                <div class="pt-3 border-t border-base-300">
                                    <button onclick="showApiOutputModal()" class="btn btn-sm btn-outline btn-primary w-full">
                                        <i class="fa-solid fa-code mr-2"></i>
                                        View API Output
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Summary -->
                        {% if media_details.summary %}
                        <div class="bg-base-200/50 rounded-lg p-6 border border-base-300">
                            <h3 class="text-lg font-semibold text-base-content mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-file-text text-primary"></i>
                                Summary
                            </h3>
                            <p class="text-sm text-base-content/70 leading-relaxed">{{ media_details.summary }}</p>
                        </div>
                        {% endif %}
                    </div>

                {% elif active_tab == 'episodes' and library.library_type and library.library_type.lower() in ['show', 'tv', 'series', 'tvshows'] %}
                    <!-- Episodes Tab -->
                    {% include 'libraries/partials/episodes_grid.html' %}
                
                {% elif active_tab == 'activity' %}
                    <!-- Activity Tab -->
                    {% include 'libraries/partials/media_activity_tab.html' %}
                {% endif %}
            </div>

        </div>
    </div>
</div>

<!-- API Output Modal -->
<dialog id="apiOutputModal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-5xl bg-base-100 border border-base-300 shadow-2xl p-0">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-base-300">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-secondary/20 flex items-center justify-center">
                    <i class="fa-solid fa-code text-secondary text-lg"></i>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-base-content">Raw API Data</h3>
                    <p class="text-sm text-base-content/60">Complete API response for "{{ media_details.title }}"</p>
                </div>
            </div>
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost hover:bg-base-200">
                    <i class="fa-solid fa-times"></i>
                </button>
            </form>
        </div>

        <!-- Content -->
        <div class="p-6">
            <div class="flex gap-2 mb-4">
                <button onclick="copyApiOutput()" class="btn btn-sm btn-outline">
                    <i class="fa-solid fa-copy mr-2"></i>
                    Copy to Clipboard
                </button>
                <button onclick="downloadApiOutput()" class="btn btn-sm btn-outline">
                    <i class="fa-solid fa-download mr-2"></i>
                    Download JSON
                </button>
            </div>
            
            <div class="bg-base-300 rounded-lg p-4 max-h-96 overflow-auto">
                <pre id="apiOutputContent" class="text-sm whitespace-pre-wrap break-words font-mono">
                    <div class="flex items-center justify-center py-8">
                        <span class="loading loading-spinner loading-md mr-2"></span>
                        Loading API output...
                    </div>
                </pre>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

<script>
// Handle refresh media page event
document.addEventListener('refreshMediaPage', function() {
    window.location.reload();
});

// API Output Modal Functions
function showApiOutputModal() {
    const modal = document.getElementById('apiOutputModal');
    const content = document.getElementById('apiOutputContent');
    
    // Show modal
    modal.showModal();
    
    // Reset content to loading state
    content.innerHTML = `
        <div class="flex items-center justify-center py-8">
            <span class="loading loading-spinner loading-md mr-2"></span>
            Loading API output...
        </div>
    `;
    
    // Fetch API output
    fetch(`{{ url_for('libraries.get_media_api_output', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=media_item.id) }}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                content.innerHTML = `<div class="text-error">Error: ${data.error}</div>`;
            } else {
                content.textContent = JSON.stringify(data, null, 2);
            }
        })
        .catch(error => {
            content.innerHTML = `<div class="text-error">Error loading API output: ${error.message}</div>`;
        });
}

function closeApiOutputModal() {
    const modal = document.getElementById('apiOutputModal');
    modal.close();
}

function copyApiOutput() {
    const content = document.getElementById('apiOutputContent');
    navigator.clipboard.writeText(content.textContent).then(() => {
        // Show temporary success message
        const originalText = content.textContent;
        const copyBtn = event.target.closest('button');
        const originalBtnText = copyBtn.innerHTML;
        
        copyBtn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>Copied!';
        copyBtn.classList.add('btn-success');
        
        setTimeout(() => {
            copyBtn.innerHTML = originalBtnText;
            copyBtn.classList.remove('btn-success');
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
    });
}

function downloadApiOutput() {
    const content = document.getElementById('apiOutputContent').textContent;
    const blob = new Blob([content], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `{{ media_details.title|replace(' ', '_') }}_api_output.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Close modal when clicking outside
document.getElementById('apiOutputModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeApiOutputModal();
    }
});
</script>

{% endblock %}