<!-- File: app/templates/libraries/partials/media_activity_tab.html -->
<div class="space-y-6">
    <!-- Filter Controls -->
    <div class="flex flex-wrap items-center justify-between gap-4">
        <h3 class="text-lg font-semibold text-base-content flex items-center gap-2">
            <i class="fa-solid fa-chart-line text-primary"></i>
            Streaming Activity
        </h3>
        
        <!-- Time Filter Dropdown -->
        <div class="dropdown dropdown-end">
            <div tabindex="0" role="button" class="btn btn-sm btn-outline">
                <i class="fa-solid fa-calendar mr-2"></i>
                {% if days_filter == 7 %}Last 7 days
                {% elif days_filter == 30 %}Last 30 days
                {% elif days_filter == 90 %}Last 90 days
                {% else %}Last 30 days{% endif %}
                <i class="fa-solid fa-chevron-down ml-2"></i>
            </div>
            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52 border border-base-300">
                <li><a href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=media_item.id, slug=generate_url_slug(media_details.title), tab='activity', days=7) }}"
                       class="{% if days_filter == 7 %}active{% endif %}">Last 7 days</a></li>
                <li><a href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=media_item.id, slug=generate_url_slug(media_details.title), tab='activity', days=30) }}"
                       class="{% if days_filter == 30 %}active{% endif %}">Last 30 days</a></li>
                <li><a href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=media_item.id, slug=generate_url_slug(media_details.title), tab='activity', days=90) }}"
                       class="{% if days_filter == 90 %}active{% endif %}">Last 90 days</a></li>
            </ul>
        </div>
    </div>

    <!-- Activity List -->
    {% if streaming_history and streaming_history.items %}
        <div class="bg-base-200/50 rounded-lg border border-base-300 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                    <thead class="bg-base-300">
                        <tr>
                            <th class="text-left">User</th>
                            <th class="text-left">Started</th>
                            <th class="text-left">Duration</th>
                            <th class="text-left">Progress</th>
                            <th class="text-left">Device</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for activity in streaming_history.items %}
                        <tr class="hover:bg-base-200/50">
                            <td>
                                <div class="flex items-center gap-3">
                                    <div class="avatar">
                                        <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center overflow-hidden">
                                            {% if activity.user_avatar_url %}
                                                <img src="{{ activity.user_avatar_url }}" 
                                                     alt="{{ activity.user_display_name }}" 
                                                     class="w-full h-full object-cover"
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                <!-- Fallback icon if avatar fails to load -->
                                                <div class="w-full h-full flex items-center justify-center" style="display: none;">
                                                    {% if activity.user_type == 'service' %}
                                                        <i class="fa-solid fa-user text-primary text-xs"></i>
                                                    {% elif activity.user_type == 'local' %}
                                                        <i class="fa-solid fa-user-gear text-primary text-xs"></i>
                                                    {% else %}
                                                        <i class="fa-solid fa-user-question text-primary text-xs"></i>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <!-- No avatar available, show icon -->
                                                {% if activity.user_type == 'service' %}
                                                    <i class="fa-solid fa-user text-primary text-xs"></i>
                                                {% elif activity.user_type == 'local' %}
                                                    <i class="fa-solid fa-user-gear text-primary text-xs"></i>
                                                {% else %}
                                                    <i class="fa-solid fa-user-question text-primary text-xs"></i>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div>
                                        <div class="font-medium text-sm">{{ activity.user_display_name }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="text-sm">
                                    <div>{{ activity.started_at.strftime('%b %d, %Y') }}</div>
                                    <div class="text-xs text-base-content/60">{{ activity.started_at.strftime('%I:%M %p') }}</div>
                                </div>
                            </td>
                            <td>
                                <div class="text-sm">
                                    {% if activity.duration_seconds %}
                                        {% set hours = (activity.duration_seconds // 3600)|int %}
                                        {% set minutes = ((activity.duration_seconds % 3600) // 60)|int %}
                                        {% if hours > 0 %}
                                            {{ hours }}h {{ minutes }}m
                                        {% else %}
                                            {{ minutes }}m
                                        {% endif %}
                                    {% elif activity.view_offset_at_end_seconds %}
                                        {% set hours = (activity.view_offset_at_end_seconds // 3600)|int %}
                                        {% set minutes = ((activity.view_offset_at_end_seconds % 3600) // 60)|int %}
                                        {% if hours > 0 %}
                                            {{ hours }}h {{ minutes }}m
                                        {% else %}
                                            {{ minutes }}m
                                        {% endif %}
                                    {% else %}
                                        <span class="text-base-content/40">Unknown</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="text-sm">
                                    {% if activity.view_offset_at_end_seconds and activity.media_duration_seconds %}
                                        {% set progress_percent = ((activity.view_offset_at_end_seconds / activity.media_duration_seconds) * 100)|round(1) %}
                                        <div class="flex items-center gap-2">
                                            <div class="w-16 bg-base-300 rounded-full h-2">
                                                <div class="bg-primary h-2 rounded-full" style="width: {{ progress_percent }}%"></div>
                                            </div>
                                            <span class="text-xs">{{ progress_percent }}%</span>
                                        </div>
                                    {% else %}
                                        <span class="text-base-content/40">Unknown</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="text-sm">
                                    {% if activity.device_name %}
                                        <div class="flex items-center gap-1">
                                            <i class="fa-solid fa-tv text-base-content/60 text-xs"></i>
                                            {{ activity.device_name }}
                                        </div>
                                    {% else %}
                                        <span class="text-base-content/40">Unknown</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        {% if streaming_history.pages > 1 %}
        <div class="flex items-center justify-center gap-2">
            <!-- Previous Page -->
            {% if streaming_history.has_prev %}
                <a href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=media_item.id, slug=generate_url_slug(media_details.title), tab='activity', days=days_filter, page=streaming_history.prev_num) }}"
                   class="btn btn-sm btn-outline">
                    <i class="fa-solid fa-chevron-left"></i>
                    Previous
                </a>
            {% endif %}

            <!-- Page Numbers -->
            {% for page_num in streaming_history.iter_pages() %}
                {% if page_num %}
                    {% if page_num != streaming_history.page %}
                        <a href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=media_item.id, slug=generate_url_slug(media_details.title), tab='activity', days=days_filter, page=page_num) }}"
                           class="btn btn-sm btn-outline">{{ page_num }}</a>
                    {% else %}
                        <span class="btn btn-sm btn-primary">{{ page_num }}</span>
                    {% endif %}
                {% else %}
                    <span class="btn btn-sm btn-disabled">…</span>
                {% endif %}
            {% endfor %}

            <!-- Next Page -->
            {% if streaming_history.has_next %}
                <a href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=media_item.id, slug=generate_url_slug(media_details.title), tab='activity', days=days_filter, page=streaming_history.next_num) }}"
                   class="btn btn-sm btn-outline">
                    Next
                    <i class="fa-solid fa-chevron-right"></i>
                </a>
            {% endif %}
        </div>
        {% endif %}

    {% else %}
        <!-- No Activity -->
        <div class="bg-base-200/50 rounded-lg p-12 text-center border border-base-300">
            <div class="w-16 h-16 rounded-full bg-base-300 flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-chart-line text-2xl text-base-content/40"></i>
            </div>
            <h3 class="text-lg font-medium text-base-content mb-2">No Activity Found</h3>
            <p class="text-sm text-base-content/60 max-w-md mx-auto">
                No streaming activity has been recorded for this content in the selected time period.
            </p>
        </div>
    {% endif %}
</div>