<!-- File: app/templates/libraries/partials/library_media_grid.html -->
<div class="space-y-6">
    <!-- Media Grid Header -->
    <div class="flex flex-col gap-4">
        <!-- Title and Stats Row -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <h3 class="text-lg font-semibold flex items-center">
                <i class="fa-solid fa-film text-primary mr-2"></i>
                Library Content
                {% if media_content and media_content.total %}
                    <span class="text-sm text-base-content/60 ml-2">({{ media_content.total }} items)</span>
                {% endif %}
            </h3>
            
            <!-- Results Info -->
            <div class="text-sm text-base-content/60">
                {% if media_content and media_content.total %}
                    Showing {{ ((media_content.page - 1) * media_content.per_page) + 1 }}-{{ 
                        [media_content.page * media_content.per_page, media_content.total] | min 
                    }} of {{ media_content.total }}
                {% endif %}
            </div>
        </div>
        
        <!-- Search and Controls Row -->
        <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
            <!-- Search Box -->
            <div class="flex-1 max-w-md">
                <div class="relative">
                    <input type="text" 
                           id="library-search" 
                           placeholder="Search library content..." 
                           class="input input-bordered w-full pl-10 pr-4"
                           value="{{ request.args.get('search', '') }}">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-search text-base-content/40"></i>
                    </div>
                    {% if request.args.get('search') %}
                    <button type="button" 
                            id="clear-search"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-base-content/60 hover:text-base-content">
                        <i class="fa-solid fa-times"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
            
            <!-- Sort By Dropdown -->
            <div class="flex items-center gap-2">
                <label for="sort-by" class="text-sm text-base-content/60 whitespace-nowrap">Sort by:</label>
                <select id="sort-by" class="select select-bordered select-sm w-64">
                    <option value="title_asc" {{ 'selected' if request.args.get('sort_by', 'title_asc') == 'title_asc' else '' }}>Title (A to Z)</option>
                    <option value="title_desc" {{ 'selected' if request.args.get('sort_by') == 'title_desc' else '' }}>Title (Z to A)</option>
                    <option value="year_desc" {{ 'selected' if request.args.get('sort_by') == 'year_desc' else '' }}>Year (Newest First)</option>
                    <option value="year_asc" {{ 'selected' if request.args.get('sort_by') == 'year_asc' else '' }}>Year (Oldest First)</option>
                    <option value="added_at_desc" {{ 'selected' if request.args.get('sort_by') == 'added_at_desc' else '' }}>Date Added (Newest First)</option>
                    <option value="added_at_asc" {{ 'selected' if request.args.get('sort_by') == 'added_at_asc' else '' }}>Date Added (Oldest First)</option>
                    <option value="rating_desc" {{ 'selected' if request.args.get('sort_by') == 'rating_desc' else '' }}>Rating (Highest First)</option>
                    <option value="rating_asc" {{ 'selected' if request.args.get('sort_by') == 'rating_asc' else '' }}>Rating (Lowest First)</option>
                    <option value="total_streams_desc" {{ 'selected' if request.args.get('sort_by') == 'total_streams_desc' else '' }}>Total Streams (Most Popular)</option>
                    <option value="total_streams_asc" {{ 'selected' if request.args.get('sort_by') == 'total_streams_asc' else '' }}>Total Streams (Least Popular)</option>
                </select>
            </div>
            
            <!-- Items Per Page Dropdown -->
            <div class="flex items-center gap-2">
                <label for="items-per-page" class="text-sm text-base-content/60 whitespace-nowrap">Items per page:</label>
                <select id="items-per-page" class="select select-bordered select-sm w-20">
                    <option value="12" {{ 'selected' if media_content.per_page == 12 else '' }}>12</option>
                    <option value="24" {{ 'selected' if media_content.per_page == 24 else '' }}>24</option>
                    <option value="48" {{ 'selected' if media_content.per_page == 48 else '' }}>48</option>
                    <option value="96" {{ 'selected' if media_content.per_page == 96 else '' }}>96</option>
                </select>
            </div>
            
            <!-- Sync Library Button -->
            <div class="flex items-center gap-2">
                <button id="purge-library-btn" 
                        class="btn btn-error btn-sm"
                        data-library-id="{{ library.id }}"
                        title="Delete all cached items for this library from database">
                    <i class="fa-solid fa-trash mr-2"></i>
                    <span class="purge-btn-text">Purge DB</span>
                </button>
                <button id="sync-library-btn" 
                        class="btn btn-primary btn-sm"
                        data-library-id="{{ library.id }}"
                        title="Sync library content to database for faster loading">
                    <i class="fa-solid fa-sync mr-2"></i>
                    <span class="sync-btn-text">Sync Library</span>
                </button>
                <div class="text-xs text-base-content/50 hidden sm:block">
                    {% if library.last_scanned %}
                        Last updated: {{ format_datetime_with_user_timezone(library.last_scanned, '%m/%d %H:%M') }}
                    {% else %}
                        Never updated
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if media_content and media_content.get('items') %}
        <!-- Media Grid -->
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4">
            {% for item in media_content.get('items', []) %}
            <a href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), content_name=encode_url_component(item.title)) }}" class="group cursor-pointer block">
                <!-- Poster Container -->
                <div class="relative aspect-[2/3] bg-base-200 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 group-hover:scale-105">
                    {% if item.type in ['folder', 'directory'] or (item.type == 'collectionfolder') %}
                        <!-- Folder Icon Display -->
                        <div class="absolute inset-0 bg-base-200 flex items-center justify-center">
                            <i class="fa-solid fa-folder text-6xl text-base-content/60"></i>
                        </div>
                    {% elif item.thumb %}
                        <img src="{{ item.thumb }}" 
                             alt="{{ item.title }}" 
                             class="w-full h-full object-cover"
                             loading="lazy"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <!-- Fallback when image fails to load -->
                        <div class="absolute inset-0 bg-base-300 flex items-center justify-center text-base-content/40" style="display: none;">
                            {% if item.type in ['folder', 'directory'] or (item.type == 'collectionfolder') %}
                                <i class="fa-solid fa-folder text-4xl text-amber-600"></i>
                            {% else %}
                                <i class="fa-solid fa-image text-4xl"></i>
                            {% endif %}
                        </div>
                    {% else %}
                        <!-- No image placeholder -->
                        <div class="absolute inset-0 bg-base-300 flex items-center justify-center text-base-content/40">
                            {% if item.type in ['folder', 'directory'] or (item.type == 'collectionfolder') %}
                                <i class="fa-solid fa-folder text-4xl text-amber-600"></i>
                            {% elif item.type == 'movie' %}
                                <i class="fa-solid fa-film text-4xl"></i>
                            {% elif item.type in ['show', 'episode'] %}
                                <i class="fa-solid fa-tv text-4xl"></i>
                            {% elif item.type in ['track', 'album'] %}
                                <i class="fa-solid fa-music text-4xl"></i>
                            {% elif item.type in ['book', 'audiobook'] %}
                                <i class="fa-solid fa-book text-4xl"></i>
                            {% elif item.type in ['comic', 'manga'] %}
                                <i class="fa-solid fa-book-open text-4xl"></i>
                            {% else %}
                                <i class="fa-solid fa-file text-4xl"></i>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <!-- Hover Overlay -->
                    <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                        <div class="text-center text-white p-2">
                            {% if item.type in ['folder', 'directory'] or (item.type == 'collectionfolder') %}
                                <i class="fa-solid fa-folder-open text-2xl mb-2"></i>
                                <div class="text-xs">Browse Folder</div>
                            {% else %}
                                <i class="fa-solid fa-play text-2xl mb-2"></i>
                                <div class="text-xs">View Details</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Rating Badge (if available) -->
                    {% if item.rating %}
                    <div class="absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded-full">
                        <i class="fa-solid fa-star text-yellow-400 mr-1"></i>
                        {{ "%.1f"|format(item.rating) }}
                    </div>
                    {% endif %}
                    
                    <!-- Type Badge -->
                    <div class="absolute top-2 left-2 bg-primary/80 text-white text-xs px-2 py-1 rounded-full capitalize">
                        {% if item.type in ['folder', 'directory'] or (item.type == 'collectionfolder') %}
                            Folder
                        {% else %}
                            {{ item.type }}
                        {% endif %}
                    </div>
                </div>
                
                <!-- Title and Year -->
                <div class="mt-2 text-center">
                    <h4 class="font-medium text-sm line-clamp-2 group-hover:text-primary transition-colors" title="{{ item.title }}">
                        {{ item.title }}
                    </h4>
                    {% if item.year %}
                    <p class="text-xs text-base-content/60 mt-1">
                        {{ item.year }}
                        {% if item.edition and item.type == 'movie' %}
                            <span class="text-primary font-medium"> • {{ item.edition }}</span>
                        {% endif %}
                    </p>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if media_content.pages > 1 %}
        <div class="flex justify-center mt-8">
            <div class="join">
                {% if media_content.has_prev %}
                    <a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), tab='media', page=media_content.page-1, sort_by=request.args.get('sort_by', 'title_asc'), search=request.args.get('search', ''), per_page=request.args.get('per_page', 24)) }}" 
                       class="join-item btn btn-sm">
                        <i class="fa-solid fa-chevron-left"></i>
                    </a>
                {% endif %}
                
                {% set start_page = [1, media_content.page - 2] | max %}
                {% set end_page = [media_content.pages, media_content.page + 2] | min %}
                
                {% if start_page > 1 %}
                    <a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), tab='media', page=1, sort_by=request.args.get('sort_by', 'title_asc'), search=request.args.get('search', ''), per_page=request.args.get('per_page', 24)) }}" 
                       class="join-item btn btn-sm">1</a>
                    {% if start_page > 2 %}
                        <button class="join-item btn btn-sm btn-disabled">...</button>
                    {% endif %}
                {% endif %}
                
                {% for page_num in range(start_page, end_page + 1) %}
                    {% if page_num == media_content.page %}
                        <button class="join-item btn btn-sm btn-active">{{ page_num }}</button>
                    {% else %}
                        <a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), tab='media', page=page_num, sort_by=request.args.get('sort_by', 'title_asc'), search=request.args.get('search', ''), per_page=request.args.get('per_page', 24)) }}" 
                           class="join-item btn btn-sm">{{ page_num }}</a>
                    {% endif %}
                {% endfor %}
                
                {% if end_page < media_content.pages %}
                    {% if end_page < media_content.pages - 1 %}
                        <button class="join-item btn btn-sm btn-disabled">...</button>
                    {% endif %}
                    <a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), tab='media', page=media_content.pages, sort_by=request.args.get('sort_by', 'title_asc'), search=request.args.get('search', ''), per_page=request.args.get('per_page', 24)) }}" 
                       class="join-item btn btn-sm">{{ media_content.pages }}</a>
                {% endif %}
                
                {% if media_content.has_next %}
                    <a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), tab='media', page=media_content.page+1, sort_by=request.args.get('sort_by', 'title_asc'), search=request.args.get('search', ''), per_page=request.args.get('per_page', 24)) }}" 
                       class="join-item btn btn-sm">
                        <i class="fa-solid fa-chevron-right"></i>
                    </a>
                {% endif %}
            </div>
        </div>
        {% endif %}

    {% elif media_content and media_content.error %}
        <!-- Error State -->
        <div class="bg-error/10 border border-error/20 rounded-lg p-8 text-center">
            <div class="flex flex-col items-center space-y-4">
                <div class="w-16 h-16 rounded-full bg-error/20 flex items-center justify-center">
                    <i class="fa-solid fa-exclamation-triangle text-2xl text-error"></i>
                </div>
                <div>
                    <h3 class="text-lg font-medium text-error mb-2">Error Loading Media</h3>
                    <p class="text-base-content/60">{{ media_content.error }}</p>
                    <p class="text-sm text-base-content/40 mt-2">Please check your server connection and try again.</p>
                </div>
                <a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), tab='media') }}" 
                   class="btn btn-error btn-sm">
                    <i class="fa-solid fa-refresh mr-2"></i>Retry
                </a>
            </div>
        </div>

    {% else %}
        <!-- Empty State -->
        <div class="bg-base-200/50 rounded-lg p-12 text-center border border-base-300">
            <div class="flex flex-col items-center space-y-4">
                <div class="w-16 h-16 rounded-full bg-base-300/50 flex items-center justify-center">
                    {% if media_content and media_content.get('needs_sync') %}
                        <i class="fa-solid fa-database text-2xl text-base-content/40"></i>
                    {% else %}
                        <i class="fa-solid fa-folder-open text-2xl text-base-content/40"></i>
                    {% endif %}
                </div>
                <div>
                    {% if media_content and media_content.get('needs_sync') %}
                        <h3 class="text-lg font-medium text-base-content mb-2">No Cached Data</h3>
                        <p class="text-base-content/60">This library has no cached content in the database.</p>
                        <p class="text-sm text-base-content/40 mt-2">Click "Sync Library" above to populate the cache with fresh content from your media server.</p>
                    {% else %}
                        <h3 class="text-lg font-medium text-base-content mb-2">No Media Found</h3>
                        <p class="text-base-content/60">This library appears to be empty or the content could not be loaded.</p>
                        <p class="text-sm text-base-content/40 mt-2">Content may still be scanning or there might be a connection issue.</p>
                    {% endif %}
                </div>
                {% if media_content and media_content.get('needs_sync') %}
                    <button onclick="document.getElementById('sync-library-btn').click()" 
                            class="btn btn-primary btn-sm">
                        <i class="fa-solid fa-sync mr-2"></i>Sync Library
                    </button>
                {% else %}
                    <a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), tab='media') }}" 
                       class="btn btn-primary btn-sm">
                        <i class="fa-solid fa-refresh mr-2"></i>Refresh
                    </a>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<style>
/* Custom styles for text clamping */
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('library-search');
    const itemsPerPageSelect = document.getElementById('items-per-page');
    const sortBySelect = document.getElementById('sort-by');
    const clearSearchBtn = document.getElementById('clear-search');
    const syncLibraryBtn = document.getElementById('sync-library-btn');
    const purgeLibraryBtn = document.getElementById('purge-library-btn');
    
    let searchTimeout;
    
    // Function to update URL and reload page with new parameters
    function updateLibraryView() {
        const currentUrl = new URL(window.location);
        const searchValue = searchInput.value.trim();
        const itemsPerPage = itemsPerPageSelect.value;
        const sortBy = sortBySelect.value;
        
        // Update URL parameters
        if (searchValue) {
            currentUrl.searchParams.set('search', searchValue);
        } else {
            currentUrl.searchParams.delete('search');
        }
        
        currentUrl.searchParams.set('per_page', itemsPerPage);
        currentUrl.searchParams.set('sort_by', sortBy);
        currentUrl.searchParams.set('page', '1'); // Reset to first page
        
        // Navigate to updated URL
        window.location.href = currentUrl.toString();
    }
    
    // Search input handler with debounce
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(updateLibraryView, 500); // 500ms debounce
        });
        
        // Handle Enter key
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(searchTimeout);
                updateLibraryView();
            }
        });
    }
    
    // Items per page change handler
    if (itemsPerPageSelect) {
        itemsPerPageSelect.addEventListener('change', updateLibraryView);
    }
    
    // Sort by change handler
    if (sortBySelect) {
        sortBySelect.addEventListener('change', updateLibraryView);
    }
    
    // Clear search button handler
    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', function() {
            searchInput.value = '';
            updateLibraryView();
        });
    }
    
    // Sync library button handler
    if (syncLibraryBtn) {
        syncLibraryBtn.addEventListener('click', function() {
            const libraryId = this.getAttribute('data-library-id');
            const btnText = this.querySelector('.sync-btn-text');
            const btnIcon = this.querySelector('i');
            
            // Update button state
            this.disabled = true;
            btnText.textContent = 'Syncing...';
            btnIcon.classList.add('fa-spin');
            
            // Make sync request using HTMX to handle modal responses properly
            htmx.ajax('POST', `/api/libraries/${libraryId}/sync`, {
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
                }
            }).then(() => {
                // Success - HTMX will handle the response (modal or toast)
                btnText.textContent = 'Sync Complete!';
                btnIcon.classList.remove('fa-spin');
                btnIcon.classList.remove('fa-sync');
                btnIcon.classList.add('fa-check');
                
                // Reset button after delay
                setTimeout(() => {
                    this.disabled = false;
                    btnText.textContent = 'Sync Library';
                    btnIcon.classList.remove('fa-check');
                    btnIcon.classList.add('fa-sync');
                }, 2000);
            }).catch((error) => {
                console.error('Sync request failed:', error);
                btnText.textContent = 'Sync Failed';
                btnIcon.classList.remove('fa-spin');
                btnIcon.classList.remove('fa-sync');
                btnIcon.classList.add('fa-exclamation-triangle');
                
                // Reset button after delay
                setTimeout(() => {
                    this.disabled = false;
                    btnText.textContent = 'Sync Library';
                    btnIcon.classList.remove('fa-exclamation-triangle');
                    btnIcon.classList.add('fa-sync');
                }, 3000);
            });
        });
    }
    
    // Purge library button handler
    if (purgeLibraryBtn) {
        purgeLibraryBtn.addEventListener('click', function() {
            const libraryId = this.getAttribute('data-library-id');
            const btnText = this.querySelector('.purge-btn-text');
            const btnIcon = this.querySelector('i');
            
            // Show confirmation dialog
            if (!confirm('Are you sure you want to purge all cached items for this library from the database? This will delete all stored media items and they will need to be re-synced.')) {
                return;
            }
            
            // Update button state
            this.disabled = true;
            btnText.textContent = 'Purging...';
            btnIcon.classList.add('fa-spin');
            btnIcon.classList.remove('fa-trash');
            btnIcon.classList.add('fa-spinner');
            
            // Make purge request
            fetch(`/api/libraries/${libraryId}/purge`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    btnText.textContent = 'Purged!';
                    btnIcon.classList.remove('fa-spin');
                    btnIcon.classList.remove('fa-spinner');
                    btnIcon.classList.add('fa-check');
                    
                    // Show success message
                    console.log(`Purged ${data.deleted_count || 0} items from library`);
                    
                    // Reload page after short delay to show updated content
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    btnText.textContent = 'Purge Failed';
                    btnIcon.classList.remove('fa-spin');
                    btnIcon.classList.remove('fa-spinner');
                    btnIcon.classList.add('fa-exclamation-triangle');
                    console.error('Purge failed:', data.error);
                    
                    // Reset button after delay
                    setTimeout(() => {
                        this.disabled = false;
                        btnText.textContent = 'Purge DB';
                        btnIcon.classList.remove('fa-exclamation-triangle');
                        btnIcon.classList.add('fa-trash');
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Purge request failed:', error);
                btnText.textContent = 'Purge Failed';
                btnIcon.classList.remove('fa-spin');
                btnIcon.classList.remove('fa-spinner');
                btnIcon.classList.add('fa-exclamation-triangle');
                
                // Reset button after delay
                setTimeout(() => {
                    this.disabled = false;
                    btnText.textContent = 'Purge DB';
                    btnIcon.classList.remove('fa-exclamation-triangle');
                    btnIcon.classList.add('fa-trash');
                }, 3000);
            });
        });
    }
});
</script>