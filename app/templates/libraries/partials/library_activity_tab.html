<!-- File: app/templates/libraries/partials/library_activity_tab.html -->
<div class="space-y-6">
    <!-- Activity Filters -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <h3 class="text-lg font-semibold flex items-center">
            <i class="fa-solid fa-history text-info mr-2"></i>
            Recent Activity
        </h3>
        
        <!-- Date Filter -->
        <div class="dropdown dropdown-end">
            <div tabindex="0" role="button" class="btn btn-sm btn-outline">
                <i class="fa-solid fa-calendar mr-2"></i>
                {% if days_filter == '7' %}Last 7 Days
                {% elif days_filter == '30' %}Last 30 Days
                {% elif days_filter == '90' %}Last 90 Days
                {% else %}Last 30 Days{% endif %}
                <i class="fa-solid fa-chevron-down ml-2"></i>
            </div>
            <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow border border-base-300">
                <li><a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=library.name, tab='activity', days=7) }}" 
                       class="{% if days_filter == '7' %}active{% endif %}">Last 7 Days</a></li>
                <li><a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=library.name, tab='activity', days=30) }}" 
                       class="{% if days_filter == '30' %}active{% endif %}">Last 30 Days</a></li>
                <li><a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=library.name, tab='activity', days=90) }}" 
                       class="{% if days_filter == '90' %}active{% endif %}">Last 90 Days</a></li>
            </ul>
        </div>
    </div>

    <!-- Activity List -->
    {% if recent_activity and recent_activity.items %}
        <div class="bg-base-200/50 rounded-lg border border-base-300 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr class="bg-base-300/50">
                            <th class="font-semibold">Content</th>
                            <th class="font-semibold">User</th>
                            <th class="font-semibold">Started</th>
                            <th class="font-semibold">Duration</th>
                            <th class="font-semibold">Platform</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for activity in recent_activity.items %}
                        <tr class="hover">
                            <td>
                                <div class="flex items-center gap-3">
                                    <!-- Poster Image -->
                                    <div class="w-12 h-16 flex-shrink-0">
                                        {% if activity.is_episode and activity.linked_show_item and activity.linked_media_item %}
                                            {# Episode: Link to episode detail page #}
                                            <a href="{{ url_for('libraries.episode_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=activity.linked_show_item.id, tv_show_slug=generate_url_slug(activity.grandparent_title), episode_slug=generate_url_slug(activity.media_title)) }}" class="block w-full h-full hover:opacity-80 transition-opacity">
                                        {% elif activity.linked_media_item %}
                                            {# Movie/Other: Link to media detail page #}
                                            <a href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=activity.linked_media_item.id, slug=generate_url_slug(activity.linked_media_item.title)) }}" class="block w-full h-full hover:opacity-80 transition-opacity">
                                        {% endif %}
                                        
                                        {% if activity.thumb_path %}
                                            <img src="{{ activity.thumb_path }}" 
                                                 alt="{{ activity.media_title or 'Unknown' }}" 
                                                 class="w-full h-full object-cover rounded border border-base-300 shadow-sm"
                                                 loading="lazy"
                                                 onerror="this.src='/static/img/favicon.ico'; this.classList.add('opacity-50');">
                                        {% elif activity.grandparent_thumb_path %}
                                            <img src="{{ activity.grandparent_thumb_path }}" 
                                                 alt="{{ activity.grandparent_title or 'Unknown' }}" 
                                                 class="w-full h-full object-cover rounded border border-base-300 shadow-sm"
                                                 loading="lazy"
                                                 onerror="this.src='/static/img/favicon.ico'; this.classList.add('opacity-50');">
                                        {% elif activity.parent_thumb_path %}
                                            <img src="{{ activity.parent_thumb_path }}" 
                                                 alt="{{ activity.parent_title or 'Unknown' }}" 
                                                 class="w-full h-full object-cover rounded border border-base-300 shadow-sm"
                                                 loading="lazy"
                                                 onerror="this.src='/static/img/favicon.ico'; this.classList.add('opacity-50');">
                                        {% else %}
                                            <div class="w-full h-full bg-base-300/50 rounded border border-base-300 flex items-center justify-center">
                                                <i class="fa-solid fa-image text-base-content/40 text-lg"></i>
                                            </div>
                                        {% endif %}
                                        
                                        {% if (activity.is_episode and activity.linked_show_item and activity.linked_media_item) or activity.linked_media_item %}
                                            </a>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Content Info -->
                                    <div class="flex flex-col min-w-0 flex-1">
                                        {% if activity.is_episode and activity.linked_show_item and activity.linked_media_item %}
                                            {# Episode: Link to episode detail page #}
                                            <a href="{{ url_for('libraries.episode_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=activity.linked_show_item.id, tv_show_slug=generate_url_slug(activity.grandparent_title), episode_slug=generate_url_slug(activity.media_title)) }}" class="font-medium truncate hover:text-primary transition-colors">
                                                {{ activity.media_title or 'Unknown' }}
                                            </a>
                                        {% elif activity.linked_media_item %}
                                            {# Movie/Other: Link to media detail page #}
                                            <a href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=activity.linked_media_item.id, slug=generate_url_slug(activity.linked_media_item.title)) }}" class="font-medium truncate hover:text-primary transition-colors">
                                                {{ activity.media_title or 'Unknown' }}
                                            </a>
                                        {% else %}
                                            <span class="font-medium truncate">{{ activity.media_title or 'Unknown' }}</span>
                                        {% endif %}
                                        
                                        {% if activity.grandparent_title or activity.parent_title %}
                                            <div class="text-sm text-base-content/60 truncate">
                                                {% if activity.grandparent_title %}
                                                    {% if activity.linked_show_item %}
                                                        <a href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=activity.linked_show_item.id, slug=generate_url_slug(activity.grandparent_title)) }}" class="hover:text-primary transition-colors">
                                                            {{ activity.grandparent_title }}
                                                        </a>
                                                    {% else %}
                                                        {{ activity.grandparent_title }}
                                                    {% endif %}
                                                {% endif %}
                                                {% if activity.grandparent_title and activity.parent_title %} • {% endif %}
                                                {% if activity.parent_title %}{{ activity.parent_title }}{% endif %}
                                            </div>
                                        {% endif %}
                                        {% if activity.media_type %}
                                            <span class="inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-400/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-400 ring-1 ring-inset ring-blue-600/20 dark:ring-blue-500/20 gap-1 w-fit mt-1">
                                                <i class="fa-solid fa-tag w-2.5 h-2.5"></i>
                                                {{ activity.media_type }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="flex items-center gap-3">
                                    <!-- User Avatar -->
                                    <div class="w-8 h-8 flex-shrink-0">
                                        {% if activity.user_avatar_url %}
                                            <img src="{{ activity.user_avatar_url }}" 
                                                 alt="{{ activity.user_display_name }} avatar" 
                                                 class="w-full h-full object-cover rounded-full border border-base-300"
                                                 loading="lazy"
                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                            <!-- Fallback colored avatar with user initial -->
                                            <div class="w-full h-full rounded-full border border-base-300 flex items-center justify-center text-white text-xs font-medium" style="display: none;
                                                {% if activity.user_type == 'service' and server.service_type.value == 'plex' %}background-color: var(--color-plex, #e5a00d);
                                                {% elif activity.user_type == 'service' and server.service_type.value == 'jellyfin' %}background-color: var(--color-jellyfin, #00a4dc);
                                                {% elif activity.user_type == 'service' and server.service_type.value == 'emby' %}background-color: var(--color-emby, #52b54b);
                                                {% elif activity.user_type == 'service' and server.service_type.value == 'kavita' %}background-color: var(--color-kavita, #f39c12);
                                                {% elif activity.user_type == 'service' and server.service_type.value == 'audiobookshelf' %}background-color: var(--color-audiobookshelf, #8b5cf6);
                                                {% elif activity.user_type == 'service' and server.service_type.value == 'komga' %}background-color: var(--color-komga, #3b82f6);
                                                {% elif activity.user_type == 'service' and server.service_type.value == 'romm' %}background-color: var(--color-romm, #ef4444);
                                                {% elif activity.user_type == 'local' %}background-color: var(--color-primary, #3b82f6);
                                                {% else %}background-color: #6b7280;{% endif %}">
                                                {{ activity.user_display_name[0]|upper if activity.user_display_name else 'U' }}
                                            </div>
                                        {% else %}
                                            <!-- No avatar available, show colored initials -->
                                            <div class="w-full h-full rounded-full border border-base-300 flex items-center justify-center text-white text-xs font-medium" style="
                                                {% if activity.user_type == 'service' and server.service_type.value == 'plex' %}background-color: var(--color-plex, #e5a00d);
                                                {% elif activity.user_type == 'service' and server.service_type.value == 'jellyfin' %}background-color: var(--color-jellyfin, #00a4dc);
                                                {% elif activity.user_type == 'service' and server.service_type.value == 'emby' %}background-color: var(--color-emby, #52b54b);
                                                {% elif activity.user_type == 'service' and server.service_type.value == 'kavita' %}background-color: var(--color-kavita, #f39c12);
                                                {% elif activity.user_type == 'service' and server.service_type.value == 'audiobookshelf' %}background-color: var(--color-audiobookshelf, #8b5cf6);
                                                {% elif activity.user_type == 'service' and server.service_type.value == 'komga' %}background-color: var(--color-komga, #3b82f6);
                                                {% elif activity.user_type == 'service' and server.service_type.value == 'romm' %}background-color: var(--color-romm, #ef4444);
                                                {% elif activity.user_type == 'local' %}background-color: var(--color-primary, #3b82f6);
                                                {% else %}background-color: #6b7280;{% endif %}">
                                                {{ activity.user_display_name[0]|upper if activity.user_display_name else 'U' }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- User Name -->
                                    <span class="font-medium truncate">{{ activity.user_display_name }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="flex flex-col">
                                    <span class="font-medium">{{ activity.started_at.strftime('%m/%d/%Y') }}</span>
                                    <span class="text-sm text-base-content/60">{{ activity.started_at.strftime('%I:%M %p') }}</span>
                                </div>
                            </td>
                            <td>
                                {% if activity.duration_seconds %}
                                    <span class="font-medium">{{ activity.get_duration_formatted() }}</span>
                                {% elif activity.view_offset_at_end_seconds %}
                                    <span class="font-medium text-warning">{{ (activity.view_offset_at_end_seconds // 60) }}m (partial)</span>
                                {% else %}
                                    <span class="text-base-content/40">Unknown</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="flex flex-col">
                                    {% if activity.platform %}
                                        <span class="font-medium">{{ activity.platform }}</span>
                                    {% endif %}
                                    {% if activity.player %}
                                        <span class="text-sm text-base-content/60">{{ activity.player }}</span>
                                    {% endif %}
                                    {% if not activity.platform and not activity.player %}
                                        <span class="text-base-content/40">Unknown</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        {% if recent_activity.pages > 1 %}
            <div class="flex justify-center">
                <div class="join">
                    {% if recent_activity.has_prev %}
                        <a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=library.name, tab='activity', days=days_filter, page=recent_activity.prev_num) }}" 
                           class="join-item btn btn-sm">«</a>
                    {% endif %}
                    
                    {% for page_num in recent_activity.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != recent_activity.page %}
                                <a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=library.name, tab='activity', days=days_filter, page=page_num) }}" 
                                   class="join-item btn btn-sm">{{ page_num }}</a>
                            {% else %}
                                <button class="join-item btn btn-sm btn-active">{{ page_num }}</button>
                            {% endif %}
                        {% else %}
                            <button class="join-item btn btn-sm btn-disabled">…</button>
                        {% endif %}
                    {% endfor %}
                    
                    {% if recent_activity.has_next %}
                        <a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=library.name, tab='activity', days=days_filter, page=recent_activity.next_num) }}" 
                           class="join-item btn btn-sm">»</a>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <!-- Activity Summary -->
        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/50">
            <div class="flex flex-wrap items-center justify-center gap-6 text-sm">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-play text-primary"></i>
                    <span><strong>{{ recent_activity.total }}</strong> total streams</span>
                </div>
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-calendar text-secondary"></i>
                    <span>in the last <strong>{{ days_filter }}</strong> days</span>
                </div>
                {% if recent_activity.total > 0 %}
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-chart-line text-accent"></i>
                        <span><strong>{{ (recent_activity.total / (days_filter|int)) | round(1) }}</strong> streams/day average</span>
                    </div>
                {% endif %}
            </div>
        </div>
    {% else %}
        <!-- No Activity State -->
        <div class="bg-base-200/50 rounded-lg p-12 text-center border border-base-300">
            <div class="flex flex-col items-center space-y-4">
                <div class="w-16 h-16 rounded-full bg-base-300/50 flex items-center justify-center">
                    <i class="fa-solid fa-history text-2xl text-base-content/40"></i>
                </div>
                <div>
                    <h3 class="text-lg font-medium text-base-content mb-2">No Recent Activity</h3>
                    <p class="text-base-content/60">No streaming activity found for this library in the last {{ days_filter }} days.</p>
                </div>
            </div>
        </div>
    {% endif %}
</div>