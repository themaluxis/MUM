<!-- Episodes Grid Template - Similar to library_media_grid.html but for TV show episodes -->
<div class="space-y-6">
    <!-- Episodes Grid Header -->
    <div class="flex flex-col gap-4">
        <!-- Title and Stats Row -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <h3 class="text-lg font-semibold flex items-center">
                <i class="fa-solid fa-list text-primary mr-2"></i>
                Episodes
                {% if episodes_content and episodes_content.total %}
                    <span class="text-sm text-base-content/60 ml-2">({{ episodes_content.total }} episodes)</span>
                {% endif %}
            </h3>
            
            <!-- Results Info -->
            <div class="text-sm text-base-content/60">
                {% if episodes_content and episodes_content.total %}
                    Showing {{ ((episodes_content.page - 1) * episodes_content.per_page) + 1 }}-{{ 
                        [episodes_content.page * episodes_content.per_page, episodes_content.total] | min 
                    }} of {{ episodes_content.total }}
                {% endif %}
            </div>
        </div>
        
        <!-- Search and Controls Row -->
        <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
            <!-- Search Box -->
            <div class="flex-1 max-w-md">
                <div class="relative">
                    <input type="text" 
                           id="episodes-search" 
                           placeholder="Search episodes..." 
                           class="input input-bordered w-full pl-10 pr-4"
                           value="{{ request.args.get('search', '') }}">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-search text-base-content/40"></i>
                    </div>
                    {% if request.args.get('search') %}
                    <button type="button" 
                            id="clear-episodes-search"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-base-content/60 hover:text-base-content">
                        <i class="fa-solid fa-times"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
            
            <!-- Sort By Dropdown -->
            <div class="flex items-center gap-2">
                <label for="episodes-sort-by" class="text-sm text-base-content/60 whitespace-nowrap">Sort by:</label>
                <select id="episodes-sort-by" class="select select-bordered select-sm w-64">
                    <option value="title_asc" {{ 'selected' if request.args.get('sort_by', 'title_asc') == 'title_asc' else '' }}>Title (A to Z)</option>
                    <option value="title_desc" {{ 'selected' if request.args.get('sort_by') == 'title_desc' else '' }}>Title (Z to A)</option>
                    <option value="year_desc" {{ 'selected' if request.args.get('sort_by') == 'year_desc' else '' }}>Year (Newest First)</option>
                    <option value="year_asc" {{ 'selected' if request.args.get('sort_by') == 'year_asc' else '' }}>Year (Oldest First)</option>
                    <option value="added_at_desc" {{ 'selected' if request.args.get('sort_by') == 'added_at_desc' else '' }}>Date Added (Newest First)</option>
                    <option value="added_at_asc" {{ 'selected' if request.args.get('sort_by') == 'added_at_asc' else '' }}>Date Added (Oldest First)</option>
                    <option value="rating_desc" {{ 'selected' if request.args.get('sort_by') == 'rating_desc' else '' }}>Rating (Highest First)</option>
                    <option value="rating_asc" {{ 'selected' if request.args.get('sort_by') == 'rating_asc' else '' }}>Rating (Lowest First)</option>
                    <option value="total_streams_desc" {{ 'selected' if request.args.get('sort_by') == 'total_streams_desc' else '' }}>Total Streams (Most Popular)</option>
                    <option value="total_streams_asc" {{ 'selected' if request.args.get('sort_by') == 'total_streams_asc' else '' }}>Total Streams (Least Popular)</option>
                </select>
            </div>
            
            <!-- Items Per Page Dropdown -->
            <div class="flex items-center gap-2">
                <label for="episodes-per-page" class="text-sm text-base-content/60 whitespace-nowrap">Items per page:</label>
                <select id="episodes-per-page" class="select select-bordered select-sm w-20">
                    <option value="12" {{ 'selected' if episodes_content.per_page == 12 else '' }}>12</option>
                    <option value="24" {{ 'selected' if episodes_content.per_page == 24 else '' }}>24</option>
                    <option value="48" {{ 'selected' if episodes_content.per_page == 48 else '' }}>48</option>
                    <option value="96" {{ 'selected' if episodes_content.per_page == 96 else '' }}>96</option>
                </select>
            </div>
        </div>
    </div>

    {% if episodes_content and episodes_content.get('items') %}
        <!-- Episodes Grid -->
        
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4">
            {% for episode in episodes_content.get('items', []) %}
            <a href="{{ url_for('libraries.episode_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=media_item.id, tv_show_slug=generate_url_slug(media_details.title), episode_slug=generate_url_slug(episode.title)) }}" class="group cursor-pointer block">
                <!-- Episode Poster Container -->
                <div class="relative aspect-[2/3] bg-base-200 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 group-hover:scale-105">
                    {% if episode.thumb %}
                        <img src="{{ episode.thumb }}" 
                             alt="{{ episode.title }}" 
                             class="w-full h-full object-cover"
                             loading="lazy"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <!-- Fallback when image fails to load -->
                        <div class="absolute inset-0 bg-base-300 flex items-center justify-center text-base-content/40" style="display: none;">
                            <i class="fa-solid fa-tv text-4xl"></i>
                        </div>
                    {% else %}
                        <!-- No image placeholder -->
                        <div class="absolute inset-0 bg-base-300 flex items-center justify-center text-base-content/40">
                            <i class="fa-solid fa-tv text-4xl"></i>
                        </div>
                    {% endif %}
                    
                    <!-- Hover Overlay -->
                    <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                        <div class="text-center text-white p-2">
                            <i class="fa-solid fa-play text-2xl mb-2"></i>
                            <div class="text-xs">View Episode</div>
                        </div>
                    </div>
                    
                    <!-- Rating Badge (if available) -->
                    {% if episode.rating %}
                    <div class="absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded-full">
                        <i class="fa-solid fa-star text-yellow-400 mr-1"></i>
                        {{ "%.1f"|format(episode.rating) }}
                    </div>
                    {% endif %}
                    
                    <!-- Episode Type Badge -->
                    <div class="absolute top-2 left-2 bg-primary/80 text-white text-xs px-2 py-1 rounded-full capitalize">
                        Episode
                    </div>
                    
                    <!-- Total Streams Badge (bottom-left) -->
                    {% if episode.stream_count is defined and episode.stream_count > 0 %}
                    <div class="absolute bottom-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded-full flex items-center">
                        <i class="fa-solid fa-eye mr-1"></i>
                        {{ episode.stream_count }}
                    </div>
                    {% endif %}
                </div>
                
                <!-- Episode Title and Details -->
                <div class="mt-2 text-center">
                    <h4 class="font-medium text-sm line-clamp-2 group-hover:text-primary transition-colors" title="{{ episode.title }}">
                        {{ episode.title }}
                    </h4>
                    {% if episode.season_number and episode.episode_number %}
                    <p class="text-xs text-base-content/60 mt-1">
                        S{{ "%02d"|format(episode.season_number) }}E{{ "%02d"|format(episode.episode_number) }}
                        {% if episode.year %}
                            â€¢ {{ episode.year }}
                        {% endif %}
                    </p>
                    {% elif episode.year %}
                    <p class="text-xs text-base-content/60 mt-1">
                        {{ episode.year }}
                    </p>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if episodes_content.pages > 1 %}
        <div class="flex justify-center mt-8">
            <div class="join">
                {% if episodes_content.has_prev %}
                    <a href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=media_item.id, slug=generate_url_slug(media_details.title), tab='episodes', page=episodes_content.page-1, sort_by=request.args.get('sort_by', 'title_asc'), search=request.args.get('search', ''), per_page=request.args.get('per_page', 24)) }}" 
                       class="join-item btn btn-sm">
                        <i class="fa-solid fa-chevron-left"></i>
                    </a>
                {% endif %}
                
                {% set start_page = [1, episodes_content.page - 2] | max %}
                {% set end_page = [episodes_content.pages, episodes_content.page + 2] | min %}
                
                {% if start_page > 1 %}
                    <a href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=media_item.id, slug=generate_url_slug(media_details.title), tab='episodes', page=1, sort_by=request.args.get('sort_by', 'title_asc'), search=request.args.get('search', ''), per_page=request.args.get('per_page', 24)) }}" 
                       class="join-item btn btn-sm">1</a>
                    {% if start_page > 2 %}
                        <button class="join-item btn btn-sm btn-disabled">...</button>
                    {% endif %}
                {% endif %}
                
                {% for page_num in range(start_page, end_page + 1) %}
                    {% if page_num == episodes_content.page %}
                        <button class="join-item btn btn-sm btn-active">{{ page_num }}</button>
                    {% else %}
                        <a href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=media_item.id, slug=generate_url_slug(media_details.title), tab='episodes', page=page_num, sort_by=request.args.get('sort_by', 'title_asc'), search=request.args.get('search', ''), per_page=request.args.get('per_page', 24)) }}" 
                           class="join-item btn btn-sm">{{ page_num }}</a>
                    {% endif %}
                {% endfor %}
                
                {% if end_page < episodes_content.pages %}
                    {% if end_page < episodes_content.pages - 1 %}
                        <button class="join-item btn btn-sm btn-disabled">...</button>
                    {% endif %}
                    <a href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=media_item.id, slug=generate_url_slug(media_details.title), tab='episodes', page=episodes_content.pages, sort_by=request.args.get('sort_by', 'title_asc'), search=request.args.get('search', ''), per_page=request.args.get('per_page', 24)) }}" 
                       class="join-item btn btn-sm">{{ episodes_content.pages }}</a>
                {% endif %}
                
                {% if episodes_content.has_next %}
                    <a href="{{ url_for('libraries.media_detail', server_nickname=server.server_nickname, library_name=encode_url_component(library.name), media_id=media_item.id, slug=generate_url_slug(media_details.title), tab='episodes', page=episodes_content.page+1, sort_by=request.args.get('sort_by', 'title_asc'), search=request.args.get('search', ''), per_page=request.args.get('per_page', 24)) }}" 
                       class="join-item btn btn-sm">
                        <i class="fa-solid fa-chevron-right"></i>
                    </a>
                {% endif %}
            </div>
        </div>
        {% endif %}

    {% elif episodes_content and episodes_content.get('error') %}
        <!-- Error State -->
        <div class="bg-base-200/50 rounded-lg p-12 text-center border border-base-300">
            <div class="w-16 h-16 rounded-full bg-base-300 flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-exclamation-triangle text-2xl text-error"></i>
            </div>
            <h3 class="text-lg font-medium text-base-content mb-2">Error Loading Episodes</h3>
            <p class="text-sm text-base-content/60 max-w-md mx-auto">
                {{ episodes_content.error }}
            </p>
        </div>

    {% else %}
        <!-- No Episodes -->
        <div class="bg-base-200/50 rounded-lg p-12 text-center border border-base-300">
            <div class="w-16 h-16 rounded-full bg-base-300 flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-list text-2xl text-base-content/40"></i>
            </div>
            <h3 class="text-lg font-medium text-base-content mb-2">No Episodes Found</h3>
            <p class="text-sm text-base-content/60 max-w-md mx-auto">
                No episodes are available for this show, or episodes data could not be loaded.
            </p>
        </div>
    {% endif %}
</div>

<style>
/* Custom styles for text clamping */
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('episodes-search');
    const itemsPerPageSelect = document.getElementById('episodes-per-page');
    const sortBySelect = document.getElementById('episodes-sort-by');
    const clearSearchBtn = document.getElementById('clear-episodes-search');
    
    let searchTimeout;
    
    // Function to update URL and reload page with new parameters
    function updateEpisodesView() {
        const currentUrl = new URL(window.location);
        const searchValue = searchInput.value.trim();
        const itemsPerPage = itemsPerPageSelect.value;
        const sortBy = sortBySelect.value;
        
        // Update URL parameters
        if (searchValue) {
            currentUrl.searchParams.set('search', searchValue);
        } else {
            currentUrl.searchParams.delete('search');
        }
        
        currentUrl.searchParams.set('per_page', itemsPerPage);
        currentUrl.searchParams.set('sort_by', sortBy);
        currentUrl.searchParams.set('page', '1'); // Reset to first page
        
        // Navigate to updated URL
        window.location.href = currentUrl.toString();
    }
    
    // Search input handler with debounce
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(updateEpisodesView, 500); // 500ms debounce
        });
        
        // Handle Enter key
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(searchTimeout);
                updateEpisodesView();
            }
        });
    }
    
    // Items per page change handler
    if (itemsPerPageSelect) {
        itemsPerPageSelect.addEventListener('change', updateEpisodesView);
    }
    
    // Sort by change handler
    if (sortBySelect) {
        sortBySelect.addEventListener('change', updateEpisodesView);
    }
    
    // Clear search button handler
    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', function() {
            searchInput.value = '';
            updateEpisodesView();
        });
    }
});
</script>