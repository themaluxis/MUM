{% extends "layouts/setup.html" %}

{% block title %}Configure {{ plugin.name }} Servers - {{ g.app_name }}{% endblock %}

{% block setup_content %}
<div class="card bg-base-200 shadow-xl max-w-6xl mx-auto">
    <div class="card-body">
        <!-- Navigation -->
        <div class="flex items-center mb-8">
            <a href="{{ url_for('setup.plugins') }}" class="btn btn-ghost btn-sm">
                <i class="fa-solid fa-arrow-left mr-2"></i> Back to Services
            </a>
        </div>

        <!-- Clean Header -->
        <div class="mb-4">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid fa-puzzle-piece text-primary text-xl"></i>
                </div>
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-1">
                        <h1 class="text-2xl font-bold text-base-content">{{ plugin.name }}</h1>
                        <span class="inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-400/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-400 ring-1 ring-inset ring-blue-600/20 dark:ring-blue-500/20 gap-1">
                            <i class="fa-solid fa-cog"></i>
                            Setup
                        </span>
                    </div>
                    <p class="text-base-content/70 text-sm">Configure servers for {{ plugin.name }} media management</p>
                </div>
            </div>
        </div>

        <!-- Plugin Status Card -->
        <div class="bg-info/10 border border-info/20 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
                <div class="w-6 h-6 rounded-full bg-info/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                    <i class="fa-solid fa-info text-info text-xs"></i>
                </div>
                <div>
                    <h4 class="font-medium text-info mb-1">Server Configuration</h4>
                    <p class="text-sm text-base-content/80">
                        Add and configure {{ plugin.name }} servers to enable media access and user management. You can add multiple servers if needed.
                    </p>
                </div>
            </div>
        </div>

        <!-- Servers Section -->
        <div class="space-y-6">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div>
                    <h2 class="text-xl font-semibold text-base-content mb-1">Configured Servers</h2>
                    <p class="text-sm text-base-content/70">{{ servers|length }} server{{ 's' if servers|length != 1 else '' }} configured</p>
                </div>
                <div class="flex gap-3">
                    <a href="{{ url_for('media_servers_setup.add_server_setup', plugin_id=plugin.plugin_id) }}" class="btn btn-primary h-12 gap-2">
                        <i class="fa-solid fa-plus"></i>
                        Add Server
                    </a>
                </div>
            </div>

            {% if servers %}
            <div class="grid gap-6 md:grid-cols-2">
                {% for server in servers %}
                <div class="bg-base-100 border border-base-300 rounded-lg p-6 hover:border-base-300/60 transition-colors">
                    <!-- Server Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-server text-primary text-lg"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-base-content">{{ server.server_nickname }}</h3>
                                <span class="text-xs text-base-content/60">{{ server.server_name or server.service_type.value.title() }}</span>
                            </div>
                        </div>
                        {% if server.is_active %}
                            <span class="inline-flex items-center rounded-md bg-green-50 dark:bg-green-400/10 px-2 py-1 text-xs font-medium text-green-700 dark:text-green-400 ring-1 ring-inset ring-green-600/20 dark:ring-green-500/20 gap-1">
                                <i class="fa-solid fa-check-circle"></i>
                                Active
                            </span>
                        {% else %}
                            <span class="inline-flex items-center rounded-md bg-red-50 dark:bg-red-400/10 px-2 py-1 text-xs font-medium text-red-700 dark:text-red-400 ring-1 ring-inset ring-red-600/20 dark:ring-red-500/20 gap-1">
                                <i class="fa-solid fa-times-circle"></i>
                                Inactive
                            </span>
                        {% endif %}
                    </div>

                    <!-- Server Details -->
                    <div class="space-y-3 mb-4">
                        <!-- URL -->
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-link text-base-content/60 text-sm w-4"></i>
                            <span class="text-sm text-base-content/80 truncate">{{ server.url }}</span>
                        </div>
                        
                        <!-- Last Sync -->
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-clock text-base-content/60 text-sm w-4"></i>
                            <span class="text-sm text-base-content/80">
                                {% if server.last_sync_at %}
                                    Last sync: {{ server.last_sync_at.strftime('%Y-%m-%d %H:%M') }}
                                {% else %}
                                    Never synced
                                {% endif %}
                            </span>
                        </div>
                        
                        <!-- Status -->
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-circle-info text-base-content/60 text-sm w-4"></i>
                            <span class="text-sm text-base-content/80">Ready for setup</span>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-center justify-between pt-4 border-t border-base-300">
                        <div class="flex items-center gap-2">
                            <!-- Edit Button -->
                            <a href="{{ url_for('media_servers_setup.setup_edit_server', plugin_id=plugin.plugin_id, server_id=server.id) }}" 
                               class="btn btn-ghost btn-xs" title="Edit Server">
                                <i class="fa-solid fa-pen-to-square"></i>
                                <span class="hidden sm:inline">Edit</span>
                            </a>
                            
                            <!-- Delete Button -->
                            <button onclick="deleteServer({{ server.id }}, '{{ server.server_nickname }}')" 
                                    class="btn btn-ghost btn-xs text-error hover:bg-error/10" title="Delete Server">
                                <i class="fa-solid fa-trash"></i>
                                <span class="hidden sm:inline">Delete</span>
                            </button>
                        </div>
                        
                        <!-- Test Connection Button -->
                        <button onclick="testConnection({{ server.id }})" class="btn btn-outline btn-xs gap-1" title="Test Connection">
                            <i class="fa-solid fa-wifi"></i>
                            <span class="hidden sm:inline">Test</span>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Empty State -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-12">
                <div class="text-center">
                    <div class="w-16 h-16 rounded-full bg-base-200/50 flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-server text-base-content/40 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-base-content mb-2">No Servers Configured</h3>
                    <p class="text-sm text-base-content/70 mb-6">
                        Add your first {{ plugin.name }} server to start managing media and users.
                    </p>
                    <a href="{{ url_for('media_servers_setup.add_server_setup', plugin_id=plugin.plugin_id) }}" class="btn btn-primary gap-2">
                        <i class="fa-solid fa-plus"></i>
                        Add First Server
                    </a>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between items-center mt-8 pt-6 border-t border-base-300">
            <a href="{{ url_for('setup.plugins') }}" class="btn btn-ghost h-12">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Services
            </a>
            <a href="{{ url_for('setup.app_config') }}" class="btn btn-primary h-12">
                Continue
                <i class="fas fa-arrow-right ml-2"></i>
            </a>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Delete Server</h3>
        <p class="py-4">Are you sure you want to delete the server "<span id="serverName"></span>"? This action cannot be undone.</p>
        <div class="modal-action">
            <form id="deleteForm" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="return_to" value="setup_plugin_config"/>
                <input type="hidden" name="plugin_id" value="{{ plugin.plugin_id }}"/>
                <button type="submit" class="btn btn-error">Delete</button>
                <button type="button" class="btn" onclick="closeDeleteModal()">Cancel</button>
            </form>
        </div>
    </div>
</div>

<script>
function testConnection(serverId) {
    // Find the button and show loading state
    const button = document.querySelector(`[onclick*="testConnection(${serverId})"]`);
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Testing...';
    button.disabled = true;
    
    fetch(`{{ url_for('plugin_management.test_existing_server_connection', plugin_id=plugin.plugin_id, server_id=999) }}`.replace('999', serverId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (typeof htmx !== 'undefined') {
                htmx.trigger('body', 'showToastEvent', { message: 'Connection test successful!', category: 'success' });
            }
            button.innerHTML = '<i class="fa-solid fa-check mr-1"></i>Success';
            button.className = 'btn btn-success btn-xs gap-1';
        } else {
            if (typeof htmx !== 'undefined') {
                htmx.trigger('body', 'showToastEvent', { message: `Connection test failed: ${data.message}`, category: 'error' });
            }
            button.innerHTML = '<i class="fa-solid fa-times mr-1"></i>Failed';
            button.className = 'btn btn-error btn-xs gap-1';
        }
    })
    .catch(error => {
        if (typeof htmx !== 'undefined') {
            htmx.trigger('body', 'showToastEvent', { message: 'Error testing connection', category: 'error' });
        }
        button.innerHTML = '<i class="fa-solid fa-times mr-1"></i>Error';
        button.className = 'btn btn-error btn-xs gap-1';
    })
    .finally(() => {
        button.disabled = false;
        
        // Reset button after 3 seconds
        setTimeout(() => {
            button.innerHTML = '<i class="fa-solid fa-wifi"></i><span class="hidden sm:inline">Test</span>';
            button.className = 'btn btn-outline btn-xs gap-1';
        }, 3000);
    });
}

function deleteServer(serverId, serverName) {
    document.getElementById('serverName').textContent = serverName;
    document.getElementById('deleteForm').action = `/setup/plugins/{{ plugin.plugin_id }}/servers/${serverId}/delete`;
    document.getElementById('deleteModal').classList.add('modal-open');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('modal-open');
}
</script>
{% endblock %}
