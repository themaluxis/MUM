<!-- File: app/templates/libraries/partials/library_stats_chart.html -->
<!-- Library Streaming History Chart -->
<div class="card bg-base-200 shadow-xl">
    <div class="card-body">
        <div class="flex justify-between items-center mb-4">
            <h2 class="card-title text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                {{ library.name }} - Watch Time Activity
            </h2>
            
            <!-- Date Range Selector -->
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-sm btn-outline">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    {% if selected_days == 7 %}Last 7 Days
                    {% elif selected_days == 30 %}Last 30 Days  
                    {% elif selected_days == 90 %}Last 90 Days
                    {% elif selected_days == 365 %}Last Year
                    {% elif selected_days == -1 %}All Time
                    {% else %}Last 30 Days{% endif %}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow">
                    <li><a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=library.name, tab='stats', days=7) }}" class="{% if selected_days == 7 %}active{% endif %}">Last 7 Days</a></li>
                    <li><a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=library.name, tab='stats', days=30) }}" class="{% if selected_days == 30 %}active{% endif %}">Last 30 Days</a></li>
                    <li><a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=library.name, tab='stats', days=90) }}" class="{% if selected_days == 90 %}active{% endif %}">Last 90 Days</a></li>
                    <li><a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=library.name, tab='stats', days=365) }}" class="{% if selected_days == 365 %}active{% endif %}">Last Year</a></li>
                    <li><a href="{{ url_for('libraries.library_detail', server_nickname=server.server_nickname, library_name=library.name, tab='stats', days='all') }}" class="{% if selected_days == -1 %}active{% endif %}">All Time</a></li>
                </ul>
            </div>
        </div>
        
        {% if chart_data %}
            <!-- Chart Container -->
            <div class="relative">
                <canvas id="libraryStatsChart" width="400" height="200"></canvas>
            </div>
            
            <!-- Legend -->
            <div class="flex flex-wrap gap-2 mt-4 justify-center">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded bg-primary"></div>
                    <span class="text-sm">Total Plays</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded bg-secondary"></div>
                    <span class="text-sm">Watch Time (minutes)</span>
                </div>
            </div>
            
            <!-- Summary Stats -->
            <div class="stats stats-horizontal shadow mt-4 w-full bg-base-100">
                <div class="stat">
                    <div class="stat-title">Total Streams</div>
                    <div class="stat-value text-primary">{{ chart_data.total_streams }}</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Total Watch Time</div>
                    <div class="stat-value text-secondary">{{ chart_data.total_duration }}</div>
                </div>
            </div>
        {% else %}
            <!-- No Data State -->
            <div class="text-center py-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-base-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m-9 0h10m-10 0a2 2 0 00-2 2v14a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2M9 12l2 2 4-4" />
                </svg>
                <p class="text-base-content/60">No streaming activity for this library in the selected time period</p>
                <p class="text-sm text-base-content/40 mt-2">Start watching content from this library to see activity here</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- User Statistics Section -->
{% if user_stats and user_stats|length > 0 %}
<div class="card bg-base-200 shadow-xl mt-6">
    <div class="card-body">
        <h2 class="card-title text-lg mb-4">
            <i class="fa-solid fa-users text-primary mr-2"></i>
            User Statistics
            <span class="text-sm text-base-content/60 ml-2">({{ user_stats|length }} users)</span>
        </h2>
        
        <!-- User Cards Grid -->
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4">
            {% for user in user_stats %}
            <div class="bg-base-100 rounded-lg p-4 border border-base-300 hover:bg-base-100/70 transition-colors text-center">
                <div class="flex flex-col items-center mb-3">
                    <a href="{{ url_for('admin_user.view_service_user', server_nickname=user.server_nickname, server_username=user.username, tab='history') }}" 
                       class="avatar mb-2 hover:scale-105 transition-transform">
                        <div class="mask mask-circle w-12 h-12">
                            {% if user.avatar_url %}
                                <img src="{{ user.avatar_url }}" 
                                     alt="{{ user.display_name }}"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <!-- Fallback avatar -->
                                <div class="w-full h-full bg-primary flex items-center justify-center text-base-content font-semibold text-sm" style="display: none;">
                                    {{ user.display_name[0].upper() if user.display_name else 'U' }}
                                </div>
                            {% else %}
                                <!-- Default avatar with initials -->
                                <div class="w-full h-full bg-primary flex items-center justify-center text-base-content font-semibold text-sm">
                                    {{ user.display_name[0].upper() if user.display_name else 'U' }}
                                </div>
                            {% endif %}
                        </div>
                    </a>
                    <div class="w-full">
                        <a href="{{ url_for('admin_user.view_service_user', server_nickname=user.server_nickname, server_username=user.username, tab='history') }}" 
                           class="font-semibold text-sm truncate hover:text-primary transition-colors block" 
                           title="{{ user.display_name }}">{{ user.display_name }}</a>
                        {% if user.username and user.username != user.display_name %}
                            <a href="{{ url_for('admin_user.view_service_user', server_nickname=user.server_nickname, server_username=user.username, tab='history') }}" 
                               class="text-xs text-base-content/60 truncate hover:text-primary transition-colors block" 
                               title="@{{ user.username }}">@{{ user.username }}</a>
                        {% endif %}
                    </div>
                </div>
                
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-base-content/60">Plays:</span>
                        <div class="flex items-center gap-1">
                            <i class="fa-solid fa-play text-primary text-xs"></i>
                            <span class="font-semibold text-sm">{{ user.play_count }}</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-base-content/60">Time:</span>
                        <div class="flex items-center gap-1">
                            <i class="fa-solid fa-clock text-secondary text-xs"></i>
                            <span class="font-semibold text-sm">{{ user.total_duration_formatted }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% if user_stats|length >= 10 %}
        <div class="text-center mt-4">
            <p class="text-sm text-base-content/60">Showing top {{ user_stats|length }} users by play count</p>
        </div>
        {% endif %}
    </div>
</div>
{% elif chart_data %}
<!-- No user activity message (only show if we have chart data but no user stats) -->
<div class="card bg-base-100 shadow-xl mt-6">
    <div class="card-body">
        <h2 class="card-title text-lg mb-4">
            <i class="fa-solid fa-users text-primary mr-2"></i>
            User Statistics
        </h2>
        <div class="text-center py-8">
            <i class="fa-solid fa-users text-4xl text-base-content/20 mb-4"></i>
            <p class="text-base-content/60">No user activity found for this library in the selected time period</p>
            <p class="text-sm text-base-content/40 mt-2">User statistics will appear here once users start watching content from this library</p>
        </div>
    </div>
</div>
{% endif %}

{% if chart_data %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('libraryStatsChart').getContext('2d');
    
    // Chart data from backend
    const chartData = {{ chart_data.chart_data | tojson | safe }};
    
    // Prepare datasets for Chart.js
    const datasets = [];
    
    // Handle empty data case
    if (!chartData || chartData.length === 0) {
        const today = new Date();
        const emptyChartData = [];
        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            emptyChartData.push({
                date: date.toISOString().split('T')[0],
                label: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
            });
        }
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: emptyChartData.map(day => day.label),
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                scales: {
                    x: { display: true },
                    y: { display: true, beginAtZero: true }
                }
            }
        });
        return;
    }
    
    // Get DaisyUI colors from computed styles
    const tempDiv = document.createElement('div');
    tempDiv.className = 'bg-primary';
    document.body.appendChild(tempDiv);
    const primaryColor = getComputedStyle(tempDiv).backgroundColor;
    tempDiv.className = 'bg-secondary';
    const secondaryColor = getComputedStyle(tempDiv).backgroundColor;
    document.body.removeChild(tempDiv);
    
    // Convert RGB to RGBA for transparency
    const primaryColorWithAlpha = primaryColor.replace('rgb', 'rgba').replace(')', ', 0.8)');
    const secondaryColorWithAlpha = secondaryColor.replace('rgb', 'rgba').replace(')', ', 0.8)');
    
    // Create datasets for plays and time
    datasets.push({
        label: 'Total Plays',
        data: chartData.map(day => day.plays || 0),
        backgroundColor: primaryColorWithAlpha, // Primary color from DaisyUI
        borderColor: primaryColor,
        borderWidth: 1,
        borderRadius: 4,
        borderSkipped: false,
        yAxisID: 'y'
    });
    
    datasets.push({
        label: 'Watch Time (minutes)',
        data: chartData.map(day => day.time || 0),
        backgroundColor: secondaryColorWithAlpha, // Secondary color from DaisyUI
        borderColor: secondaryColor,
        borderWidth: 1,
        borderRadius: 4,
        borderSkipped: false,
        yAxisID: 'y1'
    });
    
    // Create the chart
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.map(day => day.label),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: false // We use custom legend below
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        labelColor: function(context) {
                            return {
                                borderColor: context.dataset.borderColor,
                                backgroundColor: context.dataset.borderColor
                            };
                        },
                        label: function(context) {
                            if (context.dataset.label === 'Total Plays') {
                                return `${context.dataset.label}: ${context.parsed.y}`;
                            } else {
                                const minutes = Math.round(context.parsed.y);
                                const hours = Math.floor(minutes / 60);
                                const remainingMinutes = minutes % 60;
                                
                                let timeStr;
                                if (hours > 0) {
                                    timeStr = `${hours}h ${remainingMinutes}m`;
                                } else {
                                    timeStr = `${minutes}m`;
                                }
                                
                                return `${context.dataset.label}: ${timeStr}`;
                            }
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: 'rgba(156, 163, 175, 0.8)',
                        font: {
                            size: 11
                        }
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(156, 163, 175, 0.1)',
                        drawBorder: false
                    },
                    ticks: {
                        color: 'rgba(156, 163, 175, 0.8)',
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            return Math.round(value);
                        }
                    },
                    title: {
                        display: true,
                        text: 'Total Plays',
                        color: 'rgba(156, 163, 175, 0.8)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    grid: {
                        drawOnChartArea: false,
                    },
                    ticks: {
                        color: 'rgba(156, 163, 175, 0.8)',
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            const hours = Math.floor(value / 60);
                            const minutes = value % 60;
                            
                            if (hours > 0) {
                                return `${hours}h ${minutes}m`;
                            } else {
                                return `${Math.round(value)}m`;
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Watch Time (minutes)',
                        color: 'rgba(156, 163, 175, 0.8)'
                    }
                }
            }
        }
    });
});
</script>
{% endif %}