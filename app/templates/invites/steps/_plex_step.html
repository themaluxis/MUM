<!-- Plex Authentication Step -->
<div class="step-section bg-base-200/30 border border-base-300 rounded-lg p-6" id="plex-step">
    <!-- Step Header -->
    <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 rounded-full bg-plex-500/20 flex items-center justify-center flex-shrink-0">
            <i class="fa-solid fa-right-to-bracket text-plex text-lg"></i>
        </div>
        <div>
            <h2 class="text-xl font-semibold text-base-content mb-1">Plex Authentication</h2>
            <p class="text-sm text-base-content/70">
                Sign in with your Plex account to access media servers
            </p>
        </div>
    </div>
    
    {% if already_authenticated_discord_user %}
        <div class="bg-[#5865F2]/10 border border-[#5865F2]/20 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
                <div class="w-6 h-6 rounded-full bg-[#5865F2]/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                    <i class="fa-brands fa-discord text-[#5865F2] text-xs"></i>
                </div>
                <div>
                    <h4 class="font-medium text-[#5865F2] mb-1">Discord Account Connected</h4>
                    <p class="text-sm text-base-content/80">
                        Linked as <strong class="text-base-content">{{ already_authenticated_discord_user.username }}</strong>
                    </p>
                </div>
            </div>
        </div>
    {% endif %}

    {% if plex_conflict_info %}
        <!-- Plex Account Conflict Resolution -->
        {% if plex_conflict_info.type == 'already_linked' %}
            <!-- Plex user is already linked to another local account -->
            <div class="bg-error/10 border border-error/20 rounded-lg p-4 mb-6">
                <div class="flex items-start gap-3">
                    <i class="fa-solid fa-exclamation-triangle text-error text-lg mt-0.5"></i>
                    <div>
                        <h4 class="font-medium text-error mb-2">Plex Account Already Linked</h4>
                        <p class="text-sm text-base-content/80 mb-3">
                            The Plex account <strong>{{ plex_conflict_info.plex_username }}</strong> is already linked to the local account 
                            <strong>{{ plex_conflict_info.linked_username }}</strong> on {{ plex_conflict_info.server_name }}.
                        </p>
                        <p class="text-sm text-base-content/80 mb-4">
                            Please sign in with a different Plex account to continue with this invite.
                        </p>
                        <form method="POST" action="{{ url_for('invites.process_invite_form', invite_path_or_token=invite_path_or_token) }}">
                            {{ form.hidden_tag() }}
                            <button name="action" value="use_different_plex" type="submit" 
                                    class="btn btn-primary">
                                <i class="fa-solid fa-user-plus mr-2"></i>
                                Sign In with Different Plex Account
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
        {% elif plex_conflict_info.type == 'can_link' %}
            <!-- Plex user exists but can be linked -->
            <div class="bg-warning/10 border border-warning/20 rounded-lg p-4 mb-6">
                <div class="flex items-start gap-3">
                    <i class="fa-solid fa-link text-warning text-lg mt-0.5"></i>
                    <div>
                        <h4 class="font-medium text-warning mb-2">Plex Account Already Exists</h4>
                        <p class="text-sm text-base-content/80 mb-3">
                            The Plex account <strong>{{ plex_conflict_info.plex_username }}</strong> already exists on {{ plex_conflict_info.server_name }}, 
                            but it's not linked to any local account.
                        </p>
                        <p class="text-sm text-base-content/80 mb-4">
                            Would you like to link this Plex account to your new local account, or sign in with a different Plex account?
                        </p>
                        <form method="POST" action="{{ url_for('invites.process_invite_form', invite_path_or_token=invite_path_or_token) }}">
                            {{ form.hidden_tag() }}
                            <div class="flex flex-col sm:flex-row gap-3">
                                <button name="action" value="link_plex_account" type="submit" 
                                        class="btn btn-primary flex-1">
                                    <i class="fa-solid fa-link mr-2"></i>
                                    Link This Plex Account
                                </button>
                                <button name="action" value="use_different_plex" type="submit" 
                                        class="btn btn-outline flex-1">
                                    <i class="fa-solid fa-user-plus mr-2"></i>
                                    Use Different Plex Account
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
        {% elif plex_conflict_info.type == 'already_exists_no_linking' %}
            <!-- Plex user exists but no local account feature -->
            <div class="bg-error/10 border border-error/20 rounded-lg p-4 mb-6">
                <div class="flex items-start gap-3">
                    <i class="fa-solid fa-exclamation-triangle text-error text-lg mt-0.5"></i>
                    <div>
                        <h4 class="font-medium text-error mb-2">Plex Account Already Exists</h4>
                        <p class="text-sm text-base-content/80 mb-3">
                            The Plex account <strong>{{ plex_conflict_info.plex_username }}</strong> already exists on {{ plex_conflict_info.server_name }}.
                        </p>
                        <p class="text-sm text-base-content/80 mb-4">
                            Please sign in with a different Plex account to continue with this invite.
                        </p>
                        <form method="POST" action="{{ url_for('invites.process_invite_form', invite_path_or_token=invite_path_or_token) }}">
                            {{ form.hidden_tag() }}
                            <button name="action" value="use_different_plex" type="submit" 
                                    class="btn btn-primary">
                                <i class="fa-solid fa-user-plus mr-2"></i>
                                Sign In with Different Plex Account
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        {% endif %}
        
    {% else %}
        <!-- Normal Plex authentication -->
        <form method="POST" action="{{ url_for('invites.process_invite_form', invite_path_or_token=invite_path_or_token) }}">
            {{ form.hidden_tag() }}
            <button name="auth_method" value="plex" type="submit" 
                    class="btn bg-plex hover:bg-plex-600 border-plex hover:border-plex-600 text-black w-full h-12 text-base font-medium">
                <i class="fa-solid fa-right-to-bracket mr-2"></i>
                Sign In with Plex
            </button>
        </form>
    {% endif %}
</div>