{% extends "base.html" %}
{% block title %}{{ super() }} - Manage Invites{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-2">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Manage Invites ({{ invites_count or 0 }})</h1>
        <div class="flex mt-4 sm:mt-0">
            {% if current_user.has_permission('create_invites') %}
            <button class="btn btn-primary mr-2" onclick="create_invite_modal.showModal()">
                <i class="fa-solid fa-plus mr-2"></i> Create Invite
            </button>
            {% endif %}
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-ghost" title="Change view">
                    <i class="fa-solid fa-display mr-1"></i> View <i class="fa-solid fa-chevron-down fa-xs ml-1"></i>
                </label>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-300 rounded-box w-40">
                    {% set cards_args = request.args.to_dict() %}{% do cards_args.update({'view': 'cards'}) %}
                    <li><a href="{{ url_for('invites.list_invites', **cards_args) }}"
                            class="{{ 'font-bold bg-base-100/50' if current_view == 'cards' else '' }}">
                            <i class="fa-solid fa-grip-vertical fa-fw mr-2"></i> Card View</a>
                    </li>
                    {% set table_args = request.args.to_dict() %}{% do table_args.update({'view': 'table'}) %}
                    <li><a href="{{ url_for('invites.list_invites', **table_args) }}"
                            class="{{ 'font-bold bg-base-100/50' if current_view == 'table' else '' }}">
                            <i class="fa-solid fa-table-list fa-fw mr-2"></i> Table View</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <form method="GET" action="{{ url_for('invites.list_invites') }}" class="mb-6 p-4 bg-base-200 rounded-lg shadow" id="inviteFilterForm">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end"> {# Increased grid cols for per_page #}
            <div class="form-control">
                <label class="label"><span class="label-text">Filter by Status</span></label>
                <select name="filter" class="select select-sm select-bordered">
                    <option value="all" {% if request.args.get('filter', 'all') == 'all' %}selected{% endif %}>All</option>
                    <option value="active" {% if request.args.get('filter') == 'active' %}selected{% endif %}>Active</option>
                    <option value="expired" {% if request.args.get('filter') == 'expired' %}selected{% endif %}>Expired</option>
                    <option value="maxed" {% if request.args.get('filter') == 'maxed' %}selected{% endif %}>Max Uses</option>
                    <option value="inactive" {% if request.args.get('filter') == 'inactive' %}selected{% endif %}>Deactivated</option>
                </select>
            </div>
            <div class="form-control">
                <label class="label"><span class="label-text">Search by Path</span></label>
                <input type="text" name="search_path" placeholder="Custom path part" class="input input-sm input-bordered" value="{{ request.args.get('search_path', '') }}">
            </div>
            <div class="form-control">
                <label class="label"><span class="label-text">Per Page</span></label>
                <select name="per_page" class="select select-sm select-bordered" onchange="this.form.submit()">
                    {% for count in [10, 25, 50, 100] %}
                        <option value="{{ count }}" {% if current_per_page == count %}selected{% endif %}>{{ count }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-control">
                <button type="submit" class="btn btn-sm btn-primary w-full"><i class="fa-solid fa-filter mr-2"></i> Apply</button>
            </div>
        </div>
    </form>

    <!-- Mass Actions Container (hidden by default) -->
    <div id="mass-actions-container" class="mb-4 p-4 bg-base-200 rounded-lg shadow hidden">
        <div class="flex items-center space-x-2">
            <button type="button" class="btn btn-error" id="delete-selected-button">
                <i class="fa-solid fa-trash mr-2"></i> Delete (<span id="selected-invites-count" class="contents">0</span> selected)
            </button>
            <button type="button" class="btn btn-warning" id="disable-selected-button">
                <i class="fa-solid fa-ban mr-2"></i> Disable Selected
            </button>
            <button type="button" class="btn btn-secondary" id="select_all_visible_button" title="Select all invites currently visible">Select All</button>
            <button type="button" class="btn btn-secondary" id="deselect_all_visible_button" title="Deselect All">Deselect All</button>
        </div>
    </div>

    {# --- MODIFIED: Main HTMX container for list content --- #}
    <div id="invites-list-container" 
         hx-get="{{ url_for('invites.list_invites', **request.args.to_dict()) }}" 
         hx-trigger="load, refreshInvitesList from:body"
         hx-swap="innerHTML">
        <div class="text-center p-8"><span class="loading loading-lg loading-spinner"></span><p>Loading invites...</p></div>
    </div>

<!-- Modals (Create Invite, Invite Usages) as before -->
<dialog id="create_invite_modal" class="modal modal-bottom sm:modal-middle">
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
    <div class="modal-box max-w-2xl"> 
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">‚úï</button>
        </form> 
        <h3 class="font-bold text-lg mb-4">
            <i class="fa-solid fa-ticket-simple mr-2"></i>Create New Invite
        </h3> 
        <form id="createInviteForm" method="POST"
              hx-post="{{ url_for('invites.create_invite') }}"
              hx-target="#create-invite-form-fields-wrapper"
              hx-swap="innerHTML"
              hx-on::after-request="
                if(event.detail.successful && event.detail.xhr.status !== 422) { 
                    htmx.trigger(document.body, 'refreshInvitesList'); 
                    const modal = document.getElementById('create_invite_modal'); 
                    if (modal && typeof modal.close === 'function') modal.close(); 
                    this.reset(); /* 'this' is the form, should be fine to reset */
                    const expiryDateEl = this.querySelector('#calculated_expiry_date');
                    if(expiryDateEl) expiryDateEl.textContent = 'N/A (if days > 0)';
                    if(typeof window.showToast === 'function') showToast('Invite created successfully!', 'success');
                } else if (event.detail.failed && event.detail.xhr.status === 422) { 
                    console.log('Create invite form validation failed, form content updated by HTMX.');
                    // Re-run JS for the newly swapped content IF the partial's script doesn't auto-run
                    // initializeModalFormJS(document.getElementById('createInviteForm')); // Or target the wrapper
                } else if (event.detail.failed) { 
                    if(typeof window.showToast === 'function') showToast('Error creating invite. Server error.', 'error');
                }
              "
              hx-indicator="#create_invite_loader_span">
            
            {# The content is now loaded from the partial #}
            {% include 'invites/partials/create_invite_modal.html' with context %} 
        </form>
    </div> 
</dialog>
<dialog id="edit_invite_modal" class="modal modal-bottom sm:modal-middle">
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
    <div class="modal-box max-w-2xl">
        <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" type="button" onclick="edit_invite_modal.close()">‚úï</button></form>
        <div id="edit_invite_modal_content_div">
            <div class="text-center p-8"><span class="loading loading-lg loading-spinner"></span><p>Loading invite details...</p></div>
        </div>
    </div>
</dialog>
<dialog id="invite_usages_modal" class="modal modal-bottom sm:modal-middle">
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
    <div class="modal-box max-w-3xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">‚úï</button>
        </form>
        <div id="invite_usages_modal_content_div">
            <div class="text-center p-8"><span class="loading loading-lg loading-spinner"></span></div>
        </div>
    </div>
</dialog>
{% endblock %}
{% block scripts %}
{{ super() }}
<style>
/* Show checkbox on hover or when checked */
.invite-card .invite-checkbox:checked + * {
    opacity: 1 !important;
}
.invite-card:has(.invite-checkbox:checked) .invite-checkbox {
    opacity: 1 !important;
}
/* Alternative for browsers that don't support :has() */
.invite-card.selected .invite-checkbox {
    opacity: 1 !important;
}
</style>
<script>
function copyToClipboard(text, message) { navigator.clipboard.writeText(text).then(() => showToast(message || 'Copied!', 'success'), () => showToast('Failed copy!', 'error')); }
document.addEventListener('DOMContentLoaded', function () {
    function initializeModalFormJS(formElement) {
        if (!formElement) return;
        const expiresInDaysInput = formElement.querySelector('#expires_in_days_input');
        const calculatedExpiryDateSpan = formElement.querySelector('#calculated_expiry_date');
        function updateCalculatedExpiry() {
            if (!expiresInDaysInput || !calculatedExpiryDateSpan) return;
            const days = parseInt(expiresInDaysInput.value);
            if (days && days > 0) { const expiryDate = new Date(new Date().setDate(new Date().getDate() + days)); calculatedExpiryDateSpan.textContent = expiryDate.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' }); } 
            else { calculatedExpiryDateSpan.textContent = 'Never (if 0 or empty)'; }
        }
        if (expiresInDaysInput) { expiresInDaysInput.addEventListener('input', updateCalculatedExpiry); updateCalculatedExpiry(); }
        const selAll = formElement.querySelector('#create_modal_select_all_libs_partial');
        const desAll = formElement.querySelector('#create_modal_deselect_all_libs_partial');
        const cbs = formElement.querySelectorAll('.create-modal-library-checkbox-partial');
        if(selAll) selAll.addEventListener('click', () => cbs.forEach(cb => cb.checked = true));
        if(desAll) desAll.addEventListener('click', () => cbs.forEach(cb => cb.checked = false));
    }
    initializeModalFormJS(document.getElementById('createInviteForm'));
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'createInviteForm') initializeModalFormJS(event.detail.target);
    });
    const cimEl = document.getElementById('create_invite_modal');
    if (cimEl) { 
        cimEl.addEventListener('close', function() { 
            const f = document.getElementById('createInviteForm'); 
            if (f) { 
                f.reset(); 
                const e = f.querySelector('#calculated_expiry_date'); 
                if(e) e.textContent = 'N/A'; 
                f.querySelectorAll('.text-error').forEach(el => el.remove()); 
                f.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
            }
        });
        
        // Add click outside to close functionality
        cimEl.addEventListener('click', function(e) {
            if (e.target === cimEl) {
                cimEl.close();
            }
        });
    }
    
    // Initialize invite selection functionality
    console.log('üöÄ Initializing invite selection on DOMContentLoaded');
    initializeInviteSelection();
});

// Global function to update mass actions visibility and count
function updateMassActions() {
    console.log('üîç updateMassActions() called');
    
    const massActionsContainer = document.getElementById('mass-actions-container');
    const selectedCountSpan = document.getElementById('selected-invites-count');
    const selectedCheckboxes = document.querySelectorAll('.invite-checkbox:checked');
    const allCheckboxes = document.querySelectorAll('.invite-checkbox');
    const selectedCount = selectedCheckboxes.length;
    
    console.log('üìä Debug info:', {
        massActionsContainer: massActionsContainer ? 'Found' : 'NOT FOUND',
        selectedCountSpan: selectedCountSpan ? 'Found' : 'NOT FOUND',
        allCheckboxes: allCheckboxes.length,
        selectedCheckboxes: selectedCheckboxes.length,
        selectedCount: selectedCount
    });
    
    if (selectedCountSpan) {
        selectedCountSpan.textContent = selectedCount;
        console.log('‚úÖ Updated count span to:', selectedCount);
    } else {
        console.log('‚ùå selectedCountSpan not found');
    }
    
    if (massActionsContainer) {
        if (selectedCount > 0) {
            massActionsContainer.classList.remove('hidden');
            console.log('‚úÖ Showing mass actions container');
        } else {
            massActionsContainer.classList.add('hidden');
            console.log('üîí Hiding mass actions container');
        }
    } else {
        console.log('‚ùå massActionsContainer not found');
    }
}

function initializeInviteSelection() {
    console.log('üîß initializeInviteSelection() called');
    
    const massActionsContainer = document.getElementById('mass-actions-container');
    const selectedCountSpan = document.getElementById('selected-invites-count');
    const deleteSelectedButton = document.getElementById('delete-selected-button');
    const disableSelectedButton = document.getElementById('disable-selected-button');
    const selectAllButton = document.getElementById('select_all_visible_button');
    const deselectAllButton = document.getElementById('deselect_all_visible_button');
    
    console.log('üîç Element check:', {
        massActionsContainer: massActionsContainer ? 'Found' : 'NOT FOUND',
        selectedCountSpan: selectedCountSpan ? 'Found' : 'NOT FOUND',
        deleteSelectedButton: deleteSelectedButton ? 'Found' : 'NOT FOUND',
        disableSelectedButton: disableSelectedButton ? 'Found' : 'NOT FOUND',
        selectAllButton: selectAllButton ? 'Found' : 'NOT FOUND',
        deselectAllButton: deselectAllButton ? 'Found' : 'NOT FOUND'
    });

    // Function to handle checkbox changes
    function handleCheckboxChange() {
        console.log('üîÑ handleCheckboxChange() called');
        updateMassActions();
    }

    // Select all visible invites
    if (selectAllButton) {
        selectAllButton.addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('.invite-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                // Add selected styling
                const card = checkbox.closest('.invite-card');
                if (card) {
                    card.classList.add('ring-2', 'ring-primary', 'bg-primary/10', 'selected');
                }
            });
            updateMassActions();
        });
    }

    // Deselect all invites
    if (deselectAllButton) {
        deselectAllButton.addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('.invite-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                // Remove selected styling
                const card = checkbox.closest('.invite-card');
                if (card) {
                    card.classList.remove('ring-2', 'ring-primary', 'bg-primary/10', 'selected');
                }
            });
            updateMassActions();
        });
    }

    // Delete selected invites
    if (deleteSelectedButton) {
        deleteSelectedButton.addEventListener('click', function() {
            const selectedCheckboxes = document.querySelectorAll('.invite-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            if (selectedIds.length === 0) return;

            if (confirm(`Are you sure you want to delete ${selectedIds.length} invite(s)? This action cannot be undone.`)) {
                // Create form data
                const formData = new FormData();
                selectedIds.forEach(id => formData.append('invite_ids', id));

                // Send delete request
                fetch('{{ url_for("invites.delete_multiple") }}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Refresh the invite list
                        htmx.trigger(document.body, 'refreshInvitesList');
                        updateMassActions();
                        if(typeof window.showToast === 'function') showToast(`Successfully deleted ${data.deleted_count} invite(s)`, 'success');
                    } else {
                        if(typeof window.showToast === 'function') showToast('Error deleting invites: ' + (data.message || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if(typeof window.showToast === 'function') showToast('Error deleting invites', 'error');
                });
            }
        });
    }

    // Disable selected invites
    if (disableSelectedButton) {
        disableSelectedButton.addEventListener('click', function() {
            const selectedCheckboxes = document.querySelectorAll('.invite-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            if (selectedIds.length === 0) return;

            if (confirm(`Are you sure you want to disable ${selectedIds.length} invite(s)?`)) {
                // Create form data
                const formData = new FormData();
                selectedIds.forEach(id => formData.append('invite_ids', id));

                // Send disable request
                fetch('{{ url_for("invites.disable_multiple") }}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Refresh the invite list
                        htmx.trigger(document.body, 'refreshInvitesList');
                        updateMassActions();
                        if(typeof window.showToast === 'function') showToast(`Successfully disabled ${data.disabled_count} invite(s)`, 'success');
                    } else {
                        if(typeof window.showToast === 'function') showToast('Error disabling invites: ' + (data.message || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if(typeof window.showToast === 'function') showToast('Error disabling invites', 'error');
                });
            }
        });
    }

    // Set up event delegation for dynamically loaded checkboxes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('invite-checkbox')) {
            console.log('üéØ Checkbox changed:', e.target.value, 'checked:', e.target.checked);
            handleCheckboxChange();
            
            // Add/remove visual selection styling
            const card = e.target.closest('.invite-card');
            if (card) {
                if (e.target.checked) {
                    card.classList.add('ring-2', 'ring-primary', 'bg-primary/10', 'selected');
                    console.log('‚úÖ Added selection styling to card');
                } else {
                    card.classList.remove('ring-2', 'ring-primary', 'bg-primary/10', 'selected');
                    console.log('üîí Removed selection styling from card');
                }
            }
        }
    });

    // Set up event delegation for card clicks (to toggle selection)
    document.addEventListener('click', function(e) {
        // Only handle clicks on the card itself or clickable area, not on buttons or other interactive elements
        if (e.target.classList.contains('invite-card') || e.target.closest('.invite-card-clickable')) {
            console.log('üñ±Ô∏è Card clicked:', e.target);
            const card = e.target.closest('.invite-card');
            if (card) {
                const checkbox = card.querySelector('.invite-checkbox');
                if (checkbox) {
                    console.log('üìã Toggling checkbox from', checkbox.checked, 'to', !checkbox.checked);
                    checkbox.checked = !checkbox.checked;
                    console.log('üî• Dispatching change event');
                    checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                    console.log('‚úÖ Change event dispatched');
                    
                    // Fallback: directly call the handler
                    console.log('üîß Calling updateMassActions directly as fallback');
                    updateMassActions();
                    
                    // Add/remove visual selection styling directly
                    const card = checkbox.closest('.invite-card');
                    if (card) {
                        if (checkbox.checked) {
                            card.classList.add('ring-2', 'ring-primary', 'bg-primary/10', 'selected');
                            console.log('‚úÖ Added selection styling to card (direct)');
                        } else {
                            card.classList.remove('ring-2', 'ring-primary', 'bg-primary/10', 'selected');
                            console.log('üîí Removed selection styling from card (direct)');
                        }
                    }
                } else {
                    console.log('‚ùå No checkbox found in card');
                }
            }
        }
    });

    // Initial update
    console.log('üé¨ Calling initial updateMassActions()');
    updateMassActions();
}

// Re-initialize when content is loaded via HTMX
document.body.addEventListener('htmx:afterSwap', function(evt) {
    console.log('üîÑ HTMX afterSwap event fired for:', evt.detail.target.id);
    if (evt.detail.target.id === 'invites-list-container') {
        console.log('‚úÖ HTMX content loaded for invites-list-container, re-initializing selection');
        
        // Check if checkboxes are now available
        const checkboxes = document.querySelectorAll('.invite-checkbox');
        console.log('üìã Found', checkboxes.length, 'checkboxes after HTMX load');
        
        updateMassActions();
    }
});
</script>
{% endblock %}