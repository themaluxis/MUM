{# File: app/templates/invites/_invites_cards.html #}
{# Expects invites (pagination) and available_libraries in context #}
{% if invites and invites.items %}
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
    {% for invite in invites.items %}
    <div class="invite-card card bg-base-200 shadow-lg hover:shadow-xl transition-shadow duration-200 ease-in-out relative group cursor-pointer" id="invite-row-{{ invite.id }}" data-invite-id="{{ invite.id }}">
        <!-- Selection Checkbox - only visible on hover or when checked -->
        <div class="absolute top-2 right-2 z-10 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
            <input type="checkbox" class="invite-checkbox checkbox checkbox-primary" value="{{ invite.id }}" onclick="event.stopPropagation();">
        </div>
        
        <div class="card-body p-4 invite-card-clickable">
            <div class="mb-3">
                {# The link is now a button that triggers the copy function #}
                <button class="font-semibold text-primary text-left link link-hover p-0"
                        title="Click to copy invite link"
                        onclick="copyToClipboard('{{ invite.get_full_url(g.app_base_url) }}', 'Invite link copied!')">
                    {{ invite.custom_path or invite.token[:12] }}
                </button>
                <a href="{{ invite.get_full_url(g.app_base_url) }}" target="_blank" class="btn btn-xs btn-ghost p-1" title="Open link in new tab">
                    <i class="fa-solid fa-external-link-alt fa-xs"></i>
                </a>
            </div>

            <div class="text-xs space-y-1 mb-3">
                <p><i class="fa-solid fa-calendar-plus fa-fw mr-1 text-info"></i> Created: {{ invite.created_at | format_datetime_user if invite.created_at else 'N/A' }}</p>
                <p><i class="fa-solid fa-clock fa-fw mr-1 {{ 'text-error' if invite.is_expired else 'text-success' }}"></i> Expires: {{ invite.expires_at | format_datetime_user if invite.expires_at else 'Never' }}</p>
                <p><i class="fa-solid fa-users-line fa-fw mr-1 text-info"></i> Uses: {{ invite.current_uses }} / {{ invite.max_uses or 'âˆž' }}</p>
                <p><i class="fa-solid fa-circle-question text-violet-600"></i> Status: 
                    <span id="invite-status-{{ invite.id }}">
                    {% if not invite.is_active %} 
                        <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-red-500/10 text-red-400 border border-red-500/20">
                            <i class="fa-solid fa-ban w-3 h-3"></i>
                            Deactivated
                        </span>
                    {% elif invite.is_expired %} 
                        <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-yellow-500/10 text-yellow-400 border border-yellow-500/20">
                            <i class="fa-solid fa-clock w-3 h-3"></i>
                            Expired
                        </span>
                    {% elif invite.has_reached_max_uses %} 
                        <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-orange-500/10 text-orange-400 border border-orange-500/20">
                            <i class="fa-solid fa-users-slash w-3 h-3"></i>
                            Max Uses
                        </span>
                    {% else %} 
                        <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-green-500/10 text-green-400 border border-green-500/20">
                            <i class="fa-solid fa-check-circle w-3 h-3"></i>
                            Active
                        </span>
                    {% endif %}
                    </span></p>
            </div>
            
            <div class="mb-3">
                <p class="text-xs font-semibold mb-1">Servers:</p>
                <div class="flex flex-wrap gap-1 mb-2">
                    {% if invite.servers %}
                        {% for server in invite.servers %}
                            {% if server.service_type.value == 'plex' %}
                                <span class="inline-flex items-center rounded-md bg-plex-50 dark:bg-plex-400/10 px-2 py-1 text-xs font-medium text-plex-700 dark:text-plex-400 ring-1 ring-inset ring-plex-600/20 dark:ring-plex-500/20 gap-1">
                                    <svg class="w-3 h-3" viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="transparent" stroke-linejoin="round" stroke-width="12"><path d="M22 25.5h48L116 94l-46 68.5H22L68.5 94Zm109.8 56L108 46l14-20.5h48zm-.3 23.5c10.979 17.625 25.52 38.875 38.5 49.5-11.149 13.635-34.323 32.278-62.5-14z"/></svg>
                                    {{ server.server_nickname }}
                                </span>
                            {% elif server.service_type.value == 'jellyfin' %}
                                <span class="inline-flex items-center rounded-md bg-jellyfin-50 dark:bg-jellyfin-400/10 px-2 py-1 text-xs font-medium text-jellyfin-700 dark:text-jellyfin-400 ring-1 ring-inset ring-jellyfin-600/20 dark:ring-jellyfin-500/20 gap-1">
                                    <i class="fa-solid fa-cube w-3 h-3"></i>
                                    {{ server.server_nickname }}
                                </span>
                            {% elif server.service_type.value == 'emby' %}
                                <span class="inline-flex items-center rounded-md bg-emby-50 dark:bg-emby-400/10 px-2 py-1 text-xs font-medium text-emby-700 dark:text-emby-400 ring-1 ring-inset ring-emby-600/20 dark:ring-emby-500/20 gap-1">
                                    <i class="fa-solid fa-play-circle w-3 h-3"></i>
                                    {{ server.server_nickname }}
                                </span>
                            {% elif server.service_type.value == 'audiobookshelf' %}
                                <span class="inline-flex items-center rounded-md bg-audiobookshelf-50 dark:bg-audiobookshelf-400/10 px-2 py-1 text-xs font-medium text-audiobookshelf-700 dark:text-audiobookshelf-400 ring-1 ring-inset ring-audiobookshelf-600/20 dark:ring-audiobookshelf-500/20 gap-1">
                                    <i class="fa-solid fa-headphones w-3 h-3"></i>
                                    {{ server.server_nickname }}
                                </span>
                            {% elif server.service_type.value == 'kavita' %}
                                <span class="inline-flex items-center rounded-md bg-kavita-50 dark:bg-kavita-400/10 px-2 py-1 text-xs font-medium text-kavita-700 dark:text-kavita-400 ring-1 ring-inset ring-kavita-600/20 dark:ring-kavita-500/20 gap-1">
                                    <i class="fa-solid fa-book w-3 h-3"></i>
                                    {{ server.server_nickname }}
                                </span>
                            {% elif server.service_type.value == 'komga' %}
                                <span class="inline-flex items-center rounded-md bg-komga-50 dark:bg-komga-400/10 px-2 py-1 text-xs font-medium text-komga-700 dark:text-komga-400 ring-1 ring-inset ring-komga-600/20 dark:ring-komga-500/20 gap-1">
                                    <i class="fa-solid fa-book-open w-3 h-3"></i>
                                    {{ server.server_nickname }}
                                </span>
                            {% elif server.service_type.value == 'romm' %}
                                <span class="inline-flex items-center rounded-md bg-romm-50 dark:bg-romm-400/10 px-2 py-1 text-xs font-medium text-romm-700 dark:text-romm-400 ring-1 ring-inset ring-romm-600/20 dark:ring-romm-500/20 gap-1">
                                    <i class="fa-solid fa-gamepad w-3 h-3"></i>
                                    {{ server.server_nickname }}
                                </span>
                            {% else %}
                                <span class="inline-flex items-center rounded-md bg-gray-50 dark:bg-gray-400/10 px-2 py-1 text-xs font-medium text-gray-700 dark:text-gray-400 ring-1 ring-inset ring-gray-600/20 dark:ring-gray-500/20 gap-1">
                                    <i class="fa-solid fa-server w-3 h-3"></i>
                                    {{ server.server_nickname }}
                                </span>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <span class="inline-flex items-center rounded-md bg-gray-50 dark:bg-gray-400/10 px-2 py-1 text-xs font-medium text-gray-700 dark:text-gray-400 ring-1 ring-inset ring-gray-600/20 dark:ring-gray-500/20 gap-1">
                            <i class="fa-solid fa-server-slash w-3 h-3"></i>
                            No servers attached
                        </span>
                    {% endif %}
                </div>
                
                <p class="text-xs font-semibold mb-1">Access:</p>
                <div class="flex flex-wrap gap-1">
                    {% set granted_ids = invite.grant_library_ids or [] %}
                    {% if granted_ids|length == 0 %}
                        <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-green-500/10 text-green-400 border border-green-500/20">
                            <i class="fa-solid fa-globe w-3 h-3"></i>
                            All Libraries
                        </span>
                    {% else %}
                        {# Show individual library badges with service colors #}
                        {% for lib_id in granted_ids %}
                            {% if all_libraries_lookup and lib_id in all_libraries_lookup %}
                                {% set lib_info = all_libraries_lookup[lib_id] %}
                                {% set lib_name = lib_info.name %}
                                {% set service_type = lib_info.service_type %}
                                {% set server_name = lib_info.server_name %}
                                
                                {% if service_type == 'plex' %}
                                    <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-plex-500/10 text-plex-400 border border-plex-500/20" title="{{ lib_name }} ({{ server_name }})">
                                        <svg class="w-3 h-3" viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="transparent"><path d="M22 25.5h48L116 94l-46 68.5H22L68.5 94Zm109.8 56L108 46l14-20.5h48zm-.3 23.5c10.979 17.625 25.52 38.875 38.5 49.5-11.149 13.635-34.323 32.278-62.5-14z"/></svg>
                                        {{ lib_name[:15] }}{% if lib_name|length > 15 %}...{% endif %}
                                    </span>
                                {% elif service_type == 'jellyfin' %}
                                    <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-jellyfin-500/10 text-jellyfin-400 border border-jellyfin-500/20" title="{{ lib_name }} ({{ server_name }})">
                                        <i class="fa-solid fa-cube w-3 h-3"></i>
                                        {{ lib_name[:15] }}{% if lib_name|length > 15 %}...{% endif %}
                                    </span>
                                {% elif service_type == 'emby' %}
                                    <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-emby-500/10 text-emby-400 border border-emby-500/20" title="{{ lib_name }} ({{ server_name }})">
                                        <i class="fa-solid fa-play-circle w-3 h-3"></i>
                                        {{ lib_name[:15] }}{% if lib_name|length > 15 %}...{% endif %}
                                    </span>
                                {% elif service_type == 'kavita' %}
                                    <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-kavita-500/10 text-kavita-400 border border-kavita-500/20" title="{{ lib_name }} ({{ server_name }})">
                                        <i class="fa-solid fa-book w-3 h-3"></i>
                                        {{ lib_name[:15] }}{% if lib_name|length > 15 %}...{% endif %}
                                    </span>
                                {% elif service_type == 'komga' %}
                                    <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-komga-500/10 text-komga-400 border border-komga-500/20" title="{{ lib_name }} ({{ server_name }})">
                                        <i class="fa-solid fa-book-open w-3 h-3"></i>
                                        {{ lib_name[:15] }}{% if lib_name|length > 15 %}...{% endif %}
                                    </span>
                                {% elif service_type == 'romm' %}
                                    <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-romm-500/10 text-romm-400 border border-romm-500/20" title="{{ lib_name }} ({{ server_name }})">
                                        <i class="fa-solid fa-gamepad w-3 h-3"></i>
                                        {{ lib_name[:15] }}{% if lib_name|length > 15 %}...{% endif %}
                                    </span>
                                {% elif service_type == 'audiobookshelf' %}
                                    <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-audiobookshelf-500/10 text-audiobookshelf-400 border border-audiobookshelf-500/20" title="{{ lib_name }} ({{ server_name }})">
                                        <i class="fa-solid fa-headphones w-3 h-3"></i>
                                        {{ lib_name[:15] }}{% if lib_name|length > 15 %}...{% endif %}
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-gray-500/10 text-gray-400 border border-gray-500/20" title="{{ lib_name }} ({{ server_name }})">
                                        <i class="fa-solid fa-folder w-3 h-3"></i>
                                        {{ lib_name[:15] }}{% if lib_name|length > 15 %}...{% endif %}
                                    </span>
                                {% endif %}
                            {% else %}
                                {# Fallback for libraries not found in lookup #}
                                <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-gray-500/10 text-gray-400 border border-gray-500/20" title="Library ID: {{ lib_id }}">
                                    <i class="fa-solid fa-folder w-3 h-3"></i>
                                    Library
                                </span>
                            {% endif %}
                        {% endfor %}
                        
                        {# If no library lookup data available, show count fallback #}
                        {% if not all_libraries_lookup %}
                            <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-blue-500/10 text-blue-400 border border-blue-500/20">
                                <i class="fa-solid fa-list w-3 h-3"></i>
                                {{ granted_ids|length }} Libraries
                            </span>
                        {% endif %}
                    {% endif %}
                    
                    {% if invite.allow_downloads %}
                        <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-purple-500/10 text-purple-400 border border-purple-500/20">
                            <i class="fa-solid fa-download w-3 h-3"></i>
                            Downloads
                        </span>
                    {% endif %}

                    {% if invite.invite_to_plex_home %}
                        <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-yellow-500/10 text-yellow-400 border border-yellow-500/20">
                            <i class="fa-solid fa-home w-3 h-3"></i>
                            Plex Home
                        </span>
                    {% endif %}

                    {% if invite.allow_live_tv %}
                        <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-cyan-500/10 text-cyan-400 border border-cyan-500/20">
                            <i class="fa-solid fa-tv w-3 h-3"></i>
                            Live TV
                        </span>
                    {% endif %}
                    
                    {% if invite.membership_duration_days %}
                        <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-orange-500/10 text-orange-400 border border-orange-500/20" title="Membership Duration">
                            <i class="fa-solid fa-clock w-3 h-3"></i>
                            {{ invite.membership_duration_days }}-day access
                        </span>
                    {% endif %}
                </div>
            </div>
            
            <div class="card-actions justify-end mt-auto pt-3 border-t border-base-300/90" onclick="event.stopPropagation();">
                {% if current_user.has_permission('edit_invites') %}
                <button class="btn btn-xs btn-ghost text-primary hover:bg-primary/10" title="Edit Invite"
                        hx-get="{{ url_for('invites.get_edit_invite_form', invite_id=invite.id) }}"
                        hx-target="#edit_invite_modal_content_div"
                        hx-swap="innerHTML"
                        onclick="edit_invite_modal.showModal()">
                    <i class="fa-solid fa-pen-to-square"></i>
                </button>
                {% endif %}
                <button class="btn btn-xs btn-ghost text-info hover:bg-info/10" title="View Usages" hx-get="{{ url_for('invites.view_invite_usages', invite_id=invite.id) }}" hx-target="#usage-modal-content" hx-swap="innerHTML" onclick="usage_modal.showModal(); document.getElementById('usage-modal-content').innerHTML = '<div class=text-center p-8><span class=loading loading-lg loading-spinner></span></div>';">
                    <i class="fa-solid fa-chart-line"></i>
                </button>
                {% if current_user.has_permission('edit_invites') %}
                {% if invite.is_active %}
                <button class="btn btn-xs btn-ghost text-warning hover:bg-warning/10" title="Disable Invite" 
                        hx-confirm="Are you sure you want to disable this invite? It will no longer be usable."
                        hx-post="{{ url_for('invites.toggle_invite_status', invite_id=invite.id) }}"
                        hx-target="#invite-status-{{ invite.id }}"
                        hx-swap="innerHTML"
                        hx-indicator="this">
                    <i class="fa-solid fa-ban htmx-indicator-hide"></i>
                    <span class="htmx-indicator loading loading-spinner loading-xs"></span>
                </button>
                {% else %}
                <button class="btn btn-xs btn-ghost text-success hover:bg-success/10" title="Enable Invite"
                        hx-confirm="Are you sure you want to enable this invite?"
                        hx-post="{{ url_for('invites.toggle_invite_status', invite_id=invite.id) }}"
                        hx-target="#invite-status-{{ invite.id }}"
                        hx-swap="innerHTML"
                        hx-indicator="this">
                    <i class="fa-solid fa-check htmx-indicator-hide"></i>
                    <span class="htmx-indicator loading loading-spinner loading-xs"></span>
                </button>
                {% endif %}
                {% endif %}
                {% if current_user.has_permission('delete_invites') %}
                <button class="btn btn-xs btn-ghost text-error hover:bg-error/10" title="Delete Invite" hx-confirm="Are you sure you want to delete this invite?" hx-delete="{{ url_for('invites.delete_invite', invite_id=invite.id) }}" hx-target="#invite-row-{{ invite.id }}" hx-swap="outerHTML" hx-indicator="this">
                    <i class="fa-solid fa-trash-can htmx-indicator-hide"></i>
                    <span class="htmx-indicator loading loading-spinner loading-xs"></span>
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
    <div class="text-center py-10 bg-base-200 rounded-lg shadow">
        <i class="fa-solid fa-ticket-slash fa-3x text-base-content/30 mb-4"></i>
        <p class="text-xl text-base-content/70">No invites found matching your criteria.</p>
        {% if request.args.get('filter', 'all') != 'all' or request.args.get('search_path') %}
            <a href="{{ url_for('invites.list_invites') }}" class="btn btn-sm btn-outline mt-4">Clear Filters</a>
        {% endif %}
    </div>
{% endif %}