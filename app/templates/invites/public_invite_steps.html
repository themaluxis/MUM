<!-- File: app/templates/invites/public_invite_steps.html -->
{% extends "base.html" %}

{% block title %}{{ super() }} - You're Invited!{% endblock %}

{% block content %} 
<div class="min-h-[calc(100vh-12rem)] bg-gradient-to-br from-base-100 to-base-200 flex items-center justify-center p-4">
    <div class="w-full max-w-4xl">
        {% if error %}
            <!-- Error State -->
            <div class="bg-base-100 border border-error/30 rounded-xl shadow-lg overflow-hidden">
                <div class="bg-error/10 border-b border-error/20 p-6 text-center">
                    <div class="w-16 h-16 rounded-full bg-error/20 flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-circle-xmark text-error text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-error mb-2">Invite Problem</h1>
                    <p class="text-base-content/70 text-sm">
                        There was an issue with your invite
                    </p>
                </div>
                <div class="p-6 text-center">
                    <p class="text-base-content mb-6">{{ error }}</p>
                    {% if g.setup_complete %}
                        <a href="{{ url_for('auth.app_login') }}" class="btn btn-outline btn-neutral">
                            <i class="fa-solid fa-user-shield mr-2"></i>
                            Admin Login
                        </a>
                    {% else %}
                        <a href="{{ url_for('setup.account_setup') }}" class="btn btn-outline btn-neutral">
                            <i class="fa-solid fa-cog mr-2"></i>
                            Go to Setup
                        </a>
                    {% endif %}
                </div>
            </div>
        {% elif invite %}
            <!-- Main Invite Flow -->
            <div class="bg-base-100 border border-base-300 rounded-xl shadow-lg overflow-hidden">
                <!-- Header Section -->
                <div class="bg-gradient-to-r from-primary/10 to-secondary/10 p-6 text-center border-b border-base-300">
                    <div class="w-16 h-16 rounded-full bg-primary/20 flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-envelope-open-text text-primary text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-base-content mb-2">You're Invited!</h1>
                    <p class="text-base-content/70 text-sm">
                        Join <strong class="text-primary">{{ server_name }}</strong> and start streaming
                    </p>
                </div>
                
                <!-- Content Section -->
                <div class="p-6 sm:p-8">

                    {# Build steps dynamically based on invite configuration #}
                    {% set invite_steps = [] %}
                    
                    {# Step 1: User Account Creation (if enabled) #}
                    {% if allow_user_accounts %}
                        {% set _ = invite_steps.append({
                            'id': 'user_account',
                            'name': 'Create Account',
                            'icon': 'fa-solid fa-user-plus',
                            'required': true,
                            'completed': user_account_created
                        }) %}
                    {% endif %}
                    
                    {# Step 2: Discord OAuth (if enabled) #}
                    {% if show_discord_button %}
                        {% set _ = invite_steps.append({
                            'id': 'discord',
                            'name': 'Discord Login',
                            'icon': 'fa-brands fa-discord',
                            'required': discord_sso_is_mandatory,
                            'completed': already_authenticated_discord_user is not none
                        }) %}
                    {% endif %}
                    
                    {# Step 3: Plex Login (only if there are Plex servers in the invite) #}
                    {% set has_plex_servers = invite.servers and invite.servers|selectattr('service_type.name', 'equalto', 'PLEX')|list|length > 0 %}
                    {% if has_plex_servers %}
                        {% set _ = invite_steps.append({
                            'id': 'plex',
                            'name': 'Plex Login',
                            'icon': 'fa-solid fa-right-to-bracket',
                            'required': true,
                            'completed': already_authenticated_plex_user is not none
                        }) %}
                    {% endif %}
                    
                    {# Step 3+: Server Access (for each server in multi-server invites) #}
                    {% if invite.servers %}
                        {% for server in invite.servers %}
                            {% set server_icon = 'fa-solid fa-server' %}
                            {% if server.service_type.name.upper() == 'PLEX' %}
                                {% set server_icon = 'fa-solid fa-play' %}
                            {% elif server.service_type.name.upper() == 'JELLYFIN' %}
                                {% set server_icon = 'fa-solid fa-film' %}
                            {% elif server.service_type.name.upper() == 'EMBY' %}
                                {% set server_icon = 'fa-solid fa-video' %}
                            {% endif %}
                            {# Check if this server has been completed #}
                            {% set server_completed = session.get('invite_' ~ invite.id ~ '_server_' ~ server.id ~ '_completed', false) %}
                            
                            {# For Plex servers, auto-complete when Plex login is done #}
                            {% if server.service_type.name.upper() == 'PLEX' and already_authenticated_plex_user %}
                                {% set server_completed = true %}
                            {% endif %}
                            
                            {# Only add non-Plex servers as separate steps #}
                            {% if server.service_type.name.upper() != 'PLEX' %}
                                {% set _ = invite_steps.append({
                                    'id': 'server_access_' ~ server.id,
                                    'name': server.name ~ ' Access',
                                    'icon': server_icon,
                                    'required': true,
                                    'completed': server_completed,
                                    'server_type': server.service_type.name.upper(),
                                    'server_name': server.name,
                                    'server_id': server.id
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        {# Fallback for legacy single server invites #}
                        {% set _ = invite_steps.append({
                            'id': 'server_access',
                            'name': 'Server Access',
                            'icon': 'fa-solid fa-server',
                            'required': true,
                            'completed': false
                        }) %}
                    {% endif %}

                    {# Display Steps #}
                    {% if invite_steps|length > 1 %}
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="font-medium text-base-content">Setup Progress</h2>
                                <span class="text-sm text-base-content/60">
                                    {{ invite_steps|selectattr('completed')|list|length }} of {{ invite_steps|length }} completed
                                </span>
                            </div>
                            <div class="flex items-center gap-2">
                                {% for step in invite_steps %}
                                    {% set is_current = not step.completed and (loop.index0 == 0 or invite_steps[loop.index0-1].completed) %}
                                    <div class="flex items-center flex-1">
                                        <div class="flex items-center gap-2 p-3 rounded-lg transition-colors
                                            {% if step.completed %}bg-primary/10 border border-primary/20
                                            {% elif is_current %}bg-warning/10 border border-warning/20
                                            {% else %}bg-base-200/50 border border-base-300{% endif %} flex-1">
                                            <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0
                                                {% if step.completed %}bg-primary text-primary-content
                                                {% elif is_current %}bg-warning text-warning-content
                                                {% else %}bg-base-300 text-base-content/60{% endif %}">
                                                {% if step.completed %}
                                                    <i class="fa-solid fa-check text-xs"></i>
                                                {% elif is_current %}
                                                    <i class="fa-solid fa-circle text-xs"></i>
                                                {% else %}
                                                    <i class="{{ step.icon }} text-xs"></i>
                                                {% endif %}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <span class="text-xs font-medium block truncate
                                                    {% if step.completed %}text-primary
                                                    {% elif is_current %}text-warning
                                                    {% else %}text-base-content/70{% endif %}">
                                                    {{ step.name }}
                                                </span>
                                                {% if not step.required %}
                                                    <span class="text-xs text-base-content/60">Optional</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% if not loop.last %}
                                            <div class="w-3 h-0.5 mx-1
                                                {% if step.completed %}bg-primary
                                                {% else %}bg-base-300{% endif %}"></div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    {# Current Step Content #}
                    <div class="step-content max-w-sm mx-auto">
                        {% if allow_user_accounts and not user_account_created %}
                            {# User Account Creation Step #}
                            <div class="step-section bg-base-200/30 border border-base-300 rounded-lg p-6" id="user-account-step">
                                <!-- Step Header -->
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0">
                                        <i class="fa-solid fa-user-plus text-primary text-lg"></i>
                                    </div>
                                    <div>
                                        <h2 class="text-xl font-semibold text-base-content mb-1">Create Your Account</h2>
                                        <p class="text-sm text-base-content/70">
                                            Set up your account to manage media access and preferences
                                        </p>
                                    </div>
                                </div>

                                <form method="POST" action="{{ url_for('invites.process_invite_form', invite_path_or_token=invite_path_or_token) }}">
                                    {{ form.hidden_tag() }}
                                    
                                    <div class="space-y-4">
                                        <div class="form-control">
                                            <label class="label">
                                                <span class="label-text font-medium text-sm">{{ account_form.username.label.text }}</span>
                                            </label>
                                            {{ account_form.username(class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100") }}
                                            {% if account_form.username.description %}
                                                <label class="label">
                                                    <span class="label-text-alt text-xs text-base-content/60">{{ account_form.username.description }}</span>
                                                </label>
                                            {% endif %}
                                        </div>

                                        <div class="form-control">
                                            <label class="label">
                                                <span class="label-text font-medium text-sm">{{ account_form.email.label.text }}</span>
                                            </label>
                                            {{ account_form.email(class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100") }}
                                            {% if account_form.email.description %}
                                                <label class="label">
                                                    <span class="label-text-alt text-xs text-base-content/60">{{ account_form.email.description }}</span>
                                                </label>
                                            {% endif %}
                                        </div>

                                        <div class="form-control">
                                            <label class="label">
                                                <span class="label-text font-medium text-sm">{{ account_form.password.label.text }}</span>
                                            </label>
                                            {{ account_form.password(class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100") }}
                                            {% if account_form.password.description %}
                                                <label class="label">
                                                    <span class="label-text-alt text-xs text-base-content/60">{{ account_form.password.description }}</span>
                                                </label>
                                            {% endif %}
                                        </div>

                                        <div class="form-control">
                                            <label class="label">
                                                <span class="label-text font-medium text-sm">{{ account_form.confirm_password.label.text }}</span>
                                            </label>
                                            {{ account_form.confirm_password(class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100") }}
                                            {% if account_form.confirm_password.description %}
                                                <label class="label">
                                                    <span class="label-text-alt text-xs text-base-content/60">{{ account_form.confirm_password.description }}</span>
                                                </label>
                                            {% endif %}
                                        </div>

                                        <div class="pt-4">
                                            <button name="action" value="create_user_account" type="submit" class="btn btn-primary w-full h-12 text-base font-medium">
                                                <i class="fa-solid fa-user-plus mr-2"></i>
                                                Create Account & Continue
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        {% elif show_discord_button and not already_authenticated_discord_user %}
                            {# Discord Step #}
                            <div class="step-section bg-base-200/30 border border-base-300 rounded-lg p-6" id="discord-step">
                                <!-- Step Header -->
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 rounded-full bg-[#5865F2]/20 flex items-center justify-center flex-shrink-0">
                                        <i class="fa-brands fa-discord text-[#5865F2] text-lg"></i>
                                    </div>
                                    <div>
                                        <h2 class="text-xl font-semibold text-base-content mb-1">Discord Authentication</h2>
                                        <p class="text-sm text-base-content/70">
                                            {% if discord_sso_is_mandatory %}
                                                Required to continue with your invite
                                            {% else %}
                                                Optional - Connect your Discord account
                                            {% endif %}
                                        </p>
                                        {% if not discord_sso_is_mandatory %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-base-300/50 text-base-content/70 mt-1">
                                                Optional
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                {% if setting_require_guild_membership %}
                                    <div class="bg-[#5865F2]/10 border border-[#5865F2]/20 rounded-lg p-4 mb-6">
                                        <div class="flex items-start gap-3">
                                            <div class="w-6 h-6 rounded-full bg-[#5865F2]/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                                <i class="fa-solid fa-info text-[#5865F2] text-xs"></i>
                                            </div>
                                            <div>
                                                <h4 class="font-medium text-[#5865F2] mb-1">Discord Server Required</h4>
                                                <p class="text-sm text-base-content/80 mb-3">
                                                    You must be a member of our Discord server to accept this invite.
                                                </p>
                                                {% if setting_discord_server_invite_url %}
                                                    <a href="{{ setting_discord_server_invite_url }}" target="_blank" rel="noopener noreferrer" 
                                                       class="btn bg-[#5865F2] hover:bg-[#4752C4] border-[#5865F2] hover:border-[#4752C4] text-white btn-sm">
                                                        <i class="fa-brands fa-discord mr-2"></i>
                                                        Join Discord Server First
                                                        <i class="fa-solid fa-external-link-alt ml-2"></i>
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}

                                <form method="POST" action="{{ url_for('invites.process_invite_form', invite_path_or_token=invite_path_or_token) }}">
                                    {{ form.hidden_tag() }}
                                    <button name="auth_method" value="discord" type="submit" 
                                            class="btn bg-[#5865F2] hover:bg-[#4752C4] border-[#5865F2] hover:border-[#4752C4] text-white w-full h-12 text-base font-medium">
                                        <i class="fa-brands fa-discord mr-2"></i>
                                        Continue with Discord
                                    </button>
                                </form>
                                
                                {% if not discord_sso_is_mandatory %}
                                    <div class="divider">OR</div>
                                    <p class="text-sm text-base-content/60">You can skip Discord login and proceed directly to Plex authentication.</p>
                                {% endif %}
                            </div>
                        {% elif has_plex_servers and not already_authenticated_plex_user %}
                            {# Plex Step (only if there are Plex servers) #}
                            <div class="step-section bg-base-200/30 border border-base-300 rounded-lg p-6" id="plex-step">
                                <!-- Step Header -->
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 rounded-full bg-[#e5a00d]/20 flex items-center justify-center flex-shrink-0">
                                        <i class="fa-solid fa-right-to-bracket text-[#e5a00d] text-lg"></i>
                                    </div>
                                    <div>
                                        <h2 class="text-xl font-semibold text-base-content mb-1">Plex Authentication</h2>
                                        <p class="text-sm text-base-content/70">
                                            Sign in with your Plex account to access media servers
                                        </p>
                                    </div>
                                </div>
                                
                                {% if already_authenticated_discord_user %}
                                    <div class="bg-[#5865F2]/10 border border-[#5865F2]/20 rounded-lg p-4 mb-6">
                                        <div class="flex items-start gap-3">
                                            <div class="w-6 h-6 rounded-full bg-[#5865F2]/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                                <i class="fa-brands fa-discord text-[#5865F2] text-xs"></i>
                                            </div>
                                            <div>
                                                <h4 class="font-medium text-[#5865F2] mb-1">Discord Account Connected</h4>
                                                <p class="text-sm text-base-content/80">
                                                    Linked as <strong class="text-base-content">{{ already_authenticated_discord_user.username }}</strong>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}

                                <form method="POST" action="{{ url_for('invites.process_invite_form', invite_path_or_token=invite_path_or_token) }}">
                                    {{ form.hidden_tag() }}
                                    <button name="auth_method" value="plex" type="submit" 
                                            class="btn bg-[#e5a00d] hover:bg-[#c4880b] border-[#e5a00d] hover:border-[#c4880b] text-black w-full h-12 text-base font-medium">
                                        <i class="fa-solid fa-right-to-bracket mr-2"></i>
                                        Sign In with Plex
                                    </button>
                                </form>
                            </div>
                        {% else %}
                            {# Server Access Steps or Final Accept #}
                            {# Find the first incomplete step where all previous steps are completed #}
                            {% set current_step = none %}
                            {% if invite_steps|length >= 1 and not invite_steps[0].completed %}
                                {% set current_step = invite_steps[0] %}
                            {% elif invite_steps|length >= 2 and invite_steps[0].completed and not invite_steps[1].completed %}
                                {% set current_step = invite_steps[1] %}
                            {% elif invite_steps|length >= 3 and invite_steps[0].completed and invite_steps[1].completed and not invite_steps[2].completed %}
                                {% set current_step = invite_steps[2] %}
                            {% elif invite_steps|length >= 4 and invite_steps[0].completed and invite_steps[1].completed and invite_steps[2].completed and not invite_steps[3].completed %}
                                {% set current_step = invite_steps[3] %}
                            {% endif %}
                            
                            {# Find current server step #}
                            {% if current_step and current_step.id.startswith('server_access_') %}
                                {# Individual Server Access Step #}
                                <div class="step-section bg-base-200/30 border border-base-300 rounded-lg p-6" id="{{ current_step.id }}">
                                    <!-- Step Header -->
                                    <div class="flex items-center gap-3 mb-6">
                                        <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0">
                                            <i class="{{ current_step.icon }} text-primary text-lg"></i>
                                        </div>
                                        <div>
                                            <h2 class="text-xl font-semibold text-base-content mb-1">{{ current_step.name }}</h2>
                                            <p class="text-sm text-base-content/70">
                                                Setting up access to {{ current_step.server_name }}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    {# Show completed authentications #}
                                    {% if already_authenticated_plex_user or already_authenticated_discord_user %}
                                        <div class="space-y-3 mb-6">
                                            {% if already_authenticated_plex_user %}
                                                <div class="bg-[#e5a00d]/10 border border-[#e5a00d]/20 rounded-lg p-4">
                                                    <div class="flex items-start gap-3">
                                                        <div class="w-6 h-6 rounded-full bg-[#e5a00d]/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                                            <i class="fa-solid fa-right-to-bracket text-[#e5a00d] text-xs"></i>
                                                        </div>
                                                        <div>
                                                            <h4 class="font-medium text-[#e5a00d] mb-1">Plex Account Connected</h4>
                                                            <p class="text-sm text-base-content/80">
                                                                Signed in as <strong class="text-base-content">{{ already_authenticated_plex_user.username }}</strong>
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}
                                            {% if already_authenticated_discord_user %}
                                                <div class="bg-[#5865F2]/10 border border-[#5865F2]/20 rounded-lg p-4">
                                                    <div class="flex items-start gap-3">
                                                        <div class="w-6 h-6 rounded-full bg-[#5865F2]/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                                            <i class="fa-brands fa-discord text-[#5865F2] text-xs"></i>
                                                        </div>
                                                        <div>
                                                            <h4 class="font-medium text-[#5865F2] mb-1">Discord Account Connected</h4>
                                                            <p class="text-sm text-base-content/80">
                                                                Linked as <strong class="text-base-content">{{ already_authenticated_discord_user.username }}</strong>
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endif %}

                                    <!-- Server Info Card -->
                                    <div class="bg-info/10 border border-info/20 rounded-lg p-4 mb-6">
                                        <div class="flex items-start gap-3">
                                            <div class="w-6 h-6 rounded-full bg-info/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                                <i class="fa-solid fa-server text-info text-xs"></i>
                                            </div>
                                            <div>
                                                <h4 class="font-medium text-info mb-1">{{ current_step.server_name }}</h4>
                                                <p class="text-sm text-base-content/80">
                                                    {{ current_step.server_type }} Media Server
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    {% if not (discord_sso_is_mandatory and not already_authenticated_discord_user) %}
                                        <form method="POST" action="{{ url_for('invites.process_invite_form', invite_path_or_token=invite_path_or_token) }}">
                                            {{ form.hidden_tag() }}
                                            <input type="hidden" name="current_server_id" value="{{ current_step.server_id }}">
                                            
                                            {# For non-Plex servers, show username/password fields #}
                                            {% if current_step.server_type != 'PLEX' %}
                                                <div class="space-y-4 mb-6">
                                                    <div class="form-control">
                                                        <label class="label">
                                                            <span class="label-text font-medium text-sm">Choose a username for {{ current_step.server_name }}</span>
                                                        </label>
                                                        <input type="text" name="jellyfin_username" placeholder="Username" 
                                                               class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100" 
                                                               value="{{ already_authenticated_plex_user.username }}" required>
                                                        <label class="label">
                                                            <span class="label-text-alt text-xs text-base-content/60">Default: Your Plex username</span>
                                                        </label>
                                                    </div>
                                                    <div class="form-control">
                                                        <label class="label">
                                                            <span class="label-text font-medium text-sm">Set a password for {{ current_step.server_name }}</span>
                                                        </label>
                                                        <input type="password" name="jellyfin_password" placeholder="Enter password" 
                                                               class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100" required>
                                                        <label class="label">
                                                            <span class="label-text-alt text-xs text-base-content/60">Choose a secure password for your account</span>
                                                        </label>
                                                    </div>
                                                    <div class="form-control">
                                                        <label class="label">
                                                            <span class="label-text font-medium text-sm">Confirm password</span>
                                                        </label>
                                                        <input type="password" name="jellyfin_password_confirm" placeholder="Confirm password" 
                                                               class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100" required>
                                                        <label class="label">
                                                            <span class="label-text-alt text-xs text-base-content/60">Re-enter your password to confirm</span>
                                                        </label>
                                                    </div>
                                                </div>
                                            {% endif %}
                                            
                                            <button name="action" value="setup_server_access" type="submit" 
                                                    class="btn btn-primary w-full h-12 text-base font-medium" 
                                                    {% if current_step.server_type != 'PLEX' %}onclick="return validatePasswords()"{% endif %}>
                                                <i class="fa-solid fa-user-plus mr-2"></i>
                                                {% if current_step.server_type == 'PLEX' %}
                                                    Grant Access to {{ current_step.server_name }}
                                                {% else %}
                                                    Create Account on {{ current_step.server_name }}
                                                {% endif %}
                                            </button>
                                        </form>
                                    {% else %}
                                        <div class="alert alert-error">
                                            <i class="fa-solid fa-circle-xmark mr-2"></i>
                                            <span>Discord linking is required but not completed. Please go back and link your Discord account.</span>
                                        </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                {# All servers completed - Final step #}
                                <div class="step-section" id="final-step">
                                    <h2 class="text-xl font-semibold mb-4">
                                        <i class="fa-solid fa-check-circle mr-2"></i>
                                        All Servers Configured!
                                    </h2>
                                    
                                    {# Show completed authentications #}
                                    <div class="space-y-2 mb-6">
                                        {% if already_authenticated_plex_user %}
                                            <div class="alert alert-success">
                                                <i class="fa-solid fa-right-to-bracket mr-2"></i>
                                                <span>Plex account linked as <strong>{{ already_authenticated_plex_user.username }}</strong></span>
                                            </div>
                                        {% endif %}
                                        {% if already_authenticated_discord_user %}
                                            <div class="alert alert-success">
                                                <i class="fa-brands fa-discord mr-2"></i>
                                                <span>Discord account linked as <strong>{{ already_authenticated_discord_user.username }}</strong></span>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="alert alert-success mb-4">
                                        <i class="fa-solid fa-check-circle mr-2"></i>
                                        <div>
                                            <p class="font-semibold">Access has been configured for all servers!</p>
                                            <ul class="text-sm mt-2 space-y-1">
                                                {% if invite.servers %}
                                                    {% for server in invite.servers %}
                                                        <li class="flex items-center">
                                                            <i class="fa-solid fa-check mr-2 text-success"></i>
                                                            <span class="font-medium">{{ server.name }}</span>
                                                            <span class="text-xs ml-2 opacity-70">({{ server.service_type.name }})</span>
                                                        </li>
                                                    {% endfor %}
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </div>

                                    {% set success_username = already_authenticated_plex_user.username if already_authenticated_plex_user else 'User' %}
                                    {% set server_names = invite.servers|map(attribute='name')|join(', ') %}
                                    <a href="{{ url_for('invites.invite_success', username=success_username, servers=server_names) }}" class="btn btn-primary btn-block text-base btn-lg">
                                        <i class="fa-solid fa-arrow-right mr-2"></i>
                                        Continue to Success Page
                                    </a>
                                </div>
                            {% endif %}
                            {# Server Access Details (show for current server step) #}
                            {% if current_step and current_step.id.startswith('server_access_') and already_authenticated_plex_user and (not discord_sso_is_mandatory or already_authenticated_discord_user) %}
                                <div class="bg-base-200/30 border border-base-300 rounded-lg mt-6 overflow-hidden">
                                    <details class="group">
                                        <summary class="flex items-center justify-between p-4 cursor-pointer hover:bg-base-200/50 transition-colors">
                                            <div class="flex items-center gap-3">
                                                <div class="w-6 h-6 rounded-full bg-info/20 flex items-center justify-center flex-shrink-0">
                                                    <i class="fa-solid fa-info text-info text-xs"></i>
                                                </div>
                                                <span class="font-medium text-base-content">{{ current_step.server_name }} Access Details</span>
                                            </div>
                                            <i class="fa-solid fa-chevron-down text-base-content/60 transition-transform group-open:rotate-180"></i>
                                        </summary>
                                        
                                        <div class="border-t border-base-300 p-4 space-y-4">
                                            <!-- Server Information -->
                                            <div class="bg-info/10 border border-info/20 rounded-lg p-4">
                                                <div class="flex items-start gap-3">
                                                    <div class="w-6 h-6 rounded-full bg-info/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                                        <i class="fa-solid fa-server text-info text-xs"></i>
                                                    </div>
                                                    <div>
                                                        <h4 class="font-medium text-info mb-2">Server Information</h4>
                                                        <div class="space-y-1 text-sm text-base-content/80">
                                                            <div class="flex items-center gap-2">
                                                                <span class="font-medium">Name:</span>
                                                                <span>{{ current_step.server_name }}</span>
                                                            </div>
                                                            <div class="flex items-center gap-2">
                                                                <span class="font-medium">Type:</span>
                                                                <span>{{ current_step.server_type }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Library Access -->
                                            {% if invite.grant_library_ids|length > 0 %}
                                                {# Get libraries for current server #}
                                                {% set current_server_libraries = servers_with_libraries.get(current_step.server_id|int, {}).get('libraries', {}) if servers_with_libraries else {} %}
                                                
                                                {# Find matching libraries #}
                                                {% set matching_libraries = [] %}
                                                {% for lib_id in invite.grant_library_ids %}
                                                    {% if lib_id in current_server_libraries %}
                                                        {% set _ = matching_libraries.append(current_server_libraries[lib_id]) %}
                                                    {% endif %}
                                                {% endfor %}
                                                
                                                <div class="bg-primary/10 border border-primary/20 rounded-lg p-4">
                                                    <div class="flex items-start gap-3">
                                                        <div class="w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                                            <i class="fa-solid fa-folder text-primary text-xs"></i>
                                                        </div>
                                                        <div>
                                                            <h4 class="font-medium text-primary mb-2">Library Access</h4>
                                                            {% if matching_libraries %}
                                                                <p class="text-sm text-base-content/80 mb-2">
                                                                    You will have access to <strong>{{ matching_libraries|length }}</strong> selected libraries:
                                                                </p>
                                                                <div class="space-y-1">
                                                                    {% for lib_name in matching_libraries %}
                                                                        <div class="flex items-center gap-2 text-sm">
                                                                            <div class="w-3 h-3 rounded-full bg-primary/20 flex items-center justify-center">
                                                                                <i class="fa-solid fa-check text-primary text-xs"></i>
                                                                            </div>
                                                                            <span class="text-base-content/80">{{ lib_name }}</span>
                                                                        </div>
                                                                    {% endfor %}
                                                                </div>
                                                            {% else %}
                                                                <p class="text-sm text-base-content/80">
                                                                    Selected libraries (no matching libraries found for this server)
                                                                </p>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="bg-primary/10 border border-primary/20 rounded-lg p-4">
                                                    <div class="flex items-start gap-3">
                                                        <div class="w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                                            <i class="fa-solid fa-folder text-primary text-xs"></i>
                                                        </div>
                                                        <div>
                                                            <h4 class="font-medium text-primary mb-2">Library Access</h4>
                                                            <p class="text-sm text-base-content/80">
                                                                All available libraries on this server
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}
                                            
                                            <!-- Server-Specific Features -->
                                            <div class="bg-success/10 border border-success/20 rounded-lg p-4">
                                                <div class="flex items-start gap-3">
                                                    <div class="w-6 h-6 rounded-full bg-success/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                                        <i class="fa-solid fa-star text-success text-xs"></i>
                                                    </div>
                                                    <div>
                                                        <h4 class="font-medium text-success mb-2">Features & Permissions</h4>
                                                        <div class="space-y-1 text-sm text-base-content/80">
                                                            {% if current_step.server_type == 'PLEX' %}
                                                                <div class="flex items-center gap-2">
                                                                    <i class="fa-solid fa-download w-4 text-success"></i>
                                                                    <span>Downloads/Sync: <strong>{{ "Enabled" if invite.allow_downloads else "Disabled" }}</strong></span>
                                                                </div>
                                                                <div class="flex items-center gap-2">
                                                                    <i class="fa-solid fa-house-user w-4 text-success"></i>
                                                                    <span>Plex Home Invite: <strong>{{ "Yes" if invite.invite_to_plex_home else "No" }}</strong></span>
                                                                </div>
                                                                <div class="flex items-center gap-2">
                                                                    <i class="fa-solid fa-tv w-4 text-success"></i>
                                                                    <span>Live TV Access: <strong>{{ "Enabled" if invite.allow_live_tv else "Disabled" }}</strong></span>
                                                                </div>
                                                            {% elif current_step.server_type == 'JELLYFIN' %}
                                                                <div class="flex items-center gap-2">
                                                                    <i class="fa-solid fa-user w-4 text-success"></i>
                                                                    <span>Account Type: <strong>New user account will be created</strong></span>
                                                                </div>
                                                                <div class="flex items-center gap-2">
                                                                    <i class="fa-solid fa-key w-4 text-success"></i>
                                                                    <span>Authentication: <strong>Username and password (required)</strong></span>
                                                                </div>
                                                                <div class="flex items-center gap-2">
                                                                    <i class="fa-solid fa-download w-4 text-success"></i>
                                                                    <span>Downloads: <strong>Available through Jellyfin apps</strong></span>
                                                                </div>
                                                            {% elif current_step.server_type == 'EMBY' %}
                                                                <div class="flex items-center gap-2">
                                                                    <i class="fa-solid fa-user w-4 text-success"></i>
                                                                    <span>Account Type: <strong>New user account will be created</strong></span>
                                                                </div>
                                                                <div class="flex items-center gap-2">
                                                                    <i class="fa-solid fa-key w-4 text-success"></i>
                                                                    <span>Authentication: <strong>Username and password</strong></span>
                                                                </div>
                                                            {% else %}
                                                                <div class="flex items-center gap-2">
                                                                    <i class="fa-solid fa-user w-4 text-success"></i>
                                                                    <span>Account Type: <strong>New user account will be created</strong></span>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Invite Information -->
                                            <div class="bg-base-100/50 border border-base-300/50 rounded-lg p-4">
                                                <div class="flex items-start gap-3">
                                                    <div class="w-6 h-6 rounded-full bg-base-300/50 flex items-center justify-center flex-shrink-0 mt-0.5">
                                                        <i class="fa-solid fa-calendar text-base-content/60 text-xs"></i>
                                                    </div>
                                                    <div>
                                                        <h4 class="font-medium text-base-content mb-2">Invite Details</h4>
                                                        <div class="space-y-1 text-sm text-base-content/80">
                                                            <div class="flex items-center gap-2">
                                                                <i class="fa-regular fa-clock w-4 text-base-content/60"></i>
                                                                <span>Expires: <strong>{{ invite.expires_at | format_datetime_user if invite.expires_at else "Never" }}</strong></span>
                                                            </div>
                                                            <div class="flex items-center gap-2">
                                                                <i class="fa-solid fa-users w-4 text-base-content/60"></i>
                                                                <span>Uses Left: <strong>{{ (invite.max_uses - invite.current_uses) if invite.max_uses is not none else "Unlimited" }}</strong></span>
                                                            </div>
                                                            {% if invite.membership_duration_days %}
                                                                <div class="flex items-center gap-2">
                                                                    <i class="fa-solid fa-user-clock w-4 text-base-content/60"></i>
                                                                    <span>Membership Duration: <strong>{{ invite.membership_duration_days }} day{{'s' if invite.membership_duration_days != 1 else ''}} after acceptance</strong></span>
                                                                </div>
                                                            {% else %}
                                                                <div class="flex items-center gap-2">
                                                                    <i class="fa-solid fa-user-check w-4 text-base-content/60"></i>
                                                                    <span>Membership: <strong>Permanent</strong></span>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Info Footer -->
                                            <div class="bg-base-100/50 border border-base-300/50 rounded-lg p-3">
                                                <div class="flex items-start gap-2">
                                                    <i class="fa-solid fa-info-circle text-base-content/60 text-xs mt-0.5"></i>
                                                    <p class="text-xs text-base-content/60">
                                                        This information shows what access you'll receive after completing the setup.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </details>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>

                </div>
            {% else %} 
                <div class="card bg-warning text-warning-content shadow-xl p-8">
                    <i class="fa-solid fa-question-circle fa-5x mx-auto mb-4"></i>
                    <h1 class="text-3xl sm:text-4xl font-bold">Invite Information Unavailable</h1>
                    <p class="py-6 text-lg">Could not load invite details at this time. The link may be invalid or there was an issue.</p>
                     {% if g.setup_complete %}
                        <a href="{{ url_for('auth.app_login') }}" class="btn btn-neutral btn-outline">Admin Login</a>
                    {% else %}
                         <a href="{{ url_for('setup.account_setup') }}" class="btn btn-neutral btn-outline">Go to Setup</a>
                    {% endif %}
                </div>
            {% endif %}
    </div>
</div>

<style>

.step-section {
    min-height: 100px;
}
</style>

<script>
function validatePasswords() {
    const password = document.querySelector('input[name="jellyfin_password"]');
    const confirmPassword = document.querySelector('input[name="jellyfin_password_confirm"]');
    
    if (!password || !confirmPassword) {
        return true; // If fields don't exist, let form submit normally
    }
    
    if (password.value !== confirmPassword.value) {
        alert('Passwords do not match. Please check your password and confirmation.');
        confirmPassword.focus();
        return false;
    }
    
    if (password.value.length < 1) {
        alert('Password is required.');
        password.focus();
        return false;
    }
    
    return true;
}

// Add real-time validation feedback
document.addEventListener('DOMContentLoaded', function() {
    const password = document.querySelector('input[name="jellyfin_password"]');
    const confirmPassword = document.querySelector('input[name="jellyfin_password_confirm"]');
    
    if (password && confirmPassword) {
        function checkPasswordMatch() {
            if (confirmPassword.value && password.value !== confirmPassword.value) {
                confirmPassword.setCustomValidity('Passwords do not match');
            } else {
                confirmPassword.setCustomValidity('');
            }
        }
        
        password.addEventListener('input', checkPasswordMatch);
        confirmPassword.addEventListener('input', checkPasswordMatch);
    }
});
</script>
{% endblock content %}