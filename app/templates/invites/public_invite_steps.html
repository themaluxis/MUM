<!-- File: app/templates/invites/public_invite_steps.html -->
{% extends "base.html" %}

{% block title %}{{ super() }} - You're Invited!{% endblock %}

{% block content %} 
<div class="min-h-[calc(100vh-12rem)] bg-gradient-to-br from-base-100 to-base-200 flex items-center justify-center p-4">
    <div class="w-full max-w-4xl">
        {% if error %}
            <!-- Error State -->
            <div class="bg-base-100 border border-error/30 rounded-xl shadow-lg overflow-hidden">
                <div class="bg-error/10 border-b border-error/20 p-6 text-center">
                    <div class="w-16 h-16 rounded-full bg-error/20 flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-circle-xmark text-error text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-error mb-2">Invite Problem</h1>
                    <p class="text-base-content/70 text-sm">
                        There was an issue with your invite
                    </p>
                </div>
                <div class="p-6 text-center">
                    <p class="text-base-content mb-6">{{ error }}</p>
                    {% if g.setup_complete %}
                        <a href="{{ url_for('auth.app_login') }}" class="btn btn-outline btn-neutral">
                            <i class="fa-solid fa-user-shield mr-2"></i>
                            Admin Login
                        </a>
                    {% else %}
                        <a href="{{ url_for('setup.account_setup') }}" class="btn btn-outline btn-neutral">
                            <i class="fa-solid fa-cog mr-2"></i>
                            Go to Setup
                        </a>
                    {% endif %}
                </div>
            </div>
        {% elif invite %}
            <!-- Main Invite Flow -->
            <div class="bg-base-100 border border-base-300 rounded-xl shadow-lg overflow-hidden">
                <!-- Header Section -->
                <div class="bg-gradient-to-r from-primary/10 to-secondary/10 p-6 text-center border-b border-base-300">
                    <div class="w-16 h-16 rounded-full bg-primary/20 flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-envelope-open-text text-primary text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-base-content mb-2">You're Invited!</h1>
                    <p class="text-base-content/70 text-sm">
                        Join <strong class="text-primary">{{ server_name }}</strong> and start streaming
                    </p>
                </div>
                
                <!-- Content Section -->
                <div class="p-6 sm:p-8">

                    {# Build steps dynamically based on invite configuration #}
                    {% set invite_steps = [] %}
                    
                    {# Step 1: User Account Creation (if enabled) #}
                    {% if allow_user_accounts %}
                        {% set _ = invite_steps.append({
                            'id': 'user_account',
                            'name': 'Create Account',
                            'icon': 'fa-solid fa-user-plus',
                            'required': true,
                            'completed': user_account_created
                        }) %}
                    {% endif %}
                    
                    {# Step 2: Discord OAuth (if enabled) #}
                    {% if show_discord_button %}
                        {% set _ = invite_steps.append({
                            'id': 'discord',
                            'name': 'Discord Login',
                            'icon': 'fa-brands fa-discord',
                            'required': discord_sso_is_mandatory,
                            'completed': already_authenticated_discord_user is not none
                        }) %}
                    {% endif %}
                    
                    {# Step 3: Plex Login (only if there are Plex servers in the invite) #}
                    {% set has_plex_servers = invite.servers and invite.servers|selectattr('service_type.name', 'equalto', 'PLEX')|list|length > 0 %}
                    {% if has_plex_servers %}
                        {% set _ = invite_steps.append({
                            'id': 'plex',
                            'name': 'Plex Login',
                            'icon': 'fa-solid fa-right-to-bracket',
                            'required': true,
                            'completed': already_authenticated_plex_user is not none
                        }) %}
                    {% endif %}
                    
                    {# Step 3+: Server Access (for each server in multi-server invites) #}
                    {% if invite.servers %}
                        {% for server in invite.servers %}
                            {% set server_icon = 'fa-solid fa-server' %}
                            {% if server.service_type.name.upper() == 'PLEX' %}
                                {% set server_icon = 'fa-solid fa-play' %}
                            {% elif server.service_type.name.upper() == 'JELLYFIN' %}
                                {% set server_icon = 'fa-solid fa-film' %}
                            {% elif server.service_type.name.upper() == 'EMBY' %}
                                {% set server_icon = 'fa-solid fa-video' %}
                            {% endif %}
                            {# Check if this server has been completed #}
                            {% set server_completed = session.get('invite_' ~ invite.id ~ '_server_' ~ server.id ~ '_completed', false) %}
                            
                            {# For Plex servers, auto-complete when Plex login is done #}
                            {% if server.service_type.name.upper() == 'PLEX' and already_authenticated_plex_user %}
                                {% set server_completed = true %}
                            {% endif %}
                            
                            {# Only add non-Plex servers as separate steps #}
                            {% if server.service_type.name.upper() != 'PLEX' %}
                                {% set _ = invite_steps.append({
                                    'id': 'server_access_' ~ server.id,
                                    'name': server.name ~ ' Access',
                                    'icon': server_icon,
                                    'required': true,
                                    'completed': server_completed,
                                    'server_type': server.service_type.name.upper(),
                                    'server_name': server.name,
                                    'server_id': server.id
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        {# Fallback for legacy single server invites #}
                        {% set _ = invite_steps.append({
                            'id': 'server_access',
                            'name': 'Server Access',
                            'icon': 'fa-solid fa-server',
                            'required': true,
                            'completed': false
                        }) %}
                    {% endif %}

                    {# Display Steps #}
                    {% if invite_steps|length > 1 %}
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="font-medium text-base-content">Setup Progress</h2>
                                <span class="text-sm text-base-content/60">
                                    {{ invite_steps|selectattr('completed')|list|length }} of {{ invite_steps|length }} completed
                                </span>
                            </div>
                            <div class="flex items-center gap-2">
                                {% for step in invite_steps %}
                                    {% set is_current = not step.completed and (loop.index0 == 0 or invite_steps[loop.index0-1].completed) %}
                                    <div class="flex items-center flex-1">
                                        <div class="flex items-center gap-2 p-3 rounded-lg transition-colors
                                            {% if step.completed %}bg-primary/10 border border-primary/20
                                            {% elif is_current %}bg-warning/10 border border-warning/20
                                            {% else %}bg-base-200/50 border border-base-300{% endif %} flex-1">
                                            <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0
                                                {% if step.completed %}bg-primary text-primary-content
                                                {% elif is_current %}bg-warning text-warning-content
                                                {% else %}bg-base-300 text-base-content/60{% endif %}">
                                                {% if step.completed %}
                                                    <i class="fa-solid fa-check text-xs"></i>
                                                {% elif is_current %}
                                                    <i class="fa-solid fa-circle text-xs"></i>
                                                {% else %}
                                                    <i class="{{ step.icon }} text-xs"></i>
                                                {% endif %}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <span class="text-xs font-medium block truncate
                                                    {% if step.completed %}text-primary
                                                    {% elif is_current %}text-warning
                                                    {% else %}text-base-content/70{% endif %}">
                                                    {{ step.name }}
                                                </span>
                                                {% if not step.required %}
                                                    <span class="text-xs text-base-content/60">Optional</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% if not loop.last %}
                                            <div class="w-3 h-0.5 mx-1
                                                {% if step.completed %}bg-primary
                                                {% else %}bg-base-300{% endif %}"></div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    {# Current Step Content #}
                    <div class="step-content max-w-sm mx-auto">
                        {% if allow_user_accounts and not user_account_created %}
                            {# User Account Creation Step #}
                            <div class="step-section" id="user-account-step">
                                <h2 class="text-xl font-semibold mb-4">
                                    <i class="fa-solid fa-user-plus mr-2"></i>
                                    Create Your Account
                                </h2>
                                
                                <p class="text-sm text-base-content/70 mb-6">
                                    First, create your account to manage your media access and preferences.
                                </p>

                                <form method="POST" action="{{ url_for('invites.process_invite_form', invite_path_or_token=invite_path_or_token) }}">
                                    {{ form.hidden_tag() }}
                                    
                                    <div class="form-control mb-4">
                                        <label class="label">
                                            <span class="label-text">{{ account_form.username.label.text }}</span>
                                        </label>
                                        {{ account_form.username(class="input input-bordered w-full") }}
                                        <label class="label">
                                            <span class="label-text-alt">{{ account_form.username.description }}</span>
                                        </label>
                                    </div>

                                    <div class="form-control mb-4">
                                        <label class="label">
                                            <span class="label-text">{{ account_form.email.label.text }}</span>
                                        </label>
                                        {{ account_form.email(class="input input-bordered w-full") }}
                                        <label class="label">
                                            <span class="label-text-alt">{{ account_form.email.description }}</span>
                                        </label>
                                    </div>

                                    <div class="form-control mb-4">
                                        <label class="label">
                                            <span class="label-text">{{ account_form.password.label.text }}</span>
                                        </label>
                                        {{ account_form.password(class="input input-bordered w-full") }}
                                        <label class="label">
                                            <span class="label-text-alt">{{ account_form.password.description }}</span>
                                        </label>
                                    </div>

                                    <div class="form-control mb-6">
                                        <label class="label">
                                            <span class="label-text">{{ account_form.confirm_password.label.text }}</span>
                                        </label>
                                        {{ account_form.confirm_password(class="input input-bordered w-full") }}
                                        <label class="label">
                                            <span class="label-text-alt">{{ account_form.confirm_password.description }}</span>
                                        </label>
                                    </div>

                                    <button name="action" value="create_user_account" type="submit" class="btn btn-primary btn-block text-base">
                                        <i class="fa-solid fa-user-plus mr-2"></i>
                                        Create Account & Continue
                                    </button>
                                </form>
                            </div>
                        {% elif show_discord_button and not already_authenticated_discord_user %}
                            {# Discord Step #}
                            <div class="step-section" id="discord-step">
                                <h2 class="text-xl font-semibold mb-4">
                                    <i class="fa-brands fa-discord mr-2"></i>
                                    Discord Authentication
                                    {% if not discord_sso_is_mandatory %}
                                        <span class="badge badge-ghost badge-sm ml-2">Optional</span>
                                    {% endif %}
                                </h2>
                                
                                {% if setting_require_guild_membership %}
                                    <div class="alert alert-info mb-4">
                                        <i class="fa-solid fa-info-circle"></i>
                                        <span>You must be a member of our Discord server to accept this invite.</span>
                                    </div>
                                    {% if setting_discord_server_invite_url %}
                                        <div class="mb-4">
                                            <a href="{{ setting_discord_server_invite_url }}" target="_blank" rel="noopener noreferrer" 
                                               class="btn btn-secondary btn-block">
                                                <i class="fa-brands fa-discord fa-lg mr-2"></i>
                                                Join Discord Server First
                                                <i class="fa-solid fa-external-link-alt ml-2"></i>
                                            </a>
                                        </div>
                                    {% endif %}
                                {% endif %}

                                <form method="POST" action="{{ url_for('invites.process_invite_form', invite_path_or_token=invite_path_or_token) }}">
                                    {{ form.hidden_tag() }}
                                    <button name="auth_method" value="discord" type="submit" class="btn btn-info bg-[#5865F2] hover:bg-[#4752C4] border-[#5865F2] hover:border-[#4752C4] text-white btn-block text-base">
                                        <i class="fa-brands fa-discord fa-lg mr-2"></i>
                                        Continue with Discord
                                    </button>
                                </form>
                                
                                {% if not discord_sso_is_mandatory %}
                                    <div class="divider">OR</div>
                                    <p class="text-sm text-base-content/60">You can skip Discord login and proceed directly to Plex authentication.</p>
                                {% endif %}
                            </div>
                        {% elif has_plex_servers and not already_authenticated_plex_user %}
                            {# Plex Step (only if there are Plex servers) #}
                            <div class="step-section" id="plex-step">
                                <h2 class="text-xl font-semibold mb-4">
                                    <i class="fa-solid fa-right-to-bracket mr-2"></i>
                                    Plex Authentication
                                </h2>
                                
                                {% if already_authenticated_discord_user %}
                                    <div class="alert alert-success mb-4">
                                        <i class="fa-brands fa-discord mr-2"></i>
                                        <span>Discord account linked as <strong>{{ already_authenticated_discord_user.username }}</strong></span>
                                    </div>
                                {% endif %}

                                <form method="POST" action="{{ url_for('invites.process_invite_form', invite_path_or_token=invite_path_or_token) }}">
                                    {{ form.hidden_tag() }}
                                    <button name="auth_method" value="plex" type="submit" class="btn btn-primary bg-[#e5a00d] hover:bg-[#c4880b] border-[#e5a00d] hover:border-[#c4880b] text-black btn-block text-base">
                                        <i class="fa-solid fa-right-to-bracket mr-2"></i>
                                        Sign In with Plex
                                    </button>
                                </form>
                            </div>
                        {% else %}
                            {# Server Access Steps or Final Accept #}
                            {# Find the first incomplete step where all previous steps are completed #}
                            {% set current_step = none %}
                            {% if invite_steps|length >= 1 and not invite_steps[0].completed %}
                                {% set current_step = invite_steps[0] %}
                            {% elif invite_steps|length >= 2 and invite_steps[0].completed and not invite_steps[1].completed %}
                                {% set current_step = invite_steps[1] %}
                            {% elif invite_steps|length >= 3 and invite_steps[0].completed and invite_steps[1].completed and not invite_steps[2].completed %}
                                {% set current_step = invite_steps[2] %}
                            {% elif invite_steps|length >= 4 and invite_steps[0].completed and invite_steps[1].completed and invite_steps[2].completed and not invite_steps[3].completed %}
                                {% set current_step = invite_steps[3] %}
                            {% endif %}
                            
                            {# Find current server step #}
                            {% if current_step and current_step.id.startswith('server_access_') %}
                                {# Individual Server Access Step #}
                                <div class="step-section" id="{{ current_step.id }}">
                                    <h2 class="text-xl font-semibold mb-4">
                                        <i class="{{ current_step.icon }} mr-2"></i>
                                        {{ current_step.name }}
                                    </h2>
                                    
                                    {# Show completed authentications #}
                                    <div class="space-y-2 mb-6">
                                        {% if already_authenticated_plex_user %}
                                            <div class="alert alert-success">
                                                <i class="fa-solid fa-right-to-bracket mr-2"></i>
                                                <span>Plex account linked as <strong>{{ already_authenticated_plex_user.username }}</strong></span>
                                            </div>
                                        {% endif %}
                                        {% if already_authenticated_discord_user %}
                                            <div class="alert alert-success">
                                                <i class="fa-brands fa-discord mr-2"></i>
                                                <span>Discord account linked as <strong>{{ already_authenticated_discord_user.username }}</strong></span>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="alert alert-info mb-4">
                                        <i class="fa-solid fa-info-circle mr-2"></i>
                                        <div>
                                            <p class="font-semibold">Setting up access to {{ current_step.server_name }}</p>
                                            <p class="text-sm">Service Type: {{ current_step.server_type }}</p>
                                        </div>
                                    </div>

                                    {% if not (discord_sso_is_mandatory and not already_authenticated_discord_user) %}
                                        <form method="POST" action="{{ url_for('invites.process_invite_form', invite_path_or_token=invite_path_or_token) }}">
                                            {{ form.hidden_tag() }}
                                            <input type="hidden" name="current_server_id" value="{{ current_step.server_id }}">
                                            
                                            {# For non-Plex servers, show username/password fields #}
                                            {% if current_step.server_type != 'PLEX' %}
                                                <div class="space-y-4 mb-6">
                                                    <div class="form-control">
                                                        <label class="label">
                                                            <span class="label-text">Choose a username for {{ current_step.server_name }}</span>
                                                        </label>
                                                        <input type="text" name="jellyfin_username" placeholder="Username" class="input input-bordered" value="{{ already_authenticated_plex_user.username }}" required>
                                                        <label class="label">
                                                            <span class="label-text-alt">Default: Your Plex username</span>
                                                        </label>
                                                    </div>
                                                    <div class="form-control">
                                                        <label class="label">
                                                            <span class="label-text">Set a password for {{ current_step.server_name }}</span>
                                                        </label>
                                                        <input type="password" name="jellyfin_password" placeholder="Enter password" class="input input-bordered" required>
                                                        <label class="label">
                                                            <span class="label-text-alt">Choose a secure password for your account</span>
                                                        </label>
                                                    </div>
                                                    <div class="form-control">
                                                        <label class="label">
                                                            <span class="label-text">Confirm password</span>
                                                        </label>
                                                        <input type="password" name="jellyfin_password_confirm" placeholder="Confirm password" class="input input-bordered" required>
                                                        <label class="label">
                                                            <span class="label-text-alt">Re-enter your password to confirm</span>
                                                        </label>
                                                    </div>
                                                </div>
                                            {% endif %}
                                            
                                            <button name="action" value="setup_server_access" type="submit" class="btn btn-success btn-block text-base btn-lg" 
                                                    {% if current_step.server_type != 'PLEX' %}onclick="return validatePasswords()"{% endif %}>
                                                <i class="fa-solid fa-check-circle mr-2"></i>
                                                {% if current_step.server_type == 'PLEX' %}
                                                    Grant Access to {{ current_step.server_name }}
                                                {% else %}
                                                    Create Account on {{ current_step.server_name }}
                                                {% endif %}
                                            </button>
                                        </form>
                                    {% else %}
                                        <div class="alert alert-error">
                                            <i class="fa-solid fa-circle-xmark mr-2"></i>
                                            <span>Discord linking is required but not completed. Please go back and link your Discord account.</span>
                                        </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                {# All servers completed - Final step #}
                                <div class="step-section" id="final-step">
                                    <h2 class="text-xl font-semibold mb-4">
                                        <i class="fa-solid fa-check-circle mr-2"></i>
                                        All Servers Configured!
                                    </h2>
                                    
                                    {# Show completed authentications #}
                                    <div class="space-y-2 mb-6">
                                        {% if already_authenticated_plex_user %}
                                            <div class="alert alert-success">
                                                <i class="fa-solid fa-right-to-bracket mr-2"></i>
                                                <span>Plex account linked as <strong>{{ already_authenticated_plex_user.username }}</strong></span>
                                            </div>
                                        {% endif %}
                                        {% if already_authenticated_discord_user %}
                                            <div class="alert alert-success">
                                                <i class="fa-brands fa-discord mr-2"></i>
                                                <span>Discord account linked as <strong>{{ already_authenticated_discord_user.username }}</strong></span>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="alert alert-success mb-4">
                                        <i class="fa-solid fa-check-circle mr-2"></i>
                                        <div>
                                            <p class="font-semibold">Access has been configured for all servers!</p>
                                            <ul class="text-sm mt-2 space-y-1">
                                                {% if invite.servers %}
                                                    {% for server in invite.servers %}
                                                        <li class="flex items-center">
                                                            <i class="fa-solid fa-check mr-2 text-success"></i>
                                                            <span class="font-medium">{{ server.name }}</span>
                                                            <span class="text-xs ml-2 opacity-70">({{ server.service_type.name }})</span>
                                                        </li>
                                                    {% endfor %}
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </div>

                                    {% set success_username = already_authenticated_plex_user.username if already_authenticated_plex_user else 'User' %}
                                    {% set server_names = invite.servers|map(attribute='name')|join(', ') %}
                                    <a href="{{ url_for('invites.invite_success', username=success_username, servers=server_names) }}" class="btn btn-primary btn-block text-base btn-lg">
                                        <i class="fa-solid fa-arrow-right mr-2"></i>
                                        Continue to Success Page
                                    </a>
                                </div>
                            {% endif %}
                            {# Server Access Details (show for current server step) #}
                            {% if current_step and current_step.id.startswith('server_access_') and already_authenticated_plex_user and (not discord_sso_is_mandatory or already_authenticated_discord_user) %}
                                <div class="collapse collapse-arrow bg-base-100 mt-4">
                                    <input type="checkbox" /> 
                                    <div class="collapse-title text-sm font-medium">
                                        <i class="fa-solid fa-info-circle mr-2"></i>
                                        {{ current_step.server_name }} Access Details
                                    </div>
                                    <div class="collapse-content text-xs text-left space-y-1">
                                        <p><i class="fa-solid fa-server fa-fw w-4"></i> Server: {{ current_step.server_name }}</p>
                                        <p><i class="fa-solid fa-cog fa-fw w-4"></i> Service Type: {{ current_step.server_type }}</p>
                                        {% if invite.grant_library_ids|length > 0 %}
                                            {# Get libraries for current server #}
                                            {% set current_server_libraries = servers_with_libraries.get(current_step.server_id|int, {}).get('libraries', {}) if servers_with_libraries else {} %}
                                            
                                            {# Find matching libraries #}
                                            {% set matching_libraries = [] %}
                                            {% for lib_id in invite.grant_library_ids %}
                                                {% if lib_id in current_server_libraries %}
                                                    {% set _ = matching_libraries.append(current_server_libraries[lib_id]) %}
                                                {% endif %}
                                            {% endfor %}
                                            
                                            {% if matching_libraries %}
                                                <p><i class="fa-solid fa-layer-group fa-fw w-4"></i> Library Access: {{ matching_libraries|length }} selected libraries</p>
                                                <div class="text-xs opacity-70 ml-6 mt-1">
                                                    <p><strong>You will get access to:</strong></p>
                                                    <ul class="list-disc list-inside">
                                                        {% for lib_name in matching_libraries %}
                                                            <li>{{ lib_name }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                            {% else %}
                                                <p><i class="fa-solid fa-layer-group fa-fw w-4"></i> Library Access: Selected libraries</p>
                                                <div class="text-xs opacity-70 ml-6 mt-1">
                                                    <p>No matching libraries found for this server</p>
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <p><i class="fa-solid fa-layer-group fa-fw w-4"></i> Library Access: All available libraries on this server</p>
                                        {% endif %}
                                        
                                        {# Show server-specific features #}
                                        {% if current_step.server_type == 'PLEX' %}
                                            <p><i class="fa-solid fa-download fa-fw w-4"></i> Downloads/Sync: {{ "Enabled" if invite.allow_downloads else "Disabled" }}</p>
                                            <p><i class="fa-solid fa-house-user fa-fw w-4"></i> Plex Home Invite: {{ "Yes" if invite.invite_to_plex_home else "No" }}</p>
                                            <p><i class="fa-solid fa-tv fa-fw w-4"></i> Live TV Access: {{ "Enabled" if invite.allow_live_tv else "Disabled" }}</p>
                                        {% elif current_step.server_type == 'JELLYFIN' %}
                                            <p><i class="fa-solid fa-user fa-fw w-4"></i> Account Type: New user account will be created</p>
                                            <p><i class="fa-solid fa-key fa-fw w-4"></i> Authentication: Username and password (required)</p>
                                            <p><i class="fa-solid fa-download fa-fw w-4"></i> Downloads: Available through Jellyfin apps</p>
                                        {% elif current_step.server_type == 'EMBY' %}
                                            <p><i class="fa-solid fa-user fa-fw w-4"></i> Account Type: New user account will be created</p>
                                            <p><i class="fa-solid fa-key fa-fw w-4"></i> Authentication: Username and password</p>
                                        {% else %}
                                            <p><i class="fa-solid fa-user fa-fw w-4"></i> Account Type: New user account will be created</p>
                                        {% endif %}
                                        
                                        <div class="divider my-2"></div>
                                        <p><i class="fa-regular fa-clock fa-fw w-4"></i> Invite Expires: {{ invite.expires_at | format_datetime_user if invite.expires_at else "Never" }}</p>
                                        <p><i class="fa-solid fa-users fa-fw w-4"></i> Invite Uses Left: {{ (invite.max_uses - invite.current_uses) if invite.max_uses is not none else "Unlimited" }}</p>
                                        {% if invite.membership_duration_days %}
                                            <p class="text-accent"><i class="fa-solid fa-user-clock fa-fw w-4"></i> Membership Duration: {{ invite.membership_duration_days }} day{{'s' if invite.membership_duration_days != 1 else ''}} after acceptance</p>
                                        {% else %}
                                            <p><i class="fa-solid fa-user-check fa-fw w-4"></i> Membership: Permanent</p>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>

                </div>
            {% else %} 
                <div class="card bg-warning text-warning-content shadow-xl p-8">
                    <i class="fa-solid fa-question-circle fa-5x mx-auto mb-4"></i>
                    <h1 class="text-3xl sm:text-4xl font-bold">Invite Information Unavailable</h1>
                    <p class="py-6 text-lg">Could not load invite details at this time. The link may be invalid or there was an issue.</p>
                     {% if g.setup_complete %}
                        <a href="{{ url_for('auth.app_login') }}" class="btn btn-neutral btn-outline">Admin Login</a>
                    {% else %}
                         <a href="{{ url_for('setup.account_setup') }}" class="btn btn-neutral btn-outline">Go to Setup</a>
                    {% endif %}
                </div>
            {% endif %}
    </div>
</div>

<style>

.step-section {
    min-height: 100px;
}
</style>

<script>
function validatePasswords() {
    const password = document.querySelector('input[name="jellyfin_password"]');
    const confirmPassword = document.querySelector('input[name="jellyfin_password_confirm"]');
    
    if (!password || !confirmPassword) {
        return true; // If fields don't exist, let form submit normally
    }
    
    if (password.value !== confirmPassword.value) {
        alert('Passwords do not match. Please check your password and confirmation.');
        confirmPassword.focus();
        return false;
    }
    
    if (password.value.length < 1) {
        alert('Password is required.');
        password.focus();
        return false;
    }
    
    return true;
}

// Add real-time validation feedback
document.addEventListener('DOMContentLoaded', function() {
    const password = document.querySelector('input[name="jellyfin_password"]');
    const confirmPassword = document.querySelector('input[name="jellyfin_password_confirm"]');
    
    if (password && confirmPassword) {
        function checkPasswordMatch() {
            if (confirmPassword.value && password.value !== confirmPassword.value) {
                confirmPassword.setCustomValidity('Passwords do not match');
            } else {
                confirmPassword.setCustomValidity('');
            }
        }
        
        password.addEventListener('input', checkPasswordMatch);
        confirmPassword.addEventListener('input', checkPasswordMatch);
    }
});
</script>
{% endblock content %}