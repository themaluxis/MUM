<!-- File: app/templates/roles/partials/permissions_tab.html -->
<form method="POST" action="{{ url_for('role_management.edit', role_id=role.id, tab='permissions') }}">
    {{ form.hidden_tag() }}
    
    <div class="space-y-6">
        
        <!-- Permissions Overview Section -->
        <div class="bg-base-200/30 border border-base-300 rounded-lg p-6">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 rounded-full bg-success/20 flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid fa-shield-halved text-success text-lg"></i>
                </div>
                <div>
                    <h2 class="text-xl font-semibold text-base-content mb-1">Role Permissions</h2>
                    <p class="text-sm text-base-content/70">Configure what actions members of this role can perform</p>
                </div>
            </div>
            
            <!-- Info Card -->
            <div class="bg-info/10 border border-info/20 rounded-lg p-4">
                <div class="flex items-start gap-3">
                    <div class="w-6 h-6 rounded-full bg-info/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                        <i class="fa-solid fa-info text-info text-xs"></i>
                    </div>
                    <div>
                        <h4 class="font-medium text-info mb-1">Permission Guidelines</h4>
                        <p class="text-sm text-base-content/80">
                            Select the permissions that members of this role will have. Admin ID 1 automatically has all permissions regardless of role assignments.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Permission Categories -->
        <div class="space-y-4" id="permissions-container">
            {% for category, data in permissions_structure.items() %}
            <div class="bg-base-200/30 border border-base-300 rounded-lg p-6">
                <!-- Category Header -->
                <div class="flex items-center gap-3 mb-4">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" class="checkbox checkbox-primary permission-parent" data-category="{{ category }}">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center">
                                <i class="fa-solid fa-{{ 'users-gear' if category == 'Admins' else 'user-shield' if category == 'Users' else 'ticket' if category == 'Invites' else 'server' if category == 'Media Servers' else 'cog' }} text-primary text-sm"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-base-content">{{ data.label }}</h3>
                            </div>
                        </div>
                    </label>
                </div>
                
                <!-- Individual Permissions -->
                {% if data.children %}
                <div class="space-y-3 ml-11">
                    {% for p_key, p_data in data.children.items() %}
                        <div class="{% if p_key == 'view_admins_tab' %}hidden{% endif %}">
                            <label class="flex items-start gap-3 p-3 rounded-lg hover:bg-base-100/50 cursor-pointer" title="{{ p_data.description }}">
                                <input type="checkbox" name="permissions" value="{{ p_key }}" 
                                       class="toggle toggle-primary permission-child mt-1" 
                                       data-category="{{ category }}" 
                                       data-permission-key="{{ p_key }}"
                                       {% if form.permissions.data and p_key in form.permissions.data %}checked{% endif %}>
                                <div class="flex-1">
                                    <span class="text-sm font-medium text-base-content block">{{ p_data.label }}</span>
                                    <p class="text-xs text-base-content/60 mt-1">{{ p_data.description }}</p>
                                </div>
                            </label>
                        </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Save Button -->
        <div class="flex justify-end pt-6">
            <button type="submit" name="submit_permissions" value="Save" class="btn btn-primary">
                <i class="fa-solid fa-save mr-2"></i>
                Save Permissions
            </button>
        </div>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('permissions-container');
    if (!container) return;

    // --- Selectors ---
    const adminVisibleToggles = container.querySelectorAll('.permission-child[data-category="Admins"]:not([data-permission-key="view_admins_tab"])');
    const adminViewToggle = container.querySelector('.permission-child[data-permission-key="view_admins_tab"]');

    // --- Function to sync the implicit view permission ---
    function syncAdminViewPermission() {
        if (!adminViewToggle) return;
        const anyAdminActionChecked = Array.from(adminVisibleToggles).some(toggle => toggle.checked);
        adminViewToggle.checked = anyAdminActionChecked;
        // After syncing the hidden toggle, we must also re-sync its parent
        syncParent('Admins'); 
    }

    // --- Function to sync parent checkboxes based on YOUR rules ---
    function syncParent(category) {
        const parent = container.querySelector(`.permission-parent[data-category="${category}"]`);
        if (!parent) return;
        const children = container.querySelectorAll(`.permission-child[data-category="${category}"]`);
        if (children.length === 0) return;

        // Your rule: if AT LEAST ONE child is checked, the parent is checked.
        const anyChecked = Array.from(children).some(c => c.checked);
        parent.checked = anyChecked;
    }

    // --- Main Event Listener ---
    container.addEventListener('change', function (event) {
        const target = event.target;
        const category = target.dataset.category;

        // A parent was clicked: update all children
        if (target.matches('.permission-parent')) {
            const children = container.querySelectorAll(`.permission-child[data-category="${category}"]`);
            children.forEach(child => {
                child.checked = target.checked;
            });
            // After a bulk change, if it was the Admins parent, sync the view permission
            if (category === 'Admins') {
                syncAdminViewPermission();
            }
        }
        
        // A visible child was clicked: update its parent
        if (target.matches('.permission-child') && target !== adminViewToggle) {
             syncParent(category);
             // If it was an Admin child, sync the view permission
             if (category === 'Admins') {
                 syncAdminViewPermission();
             }
        }
    });

    // --- Initial State Setup on Page Load ---
    // 1. First, set the correct state for the implicit view permission
    syncAdminViewPermission();
    // 2. Then, set the state for all parent checkboxes based on their children (including the now-correct view perm)
    container.querySelectorAll('.permission-parent').forEach(parent => {
        syncParent(parent.dataset.category);
    });
});
</script>