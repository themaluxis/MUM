{# File: app/templates/components/modals/all_servers_status_modal.html #}
{# Expects 'server_status' (dict with 'servers_by_service' dict) in context #}
<dialog id="all_servers_status_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-5xl bg-base-100 border border-base-300 shadow-2xl p-0">
        <!-- Professional Header -->
        <div class="flex items-center justify-between p-6 border-b border-base-300">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-info/20 flex items-center justify-center">
                    <i class="fa-solid fa-server text-info text-lg"></i>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-base-content">All Server Statuses</h3>
                    <p class="text-sm text-base-content/60">Monitor the status of all configured media servers</p>
                </div>
            </div>
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost hover:bg-base-200">
                    <i class="fa-solid fa-times"></i>
                </button>
            </form>
        </div>

        <!-- Content -->
        <div class="p-6">
        
        {% if server_status and server_status.servers_by_service %}
            <div class="space-y-4">
                {% for service_type, service_data in server_status.servers_by_service.items() %}
                <div class="collapse collapse-arrow bg-base-200 border border-base-300">
                    <input type="checkbox" class="peer" {% if loop.first %}checked{% endif %} />
                    <div class="collapse-title text-lg font-medium flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-2">
                                {% if service_type == 'plex' %}
                                    <svg class="w-5 h-5 inline-block stroke-transparent text-warning" viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="#000000" stroke-linejoin="round" stroke-width="12"><path d="M22 25.5h48L116 94l-46 68.5H22L68.5 94Zm109.8 56L108 46l14-20.5h48zm-.3 23.5c10.979 17.625 25.52 38.875 38.5 49.5-11.149 13.635-34.323 32.278-62.5-14z"/></svg>
                                {% elif service_type == 'jellyfin' %}
                                    <i class="fa-solid fa-cube text-jellyfin fa-lg"></i>
                                {% elif service_type == 'emby' %}
                                    <i class="fa-solid fa-play-circle text-emby fa-lg"></i>
                                {% elif service_type == 'audiobookshelf' %}
                                    <i class="fa-solid fa-headphones text-audiobookshelf fa-lg"></i>
                                {% elif service_type == 'kavita' %}
                                    <i class="fa-solid fa-book text-kavita fa-lg"></i>
                                {% elif service_type == 'komga' %}
                                    <i class="fa-solid fa-book-open text-komga fa-lg"></i>
                                {% elif service_type == 'romm' %}
                                    <i class="fa-solid fa-gamepad text-romm fa-lg"></i>
                                {% else %}
                                    <i class="fa-solid fa-server text-base-content fa-lg"></i>
                                {% endif %}
                                <span>{{ service_data.service_name }}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 text-sm">
                            <span class="badge badge-sm badge-success">{{ service_data.online_count }} Online</span>
                            {% if service_data.offline_count > 0 %}
                                <span class="badge badge-sm badge-error">{{ service_data.offline_count }} Offline</span>
                            {% endif %}
                            <span class="text-base-content/60">{{ service_data.total_count }} Total</span>
                        </div>
                    </div>
                    <div class="collapse-content">
                        <div class="space-y-3 pt-2">
                            {% for status in service_data.servers %}
                            <div class="p-3 border border-base-300 rounded-lg bg-base-100">
                                <div class="flex flex-row gap-3 items-center">
                                    <div class="self-start p-2 rounded-md {{ 'bg-success/20 text-success' if status.online else 'bg-error/20 text-error' }}">
                                        <i class="fa-solid fa-server fa-lg"></i>
                                    </div>
                                    <div class="flex-grow">
                                        <h4 class="font-semibold">{{ status.name }}</h4>
                                        {% if status.online %}
                                            <p class="text-sm"><strong class="text-success">Online</strong> - {{ status.actual_server_name | default(status.name) }}</p>
                                            <p class="text-xs text-base-content/70">Version: {{ status.version | default('N/A') }}</p>
                                            {% if status.url %}
                                                <p class="text-xs text-base-content/60">URL: {{ status.url }}</p>
                                            {% endif %}
                                        {% else %}
                                            <p class="text-sm"><strong class="text-error">Offline</strong></p>
                                            <p class="text-xs text-base-content/70" title="{{ status.error_message | default('Could not connect.') }}">
                                                {{ status.error_message | default('Could not connect.') | truncate(100, True) }}
                                            </p>
                                        {% endif %}
                                    </div>
                                    <div class="flex-none flex gap-2">
                                        <a href="{{ url_for('plugin_management.edit_server', plugin_id=status.service_type, server_id=status.server_id) }}" 
                                           class="btn btn-xs btn-outline btn-ghost" 
                                           title="Configure Server">
                                            <i class="fa-solid fa-sliders"></i>
                                        </a>
                                        {% if status.online and status.url %}
                                            <a href="{{ status.url }}" 
                                               target="_blank" 
                                               class="btn btn-xs btn-outline btn-ghost" 
                                               title="Open Server">
                                                <i class="fa-solid fa-external-link-alt"></i>
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% elif server_status and server_status.all_statuses %}
            {# Fallback to old format if servers_by_service is not available #}
            <div class="space-y-4">
                {% for status in server_status.all_statuses %}
                <div class="p-3 border border-base-300 rounded-lg">
                    <div class="flex flex-row gap-3 items-center">
                        <div class="self-start p-2 rounded-md {{ 'bg-success/20 text-success' if status.online else 'bg-error/20 text-error' }}">
                            <i class="fa-solid fa-server fa-lg"></i>
                        </div>
                        <div class="flex-grow">
                            <h4 class="font-semibold">{{ status.name }}</h4>
                            {% if status.online %}
                                <p class="text-sm"><strong class="text-success">Online</strong> - {{ status.actual_server_name | default(status.name) }}</p>
                                <p class="text-xs text-base-content/70">Version: {{ status.version | default('N/A') }}</p>
                            {% else %}
                                <p class="text-sm"><strong class="text-error">Offline</strong></p>
                                <p class="text-xs text-base-content/70" title="{{ status.error_message | default('Could not connect.') }}">
                                    {{ status.error_message | default('Could not connect.') | truncate(100, True) }}
                                </p>
                            {% endif %}
                        </div>
                        <div class="flex-none">
                             <a href="{{ url_for('plugin_management.edit_server', plugin_id=status.service_type, server_id=status.server_id) }}" class="btn btn-xs btn-outline btn-ghost">
                                <i class="fa-solid fa-sliders"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-8">
                <i class="fa-solid fa-server fa-3x text-base-content/30 mb-4"></i>
                <p class="text-lg text-base-content/70">No server statuses to display.</p>
                <p class="text-sm text-base-content/50">Configure your first media server to get started.</p>
            </div>
        {% endif %}
            
            <!-- Action Buttons -->
            <div class="flex items-center justify-end gap-3 mt-8 pt-6 border-t border-base-300">
                <button type="button" class="btn btn-ghost" onclick="all_servers_status_modal.close()">
                    <i class="fa-solid fa-times"></i>
                    Close
                </button>
                <a href="{{ url_for('plugin_management.index') }}" class="btn btn-primary gap-2">
                    <i class="fa-solid fa-cog"></i>
                    Manage Servers
                </a>
            </div>
        </div>
    </div>
</dialog>