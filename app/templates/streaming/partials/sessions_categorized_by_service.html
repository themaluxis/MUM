{# File: app/templates/streaming/partials/sessions_categorized_by_service.html #}
{# Expects 'sessions_by_service' (dict) AND 'summary_stats' (dict) in context #}

{# --- Overall Summary Statistics Line --- #}
{% if summary_stats %}
<div class="text-sm text-base-content/80 mb-4 pb-3 border-b border-base-300/40">
    <i class="fa-solid fa-globe fa-fw mr-1"></i>
    <strong>Overall Activity:</strong> {{ summary_stats.total_streams }} stream{{ 's' if summary_stats.total_streams != 1 else '' }}
    {% if summary_stats.total_streams > 0 %}
        ({{ summary_stats.direct_play_count }} direct play, {{ summary_stats.transcode_count }} transcode)
        | Bandwidth: {{ summary_stats.total_bandwidth_mbps }} Mbps
        (LAN: {{ summary_stats.lan_bandwidth_mbps }} Mbps, WAN: {{ summary_stats.wan_bandwidth_mbps }} Mbps)
    {% endif %}
    <i class="fa-solid fa-info-circle fa-xs ml-1 text-base-content/50" title="Bandwidth is an estimate based on current stream bitrates."></i>
</div>
{% endif %}
{# --- End Overall Summary Statistics Line --- #}

{% if sessions_by_service and sessions_by_service|length > 0 %}
    {% for service_name, service_data in sessions_by_service.items() %}
        <div class="mb-6">
            {# Service Header with Stats #}
            <div class="flex flex-col sm:flex-row sm:items-center mb-3">
                <h3 class="text-lg font-semibold flex items-center mb-1 sm:mb-0 sm:mr-2">
                    {% if service_data.service_type == 'plex' %}
                        <i class="fa-solid fa-play mr-2 text-primary"></i>
                    {% elif service_data.service_type == 'jellyfin' %}
                        <i class="fa-solid fa-film mr-2 text-primary"></i>
                    {% elif service_data.service_type == 'emby' %}
                        <i class="fa-solid fa-video mr-2 text-primary"></i>
                    {% else %}
                        <i class="fa-solid fa-cogs mr-2 text-primary"></i>
                    {% endif %}
                    {{ service_name }}
                </h3>
                <div class="text-sm text-base-content/70">
                    <i class="fa-solid fa-chart-line fa-fw mr-1"></i>
                    <strong>Activity:</strong> {{ service_data.stats.total_streams }} stream{{ 's' if service_data.stats.total_streams != 1 else '' }}
                    {% if service_data.stats.total_streams > 0 %}
                        ({{ service_data.stats.direct_play_count }} direct play, {{ service_data.stats.transcode_count }} transcode)
                        | {{ service_data.stats.total_bandwidth_mbps }} Mbps
                        (LAN: {{ service_data.stats.lan_bandwidth_mbps }}, WAN: {{ service_data.stats.wan_bandwidth_mbps }})
                    {% endif %}
                </div>
            </div>

            {# Service Sessions Grid #}
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-4 pl-4 border-l-2 border-primary/30">
                {% for session in service_data.sessions %}
                <div class="card bg-base-200 shadow-lg w-full max-w-md relative group" tabindex="0">
                    <div class="absolute top-2 right-2 z-10 flex space-x-1
                                opacity-0 pointer-events-none 
                                transition-opacity duration-200 
                                group-hover:opacity-100 group-hover:pointer-events-auto 
                                group-focus:opacity-100 group-focus:pointer-events-auto">
                        
                        <button type="button" class="btn btn-xs btn-circle btn-info" 
                                title="Show Raw Data"
                                onclick="document.getElementById('rawDataModal-{{ session.session_key }}').showModal()">
                            <i class="fa-solid fa-info"></i>
                        </button>

                        {% if current_user.has_permission('kill_stream') and session.session_key %}
                        <button class="btn btn-xs btn-circle btn-error"
                                title="Terminate Session"
                                onclick='openTerminateSessionModal({{ session.session_key | tojson }}, {{ session.user | tojson }}, {{ session.media_title | tojson }}, {{ session.service_type | tojson }}, {{ session.server_name | tojson }})'>
                            <i class="fa-solid fa-times"></i>
                        </button>
                        {% endif %}
                    </div>
                    
                    <div class="card-body p-3">
                        {# Main Flex Container: Poster | Details #}
                        <div class="flex items-start space-x-3">
                            {# Poster Column #}
                            <div class="avatar flex-shrink-0">
                                <div class="w-16 h-24 rounded">
                                    {% if session.thumb_url %}
                                        <img src="{{ session.thumb_url }}" alt="{{ session.media_title }} Poster" 
                                             onerror="this.onerror=null; this.src='{{ url_for('static', filename='img/default_media_thumb.png') }}';" 
                                             class="object-cover w-full h-full"/>
                                    {% else %}
                                        <div class="w-full h-full bg-base-300 flex flex-col items-center justify-center text-xs text-base-content/50">
                                           <i class="fa-regular fa-image fa-2x mb-1"></i> No Poster Available
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            {# Details Column #}
                            <div class="flex-1 min-w-0">
                                {# Title and Year #}
                                <h3 class="font-semibold text-sm leading-tight mb-1 line-clamp-2" title="{{ session.media_title }}">
                                    {{ session.media_title }}
                                    {% if session.year %}<span class="text-xs text-base-content/60">({{ session.year }})</span>{% endif %}
                                </h3>

                                {# User and Player Info #}
                                <div class="text-xs text-base-content/70 mb-2 space-y-1">
                                    <div class="flex items-center">
                                        {% if session.user_avatar_url %}
                                            <div class="avatar avatar-xs mr-2">
                                                <div class="w-4 h-4 rounded-full">
                                                    <img src="{{ session.user_avatar_url }}" alt="{{ session.user }} avatar" 
                                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                                    {# Jellyfin fallback avatar with service color #}
                                                    <div class="bg-purple-500 text-white w-4 h-4 rounded-full flex items-center justify-center text-xs font-bold" style="display: none;">
                                                        {{ session.user[0]|upper if session.user else 'U' }}
                                                    </div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <i class="fa-solid fa-user fa-fw mr-1 text-info"></i>
                                        {% endif %}
                                        <span class="truncate">{{ session.user }}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fa-solid fa-tv fa-fw mr-1 text-info"></i>
                                        <span class="truncate">{{ session.player_title }}</span>
                                    </div>
                                </div>

                                {# Progress Bar #}
                                <div class="mb-2">
                                    <div class="flex justify-between items-center text-xs mb-1">
                                        <span class="text-base-content/60">{{ session.state }}</span>
                                        <span class="text-base-content/60">{{ session.progress }}%</span>
                                    </div>
                                    <progress class="progress progress-primary w-full h-1" value="{{ session.progress }}" max="100"></progress>
                                </div>

                                {# Stream Quality Badge #}
                                <div class="flex flex-wrap gap-1">
                                    {% if session.is_transcode_calc %}
                                        <div class="badge badge-warning badge-xs">Transcode</div>
                                    {% else %}
                                        <div class="badge badge-success badge-xs">Direct Play</div>
                                    {% endif %}
                                    <div class="badge badge-outline badge-xs">{{ session.quality_detail }}</div>
                                    <div class="badge badge-outline badge-xs">{{ session.location_type_calc }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {# Raw Data Modal for this session #}
                <dialog id="rawDataModal-{{ session.session_key }}" class="modal modal-bottom sm:modal-middle">
                    <div class="modal-box max-w-5xl bg-base-100 border border-base-300 shadow-2xl p-0">
                        <!-- Header -->
                        <div class="flex items-center justify-between p-6 border-b border-base-300">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-secondary/20 flex items-center justify-center">
                                    <i class="fa-solid fa-code text-secondary text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-semibold text-base-content">Raw Session Data</h3>
                                    <p class="text-sm text-base-content/60">Debug information and raw service data</p>
                                </div>
                            </div>
                            <form method="dialog">
                                <button class="btn btn-sm btn-circle btn-ghost hover:bg-base-200">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                            </form>
                        </div>

                        <!-- Content -->
                        <div class="p-6">
                            <!-- Session Info Card -->
                            <div class="bg-base-200/50 rounded-lg p-4 mb-6 border border-base-300">
                                <div class="flex items-start gap-3">
                                    <div class="w-8 h-8 rounded-full bg-info/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                        <i class="fa-solid fa-play text-info text-sm"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-medium text-base-content mb-1">Session Information</h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                                            <div><span class="text-base-content/60">User:</span> <span class="font-mono">{{ session.user }}</span></div>
                                            <div><span class="text-base-content/60">Player:</span> <span class="font-mono">{{ session.player_title }}</span></div>
                                            <div><span class="text-base-content/60">Media:</span> <span class="font-mono">{{ session.media_title }}</span></div>
                                            <div><span class="text-base-content/60">Session Key:</span> <span class="font-mono text-xs">{{ session.session_key }}</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Raw Data Section -->
                            <div class="space-y-4 mb-6">
                                <h4 class="font-medium text-base-content text-lg mb-3">
                                    <i class="fa-solid fa-code text-secondary text-sm mr-2"></i>
                                    Raw Data Output
                                </h4>
                                
                                <div class="bg-base-200/30 rounded-lg border border-base-300/30 hover:border-base-300/60 transition-colors">
                                    <div class="flex items-center justify-between p-3 border-b border-base-300/30 bg-base-200/50">
                                        <div class="flex items-center gap-2">
                                            <i class="fa-solid fa-file-code text-info text-sm"></i>
                                            <span class="font-medium text-sm">JSON Data</span>
                                        </div>
                                        <div class="text-xs text-base-content/60">
                                            Size: {{ session.raw_data_json|length }} characters
                                        </div>
                                    </div>
                                    <div class="p-4">
                                        <div class="bg-base-100 rounded-lg p-4 max-h-96 overflow-auto border border-base-300/30">
                                            <pre id="rawDataContent-{{ session.session_key }}" class="text-xs whitespace-pre-wrap break-words font-mono text-base-content"><code>{{ session.raw_data_json }}</code></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex items-center justify-end gap-3 mt-8 pt-6 border-t border-base-300">
                                <button type="button" class="btn btn-ghost" onclick="document.getElementById('rawDataModal-{{ session.session_key }}').close()">
                                    Close
                                </button>
                                <button type="button" class="btn btn-secondary gap-2" onclick="copyRawData('rawDataModal-{{ session.session_key }}')">
                                    <i class="fa-solid fa-copy"></i>
                                    Copy to Clipboard
                                </button>
                            </div>
                        </div>
                    </div>
                </dialog>
                {% endfor %}
            </div>
        </div>
    {% endfor %}
{% else %}
    <div class="text-center py-10">
        <i class="fa-solid fa-play-circle fa-3x text-base-content/30 mb-4"></i>
        <h3 class="text-lg font-semibold text-base-content/70 mb-2">No Active Streams</h3>
        <p class="text-base-content/50">There are currently no active streaming sessions across any services.</p>
    </div>
{% endif %}