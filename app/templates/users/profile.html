<!-- File: app/templates/users/profile.html -->
{% extends "base.html" %}

{% block title %}{{ super() }} - {{ title }}{% endblock %}

{% block content %}
{# Determine service-specific background tint similar to user cards #}
{% set service_types = user_service_types.get(user.id, []) %}
{% set primary_service = service_types[0] if service_types else None %}
{% if primary_service %}
    {% if primary_service.value == 'plex' %}
        {% set content_bg_class = "bg-gradient-to-br from-base-100 to-plex/5" %}
    {% elif primary_service.value == 'jellyfin' %}
        {% set content_bg_class = "bg-gradient-to-br from-base-100 to-jellyfin/5" %}
    {% elif primary_service.value == 'emby' %}
        {% set content_bg_class = "bg-gradient-to-br from-base-100 to-emby/5" %}
    {% elif primary_service.value == 'kavita' %}
        {% set content_bg_class = "bg-gradient-to-br from-base-100 to-kavita/5" %}
    {% elif primary_service.value == 'audiobookshelf' %}
        {% set content_bg_class = "bg-gradient-to-br from-base-100 to-audiobookshelf/5" %}
    {% elif primary_service.value == 'komga' %}
        {% set content_bg_class = "bg-gradient-to-br from-base-100 to-komga/5" %}
    {% elif primary_service.value == 'romm' %}
        {% set content_bg_class = "bg-gradient-to-br from-base-100 to-romm/5" %}
    {% else %}
        {% set content_bg_class = "bg-base-100" %}
    {% endif %}
{% else %}
    {% set content_bg_class = "bg-base-100" %}
{% endif %}

<div class="container mx-auto px-4 py-2 max-w-5xl">
    <div class="{{ content_bg_class }} rounded-lg shadow-lg p-6 min-h-screen">
    <div class="flex items-center mb-2">
        {% set back_url = request.args.get('back') %}
        {% set back_view = request.args.get('back_view') %}
        {% if back_url == 'streaming' %}
            <a href="{{ url_for('streaming.index') }}" class="btn btn-ghost btn-sm mr-4">
                <i class="fa-solid fa-arrow-left"></i> Back to Streaming
            </a>
        {% elif back_url == 'users' %}
            {% if back_view %}
                <a href="{{ url_for('users.list_users', view=back_view) }}" class="btn btn-ghost btn-sm mr-4">
                    <i class="fa-solid fa-arrow-left"></i> Back to Users
                </a>
            {% else %}
                <a href="{{ url_for('users.list_users') }}" class="btn btn-ghost btn-sm mr-4">
                    <i class="fa-solid fa-arrow-left"></i> Back to Users
                </a>
            {% endif %}
        {% else %}
            <a href="{{ url_for('users.list_users') }}" class="btn btn-ghost btn-sm mr-4">
                <i class="fa-solid fa-arrow-left"></i> Back to Users
            </a>
        {% endif %}
    </div>

    {# --- User Header section --- #}
    <div class="flex items-center space-x-4 p-4">
        <div class="avatar">
            <div class="w-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                {# Use service-aware avatar logic similar to user cards #}
                {% set avatar_url = user.get_avatar(url_for('static', filename='img/default_avatar.png')) %}
                {% set service_types = user_service_types.get(user.id, []) %}
                {% set primary_service = service_types[0] if service_types else None %}
                
                {# Check if this is a Jellyfin user and try to get their avatar #}
                {% if primary_service and primary_service.value == 'jellyfin' and user.raw_service_data and user.raw_service_data.startswith('{') %}
                    {# Extract Jellyfin user info using the custom filter #}
                    {% set jellyfin_info = user.raw_service_data | extract_jellyfin_user_info %}
                    {% if jellyfin_info[0] and jellyfin_info[1] %}
                        {% set jellyfin_avatar_url = url_for('api.jellyfin_user_avatar_proxy', user_id=jellyfin_info[0]) %}
                        <img src="{{ jellyfin_avatar_url }}" alt="{{ user.get_display_name() }} avatar" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                        {# Jellyfin fallback avatar with purple theme #}
                        <div class="bg-jellyfin text-white w-24 h-24 rounded-full flex items-center justify-center text-5xl font-normal" style="display: none;">
                            {{ user.get_display_name()[0]|upper if user.get_display_name() else 'U' }}
                        </div>
                    {% else %}
                        {# No Jellyfin user ID found, show purple fallback directly #}
                        <div class="bg-jellyfin text-white w-24 h-24 rounded-full flex items-center justify-center text-5xl font-normal">
                            {{ user.get_display_name()[0]|upper if user.get_display_name() else 'U' }}
                        </div>
                    {% endif %}
                {# Check if this is a Kavita user and show fallback avatar #}
                {% elif primary_service and primary_service.value == 'kavita' %}
                    {# Kavita users don't have avatars, show fallback with Kavita theme color #}
                    <div class="bg-kavita text-white w-24 h-24 rounded-full flex items-center justify-center text-5xl font-normal">
                        {{ user.get_display_name()[0]|upper if user.get_display_name() else 'K' }}
                    </div>
                {% else %}
                    <img src="{{ avatar_url }}" alt="{{ user.get_display_name() }} avatar" />
                {% endif %}
            </div>
        </div>
        <div>
            <h1 class="text-4xl font-bold">{{ user.get_display_name() }}</h1>            
        </div>
    </div>

    <div class="overflow-x-auto">
        <div role="tablist" class="tabs tabs-border mt-2 whitespace-nowrap flex-nowrap">
            {% set tab_params = {} %}
            {% if request.args.get('back') %}{% set _ = tab_params.update({'back': request.args.get('back')}) %}{% endif %}
            {% if request.args.get('back_view') %}{% set _ = tab_params.update({'back_view': request.args.get('back_view')}) %}{% endif %}
            <a role="tab" href="{{ url_for('user.view_user', user_id=user.id, tab='profile', **tab_params) }}" class="tab {{ 'tab-active' if active_tab == 'profile' else '' }}">Profile</a>
            <a role="tab" href="{{ url_for('user.view_user', user_id=user.id, tab='history', **tab_params) }}" class="tab {{ 'tab-active' if active_tab == 'history' else '' }}">History</a>
            <a role="tab" href="{{ url_for('user.view_user', user_id=user.id, tab='settings', **tab_params) }}" class="tab {{ 'tab-active' if active_tab == 'settings' else '' }}">Settings</a>
        </div>
    </div>

    {# --- Tab Content --- #}
    <div class="py-6">
        {% if active_tab == 'profile' %}
            {% include 'users/partials/profile_tab.html' %}
        {% elif active_tab == 'history' %}
            {% include 'users/partials/history_tab.html' %}
        {% elif active_tab == 'settings' %}
            {% include 'users/partials/settings_tab.html' %}
        {% endif %}
    </div>
    </div> {# Close content container #}
</div>
{% endblock %}