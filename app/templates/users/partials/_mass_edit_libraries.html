<div id="mass_edit_libraries_content">
    {% if not services_data %}
        <div class="alert alert-warning">Could not find server information for the selected users.</div>
    {% else %}
        {% for service_key, service_info in services_data.items() %}
            <details class="collapse collapse-arrow bg-base-200 border border-base-300 rounded-md mb-3" open>
                <summary class="collapse-title text-lg font-medium">
                    {{ service_info.service_name }}
                </summary>
                <div class="collapse-content">
                    {% for server_id, data in service_info.servers.items() %}
                        <div class="mb-6 p-4 border border-base-300 rounded-lg card-body">
                            <h4 class="font-bold text-md mb-2 border-b border-base-300 pb-2">
                                <i class="fa-solid fa-server mr-2"></i>{{ data.server_name }}
                            </h4>
                            <p class="text-xs text-base-content/70 mb-2">
                                Applies to users: {% for user in data.users %}{{ user.get_display_name() }}{% if not loop.last %}, {% endif %}{% endfor %}
                            </p>
                            <div class="max-h-48 overflow-y-auto p-2 border border-base-300 rounded-md grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1">
                                {% for library in data.libraries %}
                                    <label class="label cursor-pointer justify-start mb-1">
                                        <input type="checkbox" name="libraries_server_{{ server_id }}" value="{{ library.id }}" 
                                               class="checkbox checkbox-primary mr-2"
                                               {% if library.id in data.current_library_ids %}checked{% endif %}>
                                        <span class="label-text">{{ library.name }}</span>
                                    </label>
                                {% else %}
                                    <span class="text-sm italic text-base-content/70">No libraries found for this server.</span>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </details>
        {% endfor %}
    {% endif %}
</div>
