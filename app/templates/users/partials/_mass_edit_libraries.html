<div id="mass_edit_libraries_content">
    {% if not services_data %}
        <div class="alert alert-warning">Could not find server information for the selected users.</div>
    {% else %}
        {% for service_key, service_info in services_data.items() %}
            <details class="collapse collapse-arrow bg-base-200 border border-base-300 rounded-md mb-3" open>
                <summary class="collapse-title text-lg font-medium flex items-center">
                    {% if service_key.lower() == 'plex' %}
                        <svg class="w-6 h-6 inline-block text-plex mr-2" viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="transparent" stroke-linejoin="round" stroke-width="12"><path d="M22 25.5h48L116 94l-46 68.5H22L68.5 94Zm109.8 56L108 46l14-20.5h48zm-.3 23.5c10.979 17.625 25.52 38.875 38.5 49.5-11.149 13.635-34.323 32.278-62.5-14z"/></svg>
                    {% elif service_key.lower() == 'jellyfin' %}
                        <i class="fa-solid fa-cube text-jellyfin mr-2"></i>
                    {% endif %}
                    {{ service_info.service_name }}
                </summary>
                <div class="collapse-content">
                    {% for server_id, data in service_info.servers.items() %}
                        <div class="mb-6 p-4 border border-base-300 rounded-lg card-body">
                            <h4 class="font-bold text-md mb-2 border-b border-base-300 pb-2">
                                <i class="fa-solid fa-server mr-2"></i>{{ data.server_name }}
                            </h4>
                            <p class="text-xs text-base-content/70 mb-2">
                                Applies to users: {% for user in data.users %}{{ user }}{% if not loop.last %}, {% endif %}{% endfor %}
                            </p>
                            <div class="max-h-48 overflow-y-auto p-2 border border-base-300 rounded-md grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1">
                                {% for library in data.libraries %}
                                    <label class="label cursor-pointer justify-start mb-1">
                                        <input type="checkbox" name="libraries_server_{{ server_id }}" value="{{ library.id }}" 
                                               class="checkbox checkbox-primary mr-2"
                                               {% if library.id in data.current_library_ids %}checked{% endif %}>
                                        <span class="label-text">{{ library.name }}</span>
                                    </label>
                                {% else %}
                                    <span class="text-sm italic text-base-content/70">No libraries found for this server.</span>
                                {% endfor %}
                            </div>
                            
                            {# Downloads toggle for this server #}
                            <div class="mt-4 p-3 bg-base-100 rounded-lg border border-base-300">
                                <div class="form-control">
                                    <label class="label cursor-pointer justify-start">
                                        <input type="checkbox" name="downloads_server_{{ server_id }}" value="1" 
                                               class="toggle toggle-accent mr-3"
                                               {% if data.current_downloads_enabled %}checked{% endif %}>
                                        <span class="label-text font-medium">
                                            <i class="fa-solid fa-download mr-2 text-accent"></i>Enable Downloads
                                        </span>
                                    </label>
                                    <div class="label">
                                        <span class="label-text-alt text-xs">Allow users to download/sync content from this server</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </details>
        {% endfor %}
    {% endif %}
</div>
