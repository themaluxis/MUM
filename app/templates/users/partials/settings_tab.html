{# Expects 'form' and 'user' in context #}
{% set form_params = {'user_id': user.id, 'tab': 'settings'} %}
{% if request.args.get('back') %}{% set _ = form_params.update({'back': request.args.get('back')}) %}{% endif %}
{% if request.args.get('back_view') %}{% set _ = form_params.update({'back_view': request.args.get('back_view')}) %}{% endif %}

<form method="POST"
      id="editUserForm"
      hx-post="{{ url_for('user.view_user', **form_params) }}"
      hx-target="#editUserForm"
      hx-swap="outerHTML">
      
    <div class="space-y-6">
        <!-- Notes & Whitelists Section -->
        <div class="space-y-4">
            <h4 class="font-medium text-base-content text-lg mb-3">
                <i class="fa-solid fa-sticky-note text-info text-sm mr-2"></i>
                Notes & Whitelists
            </h4>
            
            <!-- Notes Card -->
            <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/30 hover:border-base-300/60 transition-colors">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fa-solid fa-note-sticky text-info text-sm"></i>
                    <h5 class="font-medium text-base-content">{{ form.notes.label.text }}</h5>
                </div>
                {{ form.notes(class="textarea textarea-bordered h-24 w-full bg-base-100 " + ("textarea-error" if form.notes.errors else ""), placeholder="Add any notes about this user...") }}
                {% if form.notes.errors %}
                    {% for error in form.notes.errors %}
                        <p class="text-error text-xs mt-2">{{ error }}</p>
                    {% endfor %}
                {% else %}
                    <p class="text-xs text-base-content/60 mt-2">Add administrative notes or comments about this user</p>
                {% endif %}
            </div>

            <!-- Discord Bot Whitelist Card -->
            <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/30 hover:border-base-300/60 transition-colors">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="flex justify-between mb-1">
                            <div class="flex items-center gap-2">
                                <i class="fa-brands fa-discord text-primary text-sm"></i>
                                <h5 class="font-medium text-base-content">{{ form.is_discord_bot_whitelisted.label.text }}</h5>
                            </div>
                            {{ form.is_discord_bot_whitelisted(class="toggle toggle-primary") }}
                        </div>
                        <p class="text-sm text-base-content/60">{{ form.is_discord_bot_whitelisted.description }}</p>
                    </div>
                </div>
            </div>

            <!-- Purge Whitelist Card -->
            <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/30 hover:border-base-300/60 transition-colors">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="flex justify-between mb-1">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-shield-halved text-accent text-sm"></i>
                                <h5 class="font-medium text-base-content">{{ form.is_purge_whitelisted.label.text }}</h5>
                            </div>
                            {{ form.is_purge_whitelisted(class="toggle toggle-accent") }}
                        </div>
                        <p class="text-sm text-base-content/60">{{ form.is_purge_whitelisted.description }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stream Permissions Section -->
        <div class="space-y-4">
            <h4 class="font-medium text-base-content text-lg mb-3">
                <i class="fa-solid fa-play text-primary text-sm mr-2"></i>
                Stream Permissions
            </h4>

            <!-- Downloads Permission Card (Disabled) -->
            <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/30 opacity-60 relative">
                <div class="absolute top-2 right-2">
                    <div class="tooltip tooltip-left" data-tip="This setting can't be changed here due to a Plex API limitation. Please update 'Allow Sync' directly in Plex for now.">
                        <i class="fa-solid fa-info-circle text-warning text-sm"></i>
                    </div>
                </div>
                <div class="flex items-center justify-between pointer-events-none">
                    <div class="flex-1">
                        <div class="flex justify-between mb-1">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-download text-accent text-sm opacity-50"></i>
                                <h5 class="font-medium text-base-content">{{ form.allow_downloads.label.text }}</h5>
                            </div>
                            {{ form.allow_downloads(class="toggle toggle-primary", disabled=True) }}
                        </div>
                        <p class="text-sm text-base-content/60">{{ form.allow_downloads.description }}</p>
                    </div>
                </div>
            </div>

            <!-- 4K Transcode Permission Card -->
            <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/30 hover:border-base-300/60 transition-colors">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="flex justify-between mb-1">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-film text-primary text-sm"></i>
                                <h5 class="font-medium text-base-content">{{ form.allow_4k_transcode.label.text }}</h5>
                            </div>
                            {{ form.allow_4k_transcode(class="toggle toggle-primary") }}
                        </div>
                        <p class="text-sm text-base-content/60">{{ form.allow_4k_transcode.description }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Access Duration Section -->
        <div class="space-y-4">
            <h4 class="font-medium text-base-content text-lg mb-3">
                <i class="fa-solid fa-calendar-clock text-warning text-sm mr-2"></i>
                Access Duration
            </h4>

            <!-- Access Expiration Card -->
            <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/30 hover:border-base-300/60 transition-colors">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fa-solid fa-calendar text-warning text-sm"></i>
                    <h5 class="font-medium text-base-content">{{ form.access_expiration.label.text }}</h5>
                </div>
                <div class="max-w-sm">
                    {{ form.access_expiration(id="user_edit_access_expiration_input", class="input input-bordered w-full bg-base-100 " + ("input-error" if form.access_expiration.errors else "")) }}
                    {% if form.access_expiration.errors %}
                        {% for error in form.access_expiration.errors %}
                            <p class="text-error text-xs mt-2">{{ error }}</p>
                        {% endfor %}
                    {% else %}
                        <p class="text-xs text-base-content/60 mt-2">{{ form.access_expiration.description }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Clear Expiration Card -->
            <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/30 hover:border-base-300/60 transition-colors">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="flex justify-between mb-1">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-times-circle text-warning text-sm"></i>
                                <h5 class="font-medium text-base-content">{{ form.clear_access_expiration.label.text }}</h5>
                            </div>
                            {{ form.clear_access_expiration(class="checkbox checkbox-warning", id="user_edit_clear_access_expiration_checkbox") }}
                        </div>
                        <p class="text-sm text-base-content/60">Remove any existing access expiration date</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Library Access Section -->
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <h4 class="font-medium text-base-content text-lg">
                    <i class="fa-solid fa-books text-accent text-sm mr-2"></i>
                    Library Access
                </h4>
                <div class="flex gap-2">
                    <button type="button" id="select_all_libraries" class="btn btn-xs btn-outline btn-accent">
                        <i class="fa-solid fa-check-double text-xs mr-1"></i>
                        Select All
                    </button>
                    <button type="button" id="deselect_all_libraries" class="btn btn-xs btn-outline">
                        <i class="fa-solid fa-times text-xs mr-1"></i>
                        Clear All
                    </button>
                </div>
            </div>

            <!-- Libraries Card -->
            <div class="bg-base-200/30 rounded-lg border border-base-300/30">
                <div class="flex items-center justify-between p-3 border-b border-base-300/30 bg-base-200/50">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-list-check text-accent text-sm"></i>
                        <span class="font-medium text-sm">Available Libraries</span>
                    </div>
                    <div class="text-xs text-base-content/60">
                        {{ form.libraries.choices|length }} libraries available
                    </div>
                </div>
                <div class="p-4">
                    <div class="max-h-80 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                        {% for subfield in form.libraries %}
                            <label class="flex items-center gap-3 p-2 rounded hover:bg-base-200/50 transition-colors cursor-pointer">
                                {{ subfield(class="checkbox checkbox-primary checkbox-sm library-checkbox") }}
                                <span class="text-sm text-base-content">{{ subfield.label.text }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center justify-end gap-3 mt-8 pt-6 border-t border-base-300">
            {{ form.submit(class="btn btn-primary gap-2") }}
        </div>
    </div>
</form>

<script>
(function () {
    const selectAllButton = document.getElementById('select_all_libraries');
    const deselectAllButton = document.getElementById('deselect_all_libraries');
    // Important: scope the checkbox query to the form to avoid conflicts if other forms exist
    const editUserForm = document.getElementById('editUserForm');
    if (!editUserForm) return;

    const libraryCheckboxes = editUserForm.querySelectorAll('.library-checkbox');
    if (selectAllButton) { selectAllButton.addEventListener('click', function() { libraryCheckboxes.forEach(checkbox => checkbox.checked = true); }); }
    if (deselectAllButton) { deselectAllButton.addEventListener('click', function() { libraryCheckboxes.forEach(checkbox => checkbox.checked = false); }); }

    const dateInput = document.getElementById('user_edit_access_expiration_input');
    const clearCheckbox = document.getElementById('user_edit_clear_access_expiration_checkbox');

    function syncExpiryFields() {
        if (!dateInput || !clearCheckbox) return;
        if (clearCheckbox.checked) {
            dateInput.disabled = true;
            dateInput.value = '';
        } else {
            dateInput.disabled = false;
        }
    }

    if (clearCheckbox) {
        clearCheckbox.addEventListener('change', syncExpiryFields);
    }

    // Run once on load to set initial state
    syncExpiryFields();
})();
</script>
