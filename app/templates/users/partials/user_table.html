<!-- File: app/templates/users/_users_table.html -->
{# Expects 'users', 'available_libraries', 'sort_column', 'sort_direction' #}
<div class="overflow-x-auto bg-base-200 shadow-lg rounded-lg">
    <table class="table table-zebra w-full table-sm md:table-md">
        <thead>
            <tr>
                <th class="w-10 text-center">
                    <label title="Select all visible">
                        <input type="checkbox" class="checkbox checkbox-primary checkbox-xs sm:checkbox-sm" id="select_all_users_table" />
                    </label>
                </th>

                {% set query_params = request.args.to_dict() %}
                
                {% set next_sort_user = 'username_desc' if sort_column == 'username' and sort_direction == 'asc' else 'username_asc' %}
                {% do query_params.update({'sort_by': next_sort_user}) %}
                <th data-col="user"><a href="{{ url_for('users.list_users', **query_params) }}" hx-get="{{ url_for('users.list_users', **query_params) }}" hx-target="#user-list-container" hx-swap="innerHTML" hx-push-url="true" class="link link-hover">User {% if sort_column == 'username' %}<i class="fa-solid fa-sort-{{ 'down' if sort_direction == 'desc' else 'up' }} ml-1"></i>{% endif %}</a></th>
                
                <th data-col="email">Email</th>

                {% set next_sort_join_date = 'plex_join_date_desc' if sort_column == 'plex_join_date' and sort_direction == 'asc' else 'plex_join_date_asc' %}
                {% do query_params.update({'sort_by': next_sort_join_date}) %}
                <th data-col="plex_join_date"><a href="{{ url_for('users.list_users', **query_params) }}" hx-get="{{ url_for('users.list_users', **query_params) }}" hx-target="#user-list-container" hx-swap="innerHTML" hx-push-url="true" class="link link-hover">Service Join Date {% if sort_column == 'plex_join_date' %}<i class="fa-solid fa-sort-{{ 'down' if sort_direction == 'desc' else 'up' }} ml-1"></i>{% endif %}</a></th>

                <th data-col="last_known_ip">Last Known IP</th>

                {% set next_sort_plays = 'total_plays_desc' if sort_column == 'total_plays' and sort_direction == 'asc' else 'total_plays_asc' %}
                {% do query_params.update({'sort_by': next_sort_plays}) %}
                <th data-col="total_plays"><a href="{{ url_for('users.list_users', **query_params) }}" hx-get="{{ url_for('users.list_users', **query_params) }}" hx-target="#user-list-container" hx-swap="innerHTML" hx-push-url="true" class="link link-hover">Total Plays {% if sort_column == 'total_plays' %}<i class="fa-solid fa-sort-{{ 'down' if sort_direction == 'desc' else 'up' }} ml-1"></i>{% endif %}</a></th>
                
                {% set next_sort_duration = 'total_duration_desc' if sort_column == 'total_duration' and sort_direction == 'asc' else 'total_duration_asc' %}
                {% do query_params.update({'sort_by': next_sort_duration}) %}
                <th data-col="total_duration"><a href="{{ url_for('users.list_users', **query_params) }}" hx-get="{{ url_for('users.list_users', **query_params) }}" hx-target="#user-list-container" hx-swap="innerHTML" hx-push-url="true" class="link link-hover">Total Duration {% if sort_column == 'total_duration' %}<i class="fa-solid fa-sort-{{ 'down' if sort_direction == 'desc' else 'up' }} ml-1"></i>{% endif %}</a></th>
                
                <th data-col="status">Status</th>
                
                <th data-col="libraries">Libraries</th>
                
                {% set next_sort_streamed = 'last_streamed_desc' if sort_column == 'last_streamed' and sort_direction == 'asc' else 'last_streamed_asc' %}
                {% do query_params.update({'sort_by': next_sort_streamed}) %}
                <th data-col="last_streamed"><a href="{{ url_for('users.list_users', **query_params) }}" hx-get="{{ url_for('users.list_users', **query_params) }}" hx-target="#user-list-container" hx-swap="innerHTML" hx-push-url="true" class="link link-hover">Last Streamed {% if sort_column == 'last_streamed' %}<i class="fa-solid fa-sort-{{ 'down' if sort_direction == 'desc' else 'up' }} ml-1"></i>{% endif %}</a></th>
                
                {% set next_sort_created_at = 'created_at_desc' if sort_column == 'created_at' and sort_direction == 'asc' else 'created_at_asc' %}
                {% do query_params.update({'sort_by': next_sort_created_at}) %}
                <th data-col="mum_added_date"><a href="{{ url_for('users.list_users', **query_params) }}" hx-get="{{ url_for('users.list_users', **query_params) }}" hx-target="#user-list-container" hx-swap="innerHTML" hx-push-url="true" class="link link-hover">MUM Added Date {% if sort_column == 'created_at' %}<i class="fa-solid fa-sort-{{ 'down' if sort_direction == 'desc' else 'up' }} ml-1"></i>{% endif %}</a></th>
                
                <th data-col="last_played">Last Played</th>
                
                <th class="text-center" data-col="actions">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users.items %}
            {# Determine service color and classes for this user #}
            {% if user._user_type is defined and user._user_type == 'local' %}
                {# Local users use primary color #}
                {% set service_color = "var(--color-primary)" %}
                {% set service_bg_class = "primary" %}
                {% set primary_service = None %}
            {% else %}
                {# Service users use their service-specific colors #}
                {% set service_types = user_service_types.get(user.uuid, []) %}
                {% set primary_service = service_types[0] if service_types else None %}
                {% if primary_service %}
                    {% if primary_service.value == 'plex' %}
                        {% set service_color = "var(--color-plex)" %}
                        {% set service_bg_class = "plex" %}
                    {% elif primary_service.value == 'jellyfin' %}
                        {% set service_color = "var(--color-jellyfin)" %}
                        {% set service_bg_class = "jellyfin" %}
                    {% elif primary_service.value == 'emby' %}
                        {% set service_color = "var(--color-emby)" %}
                        {% set service_bg_class = "emby" %}
                    {% elif primary_service.value == 'kavita' %}
                        {% set service_color = "var(--color-kavita)" %}
                        {% set service_bg_class = "kavita" %}
                    {% elif primary_service.value == 'audiobookshelf' %}
                        {% set service_color = "var(--color-audiobookshelf)" %}
                        {% set service_bg_class = "audiobookshelf" %}
                    {% elif primary_service.value == 'komga' %}
                        {% set service_color = "var(--color-komga)" %}
                        {% set service_bg_class = "komga" %}
                    {% elif primary_service.value == 'romm' %}
                        {% set service_color = "var(--color-romm)" %}
                        {% set service_bg_class = "romm" %}
                    {% else %}
                        {% set service_color = "#6b7280" %}
                        {% set service_bg_class = "gray" %}
                    {% endif %}
                {% else %}
                    {% set service_color = "#6b7280" %}
                    {% set service_bg_class = "gray" %}
                {% endif %}
            {% endif %}
            <tr id="user-row-{{ user.uuid }}" class="hover:bg-base-300 user-row user-row-clickable cursor-pointer" data-user-id="{{ user.uuid }}" data-service-color="{{ service_color }}" data-service-class="{{ service_bg_class }}">
                <td class="text-center">
                    <input type="checkbox" class="checkbox checkbox-xs sm:checkbox-sm user-select-checkbox" data-user-id="{{ user.uuid }}" style="--input-color: {{ service_color }}; --chkfg: white;">
                </td>
                <td data-col="user">
                    <div class="flex items-center space-x-3">
                        <div class="avatar"><div class="w-10 h-10 rounded-full">
                            {# Use avatar_url processed in the backend #}
                            {% set avatar_url = user.avatar_url %}
                            
                            {% if avatar_url %}
                                <img src="{{ avatar_url }}" 
                                     alt="{{ user.get_display_name() }}"
                                     class="w-10 h-10 rounded-full object-cover"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <!-- Fallback colored avatar -->
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-white" style="display: none;
                                    {% if user._user_type is defined and user._user_type == 'local' %}background-color: hsl(var(--p));
                                    {% elif primary_service and primary_service.value == 'plex' %}background-color: var(--color-plex, #e5a00d);
                                    {% elif primary_service and primary_service.value == 'jellyfin' %}background-color: var(--color-jellyfin, #00a4dc);
                                    {% elif primary_service and primary_service.value == 'emby' %}background-color: var(--color-emby, #52b54b);
                                    {% elif primary_service and primary_service.value == 'kavita' %}background-color: var(--color-kavita, #f39c12);
                                    {% elif primary_service and primary_service.value == 'audiobookshelf' %}background-color: var(--color-audiobookshelf, #8b5cf6);
                                    {% elif primary_service and primary_service.value == 'komga' %}background-color: var(--color-komga, #3b82f6);
                                    {% elif primary_service and primary_service.value == 'romm' %}background-color: var(--color-romm, #ef4444);
                                    {% else %}background-color: #6b7280;{% endif %}">
                                    {{ user.get_display_name()[0]|upper if user.get_display_name() else 'U' }}
                                </div>
                            {% else %}
                                {# No avatar available, show colored initials #}
                                {% if user._user_type is defined and user._user_type == 'local' %}
                                    <div class="bg-primary text-white w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold">
                                        {{ user.get_display_name()[0]|upper if user.get_display_name() else 'L' }}
                                    </div>
                                {% elif primary_service and primary_service.value == 'plex' %}
                                    <div class="bg-plex text-white w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold">
                                        {{ user.get_display_name()[0]|upper if user.get_display_name() else 'P' }}
                                    </div>
                                {% elif primary_service and primary_service.value == 'jellyfin' %}
                                    <div class="bg-jellyfin text-white w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold">
                                        {{ user.get_display_name()[0]|upper if user.get_display_name() else 'J' }}
                                    </div>
                                {% elif primary_service and primary_service.value == 'emby' %}
                                    <div class="bg-emby text-white w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold">
                                        {{ user.get_display_name()[0]|upper if user.get_display_name() else 'E' }}
                                    </div>
                                {% elif primary_service and primary_service.value == 'kavita' %}
                                    <div class="bg-kavita text-white w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold">
                                        {{ user.get_display_name()[0]|upper if user.get_display_name() else 'K' }}
                                    </div>
                                {% elif primary_service and primary_service.value == 'audiobookshelf' %}
                                    <div class="bg-audiobookshelf text-white w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold">
                                        {{ user.get_display_name()[0]|upper if user.get_display_name() else 'A' }}
                                    </div>
                                {% elif primary_service and primary_service.value == 'komga' %}
                                    <div class="bg-komga text-white w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold">
                                        {{ user.get_display_name()[0]|upper if user.get_display_name() else 'K' }}
                                    </div>
                                {% elif primary_service and primary_service.value == 'romm' %}
                                    <div class="bg-romm text-white w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold">
                                        {{ user.get_display_name()[0]|upper if user.get_display_name() else 'R' }}
                                    </div>
                                {% else %}
                                    <div class="bg-gray-500 text-white w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold">
                                        {{ user.get_display_name()[0]|upper if user.get_display_name() else 'U' }}
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div></div>
                        <div>
                            {# Set username color based on user type #}
                            {% if user._user_type is defined and user._user_type == 'local' %}
                                {% set username_class = "text-primary" %}
                            {% elif primary_service %}
                                {% if primary_service.value == 'plex' %}
                                    {% set username_class = "text-plex" %}
                                {% elif primary_service.value == 'jellyfin' %}
                                    {% set username_class = "text-jellyfin" %}
                                {% elif primary_service.value == 'emby' %}
                                    {% set username_class = "text-emby" %}
                                {% elif primary_service.value == 'kavita' %}
                                    {% set username_class = "text-kavita" %}
                                {% elif primary_service.value == 'audiobookshelf' %}
                                    {% set username_class = "text-audiobookshelf" %}
                                {% elif primary_service.value == 'komga' %}
                                    {% set username_class = "text-komga" %}
                                {% elif primary_service.value == 'romm' %}
                                    {% set username_class = "text-romm" %}
                                {% else %}
                                    {% set username_class = "text-base-content" %}
                                {% endif %}
                            {% else %}
                                {% set username_class = "text-base-content" %}
                            {% endif %}
                            
                            {% if current_user.has_permission('view_user') %}
                                {% if user._user_type is defined and user._user_type == 'local' %}
                                    <!-- Local user profile link -->
                                    <!-- Local user profile link -->
                                    <a href="{{ url_for('user.view_app_user', username=user.username, view='table', page=users.page, per_page=current_per_page, back='users', back_view='table') }}" title="User Profile" class="link link-hover">
                                        <div class="font-bold truncate max-w-[150px] sm:max-w-xs {{ username_class }}" title="{{ user.get_display_name() }}">{{ user.get_display_name() }}</div>
                                    </a>
                                {% else %}
                                    <!-- Service user profile link -->
                                    {% if user._user_type is defined and user._user_type == 'service' %}
                                        {% set user_servers = user_server_names.get(user.uuid, []) %}
                                        {% if user_servers %}
                                            {% set server_name = user_servers[0] %}
                                            {% if user.plex_username %}
                                                {% set username = user.plex_username %}
                                            {% elif '@' in user.primary_username %}
                                                {% set username = user.primary_username.split('@')[0] %}
                                            {% else %}
                                                {% set username = user.primary_username %}
                                            {% endif %}
                                            <a href="{{ url_for('user.view_app_user', username=user.username, view='table', page=users.page, per_page=current_per_page, back='users', back_view='table') }}" title="App User Profile" class="link link-hover">
                                                <div class="font-bold truncate max-w-[150px] sm:max-w-xs {{ username_class }}" title="{{ user.get_display_name() }}">{{ user.get_display_name() }}</div>
                                            </a>
                                        {% else %}
                                            <div class="font-bold truncate max-w-[150px] sm:max-w-xs {{ username_class }}" title="{{ user.get_display_name() }}">{{ user.get_display_name() }}</div>
                                        {% endif %}
                                    {% else %}
                                        <!-- Fallback for users without proper type detection -->
                                        <div class="font-bold truncate max-w-[150px] sm:max-w-xs {{ username_class }}" title="{{ user.get_display_name() }}">{{ user.get_display_name() }}</div>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                <div class="font-bold truncate max-w-[150px] sm:max-w-xs {{ username_class }}" title="{{ user.get_display_name() }}">{{ user.get_display_name() }}</div>
                            {% endif %}
                            
                            {# Badge for local users vs service users #}
                            {% if user._user_type is defined and user._user_type == 'local' %}
                                <span class="inline-flex items-center rounded-md px-2 py-1 bg-primary/10 text-primary ring-primary/20 hover:bg-primary/20 text-xs font-medium ring-1 ring-inset gap-1 mt-1 whitespace-nowrap">
                                    <i class="fa-solid fa-user w-2.5 h-2.5"></i>
                                    Local Account
                                </span>
                            {% else %}
                                {# Server name badge with service icon and color for service users #}
                                {% set user_servers = user_server_names.get(user.uuid, []) %}
                                {% if user_servers %}
                                    {% if primary_service %}
                                        {% if primary_service.value == 'plex' %}
                                            <span class="inline-flex items-center rounded-md bg-plex-50 dark:bg-plex-400/10 px-1.5 py-0.5 text-xs font-medium text-plex-700 dark:text-plex-400 ring-1 ring-inset ring-plex-600/20 dark:ring-plex-500/20 gap-1 mt-1">
                                                <svg class="w-2.5 h-2.5" viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="transparent" stroke-linejoin="round" stroke-width="12"><path d="M22 25.5h48L116 94l-46 68.5H22L68.5 94Zm109.8 56L108 46l14-20.5h48zm-.3 23.5c10.979 17.625 25.52 38.875 38.5 49.5-11.149 13.635-34.323 32.278-62.5-14z"/></svg>
                                                {{ user_servers[0] }}
                                            </span>
                                        {% elif primary_service.value == 'jellyfin' %}
                                            <span class="inline-flex items-center rounded-md bg-jellyfin-50 dark:bg-jellyfin-400/10 px-1.5 py-0.5 text-xs font-medium text-jellyfin-700 dark:text-jellyfin-400 ring-1 ring-inset ring-jellyfin-600/20 dark:ring-jellyfin-500/20 gap-1 mt-1">
                                                <i class="fa-solid fa-cube w-2.5 h-2.5"></i>
                                                {{ user_servers[0] }}
                                            </span>
                                        {% elif primary_service.value == 'emby' %}
                                            <span class="inline-flex items-center rounded-md bg-emby-50 dark:bg-emby-400/10 px-1.5 py-0.5 text-xs font-medium text-emby-700 dark:text-emby-400 ring-1 ring-inset ring-emby-600/20 dark:ring-emby-500/20 gap-1 mt-1">
                                                <i class="fa-solid fa-play-circle w-2.5 h-2.5"></i>
                                                {{ user_servers[0] }}
                                            </span>
                                        {% elif primary_service.value == 'kavita' %}
                                            <span class="inline-flex items-center rounded-md bg-kavita-50 dark:bg-kavita-400/10 px-1.5 py-0.5 text-xs font-medium text-kavita-700 dark:text-kavita-400 ring-1 ring-inset ring-kavita-600/20 dark:ring-kavita-500/20 gap-1 mt-1">
                                                <i class="fa-solid fa-book w-2.5 h-2.5"></i>
                                                {{ user_servers[0] }}
                                            </span>
                                        {% elif primary_service.value == 'audiobookshelf' %}
                                            <span class="inline-flex items-center rounded-md bg-audiobookshelf-50 dark:bg-audiobookshelf-400/10 px-1.5 py-0.5 text-xs font-medium text-audiobookshelf-700 dark:text-audiobookshelf-400 ring-1 ring-inset ring-audiobookshelf-600/20 dark:ring-audiobookshelf-500/20 gap-1 mt-1">
                                                <i class="fa-solid fa-headphones w-2.5 h-2.5"></i>
                                                {{ user_servers[0] }}
                                            </span>
                                        {% elif primary_service.value == 'komga' %}
                                            <span class="inline-flex items-center rounded-md bg-komga-50 dark:bg-komga-400/10 px-1.5 py-0.5 text-xs font-medium text-komga-700 dark:text-komga-400 ring-1 ring-inset ring-komga-600/20 dark:ring-komga-500/20 gap-1 mt-1">
                                                <i class="fa-solid fa-book-open w-2.5 h-2.5"></i>
                                                {{ user_servers[0] }}
                                            </span>
                                        {% elif primary_service.value == 'romm' %}
                                            <span class="inline-flex items-center rounded-md bg-romm-50 dark:bg-romm-400/10 px-1.5 py-0.5 text-xs font-medium text-romm-700 dark:text-romm-400 ring-1 ring-inset ring-romm-600/20 dark:ring-romm-500/20 gap-1 mt-1">
                                                <i class="fa-solid fa-gamepad w-2.5 h-2.5"></i>
                                                {{ user_servers[0] }}
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center rounded-md bg-gray-50 dark:bg-gray-400/10 px-1.5 py-0.5 text-xs font-medium text-gray-700 dark:text-gray-400 ring-1 ring-inset ring-gray-600/20 dark:ring-gray-500/20 gap-1 mt-1">
                                                <i class="fa-solid fa-server w-2.5 h-2.5"></i>
                                                {{ user_servers[0] }}
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        <span class="inline-flex items-center rounded-md bg-gray-50 dark:bg-gray-400/10 px-1.5 py-0.5 text-xs font-medium text-gray-700 dark:text-gray-400 ring-1 ring-inset ring-gray-600/20 dark:ring-gray-500/20 gap-1 mt-1">
                                            <i class="fa-solid fa-server w-2.5 h-2.5"></i>
                                            {{ user_servers[0] }}
                                        </span>
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                            
                            <div class="text-xs opacity-50 mt-1">
                                {% if user._user_type is defined and user._user_type == 'local' %}
                                    <span title="Local account ID - This is the internal ID for the local user account. Service accounts linked to this user have separate IDs.">Local ID: {{ user.id }}</span>
                                {% else %}
                                    ID: {{ user.plex_user_id or user.id }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </td>
                <td data-col="email" class="text-sm truncate max-w-xs" title="{{ user.plex_email or 'No email' }}">{{ user.plex_email or 'N/A' }}</td>
                <td data-col="plex_join_date" class="text-sm">
                    {{ user.plex_join_date | format_datetime_user if user.plex_join_date else 'N/A' }}
                </td>
                <td data-col="last_known_ip" class="text-sm font-mono">
                    {{ user.last_known_ip }}
                </td>
                <td data-col="total_plays" class="text-sm">
                    {{ user.total_plays }}
                </td>
                <td data-col="total_duration" class="text-sm">
                    {{ user.total_duration | format_duration }}
                </td>
                <td data-col="status">
                    {% if user.is_home_user %}<span class="badge badge-primary badge-sm whitespace-nowrap" title="Plex Home User"><i class="fa-solid fa-home"></i>Home</span>{% endif %}
                    {% if user.shares_back %}<span class="badge badge-secondary badge-sm mt-1 whitespace-nowrap" title="Shares Libraries Back"><i class="fa-solid fa-server"></i>Shares Back</span>{% endif %}
                    {% if user.discord_user_id %}<span class="badge badge-info badge-sm mt-1 whitespace-nowrap" title="Discord: {{ user.discord_username or 'Linked' }}"><i class="fa-brands fa-discord"></i>Discord</span>{% endif %}
                    {% if user.is_purge_whitelisted %}
                        <span class="badge badge-accent badge-sm mb-1 whitespace-nowrap" title="This user is immune to inactivity purges.">
                            <i class="fa-solid fa-shield-halved"></i>Purge WL
                        </span>
                    {% endif %}
                    {% if user.plex_uuid and user.plex_uuid in admins_by_uuid %}
                        {# First, display a generic Admin badge #}
                        <div class="badge badge-error badge-outline badge-sm" title="This user is an administrator"><i class="fa-solid fa-user-shield"></i>Admin</div>
                        
                        {# Then, loop through the roles for that admin and display colored badges #}
                        {% set admin = admins_by_uuid[user.plex_uuid] %}
                        {% for role in admin.roles %}
                        <span class="badge badge-sm" style="background-color: {{ role.color or '#808080' }}; border-color: {{ role.color or '#808080' }}; color: {{ get_text_color_for_bg(role.color) }};" title="Role: {{ role.name }}">
                            {% if role.icon %}<i class="{{ role.icon }}"></i>{% endif %}{{ role.name }}
                        </span>
                        {% endfor %}
                    {% endif %}
                </td>
                <td data-col="libraries" class="text-xs" data-user-id-for-libs="{{ user.uuid }}">
                    {% set sorted_libraries = user_sorted_libraries.get(user.uuid, []) %}
                    {% if sorted_libraries %}
                        <div id="libraries-{{ user.uuid }}" class="flex flex-col space-y-1">
                        {% set initially_visible_count = 3 %}
                        {% for lib_name in sorted_libraries[:initially_visible_count] %}
                            {# Library badge colors: Service-specific for local users, blue for service users #}
                            {% if user._user_type is defined and user._user_type == 'local' %}
                                {# Local users: Use service-specific colors based on library mapping #}
                                {% set lib_service = user_library_service_mapping.get(user.uuid, {}).get(lib_name, 'unknown') %}
                                
                                {% if lib_service == 'plex' %}
                                    <span class="inline-flex items-center rounded-md bg-plex-50 dark:bg-plex-400/10 px-2 py-1 text-xs font-medium text-plex-700 dark:text-plex-400 ring-1 ring-inset ring-plex-600/20 dark:ring-plex-500/20 gap-1 whitespace-nowrap" title="{{ lib_name }}">
                                {% elif lib_service == 'jellyfin' %}
                                    <span class="inline-flex items-center rounded-md bg-jellyfin-50 dark:bg-jellyfin-400/10 px-2 py-1 text-xs font-medium text-jellyfin-700 dark:text-jellyfin-400 ring-1 ring-inset ring-jellyfin-600/20 dark:ring-jellyfin-500/20 gap-1 whitespace-nowrap" title="{{ lib_name }}">
                                {% elif lib_service == 'emby' %}
                                    <span class="inline-flex items-center rounded-md bg-emby-50 dark:bg-emby-400/10 px-2 py-1 text-xs font-medium text-emby-700 dark:text-emby-400 ring-1 ring-inset ring-emby-600/20 dark:ring-emby-500/20 gap-1 whitespace-nowrap" title="{{ lib_name }}">
                                {% elif lib_service == 'kavita' %}
                                    <span class="inline-flex items-center rounded-md bg-kavita-50 dark:bg-kavita-400/10 px-2 py-1 text-xs font-medium text-kavita-700 dark:text-kavita-400 ring-1 ring-inset ring-kavita-600/20 dark:ring-kavita-500/20 gap-1 whitespace-nowrap" title="{{ lib_name }}">
                                {% elif lib_service == 'audiobookshelf' %}
                                    <span class="inline-flex items-center rounded-md bg-audiobookshelf-50 dark:bg-audiobookshelf-400/10 px-2 py-1 text-xs font-medium text-audiobookshelf-700 dark:text-audiobookshelf-400 ring-1 ring-inset ring-audiobookshelf-600/20 dark:ring-audiobookshelf-500/20 gap-1 whitespace-nowrap" title="{{ lib_name }}">
                                {% elif lib_service == 'komga' %}
                                    <span class="inline-flex items-center rounded-md bg-komga-50 dark:bg-komga-400/10 px-2 py-1 text-xs font-medium text-komga-700 dark:text-komga-400 ring-1 ring-inset ring-komga-600/20 dark:ring-komga-500/20 gap-1 whitespace-nowrap" title="{{ lib_name }}">
                                {% elif lib_service == 'romm' %}
                                    <span class="inline-flex items-center rounded-md bg-romm-50 dark:bg-romm-400/10 px-2 py-1 text-xs font-medium text-romm-700 dark:text-romm-400 ring-1 ring-inset ring-romm-600/20 dark:ring-romm-500/20 gap-1 whitespace-nowrap" title="{{ lib_name }}">
                                {% else %}
                                    {# Default blue color for unknown services #}
                                    <span class="inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-400/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-400 ring-1 ring-inset ring-blue-600/20 dark:ring-blue-500/20 gap-1 whitespace-nowrap" title="{{ lib_name }}">
                                {% endif %}
                            {% else %}
                                {# Service users: Use blue color for all libraries #}
                                {# TODO: To re-enable service-specific colors for service users, uncomment the block below and remove this blue span #}
                                {# 
                                {% set lib_service = user_library_service_mapping.get(user.uuid, {}).get(lib_name, 'unknown') %}
                                [Add the same service-specific color logic as above for local users]
                                #}
                                <span class="inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-400/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-400 ring-1 ring-inset ring-blue-600/20 dark:ring-blue-500/20 gap-1 whitespace-nowrap" title="{{ lib_name }}">
                            {% endif %}
                                <i class="fa-solid fa-folder w-2.5 h-2.5 mr-1 bottom-px relative"></i>
                                {{ lib_name | truncate(17, True, '...') }}
                            </span>
                        {% endfor %}
                        {% if sorted_libraries|length > initially_visible_count %}
                            <button id="more-libs-{{ user.uuid }}" onclick='showMoreTableLibraries("{{ user.uuid }}", {{ sorted_libraries|tojson|safe }}, {{ user_library_service_mapping.get(user.uuid, {})|tojson|safe }})' class="inline-flex items-center rounded-md bg-indigo-50 dark:bg-indigo-400/10 px-1.5 py-0.5 text-xs font-medium text-indigo-700 dark:text-indigo-400 ring-1 ring-inset ring-indigo-600/20 dark:ring-indigo-500/20 gap-1 hover:bg-indigo-100 dark:hover:bg-indigo-400/20 transition-colors cursor-pointer">
                                +{{ sorted_libraries|length - initially_visible_count }} more
                            </button>
                        {% endif %}
                        </div>
                    {% else %}
                        <span class="inline-flex items-center rounded-md bg-gray-50 dark:bg-gray-400/10 px-1.5 py-0.5 text-xs font-medium text-gray-700 dark:text-gray-400 ring-1 ring-inset ring-gray-600/20 dark:ring-gray-500/20 gap-1">
                            <i class="fa-solid fa-folder-open w-2 h-2"></i>
                            No libraries
                        </span>
                    {% endif %}
                </td>
                <td data-col="last_streamed" class="text-sm" title="{{ user.last_streamed_at | format_datetime_user if user.last_streamed_at else 'Never' }}">
                    <div title="{{ user.last_streamed_at | format_datetime_user if user.last_streamed_at else 'Never streamed' }}">
                        {{ user.last_streamed_at | format_datetime_user if user.last_streamed_at else 'Never' }}
                    </div>
                    {% if user.access_expires_at %}
                        <div class="text-xs text-warning mt-0.5" title="Access expires on {{ user.access_expires_at | format_datetime_user }}">
                            <i class="fa-solid fa-hourglass-end fa-fw"></i> Expires: {{ user.access_expires_at | format_datetime_user }}
                        </div>
                    {% endif %}
                </td>
                <td data-col="mum_added_date" class="text-sm" title="{{ user.created_at | format_datetime_user if user.created_at else 'N/A' }}">
                    {{ user.created_at | format_datetime_user if user.created_at else 'N/A' }}
                </td>
                <td data-col="last_played" class="text-sm">
                    {% set last_played = user_last_played.get(user.id) %}
                    {% if last_played %}
                        {% if last_played.rating_key %}
                        <div class="relative group">
                            <span class="cursor-help hover:text-primary">{{ last_played.media_title or 'Unknown Title' }}</span>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 hidden group-hover:block z-[9999] pointer-events-none">
                                <div class="bg-base-100 border rounded-lg shadow-lg p-2 w-64">
                                    <img src="{{ url_for('api.plex_image_proxy', path=('/library/metadata/' + last_played.rating_key + '/thumb')) }}" 
                                         alt="{{ last_played.media_title }}" 
                                         class="w-full h-auto rounded"
                                         onerror="this.parentElement.parentElement.style.display='none'">
                                    <div class="text-center text-sm font-semibold mt-2">{{ last_played.media_title }}</div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <span>{{ last_played.media_title or 'Unknown Title' }}</span>
                        {% endif %}
                        <div class="text-xs opacity-60">{{ last_played.started_at | format_datetime_user if last_played.started_at else 'N/A' }}</div>
                    {% else %}
                        Never
                    {% endif %}
                </td>
                <td class="text-center" data-col="actions">
                    <div class="flex items-center justify-center space-x-1">
                        {% if current_user.has_permission('view_user') %}
                            {% if user._user_type is defined and user._user_type == 'local' %}
                                <!-- Local user profile link -->
                                <a href="{{ url_for('user.view_app_user', username=user.username, view='table', page=users.page, per_page=current_per_page, back='users', back_view='table') }}" title="App User Profile" class="btn btn-xs btn-ghost text-info hover:bg-info/10"><i class="fa-solid fa-user"></i></a>
                            {% else %}
                                <!-- Service user profile link -->
                                {% if user._user_type is defined and user._user_type == 'service' %}
                                    {% set user_servers = user_server_names.get(user.uuid, []) %}
                                    {% if user_servers %}
                                        {% set server_name = user_servers[0] %}
                                        {% if user.plex_username %}
                                            {% set username = user.plex_username %}
                                        {% elif '@' in user.primary_username %}
                                            {% set username = user.primary_username.split('@')[0] %}
                                        {% else %}
                                            {% set username = user.primary_username %}
                                        {% endif %}
                                        <a href="{{ url_for('user.view_app_user', username=user.username, view='table', page=users.page, per_page=current_per_page, back='users', back_view='table') }}" title="App User Profile" class="btn btn-xs btn-ghost text-info hover:bg-info/10"><i class="fa-solid fa-user"></i></a>
                                    {% else %}
                                        <span title="No server info available" class="btn btn-xs btn-ghost text-gray-500"><i class="fa-solid fa-eye-slash"></i></span>
                                    {% endif %}
                                {% else %}
                                    <!-- Fallback for users without proper type detection -->
                                    <span title="Unknown user type" class="btn btn-xs btn-ghost text-gray-500"><i class="fa-solid fa-question"></i></span>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                        {% if current_user.has_permission('edit_user') %}
                        <!-- Quick edit button - only show for local users since service users have limited edit capabilities -->
                        {% if user._user_type is defined and user._user_type == 'local' %}
                        <button class="btn btn-xs btn-ghost text-primary hover:bg-primary/10 card-action-button"
                                title="Quick Edit Settings"
                                hx-get="{{ url_for('users.get_quick_edit_form', user_uuid=user.uuid, view='table', page=users.page, per_page=current_per_page) }}"
                                hx-target="#quick_edit_modal_content_div"
                                hx-swap="innerHTML"
                                onclick="quick_edit_user_modal.showModal()">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                        {% endif %}
                        {% endif %}
                        {% if current_user.has_permission('delete_user') %}
                        <button class="btn btn-xs btn-ghost text-error hover:bg-error/10" title="Remove User"
                                hx-confirm="Are you sure you want to remove '{{ user.get_display_name() }}' from MUM and media servers?"
                                hx-delete="{{ url_for('users.delete_user', user_uuid=user.uuid) }}"
                                hx-target="#user-row-{{ user.uuid }}" hx-swap="outerHTML swap:0.5s" hx-indicator="this">
                            <i class="fa-solid fa-trash-can htmx-indicator-hide"></i>
                            <span class="htmx-indicator loading loading-spinner loading-xs"></span>
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function showMoreTableLibraries(userId, libraryNames, serviceMapping) {
        const container = document.getElementById(`libraries-${userId}`);
        const button = document.getElementById(`more-libs-${userId}`);
        container.innerHTML = ''; // Clear existing badges
        
        // Check if this is a local user by checking if userId is a UUID (service users have UUIDs, local users have numeric IDs in this context)
        const isLocalUser = !userId.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i);
        
        libraryNames.forEach(libName => {
            const badge = document.createElement('span');
            
            if (isLocalUser) {
                // Local users: Use service-specific colors based on library mapping
                const service = serviceMapping[libName] || 'unknown';
                
                if (service === 'plex') {
                    badge.className = 'inline-flex items-center rounded-md bg-plex-50 dark:bg-plex-400/10 px-2 py-1 text-xs font-medium text-plex-700 dark:text-plex-400 ring-1 ring-inset ring-plex-600/20 dark:ring-plex-500/20 gap-1 whitespace-nowrap mb-1';
                } else if (service === 'jellyfin') {
                    badge.className = 'inline-flex items-center rounded-md bg-jellyfin-50 dark:bg-jellyfin-400/10 px-2 py-1 text-xs font-medium text-jellyfin-700 dark:text-jellyfin-400 ring-1 ring-inset ring-jellyfin-600/20 dark:ring-jellyfin-500/20 gap-1 whitespace-nowrap mb-1';
                } else if (service === 'emby') {
                    badge.className = 'inline-flex items-center rounded-md bg-emby-50 dark:bg-emby-400/10 px-2 py-1 text-xs font-medium text-emby-700 dark:text-emby-400 ring-1 ring-inset ring-emby-600/20 dark:ring-emby-500/20 gap-1 whitespace-nowrap mb-1';
                } else if (service === 'kavita') {
                    badge.className = 'inline-flex items-center rounded-md bg-kavita-50 dark:bg-kavita-400/10 px-2 py-1 text-xs font-medium text-kavita-700 dark:text-kavita-400 ring-1 ring-inset ring-kavita-600/20 dark:ring-kavita-500/20 gap-1 whitespace-nowrap mb-1';
                } else if (service === 'audiobookshelf') {
                    badge.className = 'inline-flex items-center rounded-md bg-audiobookshelf-50 dark:bg-audiobookshelf-400/10 px-2 py-1 text-xs font-medium text-audiobookshelf-700 dark:text-audiobookshelf-400 ring-1 ring-inset ring-audiobookshelf-600/20 dark:ring-audiobookshelf-500/20 gap-1 whitespace-nowrap mb-1';
                } else if (service === 'komga') {
                    badge.className = 'inline-flex items-center rounded-md bg-komga-50 dark:bg-komga-400/10 px-2 py-1 text-xs font-medium text-komga-700 dark:text-komga-400 ring-1 ring-inset ring-komga-600/20 dark:ring-komga-500/20 gap-1 whitespace-nowrap mb-1';
                } else if (service === 'romm') {
                    badge.className = 'inline-flex items-center rounded-md bg-romm-50 dark:bg-romm-400/10 px-2 py-1 text-xs font-medium text-romm-700 dark:text-romm-400 ring-1 ring-inset ring-romm-600/20 dark:ring-romm-500/20 gap-1 whitespace-nowrap mb-1';
                } else {
                    // Default blue color for unknown services
                    badge.className = 'inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-400/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-400 ring-1 ring-inset ring-blue-600/20 dark:ring-blue-500/20 gap-1 whitespace-nowrap mb-1';
                }
            } else {
                // Service users: Use blue color for all libraries
                // TODO: To re-enable service-specific colors for service users, replace this with the service-specific logic above
                badge.className = 'inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-400/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-400 ring-1 ring-inset ring-blue-600/20 dark:ring-blue-500/20 gap-1 whitespace-nowrap mb-1';
            }
            
            badge.title = libName;
            
            const icon = document.createElement('i');
            icon.className = 'fa-solid fa-folder w-2.5 h-2.5 mr-1 bottom-px relative';
            badge.appendChild(icon);
            
            const text = document.createTextNode(libName.length > 17 ? libName.substring(0, 17) + '...' : libName);
            badge.appendChild(text);
            
            container.appendChild(badge);
        });
        if (button) {
            button.style.display = 'none';
        }
    }

    // Function to update select all checkbox state (tri-state)
    function updateSelectAllState() {
        const selectAllCheckbox = document.getElementById('select_all_users_table');
        if (!selectAllCheckbox) return;
        
        const userCheckboxes = document.querySelectorAll('.user-select-checkbox');
        const checkedCount = document.querySelectorAll('.user-select-checkbox:checked').length;
        const totalCount = userCheckboxes.length;
        
        if (checkedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.parentElement.title = 'Select all visible';
        } else if (checkedCount === totalCount) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.parentElement.title = 'Unselect all';
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
            selectAllCheckbox.parentElement.title = `${checkedCount} of ${totalCount} selected - click to select all`;
        }
    }

    // Function to initialize tri-state checkbox functionality
    function initializeTriStateCheckbox() {
        // Re-initialize "Select All" checkbox logic
        const selectAllCheckbox = document.getElementById('select_all_users_table');
        if (selectAllCheckbox) {
            // Remove existing listeners to prevent duplicates
            selectAllCheckbox.replaceWith(selectAllCheckbox.cloneNode(true));
            const newSelectAllCheckbox = document.getElementById('select_all_users_table');
            
            // Track the previous state to handle tri-state logic correctly
            let previousState = { checked: false, indeterminate: false };
            
            // Update previous state whenever the checkbox state changes
            const updatePreviousState = () => {
                previousState = {
                    checked: newSelectAllCheckbox.checked,
                    indeterminate: newSelectAllCheckbox.indeterminate
                };
            };
            
            // Initialize previous state
            updatePreviousState();
            
            // Listen for state changes to update previous state
            const observer = new MutationObserver(() => {
                // Only update if this change wasn't from a user click
                if (!newSelectAllCheckbox.dataset.userClick) {
                    updatePreviousState();
                }
            });
            observer.observe(newSelectAllCheckbox, { attributes: true, attributeFilter: ['checked'] });
            
            newSelectAllCheckbox.addEventListener('change', function() {
                // Mark this as a user click
                this.dataset.userClick = 'true';
                
                // Determine what action to take based on previous state
                let shouldCheck;
                if (previousState.indeterminate || !previousState.checked) {
                    // Was indeterminate or unchecked -> select all
                    shouldCheck = true;
                } else {
                    // Was checked -> unselect all
                    shouldCheck = false;
                }
                
                document.querySelectorAll('.user-select-checkbox').forEach(checkbox => {
                    checkbox.checked = shouldCheck;
                    updateRowSelection(checkbox);
                    // Trigger change event to ensure all handlers are called
                    // Use bubbles: true to ensure the event delegation in the main file catches it
                    checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                });
                
                // Update the state after the change
                updateSelectAllState();
                
                // Update previous state for next click
                updatePreviousState();
                
                // Remove the user click marker
                delete this.dataset.userClick;
                
                // Also trigger the global mass edit update
                if (typeof updateMassEditUI === 'function') {
                    updateMassEditUI();
                }
            });
        }

        // Re-initialize individual user selection checkboxes
        document.querySelectorAll('.user-select-checkbox').forEach(checkbox => {
            // Remove existing listeners to prevent duplicates
            checkbox.replaceWith(checkbox.cloneNode(true));
        });
        
        document.querySelectorAll('.user-select-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectAllState();
                updateRowSelection(this);
                // The event will bubble up to the main file's event delegation listener
                // which will handle updating selectedUserIds and calling updateMassEditUI()
            });
        });
        
        // Initialize the select all state
        updateSelectAllState();
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tri-state functionality on initial page load
        initializeTriStateCheckbox();
    });

    // This is a global listener. It's better to attach it once.
    // It will catch events from content loaded by HTMX.
    document.body.addEventListener('htmx:afterSwap', function(event) {
        // Re-initialize tri-state functionality after HTMX content swap
        initializeTriStateCheckbox();
    });
    
    // Add click-to-select functionality for table rows
    document.body.addEventListener('click', function(event) {
        // Check if the clicked element is within a user row
        const row = event.target.closest('.user-row-clickable');
        if (!row) return;
        
        // Don't trigger if clicking on interactive elements
        if (event.target.closest('input, button, a, .btn, .checkbox, .link')) {
            return;
        }
        
        // Find the checkbox for this row
        const checkbox = row.querySelector('.user-select-checkbox');
        if (checkbox) {
            // Toggle the checkbox
            checkbox.checked = !checkbox.checked;
            // Trigger the change event to update everything
            // Use bubbles: true to ensure the event delegation in the main file catches it
            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
        }
    });
    
    function updateRowSelection(checkbox) {
        const row = checkbox.closest('tr');
        const serviceClass = row.getAttribute('data-service-class');
        
        if (checkbox.checked) {
            // Add service-specific background tint when selected using CSS variables
            row.classList.add('selected-row');
            const serviceColor = row.dataset.serviceColor;
            if (serviceColor && serviceColor !== '#6b7280') {
                // Use the CSS variable with opacity for dynamic service colors
                row.style.backgroundColor = `color-mix(in srgb, ${serviceColor} 10%, transparent)`;
            } else {
                // Fallback for gray/unknown services
                row.style.backgroundColor = 'rgba(107, 114, 128, 0.1)';
            }
        } else {
            // Remove selection styling
            row.classList.remove('selected-row');
            row.style.backgroundColor = '';
        }
    }
</script>
