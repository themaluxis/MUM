{# File: app/templates/users/partials/_single_user_card.html #}
{# Expects 'user' object and other context variables like 'user_sorted_libraries', 'admins_by_uuid' etc. #}
{# Determine service-specific background tint and selection colors #}
{% set service_types = user_service_types.get(user.uuid, []) %}
{% set primary_service = service_types[0] if service_types else None %}
{% if primary_service %}
    {% if primary_service.value == 'plex' %}
        {% set card_bg_class = "bg-gradient-to-br from-base-200 to-plex/10" %}
        {% set service_color = "var(--color-plex)" %}
        {% set service_color_class = "plex" %}
    {% elif primary_service.value == 'jellyfin' %}
        {% set card_bg_class = "bg-gradient-to-br from-base-200 to-jellyfin/10" %}
        {% set service_color = "var(--color-jellyfin)" %}
        {% set service_color_class = "jellyfin" %}
    {% elif primary_service.value == 'emby' %}
        {% set card_bg_class = "bg-gradient-to-br from-base-200 to-emby/10" %}
        {% set service_color = "var(--color-emby)" %}
        {% set service_color_class = "emby" %}
    {% elif primary_service.value == 'kavita' %}
        {% set card_bg_class = "bg-gradient-to-br from-base-200 to-kavita/10" %}
        {% set service_color = "var(--color-kavita)" %}
        {% set service_color_class = "kavita" %}
    {% elif primary_service.value == 'audiobookshelf' %}
        {% set card_bg_class = "bg-gradient-to-br from-base-200 to-audiobookshelf/10" %}
        {% set service_color = "var(--color-audiobookshelf)" %}
        {% set service_color_class = "audiobookshelf" %}
    {% elif primary_service.value == 'komga' %}
        {% set card_bg_class = "bg-gradient-to-br from-base-200 to-komga/10" %}
        {% set service_color = "var(--color-komga)" %}
        {% set service_color_class = "komga" %}
    {% elif primary_service.value == 'romm' %}
        {% set card_bg_class = "bg-gradient-to-br from-base-200 to-romm/10" %}
        {% set service_color = "var(--color-romm)" %}
        {% set service_color_class = "romm" %}
    {% else %}
        {% set card_bg_class = "bg-base-200" %}
        {% set service_color = "#6b7280" %}
        {% set service_color_class = "gray" %}
    {% endif %}
{% else %}
    {% set card_bg_class = "bg-base-200" %}
    {% set service_color = "#6b7280" %}
    {% set service_color_class = "gray" %}
{% endif %}
<div id="user-card-{{ user.id }}" class="card {{ card_bg_class }} shadow-lg hover:shadow-xl transition-all duration-200 ease-in-out relative group user-card-clickable user-card" data-user-id-for-card="{{ user.id }}" data-service-color="{{ service_color }}" data-service-class="{{ service_color_class }}">
    <!-- User Selection Checkbox -->
    <input type="checkbox" id="user-checkbox-{{ user.id }}" class="checkbox absolute top-2 right-2 z-10 user-select-checkbox opacity-0 group-hover:opacity-100 transition-opacity duration-200" data-user-id="{{ user.uuid }}" title="Select user" style="--input-color: {{ service_color }}; --chkfg: white;">
    
    <div class="card-body p-4">
        <div class="flex flex-row items-center mb-3">
            <div class="avatar mr-3">
                <div class="w-10 rounded-full">
                    {% set service_types = user_service_types.get(user.uuid, []) %}
                    {% set primary_service = service_types[0] if service_types else None %}
                    
                    {# Always use colored circular avatars with service-specific colors #}
                    {% if primary_service and primary_service.value == 'plex' %}
                        <div class="bg-plex text-white w-10 h-10 rounded-full flex items-center justify-center text-2xl font-normal">
                            {{ user.get_display_name()[0]|upper if user.get_display_name() else 'P' }}
                        </div>
                    {% elif primary_service and primary_service.value == 'jellyfin' %}
                        <div class="bg-jellyfin text-white w-10 h-10 rounded-full flex items-center justify-center text-2xl font-normal">
                            {{ user.get_display_name()[0]|upper if user.get_display_name() else 'J' }}
                        </div>
                    {% elif primary_service and primary_service.value == 'emby' %}
                        <div class="bg-emby text-white w-10 h-10 rounded-full flex items-center justify-center text-2xl font-normal">
                            {{ user.get_display_name()[0]|upper if user.get_display_name() else 'E' }}
                        </div>
                    {% elif primary_service and primary_service.value == 'kavita' %}
                        <div class="bg-kavita text-white w-10 h-10 rounded-full flex items-center justify-center text-2xl font-normal">
                            {{ user.get_display_name()[0]|upper if user.get_display_name() else 'K' }}
                        </div>
                    {% elif primary_service and primary_service.value == 'audiobookshelf' %}
                        <div class="bg-audiobookshelf text-white w-10 h-10 rounded-full flex items-center justify-center text-2xl font-normal">
                            {{ user.get_display_name()[0]|upper if user.get_display_name() else 'A' }}
                        </div>
                    {% elif primary_service and primary_service.value == 'komga' %}
                        <div class="bg-komga text-white w-10 h-10 rounded-full flex items-center justify-center text-2xl font-normal">
                            {{ user.get_display_name()[0]|upper if user.get_display_name() else 'K' }}
                        </div>
                    {% elif primary_service and primary_service.value == 'romm' %}
                        <div class="bg-romm text-white w-10 h-10 rounded-full flex items-center justify-center text-2xl font-normal">
                            {{ user.get_display_name()[0]|upper if user.get_display_name() else 'R' }}
                        </div>
                    {% else %}
                        <div class="bg-gray-500 text-white w-10 h-10 rounded-full flex items-center justify-center text-2xl font-normal">
                            {{ user.get_display_name()[0]|upper if user.get_display_name() else 'U' }}
                        </div>
                    {% endif %}
                </div>
            </div>
            <div>
                <div class="flex items-center gap-2">
                    <h2 class="card-title text-lg truncate" title="{{ user.get_display_name() }}">
                    {{ user.get_display_name() }}
                    </h2>
                    
                    <!-- Linked Account Badge -->
                    {# Only show linked account badge if user accounts feature is enabled AND user has a linked account #}
                    {% if allow_user_accounts and user.user_app_access %}
                    <span class="badge badge-sm badge-primary">
                        <i class="fa-solid fa-link mr-1"></i>
                        {{ user.user_app_access.username }}
                    </span>
                    {% endif %}
                </div>
                {# Service type badge #}
                {% if primary_service %}
                    {% if primary_service.value == 'plex' %}
                        {% set badge_class = "bg-plex text-plex-content" %}
                        {% set service_name = "Plex" %}
                    {% elif primary_service.value == 'jellyfin' %}
                        {% set badge_class = "bg-jellyfin text-jellyfin-content" %}
                        {% set service_name = "Jellyfin" %}
                    {% elif primary_service.value == 'emby' %}
                        {% set badge_class = "bg-emby text-emby-content" %}
                        {% set service_name = "Emby" %}
                    {% elif primary_service.value == 'kavita' %}
                        {% set badge_class = "bg-kavita text-kavita-content" %}
                        {% set service_name = "Kavita" %}
                    {% elif primary_service.value == 'audiobookshelf' %}
                        {% set badge_class = "bg-audiobookshelf text-audiobookshelf-content" %}
                        {% set service_name = "AudiobookShelf" %}
                    {% elif primary_service.value == 'komga' %}
                        {% set badge_class = "bg-komga text-komga-content" %}
                        {% set service_name = "Komga" %}
                    {% elif primary_service.value == 'romm' %}
                        {% set badge_class = "bg-romm text-romm-content" %}
                        {% set service_name = "RomM" %}
                    {% else %}
                        {% set badge_class = "bg-gray-500 text-gray-100" %}
                        {% set service_name = primary_service.value|title %}
                    {% endif %}
                    {# Server name badge with service icon and color (Discord-style) #}
                        {% set user_servers = user_server_names.get(user.uuid, []) %}
                        {% if user_servers %}
                            {% if primary_service %}
                                {% if primary_service.value == 'plex' %}
                                    <span class="inline-flex items-center rounded-md bg-plex-50 dark:bg-plex-400/10 px-2 py-1 text-xs font-medium text-plex-700 dark:text-plex-400 ring-1 ring-inset ring-plex-600/20 dark:ring-plex-500/20 gap-1 mt-1">
                                        <svg class="w-3 h-3" viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="transparent" stroke-linejoin="round" stroke-width="12"><path d="M22 25.5h48L116 94l-46 68.5H22L68.5 94Zm109.8 56L108 46l14-20.5h48zm-.3 23.5c10.979 17.625 25.52 38.875 38.5 49.5-11.149 13.635-34.323 32.278-62.5-14z"/></svg>
                                        {{ user_servers[0] }}
                                    </span>
                                {% elif primary_service.value == 'jellyfin' %}
                                    <span class="inline-flex items-center rounded-md bg-jellyfin-50 dark:bg-jellyfin-400/10 px-2 py-1 text-xs font-medium text-jellyfin-700 dark:text-jellyfin-400 ring-1 ring-inset ring-jellyfin-600/20 dark:ring-jellyfin-500/20 gap-1 mt-1">
                                        <i class="fa-solid fa-cube w-3 h-3"></i>
                                        {{ user_servers[0] }}
                                    </span>
                                {% elif primary_service.value == 'emby' %}
                                    <span class="inline-flex items-center rounded-md bg-emby-50 dark:bg-emby-400/10 px-2 py-1 text-xs font-medium text-emby-700 dark:text-emby-400 ring-1 ring-inset ring-emby-600/20 dark:ring-emby-500/20 gap-1 mt-1">
                                        <i class="fa-solid fa-play-circle w-3 h-3"></i>
                                        {{ user_servers[0] }}
                                    </span>
                                {% elif primary_service.value == 'kavita' %}
                                    <span class="inline-flex items-center rounded-md bg-kavita-50 dark:bg-kavita-400/10 px-2 py-1 text-xs font-medium text-kavita-700 dark:text-kavita-400 ring-1 ring-inset ring-kavita-600/20 dark:ring-kavita-500/20 gap-1 mt-1">
                                        <i class="fa-solid fa-book w-3 h-3"></i>
                                        {{ user_servers[0] }}
                                    </span>
                                {% elif primary_service.value == 'audiobookshelf' %}
                                    <span class="inline-flex items-center rounded-md bg-audiobookshelf-50 dark:bg-audiobookshelf-400/10 px-2 py-1 text-xs font-medium text-audiobookshelf-700 dark:text-audiobookshelf-400 ring-1 ring-inset ring-audiobookshelf-600/20 dark:ring-audiobookshelf-500/20 gap-1 mt-1">
                                        <i class="fa-solid fa-headphones w-3 h-3"></i>
                                        {{ user_servers[0] }}
                                    </span>
                                {% elif primary_service.value == 'komga' %}
                                    <span class="inline-flex items-center rounded-md bg-komga-50 dark:bg-komga-400/10 px-2 py-1 text-xs font-medium text-komga-700 dark:text-komga-400 ring-1 ring-inset ring-komga-600/20 dark:ring-komga-500/20 gap-1 mt-1">
                                        <i class="fa-solid fa-book-open w-3 h-3"></i>
                                        {{ user_servers[0] }}
                                    </span>
                                {% elif primary_service.value == 'romm' %}
                                    <span class="inline-flex items-center rounded-md bg-romm-50 dark:bg-romm-400/10 px-2 py-1 text-xs font-medium text-romm-700 dark:text-romm-400 ring-1 ring-inset ring-romm-600/20 dark:ring-romm-500/20 gap-1 mt-1">
                                        <i class="fa-solid fa-gamepad w-3 h-3"></i>
                                        {{ user_servers[0] }}
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center rounded-md bg-gray-50 dark:bg-gray-400/10 px-2 py-1 text-xs font-medium text-gray-700 dark:text-gray-400 ring-1 ring-inset ring-gray-600/20 dark:ring-gray-500/20 gap-1 mt-1">
                                        <i class="fa-solid fa-server w-3 h-3"></i>
                                        {{ user_servers[0] }}
                                    </span>
                                {% endif %}
                            {% else %}
                                <span class="inline-flex items-center rounded-md bg-gray-50 dark:bg-gray-400/10 px-2 py-1 text-xs font-medium text-gray-700 dark:text-gray-400 ring-1 ring-inset ring-gray-600/20 dark:ring-gray-500/20 gap-1 mt-1">
                                    <i class="fa-solid fa-server w-3 h-3"></i>
                                    {{ user_servers[0] }}
                                </span>
                            {% endif %}
                    {% endif %}
                {% endif %}
                
                {# Linked Account Badge - Show for service users that have a linked local account #}
                {% if user._user_type is defined and user._user_type == 'service' and user._access_record and user._access_record.user_app_access_id %}
                    {% set linked_user = user._access_record.user_app_access %}
                    {% if linked_user %}
                        <span class="inline-flex items-center rounded-md px-2 py-1 bg-primary/10 text-primary ring-primary/20 hover:bg-primary/20 text-xs font-medium ring-1 ring-inset gap-1 mt-1" title="Linked to local account: {{ linked_user.username }}">
                            <i class="fa-solid fa-link w-3 h-3"></i>
                            {{ linked_user.username }}
                        </span>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        
        <div class="text-xs space-y-1 mb-3">
            {# For UserAppAccess, show the primary email #}
            <p class="text-xs text-base-content/70 truncate" title="{{ user.email or 'No E-mail address' }}"><i class="fa-solid fa-at fa-fw mr-1 text-info"></i> Email: {{ user.email or 'No E-mail address' }}</p>
            <div class="tooltip tooltip-top" data-tip="The date {{ user.get_display_name() }} was added to MUM">
                <p><i class="fa-solid fa-calendar-plus fa-fw mr-1 text-info"></i> Added: {{ user.created_at | format_datetime_user if user.created_at else 'N/A' }}</p>
            </div>
            <p><i class="fa-solid fa-clock fa-fw mr-1 {{ 'text-success' if user.last_streamed_at else 'text-warning' }}"></i> Streamed: {{ user.last_streamed_at | format_datetime_user if user.last_streamed_at else 'Never' }}</p>
            {% if user.service_join_date or user.plex_join_date %}
            <div class="tooltip tooltip-top" data-tip="Full join date: {{ (user.service_join_date or user.plex_join_date) | format_datetime_user }} - When {{ user.get_display_name() }} joined the service">
                <p><i class="fa-solid fa-server fa-fw mr-1 text-info"></i> Service Join Date: {{ (user.service_join_date or user.plex_join_date) | format_datetime_user(include_time=False) }}</p>
            </div>
            {% endif %}
            {% if user.access_expires_at %}
                <p class="text-warning">
                    <i class="fa-solid fa-hourglass-end fa-fw mr-1"></i> 
                    Access Expires: {{ user.access_expires_at | format_datetime_user }} 
                    <span class="text-base-content">{{ user.access_expires_at | format_datetime_user }}</span>
                </p>
            {% endif %}
        </div>

        <div class="user-notes-container" style="display: none;">
            <p class="text-xs font-semibold mb-1">Notes:</p>
            <p class="text-xs text-base-content/70 mb-3">{{ user.notes or 'No notes for this user.' }}</p>
        </div>

        <div class="mb-3">
            <p class="text-xs font-semibold mb-2">Libraries (<span class="font-normal">{{ user_sorted_libraries.get(user.uuid, [])|length }}</span>):</p>
            {% if user_sorted_libraries.get(user.uuid) %}
                <div class="flex flex-wrap gap-1">
                    {% for lib_name in user_sorted_libraries.get(user.uuid, []) %}
                        <span class="inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-400/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-400 ring-1 ring-inset ring-blue-600/20 dark:ring-blue-500/20 gap-1" title="{{ lib_name }}">
                            <i class="fa-solid fa-folder w-2.5 h-2.5 mr-1 bottom-px relative"></i>
                            {{ lib_name }}
                        </span>
                    {% endfor %}
                </div>
            {% else %}
                <span class="inline-flex items-center rounded-md bg-gray-50 dark:bg-gray-400/10 px-2 py-1 text-xs font-medium text-gray-700 dark:text-gray-400 ring-1 ring-inset ring-gray-600/20 dark:ring-gray-500/20 gap-1">
                    <i class="fa-solid fa-folder-open w-2.5 h-2.5 mr-1 bottom-px relative"></i>
                    No libraries specifically shared
                </span>
            {% endif %}
        </div>

        <div class="flex flex-wrap gap-1 mb-3">
            {% if user.is_home_user %}<div class="badge badge-primary badge-sm" title="Plex Home User"><i class="fa-solid fa-home"></i>Home</div>{% endif %}
            {% if user.shares_back %}<div class="badge badge-secondary badge-sm" title="Shares Libraries Back"><i class="fa-solid fa-server"></i>Shares Back</div>{% endif %}
            {% if user.discord_user_id %}<div class="badge badge-info badge-sm" title="Discord: {{ user.discord_username or 'Linked' }}"><i class="fa-brands fa-discord"></i>Linked</div>{% endif %}
            {% if user.is_purge_whitelisted %}<div class="badge badge-accent badge-sm" title="This user is immune to inactivity purges."><i class="fa-solid fa-shield-halved"></i>Purge Whitelisted</div>{% endif %}
            {% if user.plex_uuid and user.plex_uuid in admins_by_uuid %}
                <div class="badge badge-error badge-outline badge-sm" title="This user is an administrator"><i class="fa-solid fa-user-shield"></i>Admin</div>
                {% set admin = admins_by_uuid[user.plex_uuid] %}
                {% for role in admin.roles %}
                <span class="badge badge-sm" style="background-color: {{ role.color or '#808080' }}; border-color: {{ role.color or '#808080' }}; color: {{ get_text_color_for_bg(role.color) }};" title="Role: {{ role.name }}">
                    {% if role.icon %}<i class="{{ role.icon }}"></i>{% endif %}{{ role.name }}
                </span>
                {% endfor %}
            {% endif %}
        </div>

        <div class="card-actions justify-end mt-auto pt-3 border-t border-base-300/90">
            <button class="btn btn-xs btn-ghost text-warning hover:bg-warning/10" 
                    title="Show Raw User Data"
                    hx-get="{{ url_for('users.get_user_debug_info', user_uuid=user.uuid) }}"
                    hx-target="#user_debug_modal_content"
                    hx-swap="innerHTML"
                    onclick="user_debug_modal.showModal()">
                <i class="fa-solid fa-info"></i>
            </button>
            {% if current_user.has_permission('view_user') %}
            {% if user._user_type is defined and user._user_type == 'local' %}
                <!-- Local user profile link -->
                <a href="{{ url_for('user.view_local_user', local_user_id=user.id, back='users', back_view='cards') }}" title="Local User Profile" class="btn btn-xs btn-ghost text-info hover:bg-info/10">
                    <i class="fa-solid fa-user"></i>
                </a>
            {% else %}
                <!-- User profile link -->
                {# All users are now UserAppAccess, so use consistent profile link #}
                {% if user._user_type == 'service' %}
                    {# Service user - route to /user/{server_nickname}/{username} #}
                    <a href="{{ url_for('user.view_service_account', server_nickname=user._access_record.server.name, server_username=user.username, back='users', back_view='cards') }}" title="User Profile" class="btn btn-xs btn-ghost text-info hover:bg-info/10">
                {% else %}
                    {# Local user - route to /user/{username} #}
                    <a href="{{ url_for('user.view_app_user', username=user.username, back='users', back_view='cards') }}" title="User Profile" class="btn btn-xs btn-ghost text-info hover:bg-info/10">
                {% endif %}
                    <i class="fa-solid fa-user"></i>
                </a>
            {% endif %}
            {% endif %}
            {% if current_user.has_permission('edit_user') %}
            <button class="btn btn-xs btn-ghost text-primary hover:bg-primary/10 card-action-button"
                    title="Quick Edit Settings"
                    hx-get="{{ url_for('users.get_quick_edit_form', user_uuid=user.uuid) }}"
                    hx-target="#quick_edit_modal_content_div"
                    hx-swap="innerHTML"
                    onclick="quick_edit_user_modal.showModal()">
                <i class="fa-solid fa-pen-to-square"></i>
            </button>
            {% endif %}
            {% if current_user.has_permission('delete_user') %}
            <button class="btn btn-xs btn-ghost text-error hover:bg-error/10 card-action-button" title="Remove User"
                    hx-confirm="Are you sure you want to remove '{{ user.get_display_name() }}' from MUM and media servers?"
                    hx-delete="{{ url_for('users.delete_user', user_uuid=user.uuid) }}"
                    hx-target="closest .card" 
                    hx-swap="outerHTML swap:0.5s"
                    hx-indicator="this">
                <i class="fa-solid fa-trash-can htmx-indicator-hide"></i>
                <span class="htmx-indicator loading loading-spinner loading-xs"></span>
            </button>
            {% endif %}
        </div>
    </div>
</div>
