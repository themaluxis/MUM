{% extends "base.html" %}
{% block title %}{{ super() }} - Managed Users{% endblock %}

{% block content %}

<!-- Local Users JavaScript -->
<script src="{{ url_for('static', filename='js/app_users.js') }}"></script>
<div class="container mx-auto px-4 py-2">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Managed Users ({{ users_count or 0 }})</h1>
        <div class="flex items-center space-x-2 mt-4 sm:mt-0">
            <button id="sync-users-btn" class="btn btn-secondary" 
                    hx-post="{{ url_for('users.sync_all_users') }}"
                    hx-target="#sync-noop-target"
                    hx-swap="innerHTML"
                    hx-on::before-request="showUserSyncLoading()"
                    hx-on::after-request="hideUserSyncLoading()"
                    title="Refresh user list from all enabled services"> 
                <span id="user-sync-spinner" class="loading loading-spinner loading-xs mr-2 htmx-indicator"></span>
                <i class="fa-solid fa-sync mr-2 htmx-indicator-hide"></i>
                Sync Users
            </button>
            <span id="sync-noop-target"></span>

            <button class="btn btn-ghost" onclick="user_settings_modal.showModal()">
                <i class="fa-solid fa-cog"></i>
            </button>

            <div id="column-selector-container" class="dropdown dropdown-end hidden">
                <label tabindex="0" class="btn btn-ghost" title="Select columns">
                    <i class="fa-solid fa-table-columns mr-1"></i> Columns
                </label>
                <ul tabindex="0" id="column-selector-menu" class="dropdown-content z-[1] menu p-2 shadow bg-base-300 rounded-box w-52">
                    <li><a>Loading...</a></li>
                </ul>
            </div>

            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-ghost" title="Change view">
                    <i class="fa-solid fa-display mr-1"></i> View <i class="fa-solid fa-chevron-down fa-xs ml-1"></i>
                </label>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-300 rounded-box w-40">
                    {% set cards_args = request.args.to_dict() %}{% do cards_args.update({'view': 'cards'}) %}
                    <li><a href="{{ url_for('users.list_users', **cards_args) }}" class="{{ 'font-bold bg-base-100/50' if current_view == 'cards' else '' }}"><i class="fa-solid fa-grip-vertical fa-fw mr-2"></i> Card View</a></li>
                    {% set table_args = request.args.to_dict() %}{% do table_args.update({'view': 'table'}) %}
                    <li><a href="{{ url_for('users.list_users', **table_args) }}" class="{{ 'font-bold bg-base-100/50' if current_view == 'table' else '' }}"><i class="fa-solid fa-table-list fa-fw mr-2"></i> Table View</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Simple Search Bar with Filter Button -->
    <form method="GET" action="{{ url_for('users.list_users') }}" class="p-4 bg-base-200 rounded-lg shadow mb-6">
        <div class="flex gap-2">
            <div class="form-control flex-1">
                <input type="text" name="search" placeholder="Search by username or email..." 
                       class="input input-bordered w-full" value="{{ request.args.get('search', '') }}">
                <!-- Hidden inputs to preserve current filters -->
                <input type="hidden" name="server_id" value="{{ request.args.get('server_id', 'all') }}">
                <input type="hidden" name="filter_type" value="{{ request.args.get('filter_type', '') }}">
                <input type="hidden" name="sort_by" value="{{ request.args.get('sort_by', 'username_asc') }}">
                <input type="hidden" name="per_page" value="{{ current_per_page }}">
                <input type="hidden" name="view" value="{{ current_view }}">
                <input type="hidden" name="search_username" value="{{ request.args.get('search_username', '') }}">
                <input type="hidden" name="search_email" value="{{ request.args.get('search_email', '') }}">
                <input type="hidden" name="search_notes" value="{{ request.args.get('search_notes', '') }}">
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fa-solid fa-search"></i>
            </button>
            <label for="sort-filter-drawer" class="btn btn-secondary drawer-button">
                <i class="fa-solid fa-filter mr-0 sm:mr-2"></i>
                <span class="hidden sm:inline">Sort & Filter</span>
            </label>
            {% if current_user.has_permission('purge_users') %}
            <button type="button" class="btn btn-warning" onclick="purge_modal.showModal()">
                <i class="fa-solid fa-user-clock mr-0 sm:mr-2"></i>
                <span class="hidden sm:inline">Purge</span>
            </button>
            {% endif %}
        </div>
    </form>

    <!-- Sort and Filter Drawer -->
    <div class="drawer drawer-end">
        <input id="sort-filter-drawer" type="checkbox" class="drawer-toggle" />
        <div class="drawer-content">
            <!-- Page content here -->
        </div>
        <div class="drawer-side z-50">
            <label for="sort-filter-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
            <div class="menu bg-base-200 text-base-content min-h-full w-80 p-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold">
                        <i class="fa-solid fa-filter mr-2"></i>Sort & Filter Options
                    </h3>
                    <label for="sort-filter-drawer" class="btn btn-sm btn-circle btn-ghost">
                        <i class="fa-solid fa-times"></i>
                    </label>
                </div>
                
                <form method="GET" action="{{ url_for('users.list_users') }}" id="drawerFilterForm">
                    <!-- Preserve current view -->
                    <input type="hidden" name="view" value="{{ current_view }}">
                    
                    <div class="space-y-4">
                        <!-- Server Filter -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">
                                    <i class="fa-solid fa-server mr-2"></i>Server
                                </span>
                            </label>
                            <select name="server_id" class="select select-bordered">
                                {% for server in server_dropdown_options %}
                                <option value="{{ server.id }}" {% if request.args.get('server_id', 'all') == server.id %}selected{% endif %}>{{ server.server_nickname }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- User Type Filter -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">
                                    <i class="fa-solid fa-users mr-2"></i>User Type
                                </span>
                            </label>
                            <select name="user_type" class="select select-bordered">
                                {% for user_type in user_type_options %}
                                <option value="{{ user_type.id }}" {% if request.args.get('user_type', 'all') == user_type.id %}selected{% endif %}>{{ user_type.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Search Username -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">
                                    <i class="fa-solid fa-user mr-2"></i>Search Username
                                </span>
                            </label>
                            <input type="text" name="search_username" placeholder="Search by username..." class="input input-bordered" value="{{ request.args.get('search_username', '') }}">
                        </div>
                        
                        <!-- Search Email -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">
                                    <i class="fa-solid fa-envelope mr-2"></i>Search Email
                                </span>
                            </label>
                            <input type="text" name="search_email" placeholder="Search by email..." class="input input-bordered" value="{{ request.args.get('search_email', '') }}">
                        </div>
                        
                        <!-- Search Notes -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">
                                    <i class="fa-solid fa-sticky-note mr-2"></i>Search Notes
                                </span>
                            </label>
                            <input type="text" name="search_notes" placeholder="Search by notes..." class="input input-bordered" value="{{ request.args.get('search_notes', '') }}">
                        </div>
                        
                        <!-- Filter Type -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">
                                    <i class="fa-solid fa-filter mr-2"></i>Filter by
                                </span>
                            </label>
                            <select name="filter_type" class="select select-bordered">
                                <option value="" {% if not request.args.get('filter_type') %}selected{% endif %}>All Users</option>
                                <option value="home_user" {% if request.args.get('filter_type')=='home_user' %}selected{% endif %}>Home Users</option>
                                <option value="shares_back" {% if request.args.get('filter_type')=='shares_back' %}selected{% endif %}>Shares Back</option>
                                <option value="has_discord" {% if request.args.get('filter_type')=='has_discord' %}selected{% endif %}>Discord Linked</option>
                                <option value="no_discord" {% if request.args.get('filter_type')=='no_discord' %}selected{% endif %}>No Discord Linked</option>
                            </select>
                        </div>
                        
                        <!-- Sort Options -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">
                                    <i class="fa-solid fa-sort mr-2"></i>Sort by
                                </span>
                            </label>
                            <select name="sort_by" class="select select-bordered">
                                <option value="username_asc" {% if request.args.get('sort_by', 'username_asc' )=='username_asc' %}selected{% endif %}>Username (A-Z)</option>
                                <option value="username_desc" {% if request.args.get('sort_by')=='username_desc' %}selected{% endif %}>Username (Z-A)</option>
                                <option value="email_asc" {% if request.args.get('sort_by')=='email_asc' %}selected{% endif %}>Email (A-Z)</option>
                                <option value="email_desc" {% if request.args.get('sort_by')=='email_desc' %}selected{% endif %}>Email (Z-A)</option>
                                <option value="last_streamed_desc" {% if request.args.get('sort_by')=='last_streamed_desc' %}selected{% endif %}>Last Streamed (Recent)</option>
                                <option value="last_streamed_asc" {% if request.args.get('sort_by')=='last_streamed_asc' %}selected{% endif %}>Last Streamed (Oldest)</option>
                                <option value="created_at_desc" {% if request.args.get('sort_by')=='created_at_desc' %}selected{% endif %}>Date Added (Newest)</option>
                                <option value="created_at_asc" {% if request.args.get('sort_by')=='created_at_asc' %}selected{% endif %}>Date Added (Oldest)</option>
                            </select>
                        </div>
                        
                        <!-- Per Page -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">
                                    <i class="fa-solid fa-list mr-2"></i>Items per Page
                                </span>
                            </label>
                            <select name="per_page" class="select select-bordered">
                                {% for count in [12, 24, 48, 96] %}
                                <option value="{{ count }}" {% if current_per_page==count %}selected{% endif %}>{{ count }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-col gap-2 pt-4">
                            <button type="submit" class="btn btn-primary" onclick="document.getElementById('sort-filter-drawer').checked = false;">
                                <i class="fa-solid fa-check mr-2"></i>Apply Filters
                            </button>
                            <a href="{{ url_for('users.list_users') }}" class="btn btn-outline">
                                <i class="fa-solid fa-refresh mr-2"></i>Clear All
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <div id="mass-edit-container" class="mb-4 hidden">
        <div class="flex items-center space-x-2">
            <button type="button" class="btn btn-accent" id="mass-edit-open-button">
                <i class="fa-solid fa-pen-to-square mr-0 sm:mr-2"></i> 
                <span class="hidden sm:inline-block">Mass Edit (<span id="selected-users-count" class="contents">0</span> selected)</span>
                <span class="inline-block sm:hidden">(<span id="selected-users-count-mobile" class="contents">0</span>)</span>
            </button>
            <button type="button" class="btn btn-error" id="delete-selected-users-button" title="Delete selected users">
                <i class="fa-solid fa-trash mr-0 sm:mr-2"></i>
                <span class="hidden sm:inline-block">Delete Selected</span>
            </button>
            <button type="button" class="btn btn-secondary" id="tri_state_select_button" title="Select all users currently visible">
                <i class="fa-solid fa-square mr-0 sm:mr-2" id="tri_state_icon"></i>
                <span class="hidden sm:inline-block" id="tri_state_text">Select All</span>
            </button>
        </div>
    </div>

    <!-- Sync Loading State (hidden by default) -->
    <div id="sync-loading-state" class="hidden">
        <div class="text-center p-16">
            <span class="loading loading-lg loading-spinner text-primary"></span>
            <p class="mt-4 text-lg font-medium">Syncing users from all services...</p>
            <p class="text-sm text-base-content/70">This may take a few moments</p>
        </div>
    </div>

    <div id="user-list-container">
        <div hx-get="{{ url_for('users.list_users', **request.args.to_dict()) }}"
             hx-trigger="load"
             hx-target="#user-list-container"
             hx-swap="innerHTML">
            
            <div class="text-center p-8" id="initial-loading">
                <span class="loading loading-lg loading-spinner"></span>
                <p>Loading users...</p>
            </div>
        </div>
    </div>
</div>

<dialog id="mass_edit_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-4xl bg-base-100 border border-base-300 shadow-2xl p-0">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-base-300">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center">
                    <i class="fa-solid fa-users-cog text-primary text-lg"></i>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-base-content">Mass Edit Users</h3>
                    <p class="text-sm text-base-content/60">Apply changes to multiple users at once</p>
                </div>
            </div>
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost hover:bg-base-200">
                    <i class="fa-solid fa-times"></i>
                </button>
            </form>
        </div>

        <!-- Content -->
        <div class="p-6">

            <form id="massEditForm" method="POST"
                  hx-post="{{ url_for('users.mass_edit_users', **request.args.to_dict(flat=False)) }}"
                  hx-target="#user-list-container"
                  hx-swap="innerHTML"
                  hx-indicator="#mass_edit_loader"
                  hx-on::after-request="if (event.detail.successful) { mass_edit_modal.close(); }">
                {{ mass_edit_form.hidden_tag() }}
                <input type="hidden" name="user_ids" id="mass_edit_user_ids_input">
                
                <!-- Action Selection Section -->
                <div class="space-y-4 mb-6">
                    <h4 class="font-medium text-base-content text-lg mb-3">
                        <i class="fa-solid fa-cog text-primary text-sm mr-2"></i>
                        Select Action
                    </h4>
                    
                    <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/30 hover:border-base-300/60 transition-colors">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fa-solid fa-list-check text-primary text-sm"></i>
                            <h5 class="font-medium text-base-content">{{ mass_edit_form.action.label.text }}</h5>
                        </div>
                        {{ mass_edit_form.action(class="select select-bordered w-full", id="mass_edit_action_select") }}
                        <p class="text-xs text-base-content/60 mt-2">Choose what action to perform on the selected users</p>
                    </div>
                </div>

                <!-- Libraries Section (Dynamic Content) -->
                <div id="mass_edit_libraries_section" class="space-y-4 mb-6 hidden">
                    <h4 class="font-medium text-base-content text-lg mb-3">
                        <i class="fa-solid fa-books text-accent text-sm mr-2"></i>
                        Library Access
                    </h4>
                    
                    <div id="mass_edit_libraries_content">
                        <!-- Dynamic content will be loaded here -->
                        <div class="bg-base-200/30 rounded-lg p-8 border border-base-300/30 text-center">
                            <span class="loading loading-spinner loading-lg"></span>
                            <p class="text-sm text-base-content/60 mt-4">Loading libraries...</p>
                        </div>
                    </div>
                </div>

                <!-- Extend Access Section -->
                <div id="mass_edit_extend_access_section" class="space-y-4 mb-6 hidden">
                    <h4 class="font-medium text-base-content text-lg mb-3">
                        <i class="fa-solid fa-calendar-plus text-success text-sm mr-2"></i>
                        Extend Access
                    </h4>
                    
                    <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/30">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">Days to Extend</span>
                            </label>
                            {{ mass_edit_form.days_to_extend(class="input input-bordered", placeholder="Enter number of days") }}
                            <div class="label">
                                <span class="label-text-alt">Extends current expiration date, or sets expiration from today if none exists</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Set Expiration Section -->
                <div id="mass_edit_set_expiration_section" class="space-y-4 mb-6 hidden">
                    <h4 class="font-medium text-base-content text-lg mb-3">
                        <i class="fa-solid fa-calendar-xmark text-warning text-sm mr-2"></i>
                        Set Expiration Date
                    </h4>
                    
                    <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/30">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">Expiration Date</span>
                            </label>
                            {{ mass_edit_form.new_expiration_date(class="input input-bordered") }}
                            <div class="label">
                                <span class="label-text-alt">Users will lose access at the end of this date</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Clear Expiration Section -->
                <div id="mass_edit_clear_expiration_section" class="space-y-4 mb-6 hidden">
                    <h4 class="font-medium text-base-content text-lg mb-3">
                        <i class="fa-solid fa-infinity text-info text-sm mr-2"></i>
                        Clear Expiration
                    </h4>
                    
                    <div class="bg-info/10 rounded-lg p-4 border border-info/30">
                        <div class="flex items-start gap-3">
                            <i class="fa-solid fa-info-circle text-info text-lg mt-0.5"></i>
                            <div>
                                <h5 class="font-medium text-base-content mb-1">Permanent Access</h5>
                                <p class="text-sm text-base-content/80">
                                    This will remove expiration dates from selected users, granting them permanent access until manually changed.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete Confirmation Section -->
                <div id="mass_edit_delete_confirmation_section" class="space-y-4 mb-6 hidden">
                    <h4 class="font-medium text-base-content text-lg mb-3">
                        <i class="fa-solid fa-exclamation-triangle text-error text-sm mr-2"></i>
                        Confirm Deletion
                    </h4>
                    
                    <div class="bg-error/10 rounded-lg p-4 border border-error/30">
                        <div class="flex items-start gap-3">
                            <i class="fa-solid fa-triangle-exclamation text-error text-lg mt-0.5"></i>
                            <div>
                                <h5 class="font-medium text-base-content mb-1">Permanent Action Warning</h5>
                                <p class="text-sm text-base-content/80 mb-3">
                                    This will permanently remove the selected users from both MUM and all connected media servers. This action cannot be undone.
                                </p>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    {{ mass_edit_form.confirm_delete(class="checkbox checkbox-error", id="mass_edit_confirm_delete") }}
                                    <span class="font-medium text-base-content">I understand this action is permanent and cannot be undone</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center justify-end gap-3 mt-8 pt-6 border-t border-base-300">
                    <button type="button" class="btn btn-ghost" onclick="mass_edit_modal.close()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary gap-2" id="mass_edit_submit_button">
                        <span id="mass_edit_loader" class="htmx-indicator loading loading-spinner loading-xs"></span>
                        <i class="fa-solid fa-check"></i>
                        Apply Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</dialog>

<dialog id="confirm_purge_modal" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box max-w-2xl">
    <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="confirm_purge_modal.close()">âœ•</button>
    </form>
    <div id="confirm_purge_modal_content_div">
        <div class="text-center p-8"><span class="loading loading-lg loading-spinner"></span><p>Loading preview...</p></div>
    </div>
  </div>
</dialog>

<dialog id="sync_results_modal" class="modal modal-bottom sm:modal-middle">
  <div id="syncResultModalContainer">
      <div class="modal-box"><div class="text-center p-8"><span class="loading loading-lg loading-spinner"></span><p>Loading sync results...</p></div></div>
  </div>
</dialog>

<dialog id="quick_edit_user_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-2xl bg-base-100 border border-base-300 shadow-2xl p-0">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-base-300">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center">
                    <i class="fa-solid fa-user-edit text-primary text-lg"></i>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-base-content">Quick Edit User</h3>
                    <p class="text-sm text-base-content/60">Modify user settings and permissions</p>
                </div>
            </div>
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost hover:bg-base-200">
                    <i class="fa-solid fa-times"></i>
                </button>
            </form>
        </div>

        <!-- Content -->
        <div class="p-6">
            <div id="quick_edit_modal_content_div">
                <div class="text-center p-8"><span class="loading loading-lg loading-spinner"></span></div>
            </div>
        </div>
    </div>
</dialog>

<dialog id="purge_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-5xl bg-base-100 border border-base-300 shadow-2xl p-0">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-base-300">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-warning/20 flex items-center justify-center">
                    <i class="fa-solid fa-user-clock text-warning text-lg"></i>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-base-content">Purge Inactive Users</h3>
                    <p class="text-sm text-base-content/60">Manage inactive user cleanup</p>
                </div>
            </div>
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost hover:bg-base-200">
                    <i class="fa-solid fa-times"></i>
                </button>
            </form>
        </div>

        <!-- Content -->
        <div class="p-6">
            <!-- Description Card -->
            <div class="bg-base-200/50 rounded-lg p-4 mb-6 border border-base-300">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full bg-info/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                        <i class="fa-solid fa-info text-info text-sm"></i>
                    </div>
                    <div>
                        <h4 class="font-medium text-base-content mb-1">How it works</h4>
                        <p class="text-sm text-base-content/70 leading-relaxed">
                            Automatically remove users from MUM and your media servers if they haven't streamed content
                            for a specified period. Plex Home users are always excluded from purging.
                        </p>
                    </div>
                </div>
            </div>

            <form id="previewPurgeForm"
                  hx-post="{{ url_for('users.preview_purge_inactive_users') }}"
                  hx-target="#confirm_purge_modal_content_div"
                  hx-swap="innerHTML"
                  hx-indicator="#preview-purge-loader"
                  hx-on::after-request="if(event.detail.successful && event.detail.xhr.status !== 400) confirm_purge_modal.showModal();">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <!-- Settings Grid -->
                <div class="space-y-4">
                    <!-- Inactive Days Setting -->
                    <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-1">
                                    <h4 class="font-medium text-base-content mb-1">Inactivity Threshold</h4>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="inactive_days_modal_form" name="inactive_days" 
                                            class="input input-bordered input-sm w-20 text-center" 
                                            value="{{ purge_settings.inactive_days }}" min="7" required>
                                        <span class="text-sm text-base-content/60">days</span>
                                    </div>
                                </div>
                                <p class="text-sm text-base-content/60">Users inactive for this many days will be eligible for purging</p>
                            </div>
                        </div>
                        <div class="mt-2">
                            <span class="text-xs text-base-content/50">Minimum: 7 days</span>
                        </div>
                    </div>

                    <!-- Protection Settings -->
                    <div class="space-y-3">
                        <h4 class="font-medium text-base-content text-lg mb-3">Protection Settings</h4>
                        
                        <!-- Exclude Sharers -->
                        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex justify-between mb-1">
                                        <div class="flex items-center gap-2">
                                            <i class="fa-solid fa-share text-success text-sm"></i>
                                            <h5 class="font-medium text-base-content">Protect Sharers</h5>
                                        </div>
                                        <input type="checkbox" id="exclude_sharers_modal_form" name="exclude_sharers" value="true"
                                        class="toggle toggle-success" 
                                        {% if purge_settings.exclude_sharers %}checked{% endif %}>
                                    </div>
                                    <p class="text-sm text-base-content/60">Exclude users marked as "Shares Back" from purging</p>
                                </div>
                            </div>
                        </div>

                        <!-- Exclude Whitelisted -->
                        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex justify-between mb-1">
                                        <div class="flex items-center gap-2">
                                            <i class="fa-solid fa-shield-halved text-primary text-sm"></i>
                                            <h5 class="font-medium text-base-content">Protect Whitelisted Users</h5>
                                        </div>
                                        <input type="checkbox" id="exclude_purge_whitelisted_modal_form" name="exclude_purge_whitelisted" value="true"
                                        class="toggle toggle-primary" checked>
                                    </div>
                                    <p class="text-sm text-base-content/60">Exclude users on the Purge Whitelist from purging</p>
                                </div>
                            </div>
                        </div>

                        <!-- Ignore Creation Date -->
                        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex justify-between mb-1">
                                        <div class="flex items-center gap-2">
                                            <i class="fa-solid fa-calendar-xmark text-warning text-sm"></i>
                                            <h5 class="font-medium text-base-content">Ignore Creation Date</h5>
                                        </div>
                                        <input type="checkbox" id="ignore_creation_date_modal_form" name="ignore_creation_date" value="true"
                                        class="toggle toggle-warning">
                                    </div>
                                    <p class="text-sm text-base-content/60">Purge users who never streamed, regardless of when they were added</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center justify-end gap-3 mt-8 pt-6 border-t border-base-300">
                    <button type="button" class="btn btn-ghost" onclick="purge_modal.close()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-warning gap-2">
                        <span id="preview-purge-loader" class="htmx-indicator loading loading-spinner loading-xs"></span>
                        <i class="fa-solid fa-list-check"></i>
                        Preview Purge
                    </button>
                </div>
            </form>
            
            <div id="purge-status-message" class="mt-4 min-h-[2rem]"></div>
        </div>
    </div>
</dialog>
<dialog id="user_settings_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-3xl bg-base-100 border border-base-300 shadow-2xl p-0">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-base-300">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center">
                    <i class="fa-solid fa-cog text-primary text-lg"></i>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-base-content">User Display Settings</h3>
                    <p class="text-sm text-base-content/60">Customize how users are displayed</p>
                </div>
            </div>
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost hover:bg-base-200">
                    <i class="fa-solid fa-times"></i>
                </button>
            </form>
        </div>

        <!-- Content -->
        <div class="p-6">
            <!-- Description Card -->
            <div class="bg-base-200/50 rounded-lg p-4 mb-6 border border-base-300">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full bg-info/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                        <i class="fa-solid fa-info text-info text-sm"></i>
                    </div>
                    <div>
                        <h4 class="font-medium text-base-content mb-1">Personalization</h4>
                        <p class="text-sm text-base-content/70 leading-relaxed">
                            Configure how the user interface displays information and behaves to match your preferences.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Settings Grid -->
            <div class="space-y-4">
                <!-- Display Settings Section -->
                <div class="space-y-3">
                    <h4 class="font-medium text-base-content text-lg mb-3">Display Options</h4>
                    
                    <!-- Show User Notes -->
                    <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex justify-between mb-1">
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-sticky-note text-warning text-sm"></i>
                                        <h5 class="font-medium text-base-content">Show User Notes on Cards</h5>
                                    </div>
                                    <input type="checkbox" id="show_user_notes_toggle" class="toggle toggle-warning" />
                                </div>
                                <p class="text-sm text-base-content/60">Display user notes directly on user cards for quick reference</p>
                            </div>
                        </div>
                    </div>

                    <!-- Preferred View -->
                    <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex justify-between mb-1">
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-layout text-secondary text-sm"></i>
                                        <h5 class="font-medium text-base-content">Preferred Default View</h5>
                                    </div>
                                    <select id="preferred_view_select" class="select select-bordered select-sm max-w-fit">
                                        <option value="cards">Cards</option>
                                        <option value="table">Table</option>
                                    </select>
                                </div>
                                <p class="text-sm text-base-content/60">Choose how users are displayed by default when loading the page</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Behavior Settings Section -->
                <div class="space-y-3">
                    <h4 class="font-medium text-base-content text-lg mb-3">Behavior Settings</h4>
                    
                    <!-- Auto-sync -->
                    <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex justify-between mb-1">
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-sync text-success text-sm"></i>
                                        <h5 class="font-medium text-base-content">Auto-sync Users on Page Load</h5>
                                    </div>
                                    <input type="checkbox" id="auto_sync_users_toggle" class="toggle toggle-success" />
                                </div>
                                <p class="text-sm text-base-content/60">Automatically sync users from all services when visiting this page</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center justify-end gap-3 mt-8 pt-6 border-t border-base-300">
                <button type="button" class="btn btn-ghost" onclick="user_settings_modal.close()">
                    Cancel
                </button>
                <button id="save_user_settings_btn" class="btn btn-primary gap-2">
                    <i class="fa-solid fa-save"></i>
                    Save Settings
                </button>
            </div>
        </div>
    </div>
</dialog>

<!-- User Debug Info Modal -->
<dialog id="user_debug_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-5xl bg-base-100 border border-base-300 shadow-2xl p-0">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-base-300">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-secondary/20 flex items-center justify-center">
                    <i class="fa-solid fa-code text-secondary text-lg"></i>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-base-content">Raw User Data</h3>
                    <p class="text-sm text-base-content/60">Debug information and raw service data</p>
                </div>
            </div>
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost hover:bg-base-200">
                    <i class="fa-solid fa-times"></i>
                </button>
            </form>
        </div>

        <!-- Content -->
        <div class="p-6">
            <div id="user_debug_modal_content">
                <!-- Content will be loaded here via HTMX -->
                <div class="text-center p-8"><span class="loading loading-lg loading-spinner"></span></div>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>
{% endblock %}

{% block scripts %}
{{ super() }}
<style>
/* Service-specific selection styling for user cards */
.user-card.selected {
    transition: all 0.2s ease-in-out;
    outline: 2px solid;
    outline-offset: 2px;
}

/* Show checkbox when selected */
.user-card.selected .user-select-checkbox,
.user-card:hover .user-select-checkbox {
    opacity: 1 !important;
}
</style>
<script>
    // User Display Settings Logic
    const userSettingsModal = document.getElementById('user_settings_modal');
    const showUserNotesToggle = document.getElementById('show_user_notes_toggle');
    const preferredViewSelect = document.getElementById('preferred_view_select');
    const saveSettingsBtn = document.getElementById('save_user_settings_btn');
    const openSettingsBtn = document.querySelector('button[onclick="user_settings_modal.showModal()"]');

    // This function applies the "Show Notes" preference to the user cards on the page.
    function applyShowNotesPreference() {
        const showNotes = localStorage.getItem('showUserNotes') === 'true';
        document.querySelectorAll('.user-notes-container').forEach(container => {
            container.style.display = showNotes ? '' : 'none';
        });
    }

    // This function is called when the modal is opened. It sets the
    // inputs inside the modal to reflect the currently saved settings.
    function loadSettingsIntoModal() {
        const showNotes = localStorage.getItem('showUserNotes') === 'true';
        showUserNotesToggle.checked = showNotes;

        const autoSync = localStorage.getItem('autoSyncUsers') === 'true';
        document.getElementById('auto_sync_users_toggle').checked = autoSync;

        const preferredView = localStorage.getItem('userListView') || 'cards';
        preferredViewSelect.value = preferredView;
    }

    // When the settings cog is clicked, load the current settings into the modal before showing it.
    if (openSettingsBtn) {
        openSettingsBtn.addEventListener('click', loadSettingsIntoModal);
    }

    // When the "Save" button is clicked...
    saveSettingsBtn.addEventListener('click', function() {
        // 1. Get the chosen values from the modal inputs.
        const showNotes = showUserNotesToggle.checked;
        const autoSync = document.getElementById('auto_sync_users_toggle').checked;
        const preferredView = preferredViewSelect.value;

        // 2. Save them to localStorage for immediate UI updates.
        localStorage.setItem('showUserNotes', showNotes);
        localStorage.setItem('autoSyncUsers', autoSync);
        localStorage.setItem('userListView', preferredView);

        // 3. Visually apply the notes preference right away.
        applyShowNotesPreference();

        // 4. Send the preferred view to the backend to save in the database.
        htmx.ajax('POST', '/users/save_view_preference', {
            values: { view_mode: preferredView },
            swap: 'none'
        }).then(() => {
            // SUCCESS: The request completed successfully (e.g., status 204).
            userSettingsModal.close();
            htmx.trigger(document.body, 'showToastEvent', { message: 'Settings saved successfully!', category: 'success' });
            
            // If the view preference was changed, the user can see the result by navigating to the new view manually.
            // No automatic reload is needed.
            if (preferredView !== '{{ current_view }}') {
                // Optional: could trigger a soft refresh of the content area if desired,
                // but for now, we will just let the user navigate.
            }
        }).catch((error) => {
            // ERROR: The request failed (e.g., status 4xx, 5xx, or network error).
            console.error("Failed to save settings:", error);
            userSettingsModal.close();
            htmx.trigger(document.body, 'showToastEvent', { message: 'Failed to save settings.', category: 'error' });
        });
    });

    // On initial page load, apply the "Show Notes" preference.
    document.addEventListener('DOMContentLoaded', applyShowNotesPreference);
    
    // After any HTMX content swap, re-apply the "Show Notes" preference.
    htmx.on('htmx:afterSwap', applyShowNotesPreference);
</script>
<script>
    const TABLE_COLUMNS = {
        email: 'Email',
        status: 'Status',
        libraries: 'Libraries',
        plex_join_date: 'Plex Join Date',
        last_known_ip: 'Last Known IP',
        total_plays: 'Total Plays',
        total_duration: 'Total Duration',
        last_streamed: 'Last Streamed'
        //actions: 'Actions'
    };
    function saveColumnPreferences(prefs) { localStorage.setItem('userTableColumnPrefs', JSON.stringify(prefs)); }
    function loadColumnPreferences() {
        const saved = localStorage.getItem('userTableColumnPrefs');
        return saved ? JSON.parse(saved) : Object.keys(TABLE_COLUMNS).reduce((acc, key) => ({ ...acc, [key]: true }), {});
    }
    function toggleColumn(columnName, isVisible) {
        const table = document.querySelector('.table');
        if (!table) return;
        const cells = table.querySelectorAll(`[data-col="${columnName}"]`);
        cells.forEach(cell => { cell.style.display = isVisible ? '' : 'none'; });
    }
    function populateColumnSelector() {
        const menu = document.getElementById('column-selector-menu');
        const prefs = loadColumnPreferences();
        if (!menu) return;
        menu.innerHTML = '';
        for (const [key, label] of Object.entries(TABLE_COLUMNS)) {
            const li = document.createElement('li');
            const isChecked = prefs[key] !== false;
            li.innerHTML = `<label class="label cursor-pointer"><input type="checkbox" class="checkbox checkbox-primary column-toggle-checkbox" data-column="${key}" ${isChecked ? 'checked' : ''}><span class="label-text">${label}</span></label>`;
            menu.appendChild(li);
        }
        attachColumnToggleListeners();
    }
    function applyColumnPreferences() {
        const prefs = loadColumnPreferences();
        for (const [key, isVisible] of Object.entries(prefs)) {
            toggleColumn(key, isVisible !== false);
        }
    }
    function attachColumnToggleListeners() {
        document.querySelectorAll('.column-toggle-checkbox').forEach(checkbox => {
            if (checkbox.dataset.listenerAttached) return;
            checkbox.dataset.listenerAttached = 'true';
            checkbox.addEventListener('change', (event) => {
                const columnName = event.target.dataset.column;
                const isVisible = event.target.checked;
                const prefs = loadColumnPreferences();
                prefs[columnName] = isVisible;
                toggleColumn(columnName, isVisible);
                saveColumnPreferences(prefs);
            });
        });
    }

    const selectedUserIds = new Set();
    function updateMassEditUI() {
        const massEditContainer = document.getElementById('mass-edit-container');
        const selectedUsersCountSpan = document.getElementById('selected-users-count');
        const selectedUsersCountMobileSpan = document.getElementById('selected-users-count-mobile');
        if (!massEditContainer || !selectedUsersCountSpan) return;
        const count = selectedUserIds.size;
        selectedUsersCountSpan.textContent = count;
        if (selectedUsersCountMobileSpan) {
            selectedUsersCountMobileSpan.textContent = count;
        }
        massEditContainer.classList.toggle('hidden', count === 0);
    }

    function reinitializeUserListFeatures() {
        const currentView = '{{ current_view }}';
        const columnSelectorContainer = document.getElementById('column-selector-container');
        if (currentView === 'table' && columnSelectorContainer) {
            columnSelectorContainer.classList.remove('hidden');
            populateColumnSelector();
            applyColumnPreferences();
        } else if (columnSelectorContainer) {
            columnSelectorContainer.classList.add('hidden');
        }
        updateMassEditUI();
        updateTriStateButton();
    }

    // Functions to show/hide sync loading state
    function showSyncLoading() {
        console.log('Showing sync loading state...');
        const userListContainer = document.getElementById('user-list-container');
        const syncLoadingState = document.getElementById('sync-loading-state');
        
        if (userListContainer && syncLoadingState) {
            userListContainer.classList.add('hidden');
            syncLoadingState.classList.remove('hidden');
        }
    }

    function hideSyncLoading() {
        console.log('Hiding sync loading state...');
        const userListContainer = document.getElementById('user-list-container');
        const syncLoadingState = document.getElementById('sync-loading-state');
        
        if (userListContainer && syncLoadingState) {
            syncLoadingState.classList.add('hidden');
            userListContainer.classList.remove('hidden');
            
            // Refresh the user list after sync
            htmx.ajax('GET', '{{ url_for("users.list_users", **request.args.to_dict()) }}', {
                target: '#user-list-container',
                swap: 'innerHTML'
            });
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Check if auto-sync is enabled and trigger sync on page load
        const autoSyncEnabled = localStorage.getItem('autoSyncUsers') === 'true';
        if (autoSyncEnabled) {
            console.log('Auto-sync enabled, skipping initial load and going directly to sync...');
            
            // Cancel the initial HTMX load request
            const initialLoader = document.querySelector('#user-list-container [hx-get]');
            if (initialLoader) {
                initialLoader.removeAttribute('hx-trigger');
            }
            
            // Show sync loading immediately
            showSyncLoading();
            
            // Trigger the sync button click after a short delay
            setTimeout(() => {
                const syncButton = document.querySelector('button[hx-post="{{ url_for("users.sync_all_users") }}"]');
                if (syncButton && !syncButton.disabled) {
                    syncButton.click();
                }
            }, 500);
        }

        htmx.on('#user-list-container', 'htmx:afterSwap', function() {
            selectedUserIds.clear();
            reinitializeUserListFeatures();
        });

        // Event delegation for user selection
        const userListContainer = document.getElementById('user-list-container');
        if (userListContainer) {
            userListContainer.addEventListener('change', function(event) {
                const target = event.target;
                if (target.matches('.user-select-checkbox') && target.dataset.userId) {
                    const userId = target.dataset.userId;
                    const card = target.closest('.user-card');
                    
                    if (target.checked) {
                        selectedUserIds.add(userId);
                        // Add selection styling with service color
                        if (card) {
                            card.classList.add('selected');
                            const serviceColor = card.dataset.serviceColor;
                            if (serviceColor) {
                                card.style.outlineColor = serviceColor;
                                card.style.backgroundColor = `color-mix(in srgb, ${serviceColor} 10%, transparent)`;
                            }
                        }
                    } else {
                        selectedUserIds.delete(userId);
                        // Remove selection styling
                        if (card) {
                            card.classList.remove('selected');
                            card.style.outlineColor = '';
                            card.style.backgroundColor = '';
                        }
                    }
                    updateMassEditUI();
                    updateTriStateButton();
                }
            });
            userListContainer.addEventListener('click', function(event) {
                const card = event.target.closest('.user-card-clickable');
                if (card && !event.target.closest('a, button, .user-select-checkbox')) {
                    const checkbox = card.querySelector('.user-select-checkbox');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            });
        }
        
        // Function to update tri-state button appearance
        function updateTriStateButton() {
            const triStateBtn = document.getElementById('tri_state_select_button');
            const triStateIcon = document.getElementById('tri_state_icon');
            const triStateText = document.getElementById('tri_state_text');
            
            if (!triStateBtn || !triStateIcon || !triStateText) return;
            
            const checkboxes = document.querySelectorAll('#user-list-container .user-select-checkbox');
            const checkedCount = document.querySelectorAll('#user-list-container .user-select-checkbox:checked').length;
            const totalCount = checkboxes.length;
            
            if (checkedCount === 0) {
                // No items selected - empty state
                triStateIcon.className = 'fa-solid fa-square mr-0 sm:mr-2';
                triStateText.textContent = 'Select All';
                triStateBtn.title = 'Select all users currently visible';
                triStateBtn.dataset.state = 'none';
            } else if (checkedCount === totalCount) {
                // All items selected - full state
                triStateIcon.className = 'fa-solid fa-check-square mr-0 sm:mr-2';
                triStateText.textContent = 'Unselect All';
                triStateBtn.title = 'Unselect all users';
                triStateBtn.dataset.state = 'all';
            } else {
                // Some items selected - indeterminate state
                triStateIcon.className = 'fa-solid fa-minus-square mr-0 sm:mr-2';
                triStateText.textContent = 'Select All';
                triStateBtn.title = `${checkedCount} of ${totalCount} selected - click to select all`;
                triStateBtn.dataset.state = 'some';
            }
        }
        
        // Tri-state select button listener
        const triStateBtn = document.getElementById('tri_state_select_button');
        if (triStateBtn) {
            triStateBtn.onclick = function() {
                const currentState = this.dataset.state;
                const checkboxes = document.querySelectorAll('#user-list-container .user-select-checkbox');
                
                if (currentState === 'all') {
                    // All selected -> Unselect all
                    checkboxes.forEach(cb => {
                        if (cb.checked) {
                            cb.checked = false;
                            cb.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                } else {
                    // None or some selected -> Select all
                    checkboxes.forEach(cb => {
                        if (!cb.checked) {
                            cb.checked = true;
                            cb.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                }
            };
        }

        // Delete selected users button
        const deleteSelectedUsersBtn = document.getElementById('delete-selected-users-button');
        if (deleteSelectedUsersBtn) {
            deleteSelectedUsersBtn.onclick = function() {
                if (selectedUserIds.size === 0) return;
                
                const userCount = selectedUserIds.size;
                const confirmMessage = `Are you sure you want to delete ${userCount} user(s)? This will remove them from MUM AND all media servers. This action cannot be undone.`;
                
                if (confirm(confirmMessage)) {
                    // Create form data
                    const formData = new FormData();
                    formData.append('action', 'delete_users');
                    formData.append('confirm_delete', 'true');
                    
                    // Add user IDs as a comma-separated string (matching the modal form)
                    const userIdsString = Array.from(selectedUserIds).join(',');
                    formData.append('user_ids', userIdsString);
                    
                    console.log('Deleting users with IDs:', userIdsString);
                    
                    // Add CSRF token
                    const csrfToken = document.querySelector('meta[name=csrf-token]');
                    if (csrfToken) {
                        formData.append('csrf_token', csrfToken.getAttribute('content'));
                    }
                    
                    // Send delete request
                    fetch('{{ url_for("users.mass_edit_users", **request.args.to_dict(flat=False)) }}', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.ok) {
                            // Refresh the user list by triggering HTMX reload
                            const userListContainer = document.getElementById('user-list-container');
                            if (userListContainer) {
                                htmx.ajax('GET', '{{ url_for("users.list_users", **request.args.to_dict()) }}', {
                                    target: '#user-list-container',
                                    swap: 'innerHTML'
                                });
                            }
                            selectedUserIds.clear();
                            updateMassEditUI();
                            if(typeof window.showToast === 'function') {
                                showToast(`Successfully deleted ${userCount} user(s)`, 'success');
                            }
                        } else {
                            response.text().then(errorText => {
                                console.error('Delete request failed:', errorText);
                                if(typeof window.showToast === 'function') {
                                    showToast('Error deleting users: ' + response.statusText, 'error');
                                }
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        if(typeof window.showToast === 'function') {
                            showToast('Error deleting users', 'error');
                        }
                    });
                }
            };
        }

        // Mass Edit Modal Logic
        const massEditSubmitButton = document.getElementById('mass_edit_submit_button');
        const massEditForm = document.getElementById('massEditForm');
        const massEditActionSelect = document.getElementById('mass_edit_action_select');
        const librariesSection = document.getElementById('mass_edit_libraries_section');
        const deleteConfirmSection = document.getElementById('mass_edit_delete_confirmation_section');
        const confirmDeleteCheckbox = document.getElementById('mass_edit_confirm_delete');
        
        if (massEditSubmitButton) {
            massEditSubmitButton.addEventListener('click', function() {
                const hiddenInput = document.getElementById('mass_edit_user_ids_input');
                if (hiddenInput) {
                    hiddenInput.value = Array.from(selectedUserIds).join(',');
                }
            });
        }

        const massEditOpenButton = document.getElementById('mass-edit-open-button');
        const massEditModal = document.getElementById('mass_edit_modal');

        function syncMassEditActionState() {
            if (!massEditActionSelect) return;
            const action = massEditActionSelect.value;
            
            // Hide all sections first
            if(librariesSection) librariesSection.classList.add('hidden');
            if(deleteConfirmSection) deleteConfirmSection.classList.add('hidden');
            const extendAccessSection = document.getElementById('mass_edit_extend_access_section');
            const setExpirationSection = document.getElementById('mass_edit_set_expiration_section');
            const clearExpirationSection = document.getElementById('mass_edit_clear_expiration_section');
            if(extendAccessSection) extendAccessSection.classList.add('hidden');
            if(setExpirationSection) setExpirationSection.classList.add('hidden');
            if(clearExpirationSection) clearExpirationSection.classList.add('hidden');
            
            const submitBtn = document.getElementById('mass_edit_submit_button');
            if(submitBtn) submitBtn.disabled = (action === '');

            if (action === 'update_libraries' && librariesSection) {
                librariesSection.classList.remove('hidden');
                const userIds = Array.from(selectedUserIds).join(',');
                htmx.ajax('GET', `{{ url_for('users.mass_edit_libraries_form') }}?user_ids=${userIds}`, {
                    target: '#mass_edit_libraries_content',
                    swap: 'innerHTML'
                });
            } else if (action === 'extend_access' && extendAccessSection) {
                extendAccessSection.classList.remove('hidden');
            } else if (action === 'set_expiration' && setExpirationSection) {
                setExpirationSection.classList.remove('hidden');
            } else if (action === 'clear_expiration' && clearExpirationSection) {
                clearExpirationSection.classList.remove('hidden');
            } else if (action === 'delete_users' && deleteConfirmSection) {
                deleteConfirmSection.classList.remove('hidden');
                if (submitBtn && confirmDeleteCheckbox) {
                    submitBtn.disabled = !confirmDeleteCheckbox.checked;
                }
            } else if (action.includes('whitelist')) {
                // Whitelist actions don't need additional UI, just enable the submit button
                if(submitBtn) submitBtn.disabled = false;
            }
        }

        if (massEditOpenButton && massEditModal) {
            massEditOpenButton.addEventListener('click', function() {
                massEditModal.showModal();
                syncMassEditActionState();
            });
        }

        if (massEditActionSelect) {
            massEditActionSelect.addEventListener('change', syncMassEditActionState);
            syncMassEditActionState(); // Set initial state
        }

        if (confirmDeleteCheckbox) {
            confirmDeleteCheckbox.addEventListener('change', function () {
                const submitBtn = document.getElementById('mass_edit_submit_button');
                if (massEditActionSelect && massEditActionSelect.value === 'delete_users' && submitBtn) {
                    submitBtn.disabled = !this.checked;
                }
            });
        }
        
        document.body.addEventListener('openSyncResultsModal', function() {
            const modal = document.getElementById('sync_results_modal');
            if (modal) modal.showModal();
        });

        // Add click-outside-to-close functionality for modals
        function addClickOutsideToClose(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.addEventListener('click', function(e) {
                    // Check if the click was on the modal backdrop (not on the modal content)
                    if (e.target === modal) {
                        modal.close();
                    }
                });
            }
        }

        // Apply click-outside-to-close to both modals
        addClickOutsideToClose('mass_edit_modal');
        addClickOutsideToClose('quick_edit_user_modal');
    });

    // Button state management for sync users
    function showUserSyncLoading() {
        const btn = document.getElementById('sync-users-btn');
        if (btn) {
            btn.disabled = true;
            const spinner = btn.querySelector('#user-sync-spinner');
            const icon = btn.querySelector('.fa-sync');
            const text = btn.lastChild;
            
            if (spinner) spinner.style.display = 'inline-block';
            if (icon) icon.style.display = 'none';
            if (text && text.nodeType === Node.TEXT_NODE) {
                text.textContent = ' Syncing...';
            }
        }
    }

    function hideUserSyncLoading() {
        const btn = document.getElementById('sync-users-btn');
        if (btn) {
            btn.disabled = false;
            const spinner = btn.querySelector('#user-sync-spinner');
            const icon = btn.querySelector('.fa-sync');
            const text = btn.lastChild;
            
            if (spinner) spinner.style.display = 'none';
            if (icon) icon.style.display = 'inline';
            if (text && text.nodeType === Node.TEXT_NODE) {
                text.textContent = ' Sync Users';
            }
        }
    }

    // Global function for copying user raw data
    function copyUserRawData(userId) {
        const contentElement = document.querySelector(`#userRawDataContent-${userId} pre code`);
        if (contentElement) {
            const textToCopy = contentElement.textContent;
            navigator.clipboard.writeText(textToCopy).then(() => {
                // Find the copy button for this user
                const copyButton = document.querySelector(`button[onclick="copyUserRawData('${userId}')"]`);
                if (copyButton) {
                    const originalHTML = copyButton.innerHTML;
                    copyButton.innerHTML = '<i class="fa-solid fa-check mr-1"></i> Copied!';
                    copyButton.classList.add('btn-success');
                    copyButton.classList.remove('btn-outline');
                    setTimeout(() => {
                        copyButton.innerHTML = originalHTML;
                        copyButton.classList.remove('btn-success');
                        copyButton.classList.add('btn-outline');
                    }, 2000);
                }
            }).catch(err => {
                console.error('Failed to copy user raw data: ', err);
                const copyButton = document.querySelector(`button[onclick="copyUserRawData('${userId}')"]`);
                if (copyButton) {
                    const originalHTML = copyButton.innerHTML;
                    copyButton.innerHTML = '<i class="fa-solid fa-times mr-1"></i> Error!';
                    copyButton.classList.add('btn-error');
                    copyButton.classList.remove('btn-outline');
                    setTimeout(() => {
                        copyButton.innerHTML = originalHTML;
                        copyButton.classList.remove('btn-error');
                        copyButton.classList.add('btn-outline');
                    }, 2000);
                }
            });
        }
    }
</script>

<!-- Modal Containers for Local User Management -->
<dialog id="localUserEditModal" class="modal modal-bottom sm:modal-middle">
    <div id="localUserEditModalContainer">
        <!-- Content will be loaded here via HTMX -->
    </div>
</dialog>

<dialog id="linkedAccountsModal" class="modal modal-bottom sm:modal-middle">
    <div id="linkedAccountsModalContainer">
        <!-- Content will be loaded here via HTMX -->
    </div>
</dialog>

{% endblock %}