<!-- Watch Statistics Section - Similar to Tautulli -->
<div class="bg-base-200 text-neutral-content p-6 rounded-lg mb-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <h2 class="text-lg font-bold uppercase tracking-wide text-white">WATCH STATISTICS</h2>
        <div class="flex flex-wrap gap-2">
            <!-- Time Period Dropdown -->
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-sm btn-ghost text-white">
                    Last {{ selected_days if selected_days != -1 else 'All Time' }} Days
                    <i class="fa-solid fa-chevron-down ml-1"></i>
                </div>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                    <li><a href="{{ url_for('dashboard.index', days=7, services=selected_services) }}" class="{{ 'font-bold' if selected_days == 7 else '' }}">Last 7 Days</a></li>
                    <li><a href="{{ url_for('dashboard.index', days=30, services=selected_services) }}" class="{{ 'font-bold' if selected_days == 30 else '' }}">Last 30 Days</a></li>
                    <li><a href="{{ url_for('dashboard.index', days=90, services=selected_services) }}" class="{{ 'font-bold' if selected_days == 90 else '' }}">Last 90 Days</a></li>
                    <li><a href="{{ url_for('dashboard.index', days='all', services=selected_services) }}" class="{{ 'font-bold' if selected_days == -1 else '' }}">All Time</a></li>
                </ul>
            </div>
            
            <!-- Service Filter Dropdown -->
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-sm btn-ghost text-white">
                    {% if selected_services|length == 0 %}
                        All Services
                    {% elif selected_services|length == 1 %}
                        {{ selected_services[0].title() }}
                    {% else %}
                        {{ selected_services|length }} Services
                    {% endif %}
                    <i class="fa-solid fa-chevron-down ml-1"></i>
                </div>
                <div tabindex="0" class="dropdown-content z-[1] bg-base-100 rounded-box w-64 p-4 shadow">
                    <form id="serviceFilterForm" method="GET" action="{{ url_for('dashboard.index') }}">
                        <!-- Preserve current days parameter -->
                        <input type="hidden" name="days" value="{{ selected_days if selected_days != -1 else 'all' }}">
                        
                        <div class="form-control">
                            <h3 class="font-semibold mb-3">Filter by Services</h3>
                            
                            <!-- All Services Option -->
                            <label class="label cursor-pointer justify-start">
                                <input type="checkbox" id="allServices" style="--input-color: var(--color-primary)" class="checkbox checkbox-sm mr-2" 
                                       {{ 'checked' if selected_services|length == 0 else '' }}
                                       onchange="toggleAllServices()">
                                <span class="label-text font-medium">All Services</span>
                            </label>
                            
                            <div class="divider my-2"></div>
                            
                            <!-- Individual Service Options -->
                            {% for service in available_services %}
                            <label class="label cursor-pointer justify-start">
                                <input type="checkbox" name="services" value="{{ service.value }}" 
                                       class="checkbox checkbox-sm mr-2 service-checkbox"
                                       style="--input-color: var(--color-primary)"
                                       {{ 'checked' if service.value in selected_services else '' }}
                                       onchange="updateServiceSelection()">
                                <span class="label-text">
                                    {% if service.value == 'plex' %}
                                        <svg class="w-4 h-4 inline mr-1" viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M22 25.5h48L116 94l-46 68.5H22L68.5 94Zm109.8 56L108 46l14-20.5h48zm-.3 23.5c10.979 17.625 25.52 38.875 38.5 49.5-11.149 13.635-34.323 32.278-62.5-14z"/></svg>
                                    {% elif service.value == 'jellyfin' %}
                                        <i class="fa-solid fa-cube mr-1"></i>
                                    {% elif service.value == 'emby' %}
                                        <i class="fa-solid fa-play-circle mr-1"></i>
                                    {% elif service.value == 'kavita' %}
                                        <i class="fa-solid fa-book mr-1"></i>
                                    {% elif service.value == 'komga' %}
                                        <i class="fa-solid fa-book-open mr-1"></i>
                                    {% elif service.value == 'audiobookshelf' %}
                                        <i class="fa-solid fa-headphones mr-1"></i>
                                    {% elif service.value == 'romm' %}
                                        <i class="fa-solid fa-gamepad mr-1"></i>
                                    {% else %}
                                        <i class="fa-solid fa-server mr-1"></i>
                                    {% endif %}
                                    {{ service.value.title() }}
                                </span>
                            </label>
                            {% endfor %}
                            
                            <div class="mt-4 flex gap-2">
                                <button type="submit" class="btn btn-primary btn-sm flex-1">Apply</button>
                                <button type="button" class="btn btn-ghost btn-sm" onclick="clearFilters()">Clear</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Overall Statistics Cards -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
        <div class="bg-base-100 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-primary">{{ watch_statistics_data.total_plays }}</div>
            <div class="text-sm text-base-content/70">Total Plays</div>
        </div>
        <div class="bg-base-100 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-secondary">{{ watch_statistics_data.total_duration }}</div>
            <div class="text-sm text-base-content/70">Total Duration</div>
        </div>
        <div class="bg-base-100 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-accent">{{ watch_statistics_data.unique_titles }}</div>
            <div class="text-sm text-base-content/70">Unique Titles</div>
        </div>
        <div class="bg-base-100 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-info">{{ watch_statistics_data.unique_users }}</div>
            <div class="text-sm text-base-content/70">Active Users</div>
        </div>
        <div class="bg-base-100 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-success">{{ watch_statistics_data.avg_session_length }}</div>
            <div class="text-sm text-base-content/70">Avg Session</div>
        </div>
        <div class="bg-base-100 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-warning">{{ watch_statistics_data.peak_day_streams }}</div>
            <div class="text-sm text-base-content/70">Peak Day</div>
        </div>
    </div>

    <!-- Top Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Top Movies -->
        <div class="bg-base-100 rounded-lg p-4">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa-solid fa-film text-primary mr-2"></i>
                Top Movies
            </h3>
            {% if watch_statistics_data.top_movies %}
                <div class="space-y-3">
                    {% for movie in watch_statistics_data.top_movies %}
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium truncate">{{ movie.title }}</div>
                            <div class="text-xs text-base-content/70">{{ movie.duration }}</div>
                        </div>
                        <div class="text-right ml-2">
                            <div class="text-sm font-bold">{{ movie.plays }}</div>
                            <div class="text-xs text-base-content/70">plays</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8 text-base-content/50">
                    <i class="fa-solid fa-film fa-2x mb-2"></i>
                    <p>No movie data available</p>
                </div>
            {% endif %}
        </div>

        <!-- Top TV Shows -->
        <div class="bg-base-100 rounded-lg p-4">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa-solid fa-tv text-secondary mr-2"></i>
                Top TV Shows
            </h3>
            {% if watch_statistics_data.top_shows %}
                <div class="space-y-3">
                    {% for show in watch_statistics_data.top_shows %}
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium truncate">{{ show.title }}</div>
                            <div class="text-xs text-base-content/70">{{ show.duration }}</div>
                        </div>
                        <div class="text-right ml-2">
                            <div class="text-sm font-bold">{{ show.plays }}</div>
                            <div class="text-xs text-base-content/70">plays</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8 text-base-content/50">
                    <i class="fa-solid fa-tv fa-2x mb-2"></i>
                    <p>No TV show data available</p>
                </div>
            {% endif %}
        </div>

        <!-- Top Platforms -->
        <div class="bg-base-100 rounded-lg p-4">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa-solid fa-desktop text-accent mr-2"></i>
                Top Platforms
            </h3>
            {% if watch_statistics_data.top_platforms %}
                <div class="space-y-3">
                    {% for platform in watch_statistics_data.top_platforms %}
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium truncate">{{ platform.name }}</div>
                            <div class="text-xs text-base-content/70">{{ platform.duration }}</div>
                        </div>
                        <div class="text-right ml-2">
                            <div class="text-sm font-bold">{{ platform.plays }}</div>
                            <div class="text-xs text-base-content/70">plays</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8 text-base-content/50">
                    <i class="fa-solid fa-desktop fa-2x mb-2"></i>
                    <p>No platform data available</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function toggleAllServices() {
    const allServicesCheckbox = document.getElementById('allServices');
    const serviceCheckboxes = document.querySelectorAll('.service-checkbox');
    
    if (allServicesCheckbox.checked) {
        // Uncheck all individual services
        serviceCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
    }
}

function updateServiceSelection() {
    const allServicesCheckbox = document.getElementById('allServices');
    const serviceCheckboxes = document.querySelectorAll('.service-checkbox');
    const checkedServices = document.querySelectorAll('.service-checkbox:checked');
    
    // If any individual service is selected, uncheck "All Services"
    if (checkedServices.length > 0) {
        allServicesCheckbox.checked = false;
    } else {
        // If no services are selected, check "All Services"
        allServicesCheckbox.checked = true;
    }
}

function clearFilters() {
    // Check "All Services" and uncheck all individual services
    document.getElementById('allServices').checked = true;
    document.querySelectorAll('.service-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Submit the form to apply the clear
    document.getElementById('serviceFilterForm').submit();
}
</script>