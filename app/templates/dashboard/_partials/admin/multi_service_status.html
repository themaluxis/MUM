{# File: app/templates/dashboard/_partials/multi_service_status.html #}
{# Expects 'server_status' (dict) in context #}

{% if server_status and server_status.loading %}
    {# Initial state - show server count without status check #}
    <div class="flex flex-row gap-3 items-center">
        <div class="self-start p-3 rounded-md bg-base-300 text-base-content/60">
            <i class="fa-solid fa-server fa-2x"></i>
        </div>
        <div class="flex flex-col">
            <h2 class="card-title text-base-content/70 text-sm font-normal mb-px">Media Server Status</h2>
            <p class="text-sm text-base-content/70">Click "Check Status" to view server status</p>
            {% if server_status.server_count > 0 %}
                <p class="text-xs text-base-content/60">{{ server_status.server_count }} server{{ 's' if server_status.server_count != 1 else '' }} configured</p>
            {% endif %}
        </div>
    </div>
    <div class="card-actions justify-end mt-4">
        <button class="btn btn-xs btn-outline btn-primary"
                hx-get="{{ url_for('api.get_dashboard_server_status') }}"
                hx-target="#server_status_card_content"
                hx-swap="innerHTML"
                hx-indicator="#server_status_loader">
            <span id="server_status_loader" class="htmx-indicator loading loading-spinner loading-xs"></span>
            <i class="fa-solid fa-sync mr-1 htmx-indicator-hide"></i> Check Status
        </button>
        <a href="{{ url_for('plugin_management.index') }}" class="btn btn-xs btn-outline btn-ghost">
            <i class="fa-solid fa-sliders mr-1"></i> Configure
        </a>
    </div>

{% elif not server_status %}
    {# Case where no servers are configured at all #}
    <div class="flex flex-row gap-3 items-center">
        <div class="self-start p-3 rounded-md bg-base-300 text-base-content/60"><i class="fa-solid fa-server fa-2x"></i></div>
        <div class="flex flex-col">
            <h2 class="card-title text-base-content/70 text-sm font-normal mb-px">Media Server Status</h2>
            <p class="text-sm text-warning">No media servers configured.</p>
        </div>
    </div>
    <div class="card-actions justify-end mt-4">
        <a href="{{ url_for('plugin_management.index') }}" class="btn btn-xs btn-primary">
            <i class="fa-solid fa-sliders mr-1"></i> Configure a Server
        </a>
    </div>

{% elif server_status.multi_server %}
    {# Case for multiple servers #}
    <div class="flex flex-row gap-3 items-center">
        <div class="self-start p-3 rounded-md {{ 'bg-error/20 text-error' if server_status.offline_count > 0 else 'bg-success/20 text-success' }}"><i class="fa-solid fa-network-wired fa-2x"></i></div>
        <div class="flex flex-col">
            <h2 class="card-title text-base-content/70 text-sm font-normal mb-px">Media Server Status</h2>
            <div class="flex items-center gap-x-4 text-sm">
                <strong class="text-success">Online: {{ server_status.online_count }}</strong>
                {% if server_status.offline_count > 0 %}
                <strong class="text-error">Offline: {{ server_status.offline_count }}</strong>
                {% endif %}
            </div>
            {% if server_status.all_statuses and server_status.all_statuses|length > 0 %}
                {% set latest_check = server_status.all_statuses|selectattr('last_check_time')|map(attribute='last_check_time')|max %}
                {% if latest_check %}
                    <p class="text-xs text-base-content/60">Last checked: {{ latest_check | time_ago }}</p>
                {% endif %}
            {% endif %}
        </div>
    </div>
    <div class="card-actions justify-end mt-4">
        <button class="btn btn-xs btn-outline btn-primary"
                hx-get="{{ url_for('api.get_dashboard_server_status') }}"
                hx-target="#server_status_card_content"
                hx-swap="innerHTML"
                hx-indicator="#server_status_refresh_loader">
            <span id="server_status_refresh_loader" class="htmx-indicator loading loading-spinner loading-xs"></span>
            <i class="fa-solid fa-sync mr-1 htmx-indicator-hide"></i> Refresh
        </button>
        <button class="btn btn-xs btn-outline btn-ghost" onclick="openAllServersModal()">
            <i class="fa-solid fa-eye mr-1"></i> View All
        </button>
    </div>

{% else %}
    {# Case for a single server #}
    <div class="flex flex-row gap-3 items-center">
        <div class="self-start p-3 rounded-md {{ 'bg-success/20 text-success' if server_status.online else 'bg-error/20 text-error' }}"><i class="fa-solid fa-server fa-2x"></i></div>
        <div class="flex flex-col">
            <h2 class="card-title text-base-content/70 text-sm font-normal mb-px">{{ server_status.name | default('Server Status') }}</h2>
            {% if server_status.online %}
                <p class="text-sm"><strong class="text-success">Online</strong> - {{ server_status.friendly_name | default('Unknown Server') }}</p>
                <p class="text-xs text-base-content/70">Version: {{ server_status.version | default('N/A') }}</p>
            {% elif server_status.online == false %}
                <p class="text-sm"><strong class="text-error">Offline</strong></p>
                <p class="text-xs text-base-content/70" title="{{ server_status.error_message | default('Could not connect.') }}">
                    {{ server_status.error_message | default('Could not connect to server.') | truncate(100, True) }}
                </p>
            {% else %}
                <p class="text-sm text-base-content/70">Status unknown - click "Check Status"</p>
            {% endif %}
            {% if server_status.last_check_time %}
                <p class="text-xs text-base-content/60">Last checked: {{ server_status.last_check_time | time_ago }}</p>
            {% endif %}
        </div>
    </div>
    <div class="card-actions justify-end mt-4">
        <a href="{{ url_for('plugin_management.edit_server', plugin_id=server_status.service_type, server_id=server_status.server_id) }}" class="btn btn-xs btn-outline btn-ghost">
            <i class="fa-solid fa-sliders mr-1"></i> Configure
        </a>
        <button class="btn btn-xs btn-outline btn-ghost"
                hx-post="{{ url_for('api.check_server_status', server_id=server_status.server_id) }}"
                hx-target="#server_status_card_content"
                hx-swap="innerHTML"
                hx-indicator="#server_status_loader_refresh">
            <span id="server_status_loader_refresh" class="htmx-indicator loading loading-spinner loading-xs"></span>
            <i class="fa-solid fa-sync mr-1 htmx-indicator-hide"></i> Refresh
        </button>
    </div>
{% endif %}
