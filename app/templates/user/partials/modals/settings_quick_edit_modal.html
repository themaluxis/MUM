{# Use override form action if provided, otherwise determine based on user type #}
{% if form_action_override %}
    {% set form_action = form_action_override %}
{% elif user.__class__.__name__ == 'AppUser' %}
    {% set form_params = {'username': user.username, 'tab': 'settings'} %}
    {% if request.args.get('back') %}{% set _ = form_params.update({'back': request.args.get('back')}) %}{% endif %}
    {% if request.args.get('back_view') %}{% set _ = form_params.update({'back_view': request.args.get('back_view')}) %}{% endif %}
    {% set form_action = url_for('user.view_app_user', **form_params) %}
{% else %}
    {% set user_servers = user_server_names.get(user.id, []) %}
    {% if user_servers %}
        {% set server_name = user_servers[0] %}
        {% set username = user.get_display_name() %}
        {% set form_params = {'server_nickname': server_name, 'server_username': username, 'tab': 'settings'} %}
        {% if request.args.get('back') %}{% set _ = form_params.update({'back': request.args.get('back')}) %}{% endif %}
        {% if request.args.get('back_view') %}{% set _ = form_params.update({'back_view': request.args.get('back_view')}) %}{% endif %}
        {% set form_action = url_for('user.view_service_account', **form_params) %}
    {% else %}
        {% set form_action = '#' %}
    {% endif %}
{% endif %}

<!-- User Settings Form Content (for HTMX swapping) -->
<form method="POST"
      id="editUserForm"
      action="{{ form_action }}"
      hx-post="{{ form_action }}"
      hx-target="#editUserForm"
      hx-swap="outerHTML"
      onsubmit="console.log('Form submitted to:', this.action); return true;"
      hx-on::before-request="console.log('HTMX before request');"
      hx-on::after-request="console.log('HTMX after request');"
      hx-on::config-request="console.log('HTMX config request:', event.detail);"
      hx-on::response-error="console.log('HTMX response error:', event.detail);">

    <div class="space-y-6">
        <!-- Notes Section -->
        <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm overflow-hidden">
            <div class="bg-gradient-to-r from-yellow-50 dark:from-yellow-900/20 to-yellow-100 dark:to-yellow-800/20 p-4 border-b border-base-300">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i class="fa-solid fa-sticky-note text-yellow-600 dark:text-yellow-400"></i>
                    Notes & Comments
                </h3>
            </div>
            <div class="p-4">
                <div class="form-control">
                    {{ form.notes.label(class="label") }}
                    <span class="label-text text-sm text-base-content/70 mb-2 block">Add personal notes or important information about this user</span>
                    {{ form.notes(class="textarea textarea-bordered h-24 w-full bg-base-50 dark:bg-base-800/50 border-base-300 focus:border-primary focus:ring-2 focus:ring-primary/20 " + ("textarea-error" if form.notes.errors else ""), placeholder="Add any notes about this user...") }}
                    {% if form.notes.errors %}
                        {% for error in form.notes.errors %}
                            <p class="text-error text-xs mt-2">{{ error }}</p>
                        {% endfor %}
                    {% else %}
                        <p class="text-xs text-base-content/60 mt-2">Administrative notes are only visible to administrators</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- User Permissions Section -->
        <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm overflow-hidden">
            <div class="bg-gradient-to-r from-blue-50 dark:from-blue-900/20 to-blue-100 dark:to-blue-800/20 p-4 border-b border-base-300">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i class="fa-solid fa-user-cog text-blue-600 dark:text-blue-400"></i>
                    User Permissions
                </h3>
            </div>
            <div class="p-4 space-y-4">
                <!-- Discord Bot Whitelist -->
                <div class="p-4 rounded-lg border border-purple-200 dark:border-purple-500/30 bg-purple-50 dark:bg-purple-900/20">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fa-brands fa-discord text-purple-600 dark:text-purple-400"></i>
                                <h5 class="font-medium text-purple-700 dark:text-purple-300">{{ form.is_discord_bot_whitelisted.label.text }}</h5>
                            </div>
                            <p class="text-sm text-purple-600 dark:text-purple-400">{{ form.is_discord_bot_whitelisted.description or "Allow this user to interact with Discord bot features" }}</p>
                        </div>
                        {{ form.is_discord_bot_whitelisted(class="toggle toggle-primary ml-4") }}
                    </div>
                </div>

                <!-- Purge Whitelist -->
                <div class="p-4 rounded-lg border border-yellow-200 dark:border-yellow-500/30 bg-yellow-50 dark:bg-yellow-900/20">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fa-solid fa-shield text-yellow-600 dark:text-yellow-400"></i>
                                <h5 class="font-medium text-yellow-700 dark:text-yellow-300">{{ form.is_purge_whitelisted.label.text }}</h5>
                            </div>
                            <p class="text-sm text-yellow-600 dark:text-yellow-400">{{ form.is_purge_whitelisted.description or "Protect this user from automatic inactivity purges" }}</p>
                        </div>
                        {{ form.is_purge_whitelisted(class="toggle toggle-primary ml-4") }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Stream Permissions Section -->
        <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm overflow-hidden">
            <div class="bg-gradient-to-r from-green-50 dark:from-green-900/20 to-green-100 dark:to-green-800/20 p-4 border-b border-base-300">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i class="fa-solid fa-play text-green-600 dark:text-green-400"></i>
                    Stream Permissions
                </h3>
            </div>
            <div class="p-4 space-y-4">
                <!-- Downloads Permission (Disabled) -->
                <div class="p-4 rounded-lg border border-gray-200 dark:border-gray-500/30 bg-gray-50 dark:bg-gray-900/20 opacity-60 relative">
                    <div class="absolute top-2 right-2">
                        <div class="tooltip tooltip-left" data-tip="This setting can't be changed here due to a Plex API limitation. Please update 'Allow Sync' directly in Plex for now.">
                            <i class="fa-solid fa-info-circle text-orange-500"></i>
                        </div>
                    </div>
                    <div class="flex items-center justify-between pointer-events-none">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fa-solid fa-download text-gray-500"></i>
                                <h5 class="font-medium text-gray-600 dark:text-gray-400">{{ form.allow_downloads.label.text }}</h5>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-500">{{ form.allow_downloads.description or "Allow user to download content for offline viewing" }}</p>
                        </div>
                        {{ form.allow_downloads(class="toggle toggle-primary ml-4", disabled=True) }}
                    </div>
                </div>

                <!-- 4K Transcode Permission -->
                <div class="p-4 rounded-lg border border-green-200 dark:border-green-500/30 bg-green-50 dark:bg-green-900/20">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fa-solid fa-video text-green-600 dark:text-green-400"></i>
                                <h5 class="font-medium text-green-700 dark:text-green-300">{{ form.allow_4k_transcode.label.text }}</h5>
                            </div>
                            <p class="text-sm text-green-600 dark:text-green-400">{{ form.allow_4k_transcode.description or "Allow transcoding of 4K content (high server load)" }}</p>
                        </div>
                        {{ form.allow_4k_transcode(class="toggle toggle-primary ml-4") }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Access Duration Section -->
        <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm overflow-hidden">
            <div class="bg-gradient-to-r from-red-50 dark:from-red-900/20 to-red-100 dark:to-red-800/20 p-4 border-b border-base-300">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i class="fa-solid fa-calendar-times text-red-600 dark:text-red-400"></i>
                    Access Expiration
                </h3>
            </div>
            <div class="p-4 space-y-4">
                <!-- Info Banner -->
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-500/30 rounded-lg p-3">
                    <div class="flex items-start gap-2">
                        <i class="fa-solid fa-info-circle text-blue-600 dark:text-blue-400 mt-0.5"></i>
                        <div class="text-sm text-blue-700 dark:text-blue-300">
                            <p class="font-medium mb-1">Automatic Access Control</p>
                            <p>Set an expiration date to automatically revoke user access. Leave blank for permanent access.</p>
                        </div>
                    </div>
                </div>

                <!-- Access Expiration Input -->
                <div class="form-control">
                    {{ form.access_expiration.label(class="label") }}
                    <span class="label-text text-sm text-base-content/70 mb-2 block">Choose when this user's access should expire</span>
                    {{ form.access_expiration(id="user_edit_access_expiration_input", class="input input-bordered w-full max-w-sm bg-base-50 dark:bg-base-800/50 border-base-300 focus:border-primary focus:ring-2 focus:ring-primary/20 " + ("input-error" if form.access_expiration.errors else "")) }}
                    {% if form.access_expiration.errors %}
                        {% for error in form.access_expiration.errors %}
                            <p class="text-error text-xs mt-2">{{ error }}</p>
                        {% endfor %}
                    {% else %}
                        <p class="text-xs text-base-content/60 mt-2">{{ form.access_expiration.description or "User access will be automatically revoked at midnight on this date" }}</p>
                    {% endif %}
                </div>

                <!-- Clear Expiration Option -->
                <div class="p-3 rounded-lg border border-orange-200 dark:border-orange-500/30 bg-orange-50 dark:bg-orange-900/20">
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start">
                            {{ form.clear_access_expiration(class="checkbox checkbox-primary mr-3", id="user_edit_clear_access_expiration_checkbox") }}
                            <div class="flex flex-col">
                                <span class="label-text font-medium">{{ form.clear_access_expiration.label.text }}</span>
                                <span class="text-xs text-orange-700 dark:text-orange-300">Remove any existing expiration date and grant permanent access</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Library Access Section -->
        <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm overflow-hidden">
            <div class="bg-gradient-to-r from-primary/5 to-primary/10 p-4 border-b border-base-300">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fa-solid fa-folder-open text-primary"></i>
                        Library Access
                    </h3>
                    <div class="flex gap-2">
                        <button type="button" id="select_all_libraries" class="inline-flex items-center rounded-md bg-green-50 dark:bg-green-400/10 px-2 py-1 text-xs font-medium text-green-700 dark:text-green-400 ring-1 ring-inset ring-green-600/20 dark:ring-green-500/20 gap-1 hover:bg-green-100 dark:hover:bg-green-400/20 transition-colors">
                            <i class="fa-solid fa-check-square w-3 h-3"></i>
                            Select All
                        </button>
                        <button type="button" id="deselect_all_libraries" class="inline-flex items-center rounded-md bg-gray-50 dark:bg-gray-400/10 px-2 py-1 text-xs font-medium text-gray-700 dark:text-gray-400 ring-1 ring-inset ring-gray-600/20 dark:ring-gray-500/20 gap-1 hover:bg-gray-100 dark:hover:bg-gray-400/20 transition-colors">
                            <i class="fa-solid fa-square w-3 h-3"></i>
                            Clear All
                        </button>
                    </div>
                </div>
            </div>
            <div class="p-4">
                {% if form.libraries.choices %}
                <div class="space-y-4">
                    <!-- Header info -->
                    <div class="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-500/30 rounded-lg">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-folder w-4 h-4 text-blue-600 dark:text-blue-400"></i>
                            <span class="text-sm font-medium text-blue-700 dark:text-blue-300">
                                {{ form.libraries.choices|length }} libraries available
                            </span>
                        </div>
                        <span class="text-xs text-blue-600 dark:text-blue-400">Select which libraries this user can access</span>
                    </div>
                    
                    <!-- Library list -->
                    <div class="max-h-80 overflow-y-auto border border-base-300 rounded-lg bg-base-50 dark:bg-base-800/50">
                        {% for subfield in form.libraries %}
                        <div class="form-control border-b border-base-300 last:border-b-0">
                            <label class="label cursor-pointer justify-start py-3 px-4 hover:bg-base-100 dark:hover:bg-base-700/50 transition-colors">
                                {{ subfield(class="checkbox checkbox-primary checkbox-sm library-checkbox") }}
                                <div class="flex items-center gap-2 ml-3">
                                    <i class="fa-solid fa-folder w-3 h-3 text-blue-500"></i>
                                    <span class="label-text font-medium">{{ subfield.label.text }}</span>
                                </div>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Help text -->
                    <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-500/30 rounded-lg p-3">
                        <div class="flex items-start gap-2">
                            <i class="fa-solid fa-lightbulb text-orange-600 dark:text-orange-400 mt-0.5"></i>
                            <div class="text-sm text-orange-700 dark:text-orange-300">
                                <p class="font-medium mb-1">Library Access Control</p>
                                <p>Changes will be applied to all connected media servers. Unselected libraries will be removed from user access.</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-8">
                    <i class="fa-solid fa-folder-open fa-3x text-base-content/20 mb-4"></i>
                    <p class="text-base-content/60 mb-2">No libraries available</p>
                    <p class="text-sm text-base-content/50">User may not have access to any media servers</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center justify-end gap-3 mt-8 pt-6 border-t border-base-300">
            <button type="button" class="btn btn-ghost" onclick="quick_edit_user_modal.close()">
                Cancel
            </button>
            <button type="submit" class="btn btn-primary gap-2" 
                    onclick="console.log('Save button clicked'); console.log('Form element:', document.getElementById('editUserForm')); return true;">
                <i class="fa-solid fa-save w-4 h-4"></i>
                Save Changes
            </button>
        </div>
    </div>
</form>

<script>
(function () {
    const selectAllButton = document.getElementById('select_all_libraries');
    const deselectAllButton = document.getElementById('deselect_all_libraries');
    // Important: scope the checkbox query to the form to avoid conflicts if other forms exist
    const editUserForm = document.getElementById('editUserForm');
    if (!editUserForm) return;

    const libraryCheckboxes = editUserForm.querySelectorAll('.library-checkbox');
    if (selectAllButton) { selectAllButton.addEventListener('click', function() { libraryCheckboxes.forEach(checkbox => checkbox.checked = true); }); }
    if (deselectAllButton) { deselectAllButton.addEventListener('click', function() { libraryCheckboxes.forEach(checkbox => checkbox.checked = false); }); }

    const dateInput = document.getElementById('user_edit_access_expiration_input');
    const clearCheckbox = document.getElementById('user_edit_clear_access_expiration_checkbox');

    function syncExpiryFields() {
        if (!dateInput || !clearCheckbox) return;
        if (clearCheckbox.checked) {
            dateInput.disabled = true;
            dateInput.value = '';
        } else {
            dateInput.disabled = false;
        }
    }

    if (clearCheckbox) {
        clearCheckbox.addEventListener('change', syncExpiryFields);
    }

    // Run once on load to set initial state
    syncExpiryFields();
})();
</script>