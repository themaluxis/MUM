<!-- File: app/templates/user/_history_tab_content.html -->
{% set user_services = user_service_types.get(user.uuid, []) if user_service_types else [] %}
{% set service_values = [] %}
{% for st in user_services %}
    {% set _ = service_values.append(st.value) %}
{% endfor %}
{% set is_kavita_user = user_service_types and user_service_types.get(user.uuid) and 'kavita' in service_values %}

{# Use the same table format for all users, but with different headers for Kavita users #}
    <!-- Regular Stream History for non-Kavita users -->
{# Expects 'user' and 'history_logs' (pagination object) in context #}

<form id="history-delete-form"
      {% if user._is_service_user %}
        hx-post="{{ url_for('user.delete_stream_history', server_nickname=user._access_record.server.server_nickname, server_username=user.username) }}"
      {% else %}
        hx-post="{{ url_for('user.delete_stream_history', username=user.username) }}"
      {% endif %}
      hx-on::after-request="if(event.detail.successful) htmx.trigger('#user-history-container', 'load');">
      
    <div class="flex justify-end items-center mb-4">
        <div id="history-actions-header" class="hidden">
            <button type="submit" class="btn btn-sm btn-error"
                    hx-confirm="Are you sure you want to permanently delete the selected history entries? This cannot be undone.">
                <i class="fa-solid fa-trash-can mr-2"></i>
                Delete <span id="history-selected-count">0</span> Selected Item(s)
            </button>
        </div>
    </div>

    <!-- History Table -->
    <div class="bg-base-100 rounded-xl border border-base-300/60 overflow-hidden">
        <!-- Table Header -->
        <div class="bg-base-200/50 px-6 py-4 border-b border-base-300/60 flex justify-between items-center">
            <h3 class="font-semibold text-base-content">Recent Activity</h3>
            
            <!-- Columns Dropdown -->
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-ghost btn-sm" title="Select columns">
                    <i class="fa-solid fa-table-columns mr-1"></i> Columns
                </label>
                <ul tabindex="0" id="history-column-selector-menu" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52 max-h-96 overflow-y-auto z-50">
                    <!-- Column options will be populated by JavaScript -->
                </ul>
            </div>
        </div>

        <!-- Table Content -->
        <div class="overflow-x-auto">
            <table class="table table-zebra w-full">
            <thead>
                <tr class="bg-base-200/30">
                    <th class="w-10 text-center">
                        <input type="checkbox" id="history-select-all" class="checkbox checkbox-primary checkbox-sm" title="Select All">
                    </th>
                    {% if is_kavita_user %}
                        <th data-col="media_title">Book / Chapter</th>
                        <th data-col="player">Reader / Platform</th>
                        <th data-col="ip_address">IP Address</th>
                        <th data-col="started_at">Started Reading</th>
                        <th data-col="paused_at">Paused</th>
                        <th data-col="stopped_at">Stopped Reading</th>
                        <th data-col="duration">Reading Time</th>
                        <th data-col="progress">Progress</th>
                    {% else %}
                        <th class="w-20" data-col="poster">Poster</th>
                        <th data-col="media_title">Media Title</th>
                        <th data-col="player">Player / Platform</th>
                        <th data-col="ip_address">IP Address</th>
                        <th data-col="started_at">Started</th>
                        <th data-col="paused_at">Paused</th>
                        <th data-col="stopped_at">Stopped</th>
                        <th data-col="duration">Duration</th>
                        <th data-col="progress">Progress</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for entry in history_logs.items %}
                    <tr class="hover:bg-base-200/50">
                        <td class="text-center">
                            <input type="checkbox" name="history_ids[]" value="{{ entry.id }}" class="checkbox checkbox-primary checkbox-sm history-checkbox">
                        </td>
                        <td data-col="poster">
                            {% if entry.rating_key %}
                                {% if entry.server and entry.server.service_type.value == 'jellyfin' %}
                                    <img src="{{ url_for('api.jellyfin_image_proxy', item_id=entry.rating_key, image_type='Primary') }}" 
                                         class="w-12 h-18 rounded object-cover" 
                                         alt="Media poster"
                                         onerror="this.src='{{ url_for('static', filename='default_media_thumb.png') }}'">
                                {% else %}
                                    <img src="{{ url_for('api.plex_image_proxy', path=('/library/metadata/' + entry.rating_key + '/thumb')) }}" 
                                         class="w-12 h-18 rounded object-cover" 
                                         alt="Media poster"
                                         onerror="this.src='{{ url_for('static', filename='default_media_thumb.png') }}'">
                                {% endif %}
                            {% else %}
                                <div class="w-12 h-18 rounded bg-base-300 flex items-center justify-center">
                                    <i class="fa-solid fa-play text-base-content/40"></i>
                                </div>
                            {% endif %}
                        </td>
                        <td data-col="media_title">
                            {% if entry.media_item_db_id or entry.show_media_item_db_id %}
                                <!-- Episode link (for TV shows) -->
                                {% if entry.grandparent_title and entry.grandparent_title != entry.media_title %}
                                    <div class="font-bold">
                                        {% if entry.media_item_db_id %}
                                            <a href="{{ url_for('libraries.episode_detail', 
                                                server_nickname=entry.server.server_nickname, 
                                                library_name=encode_url_component(entry.library_name), 
                                                media_id=entry.show_media_item_db_id or entry.media_item_db_id,
                                                tv_show_slug=generate_url_slug(entry.grandparent_title),
                                                episode_slug=generate_url_slug(entry.media_title)) }}" 
                                               class="text-primary hover:text-primary-focus hover:underline">
                                                {{ entry.media_title or 'Unknown Title' }}
                                            </a>
                                        {% else %}
                                            {{ entry.media_title or 'Unknown Title' }}
                                        {% endif %}
                                    </div>
                                    <div class="text-xs opacity-70">
                                        {% if entry.show_media_item_db_id %}
                                            <a href="{{ url_for('libraries.media_detail', 
                                                server_nickname=entry.server.server_nickname, 
                                                library_name=encode_url_component(entry.library_name), 
                                                media_id=entry.show_media_item_db_id,
                                                slug=generate_url_slug(entry.grandparent_title)) }}" 
                                               class="text-base-content/70 hover:text-base-content hover:underline">
                                                {{ entry.grandparent_title }}
                                            </a>
                                        {% else %}
                                            {{ entry.grandparent_title }}
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <!-- Movie or other content link -->
                                    <div class="font-bold">
                                        {% if entry.media_item_db_id %}
                                            <a href="{{ url_for('libraries.media_detail', 
                                                server_nickname=entry.server.server_nickname, 
                                                library_name=encode_url_component(entry.library_name), 
                                                media_id=entry.media_item_db_id,
                                                slug=generate_url_slug(entry.media_title)) }}" 
                                               class="text-primary hover:text-primary-focus hover:underline">
                                                {{ entry.media_title or 'Unknown Title' }}
                                            </a>
                                        {% else %}
                                            {{ entry.media_title or 'Unknown Title' }}
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% else %}
                                <!-- Fallback for entries without database IDs -->
                                <div class="font-bold">{{ entry.media_title or 'Unknown Title' }}</div>
                                {% if entry.grandparent_title %}
                                    <div class="text-xs opacity-70">{{ entry.grandparent_title }}</div>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td data-col="player">
                            <div class="font-medium">{{ entry.player or 'Unknown Player' }}</div>
                            <div class="text-xs opacity-70">{{ entry.product or entry.platform or 'Unknown Platform' }}</div>
                        </td>
                        <td data-col="ip_address">
                            {% if entry.ip_address %}
                                <span class="font-mono text-xs">{{ entry.ip_address }}</span>
                                <span class="badge badge-ghost badge-xs ml-1">{{ 'LAN' if entry.is_lan else 'WAN' }}</span>
                            {% else %}
                                <span class="text-xs italic opacity-60">N/A</span>
                            {% endif %}
                        </td>
                        
                        {# Started Column #}
                        <td data-col="started_at" title="{{ entry.started_at | format_datetime_user if entry.started_at }}">
                            <div>{{ entry.started_at | format_datetime_user if entry.started_at else 'N/A' }}</div>
                        </td>
                        
                        {# Paused Column #}
                        <td data-col="paused_at">
                            {% if entry.stopped_at and entry.duration_seconds is not none %}
                                {# Calculate paused time for completed sessions #}
                                {% set total_elapsed = (entry.stopped_at - entry.started_at).total_seconds() %}
                                {% set paused_seconds = total_elapsed - entry.duration_seconds %}
                                {{ paused_seconds | format_duration if paused_seconds > 0 else '0m' }}
                            {% elif entry.view_offset_at_end_seconds is not none %}
                                {# For active sessions, calculate paused time based on current time #}
                                {% set now = datetime.utcnow() %}
                                {% set total_elapsed = (now - entry.started_at).total_seconds() %}
                                {% set watch_time = entry.view_offset_at_end_seconds %}
                                {% set paused_seconds = total_elapsed - watch_time %}
                                {{ paused_seconds | format_duration if paused_seconds > 0 else '0m' }}
                            {% else %}
                                {# For sessions without stopped_at or view_offset, show N/A #}
                                <span class="text-xs italic opacity-60">N/A</span>
                            {% endif %}
                        </td>
                        
                        {# Stopped Column #}
                        <td data-col="stopped_at">
                            {% if entry.stopped_at %}
                                {{ entry.stopped_at.strftime('%I:%M %p') }}
                            {% else %}
                                <span class="text-xs italic opacity-60">N/A</span>
                            {% endif %}
                        </td>
                        
                        {# Duration Column #}
                        <td data-col="duration">
                            {% if entry.stopped_at and entry.duration_seconds is not none %}
                                {# Completed session - show final duration #}
                                {{ entry.duration_seconds | format_duration }}
                            {% elif not entry.stopped_at and entry.view_offset_at_end_seconds %}
                                {# Actually active session - show current watched time #}
                                <span class="text-warning">{{ entry.view_offset_at_end_seconds | format_duration }}</span>
                            {% elif entry.view_offset_at_end_seconds %}
                                {# Incomplete session - show last known progress #}
                                <span class="text-gray-500">{{ entry.view_offset_at_end_seconds | format_duration }}</span>
                            {% else %}
                                {# No data available #}
                                <span class="text-xs italic opacity-60">0m</span>
                            {% endif %}
                        </td>
                        
                        {# Progress Column #}
                        <td class="text-center">
                            {% if entry.view_offset_at_end_seconds and entry.media_duration_seconds and entry.media_duration_seconds > 0 %}
                                {# Calculate progress based on view_offset_at_end_seconds #}
                                {% set progress_seconds = entry.view_offset_at_end_seconds %}
                                {% set percent = ((progress_seconds / entry.media_duration_seconds) * 100) | round %}
                                {% set percent = [percent, 100] | min %}  {# Cap at 100% #}
                                
                                {# Determine status for tooltip and styling #}
                                {% if entry.stopped_at %}
                                    {% set progress_class = "text-primary" %}
                                {% else %}
                                    {% set progress_class = "text-warning" %}
                                {% endif %}
                                
                                <div class="tooltip tooltip-left" data-tip="{{ percent | int }}% ({{ progress_seconds | format_duration }} / {{ entry.media_duration_seconds | format_duration }})">
                                    <div class="radial-progress {{ progress_class }}" style="--value:{{ percent }}; --size:1.7rem; --thickness: 4px;" role="progressbar">
                                        <span class="text-xs font-mono opacity-0 group-hover:opacity-100 transition-opacity">{{ percent | int }}</span>
                                    </div>
                                </div>
                            {% else %}
                                <div class="tooltip tooltip-left" data-tip="No progress data available">
                                    <div class="radial-progress text-gray-400" style="--value:0; --size:1.7rem; --thickness: 4px;" role="progressbar">
                                        <span class="text-xs font-mono">0</span>
                                    </div>
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="9" class="text-center py-6 text-base-content/70 italic">
                            No stream history found for this user.
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
</div>
</form>

<!-- Pagination remains the same -->
{% if history_logs and history_logs.pages > 1 %}
    <div class="join my-8 flex justify-center">
        {% if history_logs.has_prev %}
            {# Determine the correct route based on user type #}
            {% if user.__class__.__name__ == 'AppUser' %}
                {% set prev_params = {'username': user.username, 'tab': 'history', 'page': history_logs.prev_num} %}
                {% if request.args.get('back') %}{% set _ = prev_params.update({'back': request.args.get('back')}) %}{% endif %}
                {% if request.args.get('back_view') %}{% set _ = prev_params.update({'back_view': request.args.get('back_view')}) %}{% endif %}
                {% set prev_url = url_for('user.view_app_user', **prev_params) %}
            {% else %}
                {% set user_servers = user_server_names.get(user.uuid, []) %}
                {% if user_servers %}
                    {% set server_name = user_servers[0] %}
                    {% if user.plex_username %}
                        {% set username = user.plex_username %}
                    {% elif '@' in user.primary_username %}
                        {% set username = user.primary_username.split('@')[0] %}
                    {% else %}
                        {% set username = user.primary_username %}
                    {% endif %}
                    {% set prev_params = {'server_nickname': server_name, 'server_username': username, 'tab': 'history', 'page': history_logs.prev_num} %}
                    {% if request.args.get('back') %}{% set _ = prev_params.update({'back': request.args.get('back')}) %}{% endif %}
                    {% if request.args.get('back_view') %}{% set _ = prev_params.update({'back_view': request.args.get('back_view')}) %}{% endif %}
                    {% set prev_url = url_for('user.view_service_account', **prev_params) %}
                {% else %}
                    {% set prev_url = '#' %}
                {% endif %}
            {% endif %}
            <a hx-get="{{ prev_url }}"
               hx-target="#user-history-container"
               class="join-item btn">
               <i class="fa-solid fa-arrow-left"></i>
            </a>
        {% else %}
           <button class="join-item btn btn-disabled"><i class="fa-solid fa-arrow-left"></i></button>
        {% endif %}
        {% for page_num in history_logs.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
            {% if page_num %}
                {% if history_logs.page == page_num %}
                    <button class="join-item btn btn-primary btn-active">{{ page_num }}</button>
                {% else %}
                    {# Determine the correct route based on user type #}
                    {% if user.__class__.__name__ == 'AppUser' %}
                        {% set page_params = {'username': user.username, 'tab': 'history', 'page': page_num} %}
                        {% if request.args.get('back') %}{% set _ = page_params.update({'back': request.args.get('back')}) %}{% endif %}
                        {% if request.args.get('back_view') %}{% set _ = page_params.update({'back_view': request.args.get('back_view')}) %}{% endif %}
                        {% set page_url = url_for('user.view_app_user', **page_params) %}
                    {% else %}
                        {% set user_servers = user_server_names.get(user.uuid, []) %}
                        {% if user_servers %}
                            {% set server_name = user_servers[0] %}
                            {% if user.plex_username %}
                                {% set username = user.plex_username %}
                            {% elif '@' in user.primary_username %}
                                {% set username = user.primary_username.split('@')[0] %}
                            {% else %}
                                {% set username = user.primary_username %}
                            {% endif %}
                            {% set page_params = {'server_nickname': server_name, 'server_username': username, 'tab': 'history', 'page': page_num} %}
                            {% if request.args.get('back') %}{% set _ = page_params.update({'back': request.args.get('back')}) %}{% endif %}
                            {% if request.args.get('back_view') %}{% set _ = page_params.update({'back_view': request.args.get('back_view')}) %}{% endif %}
                            {% set page_url = url_for('user.view_service_account', **page_params) %}
                        {% else %}
                            {% set page_url = '#' %}
                        {% endif %}
                    {% endif %}
                    <a hx-get="{{ page_url }}"
                       hx-target="#user-history-container"
                       class="join-item btn">
                       {{ page_num }}
                    </a>
                {% endif %}
            {% else %}
                <button class="join-item btn btn-disabled">...</button>
            {% endif %}
        {% endfor %}
        {% if history_logs.has_next %}
            {# Determine the correct route based on user type #}
            {% if user.__class__.__name__ == 'AppUser' %}
                {% set next_params = {'username': user.username, 'tab': 'history', 'page': history_logs.next_num} %}
                {% if request.args.get('back') %}{% set _ = next_params.update({'back': request.args.get('back')}) %}{% endif %}
                {% if request.args.get('back_view') %}{% set _ = next_params.update({'back_view': request.args.get('back_view')}) %}{% endif %}
                {% set next_url = url_for('user.view_app_user', **next_params) %}
            {% else %}
                {% set user_servers = user_server_names.get(user.uuid, []) %}
                {% if user_servers %}
                    {% set server_name = user_servers[0] %}
                    {% if user.plex_username %}
                        {% set username = user.plex_username %}
                    {% elif '@' in user.primary_username %}
                        {% set username = user.primary_username.split('@')[0] %}
                    {% else %}
                        {% set username = user.primary_username %}
                    {% endif %}
                    {% set next_params = {'server_nickname': server_name, 'server_username': username, 'tab': 'history', 'page': history_logs.next_num} %}
                    {% if request.args.get('back') %}{% set _ = next_params.update({'back': request.args.get('back')}) %}{% endif %}
                    {% if request.args.get('back_view') %}{% set _ = next_params.update({'back_view': request.args.get('back_view')}) %}{% endif %}
                    {% set next_url = url_for('user.view_service_account', **next_params) %}
                {% else %}
                    {% set next_url = '#' %}
                {% endif %}
            {% endif %}
            <a hx-get="{{ next_url }}"
               hx-target="#user-history-container"
               class="join-item btn">
               <i class="fa-solid fa-arrow-right"></i>
            </a>
        {% else %}
             <button class="join-item btn btn-disabled"><i class="fa-solid fa-arrow-right"></i></button>
        {% endif %}
    </div>
{% endif %}

<script>
(function() {
    function initializeHistoryCheckboxes() {
        const form = document.getElementById('history-delete-form');
        if (!form) return;

        const deleteButton = form.querySelector('button[type="submit"]');
        if (deleteButton) {
            deleteButton.addEventListener('click', function(e) {
                e.preventDefault();
                htmx.trigger(form, 'submit');
            });
        }

        const selectAll = form.querySelector('#history-select-all');
        const checkboxes = form.querySelectorAll('.history-checkbox');
        const actionsHeader = document.getElementById('history-actions-header');
        const selectedCountSpan = document.getElementById('history-selected-count');

        if (!selectAll || !actionsHeader || !selectedCountSpan) return;

        function updateUI() {
            const checkedCheckboxes = form.querySelectorAll('.history-checkbox:checked');
            const count = checkedCheckboxes.length;
            
            actionsHeader.classList.toggle('hidden', count === 0);
            selectedCountSpan.textContent = count;

            if (count === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else if (count === checkboxes.length) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else {
                selectAll.checked = false;
                selectAll.indeterminate = true;
            }
        }

        selectAll.addEventListener('change', () => {
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
            updateUI();
        });

        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateUI);
        });

        updateUI();
    }
    initializeHistoryCheckboxes();
    htmx.on('#user-history-container', 'htmx:afterSwap', initializeHistoryCheckboxes);
})();

// History table columns functionality
(function() {
    const HISTORY_TABLE_COLUMNS = {
        poster: 'Poster',
        media_title: 'Media Title',
        player: 'Player / Platform',
        ip_address: 'IP Address',
        started_at: 'Started',
        paused_at: 'Paused',
        stopped_at: 'Stopped',
        duration: 'Duration',
        progress: 'Progress'
    };

    function saveHistoryColumnPreferences(prefs) { 
        localStorage.setItem('historyTableColumnPrefs', JSON.stringify(prefs)); 
    }
    
    function loadHistoryColumnPreferences() {
        const saved = localStorage.getItem('historyTableColumnPrefs');
        return saved ? JSON.parse(saved) : Object.keys(HISTORY_TABLE_COLUMNS).reduce((acc, key) => ({ ...acc, [key]: true }), {});
    }
    
    function toggleHistoryColumn(columnName, isVisible) {
        const table = document.querySelector('#history-delete-form .table');
        if (!table) return;
        const cells = table.querySelectorAll(`[data-col="${columnName}"]`);
        cells.forEach(cell => { cell.style.display = isVisible ? '' : 'none'; });
    }
    
    function populateHistoryColumnSelector() {
        const menu = document.getElementById('history-column-selector-menu');
        const prefs = loadHistoryColumnPreferences();
        if (!menu) return;
        menu.innerHTML = '';
        for (const [key, label] of Object.entries(HISTORY_TABLE_COLUMNS)) {
            const li = document.createElement('li');
            const isChecked = prefs[key] !== false;
            li.innerHTML = `<label class="label cursor-pointer"><input type="checkbox" class="checkbox checkbox-primary history-column-toggle-checkbox" data-column="${key}" ${isChecked ? 'checked' : ''}><span class="label-text">${label}</span></label>`;
            menu.appendChild(li);
        }
        attachHistoryColumnToggleListeners();
    }
    
    function applyHistoryColumnPreferences() {
        const prefs = loadHistoryColumnPreferences();
        for (const [key, isVisible] of Object.entries(prefs)) {
            toggleHistoryColumn(key, isVisible !== false);
        }
    }
    
    function attachHistoryColumnToggleListeners() {
        document.querySelectorAll('.history-column-toggle-checkbox').forEach(checkbox => {
            if (checkbox.dataset.listenerAttached) return;
            checkbox.dataset.listenerAttached = 'true';
            checkbox.addEventListener('change', (event) => {
                const columnName = event.target.dataset.column;
                const isVisible = event.target.checked;
                const prefs = loadHistoryColumnPreferences();
                prefs[columnName] = isVisible;
                toggleHistoryColumn(columnName, isVisible);
                saveHistoryColumnPreferences(prefs);
            });
        });
    }

    function initializeHistoryColumns() {
        populateHistoryColumnSelector();
        applyHistoryColumnPreferences();
    }

    // Initialize on load and after HTMX swaps
    initializeHistoryColumns();
    htmx.on('#user-history-container', 'htmx:afterSwap', initializeHistoryColumns);
})();
</script>