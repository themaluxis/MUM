{# Local Account History Tab - Aggregated streaming history from all linked service accounts #}
<div class="max-w-6xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold text-base-content mb-2">Streaming History</h2>
                <p class="text-base-content/70">Combined activity from all linked service accounts</p>
            </div>
            <div class="flex items-center gap-3">
                <!-- Filter Controls -->
                <select class="select select-sm select-bordered" id="serviceFilter" onchange="updateHistoryFilters()">
                    <option value="all" {{ 'selected' if service_filter == 'all' else '' }}>All Services</option>
                    <option value="plex" {{ 'selected' if service_filter == 'plex' else '' }}>Plex Only</option>
                    <option value="jellyfin" {{ 'selected' if service_filter == 'jellyfin' else '' }}>Jellyfin Only</option>
                    <option value="emby" {{ 'selected' if service_filter == 'emby' else '' }}>Emby Only</option>
                    <option value="kavita" {{ 'selected' if service_filter == 'kavita' else '' }}>Kavita Only</option>
                    <option value="audiobookshelf" {{ 'selected' if service_filter == 'audiobookshelf' else '' }}>AudioBookshelf Only</option>
                    <option value="komga" {{ 'selected' if service_filter == 'komga' else '' }}>Komga Only</option>
                    <option value="romm" {{ 'selected' if service_filter == 'romm' else '' }}>RomM Only</option>
                </select>
                <select class="select select-sm select-bordered" id="daysFilter" onchange="updateHistoryFilters()">
                    <option value="7" {{ 'selected' if days_filter == 7 else '' }}>Last 7 days</option>
                    <option value="30" {{ 'selected' if days_filter == 30 else '' }}>Last 30 days</option>
                    <option value="90" {{ 'selected' if days_filter == 90 else '' }}>Last 90 days</option>
                    <option value="365" {{ 'selected' if days_filter == 365 else '' }}>Last year</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Linked Accounts Summary -->
    {% if user.linked_service_users %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-8">
        {% for service_user in user.linked_service_users %}
            {% set service_type = service_user.get_service_type() %}
            <div class="bg-base-100 rounded-xl border border-base-300/60 p-4">
                <div class="flex items-center gap-3">
                    <!-- Service Icon -->
                    {% if service_type == 'plex' %}
                        <div class="w-10 h-10 rounded-xl bg-plex flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M22 25.5h48L116 94l-46 68.5H22L68.5 94Zm109.8 56L108 46l14-20.5h48zm-.3 23.5c10.979 17.625 25.52 38.875 38.5 49.5-11.149 13.635-34.323 32.278-62.5-14z"/></svg>
                        </div>
                    {% elif service_type == 'jellyfin' %}
                        <div class="w-10 h-10 rounded-xl bg-jellyfin flex items-center justify-center">
                            <i class="fa-solid fa-cube text-white text-lg"></i>
                        </div>
                    {% elif service_type == 'emby' %}
                        <div class="w-10 h-10 rounded-xl bg-emby flex items-center justify-center">
                            <i class="fa-solid fa-play-circle text-white text-lg"></i>
                        </div>
                    {% elif service_type == 'kavita' %}
                        <div class="w-10 h-10 rounded-xl bg-kavita flex items-center justify-center">
                            <i class="fa-solid fa-book text-white text-lg"></i>
                        </div>
                    {% elif service_type == 'audiobookshelf' %}
                        <div class="w-10 h-10 rounded-xl bg-audiobookshelf flex items-center justify-center">
                            <i class="fa-solid fa-headphones text-white text-lg"></i>
                        </div>
                    {% elif service_type == 'komga' %}
                        <div class="w-10 h-10 rounded-xl bg-komga flex items-center justify-center">
                            <i class="fa-solid fa-book-open text-white text-lg"></i>
                        </div>
                    {% elif service_type == 'romm' %}
                        <div class="w-10 h-10 rounded-xl bg-romm flex items-center justify-center">
                            <i class="fa-solid fa-gamepad text-white text-lg"></i>
                        </div>
                    {% else %}
                        <div class="w-10 h-10 rounded-xl bg-gray-500 flex items-center justify-center">
                            <i class="fa-solid fa-server text-white text-lg"></i>
                        </div>
                    {% endif %}
                    
                    <!-- Account Info -->
                    <div class="flex-1 min-w-0">
                        <h4 class="font-medium text-base-content truncate">{{ media_access.get_display_name() }}</h4>
                        <p class="text-sm text-base-content/60">{{ media_access.server.server_nickname }}</p>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- History Table -->
    <div class="bg-base-100 rounded-xl border border-base-300/60 overflow-hidden">
        <!-- Table Header -->
        <div class="bg-base-200/50 px-6 py-4 border-b border-base-300/60">
            <h3 class="font-semibold text-base-content">Recent Activity</h3>
        </div>

        <!-- Table Content -->
        <div class="overflow-x-auto">
            <table class="table table-zebra w-full">
                <thead>
                    <tr class="bg-base-200/30">
                        <th class="text-left">Media</th>
                        <th class="text-left">Service Account</th>
                        <th class="text-left">Server</th>
                        <th class="text-left">Started</th>
                        <th class="text-left">Duration</th>
                        <th class="text-left">Progress</th>
                    </tr>
                </thead>
                <tbody>
                    {% if streaming_history %}
                        {% for entry in streaming_history %}
                        <tr class="hover:bg-base-200/50">
                            <!-- Media Column -->
                            <td>
                                <div class="flex items-center gap-3">
                                    {% if entry.rating_key %}
                                        {% if entry.service_type == 'jellyfin' %}
                                            <img src="{{ url_for('api.jellyfin_image_proxy', item_id=entry.rating_key, image_type='Primary') }}" 
                                                 class="w-12 h-18 rounded object-cover" 
                                                 alt="Media thumbnail"
                                                 onerror="this.src='{{ url_for('static', filename='default_media_thumb.png') }}'">
                                        {% else %}
                                            <img src="{{ url_for('api.plex_image_proxy', path=('/library/metadata/' + entry.rating_key + '/thumb')) }}" 
                                                 class="w-12 h-18 rounded object-cover" 
                                                 alt="Media thumbnail"
                                                 onerror="this.src='{{ url_for('static', filename='default_media_thumb.png') }}'">
                                        {% endif %}
                                    {% else %}
                                        <div class="w-12 h-18 rounded bg-base-300 flex items-center justify-center">
                                            <i class="fa-solid fa-play text-base-content/40"></i>
                                        </div>
                                    {% endif %}
                                    <div class="min-w-0 flex-1">
                                        <div class="font-medium truncate" title="{{ entry.media_title }}">
                                            {{ entry.media_title or 'Unknown Title' }}
                                        </div>
                                        {% if entry.grandparent_title or entry.parent_title %}
                                        <div class="text-sm text-base-content/60 truncate">
                                            {% if entry.grandparent_title and entry.parent_title %}
                                                {{ entry.grandparent_title }} â€¢ {{ entry.parent_title }}
                                            {% elif entry.grandparent_title %}
                                                {{ entry.grandparent_title }}
                                            {% elif entry.parent_title %}
                                                {{ entry.parent_title }}
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            
                            <!-- Service Account Column -->
                            <td>
                                <div class="flex items-center gap-2">
                                    {% if entry.service_type == 'plex' %}
                                        <div class="w-6 h-6 rounded bg-plex flex items-center justify-center">
                                            <svg class="w-3 h-3 text-white" viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M22 25.5h48L116 94l-46 68.5H22L68.5 94Zm109.8 56L108 46l14-20.5h48zm-.3 23.5c10.979 17.625 25.52 38.875 38.5 49.5-11.149 13.635-34.323 32.278-62.5-14z"/></svg>
                                        </div>
                                    {% elif entry.service_type == 'jellyfin' %}
                                        <div class="w-6 h-6 rounded bg-jellyfin flex items-center justify-center">
                                            <i class="fa-solid fa-cube text-white text-xs"></i>
                                        </div>
                                    {% elif entry.service_type == 'emby' %}
                                        <div class="w-6 h-6 rounded bg-emby flex items-center justify-center">
                                            <i class="fa-solid fa-play-circle text-white text-xs"></i>
                                        </div>
                                    {% elif entry.service_type == 'kavita' %}
                                        <div class="w-6 h-6 rounded bg-kavita flex items-center justify-center">
                                            <i class="fa-solid fa-book text-white text-xs"></i>
                                        </div>
                                    {% elif entry.service_type == 'audiobookshelf' %}
                                        <div class="w-6 h-6 rounded bg-audiobookshelf flex items-center justify-center">
                                            <i class="fa-solid fa-headphones text-white text-xs"></i>
                                        </div>
                                    {% elif entry.service_type == 'komga' %}
                                        <div class="w-6 h-6 rounded bg-komga flex items-center justify-center">
                                            <i class="fa-solid fa-book-open text-white text-xs"></i>
                                        </div>
                                    {% elif entry.service_type == 'romm' %}
                                        <div class="w-6 h-6 rounded bg-romm flex items-center justify-center">
                                            <i class="fa-solid fa-gamepad text-white text-xs"></i>
                                        </div>
                                    {% else %}
                                        <div class="w-6 h-6 rounded bg-gray-500 flex items-center justify-center">
                                            <i class="fa-solid fa-server text-white text-xs"></i>
                                        </div>
                                    {% endif %}
                                    <span class="text-sm truncate" title="{{ entry.service_username }}">{{ entry.service_username }}</span>
                                </div>
                            </td>
                            
                            <!-- Server Column -->
                            <td>
                                <span class="text-sm" title="{{ entry.server_name }}">{{ entry.server_name }}</span>
                            </td>
                            
                            <!-- Started Column -->
                            <td>
                                <span class="text-sm" title="{{ entry.started_at | format_datetime_user }}">
                                    {{ entry.started_at | format_datetime_user }}
                                </span>
                            </td>
                            
                            <!-- Duration Column -->
                            <td>
                                <span class="text-sm">
                                    {% if entry.duration_seconds %}
                                        {{ entry.duration_seconds | format_duration }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </span>
                            </td>
                            
                            <!-- Progress Column -->
                            <td>
                                {% if entry.progress_percent is not none %}
                                    <div class="flex items-center gap-2">
                                        <progress class="progress progress-primary w-20" value="{{ entry.progress_percent }}" max="100"></progress>
                                        <span class="text-xs">{{ entry.progress_percent }}%</span>
                                    </div>
                                {% else %}
                                    <span class="text-sm text-base-content/60">N/A</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <!-- No History Found -->
                        <tr>
                            <td colspan="6" class="text-center py-12">
                                <div class="space-y-4">
                                    <div class="w-16 h-16 rounded-2xl bg-base-200/80 flex items-center justify-center mx-auto">
                                        <i class="fa-solid fa-clock-rotate-left text-base-content/40 text-2xl"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-base-content text-lg mb-2">No Streaming History</h4>
                                        <p class="text-sm text-base-content/60 max-w-md mx-auto leading-relaxed">
                                            {% if service_filter != 'all' %}
                                                No streaming activity found for {{ service_filter|title }} in the selected time period.
                                            {% else %}
                                                No streaming activity found in the selected time period.
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function updateHistoryFilters() {
    const serviceFilter = document.getElementById('serviceFilter').value;
    const daysFilter = document.getElementById('daysFilter').value;
    
    // Get current URL and update query parameters
    const url = new URL(window.location);
    url.searchParams.set('service', serviceFilter);
    url.searchParams.set('days', daysFilter);
    url.searchParams.set('tab', 'history'); // Ensure we stay on history tab
    
    // Navigate to updated URL
    window.location.href = url.toString();
}
</script>