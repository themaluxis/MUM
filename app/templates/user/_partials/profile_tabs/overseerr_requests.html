<!-- File: app/templates/user/_partials/overseerr_requests.html -->
{% if requests and requests|length > 0 %}
    <!-- CSRF Token for AJAX requests -->
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <!-- Requests List -->
    <div class="space-y-4">
        {% for request in requests %}
        <div class="card bg-base-200 border border-base-300 shadow-sm">
            <div class="card-body p-4">
                <!-- Desktop Layout -->
                <div class="hidden md:block">
                    <div class="flex items-start gap-4">
                        <!-- Poster Image -->
                        {% if request.media and request.media.posterPath %}
                        <div class="w-16 h-24 rounded-lg overflow-hidden bg-base-200 flex-shrink-0">
                            <img src="https://image.tmdb.org/t/p/w154{{ request.media.posterPath }}" 
                                alt="{{ request.media.title or 'Unknown' }}"
                                class="w-full h-full object-cover"
                                onerror="this.parentElement.innerHTML='<div class=&quot;w-full h-full flex items-center justify-center&quot;><i class=&quot;fa-solid fa-image text-base-content/30&quot;></i></div>'"
                            >
                        </div>
                        {% else %}
                        <div class="w-16 h-24 rounded-lg bg-base-200 flex items-center justify-center flex-shrink-0">
                            <i class="fa-solid fa-image text-base-content/30"></i>
                        </div>
                        {% endif %}
                        
                        <!-- Request Details -->
                        <div class="flex-1 min-w-0">
                            <!-- Title and Rating -->
                            <div class="flex items-start justify-between mb-1">
                                <h4 class="font-semibold text-base-content flex-1 pr-2">
                                    {% if request.media %}
                                        {% if request.media.mediaType == 'tv' and request.media.originalName %}
                                            {{ request.media.originalName }}
                                        {% else %}
                                            {{ request.media.title or request.media.name or 'Unknown Title' }}
                                        {% endif %}
                                    {% else %}
                                        Unknown Title
                                    {% endif %}
                                    {% if request.media and (request.media.releaseDate or request.media.firstAirDate) %}
                                        <span class="text-sm font-normal text-base-content/60">
                                            ({{ (request.media.releaseDate or request.media.firstAirDate)[:4] }})
                                        </span>
                                    {% endif %}
                                </h4>
                                
                                <!-- Rating -->
                                {% if request.media and request.media.voteAverage %}
                                <div class="flex items-center gap-1 text-xs text-base-content/60 flex-shrink-0">
                                    <i class="fa-solid fa-star text-yellow-500"></i>
                                    <span>{{ "%.1f"|format(request.media.voteAverage) }}</span>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Media Type & Genre -->
                            <div class="flex items-center gap-2">
                                {% if request.media and request.media.mediaType %}
                                <span class="badge badge-sm {% if request.media.mediaType == 'movie' %}badge-primary{% else %}badge-secondary{% endif %}">
                                    {{ 'Movie' if request.media.mediaType == 'movie' else 'TV Show' }}
                                </span>
                                {% endif %}
                                
                                {% if request.media and request.media.genres and request.media.genres|length > 0 %}
                                <span class="text-xs text-base-content/50">
                                    {{ request.media.genres[0].name }}{% if request.media.genres|length > 1 %}, {{ request.media.genres[1].name }}{% endif %}
                                </span>
                                {% endif %}
                            </div>
                            
                            {% if request.media and request.media.overview %}
                            <p class="text-sm text-base-content/70 mt-2 line-clamp-2">
                                {{ request.media.overview[:200] }}{% if request.media.overview|length > 200 %}...{% endif %}
                            </p>
                            {% endif %}
                            
                            <div class="flex items-center justify-between mt-3 text-xs">
                                <span class="text-base-content/60">
                                    <i class="fa-solid fa-calendar mr-1"></i>
                                    Requested {{ request.createdAt[:10] }}
                                </span>
                                <!-- Request Status -->
                                {% if request.status == 1 %}
                                <div class="flex items-center gap-2">
                                    <span class="badge badge-warning badge-sm">Pending</span>
                                    <button class="btn btn-xs btn-success" 
                                            onclick="updateRequestStatus({{ server_id }}, {{ request.id }}, 'approve', this)"
                                            title="Approve Request">
                                        <i class="fa-solid fa-check"></i>
                                    </button>
                                    <button class="btn btn-xs btn-error" 
                                            onclick="updateRequestStatus({{ server_id }}, {{ request.id }}, 'decline', this)"
                                            title="Decline Request">
                                        <i class="fa-solid fa-times"></i>
                                    </button>
                                    <button class="btn btn-xs btn-ghost" 
                                            onclick="deleteRequest({{ server_id }}, {{ request.id }}, this)"
                                            title="Delete Request">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                                {% elif request.status == 2 %}
                                <div class="flex items-center gap-2">
                                    <span class="badge badge-success badge-sm">Approved</span>
                                    <button class="btn btn-xs btn-ghost" 
                                            onclick="deleteRequest({{ server_id }}, {{ request.id }}, this)"
                                            title="Delete Request">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                                {% elif request.status == 3 %}
                                <div class="flex items-center gap-2">
                                    <span class="badge badge-success badge-sm">Available</span>
                                    <button class="btn btn-xs btn-ghost" 
                                            onclick="deleteRequest({{ server_id }}, {{ request.id }}, this)"
                                            title="Delete Request">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                                {% else %}
                                <div class="flex items-center gap-2">
                                    <span class="badge badge-ghost badge-sm">Unknown</span>
                                    <button class="btn btn-xs btn-ghost" 
                                            onclick="deleteRequest({{ server_id }}, {{ request.id }}, this)"
                                            title="Delete Request">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile Layout -->
                <div class="md:hidden space-y-3">
                    <!-- Top Half: Poster, Title, Content Type, Genre -->
                    <div class="flex items-start gap-3">
                        <!-- Poster Image -->
                        {% if request.media and request.media.posterPath %}
                        <div class="w-12 h-18 rounded-lg overflow-hidden bg-base-200 flex-shrink-0">
                            <img src="https://image.tmdb.org/t/p/w154{{ request.media.posterPath }}" 
                                 alt="{{ request.media.title or 'Unknown' }}"
                                 class="w-full h-full object-cover"
                                 onerror="this.parentElement.innerHTML='<div class=&quot;w-full h-full flex items-center justify-center&quot;><i class=&quot;fa-solid fa-image text-base-content/30 text-xs&quot;></i></div>'"
                            >
                        </div>
                        {% else %}
                        <div class="w-12 h-18 rounded-lg bg-base-200 flex items-center justify-center flex-shrink-0">
                            <i class="fa-solid fa-image text-base-content/30 text-xs"></i>
                        </div>
                        {% endif %}
                        
                        <div class="flex-1 min-w-0">
                            <!-- Title and Rating -->
                            <div class="flex items-start justify-between mb-1">
                                <h4 class="font-semibold text-base-content flex-1 pr-2 text-sm">
                                    {% if request.media %}
                                        {% if request.media.mediaType == 'tv' and request.media.originalName %}
                                            {{ request.media.originalName }}
                                        {% else %}
                                            {{ request.media.title or request.media.name or 'Unknown Title' }}
                                        {% endif %}
                                    {% else %}
                                        Unknown Title
                                    {% endif %}
                                    {% if request.media and (request.media.releaseDate or request.media.firstAirDate) %}
                                        <span class="text-xs font-normal text-base-content/60">
                                            ({{ (request.media.releaseDate or request.media.firstAirDate)[:4] }})
                                        </span>
                                    {% endif %}
                                </h4>
                                
                                <!-- Rating -->
                                {% if request.media and request.media.voteAverage %}
                                <div class="flex items-center gap-1 text-xs text-base-content/60 flex-shrink-0">
                                    <i class="fa-solid fa-star text-yellow-500"></i>
                                    <span>{{ "%.1f"|format(request.media.voteAverage) }}</span>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Media Type & Genre -->
                            <div class="flex items-center gap-2 flex-wrap">
                                {% if request.media and request.media.mediaType %}
                                <span class="badge badge-sm {% if request.media.mediaType == 'movie' %}badge-primary{% else %}badge-secondary{% endif %}">
                                    {{ 'Movie' if request.media.mediaType == 'movie' else 'TV Show' }}
                                </span>
                                {% endif %}
                                
                                {% if request.media and request.media.genres and request.media.genres|length > 0 %}
                                <span class="text-xs text-base-content/50">
                                    {{ request.media.genres[0].name }}{% if request.media.genres|length > 1 %}, {{ request.media.genres[1].name }}{% endif %}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bottom Half: Summary and Request Data -->
                    <div class="space-y-2">
                        {% if request.media and request.media.overview %}
                        <p class="text-sm text-base-content/70 line-clamp-2">
                            {{ request.media.overview[:150] }}{% if request.media.overview|length > 150 %}...{% endif %}
                        </p>
                        {% endif %}
                        
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-base-content/60">
                                <i class="fa-solid fa-calendar mr-1"></i>
                                Requested {{ request.createdAt[:10] }}
                            </span>
                            <!-- Request Status -->
                            {% if request.status == 1 %}
                            <div class="flex items-center gap-2">
                                <span class="badge badge-warning badge-sm">Pending</span>
                                <button class="btn btn-xs btn-success" 
                                        onclick="updateRequestStatus({{ server_id }}, {{ request.id }}, 'approve', this)"
                                        title="Approve Request">
                                    <i class="fa-solid fa-check"></i>
                                </button>
                                <button class="btn btn-xs btn-error" 
                                        onclick="updateRequestStatus({{ server_id }}, {{ request.id }}, 'decline', this)"
                                        title="Decline Request">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                                <button class="btn btn-xs btn-ghost" 
                                        onclick="deleteRequest({{ server_id }}, {{ request.id }}, this)"
                                        title="Delete Request">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                            {% elif request.status == 2 %}
                            <div class="flex items-center gap-2">
                                <span class="badge badge-success badge-sm">Approved</span>
                                <button class="btn btn-xs btn-ghost" 
                                        onclick="deleteRequest({{ server_id }}, {{ request.id }}, this)"
                                        title="Delete Request">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                            {% elif request.status == 3 %}
                            <div class="flex items-center gap-2">
                                <span class="badge badge-success badge-sm">Available</span>
                                <button class="btn btn-xs btn-ghost" 
                                        onclick="deleteRequest({{ server_id }}, {{ request.id }}, this)"
                                        title="Delete Request">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                            {% else %}
                            <div class="flex items-center gap-2">
                                <span class="badge badge-ghost badge-sm">Unknown</span>
                                <button class="btn btn-xs btn-ghost" 
                                        onclick="deleteRequest({{ server_id }}, {{ request.id }}, this)"
                                        title="Delete Request">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination Controls -->
    {% if pagination.total_pages > 1 %}
    <div class="flex items-center justify-between mt-6 p-4 bg-base-200/50 rounded-lg">
        <div class="text-sm text-base-content/70">
            Showing {{ ((pagination.current_page - 1) * pagination.results_per_page + 1) }} to 
            {{ (pagination.current_page * pagination.results_per_page) if pagination.current_page * pagination.results_per_page < pagination.total_results else pagination.total_results }} 
            of {{ pagination.total_results }} requests
        </div>
        
        <div class="flex items-center gap-2">
            {% if pagination.has_prev %}
            <button class="btn btn-sm btn-outline" 
                    hx-get="{{ request.path }}?page={{ pagination.current_page - 1 }}&per_page={{ pagination.results_per_page }}"
                    hx-target="#overseerr-requests-{{ server_id }}"
                    hx-indicator="#loading-requests-{{ server_id }}">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            {% endif %}
            
            <span class="px-3 py-1 text-sm">
                Page {{ pagination.current_page }} of {{ pagination.total_pages }}
            </span>
            
            {% if pagination.has_next %}
            <button class="btn btn-sm btn-outline"
                    hx-get="{{ request.path }}?page={{ pagination.current_page + 1 }}&per_page={{ pagination.results_per_page }}"
                    hx-target="#overseerr-requests-{{ server_id }}"
                    hx-indicator="#loading-requests-{{ server_id }}">
                <i class="fa-solid fa-chevron-right"></i>
            </button>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
{% else %}
    <!-- No Requests Found -->
    <div class="text-center py-8">
        <div class="p-4 rounded-full bg-info/10 w-16 h-16 mx-auto flex items-center justify-center mb-4">
            <i class="fa-solid fa-inbox text-2xl text-info"></i>
        </div>
        <h3 class="text-lg font-semibold text-base-content mb-2">No Requests Found</h3>
        <p class="text-base-content/70 mb-4">
            This user hasn't made any requests yet.
        </p>
    </div>
{% endif %}

<script>
function updateRequestStatus(serverId, requestId, status, buttonElement) {
    // Disable the button and show loading state
    const originalContent = buttonElement.innerHTML;
    buttonElement.disabled = true;
    buttonElement.innerHTML = '<span class="loading loading-spinner loading-xs"></span>';
    
    // Make the API call
    fetch('/user/overseerr-request-update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify({
            server_id: serverId,
            request_id: requestId,
            status: status
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const badge = buttonElement.parentElement.querySelector('.badge');
            if (status === 'approve') {
                badge.className = 'badge badge-success badge-sm';
                badge.textContent = 'Approved';
            } else {
                badge.className = 'badge badge-error badge-sm';
                badge.textContent = 'Declined';
            }
            
            // Remove the action buttons
            buttonElement.parentElement.querySelectorAll('button').forEach(btn => btn.remove());
            
            // Show toast notification
            if (typeof showToast === 'function') {
                showToast(data.message, 'success');
            }
        } else {
            // Show error message
            if (typeof showToast === 'function') {
                showToast(data.message, 'error');
            } else {
                alert('Error: ' + data.message);
            }
            
            // Restore button
            buttonElement.disabled = false;
            buttonElement.innerHTML = originalContent;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Show error message
        if (typeof showToast === 'function') {
            showToast('An error occurred while updating the request', 'error');
        } else {
            alert('An error occurred while updating the request');
        }
        
        // Restore button
        buttonElement.disabled = false;
        buttonElement.innerHTML = originalContent;
    });
}

function deleteRequest(serverId, requestId, buttonElement) {
    // Show confirmation dialog
    if (!confirm('Are you sure you want to delete this request? This action cannot be undone.')) {
        return;
    }
    
    // Disable the button and show loading state
    const originalContent = buttonElement.innerHTML;
    buttonElement.disabled = true;
    buttonElement.innerHTML = '<span class="loading loading-spinner loading-xs"></span>';
    
    // Make the API call
    fetch('/user/overseerr-request-delete', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify({
            server_id: serverId,
            request_id: requestId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the entire request card from the DOM
            const requestCard = buttonElement.closest('.card');
            if (requestCard) {
                requestCard.style.transition = 'opacity 0.3s ease-out';
                requestCard.style.opacity = '0';
                setTimeout(() => {
                    requestCard.remove();
                }, 300);
            }
            
            // Show toast notification
            if (typeof showToast === 'function') {
                showToast(data.message, 'success');
            }
        } else {
            // Show error message
            if (typeof showToast === 'function') {
                showToast(data.message, 'error');
            } else {
                alert('Error: ' + data.message);
            }
            
            // Restore button
            buttonElement.disabled = false;
            buttonElement.innerHTML = originalContent;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Show error message
        if (typeof showToast === 'function') {
            showToast('An error occurred while deleting the request', 'error');
        } else {
            alert('An error occurred while deleting the request');
        }
        
        // Restore button
        buttonElement.disabled = false;
        buttonElement.innerHTML = originalContent;
    });
}
</script>