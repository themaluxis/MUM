{% extends "base.html" %}

{% block content %} 
<!-- app\templates\invite\steps\index.html -->
<div class="min-h-[calc(100vh-12rem)] flex items-center justify-center p-4">
    <div class="w-full max-w-4xl">
        {% if error %}
            <!-- Error State -->
            <div class="bg-base-100 border border-error/30 rounded-xl shadow-lg overflow-hidden">
                <div class="bg-error/10 border-b border-error/20 p-6 text-center">
                    <div class="w-16 h-16 rounded-full bg-error/20 flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-circle-xmark text-error text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-error mb-2">Invite Problem</h1>
                    <p class="text-base-content/70 text-sm">
                        There was an issue with your invite
                    </p>
                </div>
                <div class="p-6 text-center">
                    <p class="text-base-content mb-6">{{ error }}</p>
                    {% if g.setup_complete %}
                        <a href="{{ url_for('auth.app_login') }}" class="btn btn-outline btn-neutral">
                            <i class="fa-solid fa-user-shield mr-2"></i>
                            Admin Login
                        </a>
                    {% else %}
                        <a href="{{ url_for('setup.account_setup') }}" class="btn btn-outline btn-neutral">
                            <i class="fa-solid fa-cog mr-2"></i>
                            Go to Setup
                        </a>
                    {% endif %}
                </div>
            </div>
        {% elif invite %}
            <!-- Main Invite Flow -->
            <div class="bg-base-100 border border-base-300 rounded-xl shadow-lg overflow-hidden">
                <!-- Header Section -->
                <div class="bg-gradient-to-r from-primary/10 to-secondary/10 p-6 text-center border-b border-base-300">
                    <div class="w-16 h-16 rounded-full bg-primary/20 flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-envelope-open-text text-primary text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-base-content mb-2">You're Invited!</h1>
                    <p class="text-base-content/70 text-sm">
                        Join <strong class="text-primary">{{ server_name }}</strong> and start streaming
                    </p>
                </div>
                
                <!-- Content Section -->
                <div class="p-6 sm:p-8">
                    <!-- Progress Steps -->
                    {% if invite_steps|length > 1 %}
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="font-medium text-base-content">Setup Progress</h2>
                                <span class="text-sm text-base-content/60">
                                    {{ invite_steps|selectattr('completed')|list|length }} of {{ invite_steps|length }} completed
                                </span>
                            </div>
                            <div class="flex items-center gap-2">
                                {% for step in invite_steps %}
                                    {% set is_current = not step.completed and (loop.index0 == 0 or invite_steps[loop.index0-1].completed) %}
                                    <div class="flex items-center flex-1">
                                        <div class="flex items-center gap-2 p-3 rounded-lg transition-colors
                                            {% if step.completed %}bg-primary/10 border border-primary/20
                                            {% elif is_current %}bg-warning/10 border border-warning/20
                                            {% else %}bg-base-200/50 border border-base-300{% endif %} flex-1">
                                            <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0
                                                {% if step.completed %}bg-primary text-primary-content
                                                {% elif is_current %}bg-warning text-warning-content
                                                {% else %}bg-base-300 text-base-content/60{% endif %}">
                                                {% if step.completed %}
                                                    <i class="fa-solid fa-check text-xs"></i>
                                                {% elif is_current %}
                                                    <i class="fa-solid fa-circle text-xs"></i>
                                                {% else %}
                                                    <i class="{{ step.icon }} text-xs"></i>
                                                {% endif %}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <span class="text-xs font-medium block truncate
                                                    {% if step.completed %}text-primary
                                                    {% elif is_current %}text-warning
                                                    {% else %}text-base-content/70{% endif %}">
                                                    {{ step.name }}
                                                </span>
                                                {% if not step.required %}
                                                    <span class="text-xs text-base-content/60">Optional</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% if not loop.last %}
                                            <div class="w-3 h-0.5 mx-1
                                                {% if step.completed %}bg-primary
                                                {% else %}bg-base-300{% endif %}"></div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Step Content -->
                    <div class="step-content">
                        {# User Account Creation Step #}
                        {% if allow_user_accounts and not user_account_created %}
                            {% include 'invite/steps/_user_account_step.html' %}
                        
                        {# Discord Authentication Step #}
                        {% elif show_discord_button and not already_authenticated_discord_user %}
                            {% include 'invite/steps/_discord_step.html' %}
                        
                        {# Plex Authentication Step (only if there are Plex servers) #}
                        {% elif has_plex_servers and not already_authenticated_plex_user %}
                            {% include 'invite/steps/_plex_step.html' %}
                        
                        {# Individual Server Access Steps #}
                        {% elif current_step and current_step.id.startswith('server_access_') %}
                            {% include 'invite/steps/_server_access_step.html' %}
                        
                        {# Check if all steps are completed #}
                        {% elif (not show_discord_button or already_authenticated_discord_user) and 
                                (not has_plex_servers or already_authenticated_plex_user) and 
                                (not allow_user_accounts or user_account_created) and
                                not (current_step and current_step.id.startswith('server_access_')) %}
                            {% include 'invite/steps/_success_step.html' %}
                        
                        {# Fallback - show first required step #}
                        {% else %}
                            {% if allow_user_accounts and not user_account_created %}
                                {% include 'invite/steps/_user_account_step.html' %}
                            {% elif show_discord_button and not already_authenticated_discord_user %}
                                {% include 'invite/steps/_discord_step.html' %}
                            {% elif has_plex_servers and not already_authenticated_plex_user %}
                                {% include 'invite/steps/_plex_step.html' %}
                            {% else %}
                                {% include 'invite/steps/_success_step.html' %}
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        {% else %}
            <!-- No Invite Found -->
            <div class="bg-base-100 border border-base-300 rounded-xl shadow-lg overflow-hidden">
                <div class="p-8 text-center">
                    <div class="w-16 h-16 rounded-full bg-base-300/50 flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-question text-base-content/60 text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-base-content mb-2">Invite Not Found</h1>
                    <p class="text-base-content/70">
                        The invite you're looking for doesn't exist or has expired.
                    </p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- JavaScript for password validation -->
<script>
function validatePasswords() {
    const password = document.querySelector('input[name="jellyfin_password"]');
    const confirmPassword = document.querySelector('input[name="jellyfin_password_confirm"]');
    
    if (password && confirmPassword) {
        if (password.value !== confirmPassword.value) {
            alert('Passwords do not match. Please try again.');
            return false;
        }
        if (password.value.length < 1) {
            alert('Password cannot be empty.');
            return false;
        }
    }
    return true;
}
</script>

{% endblock content %}