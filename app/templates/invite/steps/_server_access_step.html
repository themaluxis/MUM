<!-- Individual Server Access Step app\templates\invite\steps\_server_access_step.html -->
<div class="step-section bg-base-200/30 border border-base-300 rounded-lg p-6" id="{{ current_step.id }}">
    <!-- Step Header -->
    <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0">
            <i class="{{ current_step.icon }} text-primary text-lg"></i>
        </div>
        <div>
            <h2 class="text-xl font-semibold text-base-content mb-1">{{ current_step.name }}</h2>
            <p class="text-sm text-base-content/70">
                Setting up access to {{ current_step.server_name }}
            </p>
        </div>
    </div>
    
    {# Show completed authentications #}
    {% if already_authenticated_plex_user or already_authenticated_discord_user %}
        <div class="space-y-3 mb-6">
            {% if already_authenticated_plex_user %}
                <div class="bg-[#e5a00d]/10 border border-[#e5a00d]/20 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <div class="w-6 h-6 rounded-full bg-[#e5a00d]/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fa-solid fa-right-to-bracket text-[#e5a00d] text-xs"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-[#e5a00d] mb-1">Plex Account Connected</h4>
                            <p class="text-sm text-base-content/80">
                                Signed in as <strong class="text-base-content">{{ already_authenticated_plex_user.username }}</strong>
                            </p>
                        </div>
                    </div>
                </div>
            {% endif %}
            {% if already_authenticated_discord_user %}
                <div class="bg-[#5865F2]/10 border border-[#5865F2]/20 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <div class="w-6 h-6 rounded-full bg-[#5865F2]/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fa-brands fa-discord text-[#5865F2] text-xs"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-[#5865F2] mb-1">Discord Account Connected</h4>
                            <p class="text-sm text-base-content/80">
                                Linked as <strong class="text-base-content">{{ already_authenticated_discord_user.username }}</strong>
                            </p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    {% endif %}

    <form method="POST" action="{{ url_for('invites.process_invite_form', invite_path_or_token=invite_path_or_token) }}">
        {{ form.hidden_tag() }}
        <input type="hidden" name="current_server_id" value="{{ current_step.server_id }}">
        
        {% if current_step.server_type != 'PLEX' %}
            <div class="space-y-4 mb-6">
                <!-- Username field (only show if not using same username or if username was taken) -->
                {% if not use_same_username or server_username_taken %}
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium text-sm">
                                {% if server_username_taken %}
                                    Username for {{ current_step.server_name }} (original was taken)
                                {% else %}
                                    Choose a username for {{ current_step.server_name }}
                                {% endif %}
                            </span>
                        </label>
                        
                        {% if server_username_taken %}
                            <!-- Show warning that username was taken -->
                            <div class="bg-warning/10 border border-warning/20 rounded-lg p-3 mb-3">
                                <div class="flex items-start gap-2">
                                    <i class="fa-solid fa-exclamation-triangle text-warning text-sm mt-0.5"></i>
                                    <div class="text-sm">
                                        <p class="font-medium text-warning mb-1">Username Not Available</p>
                                        <p class="text-base-content/80">
                                            The username "{{ preferred_username }}" is already taken on {{ current_step.server_name }}. 
                                            Please choose a different username.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        
                        <input type="text" name="jellyfin_username" placeholder="Username" 
                               class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100" 
                               value="{% if server_username_taken %}{% else %}{{ default_username }}{% endif %}" required>
                        <label class="label">
                            <span class="label-text-alt text-xs text-base-content/60">
                                {% if already_authenticated_plex_user %}
                                    Default: Your Plex username
                                {% else %}
                                    Choose a unique username for this server
                                {% endif %}
                            </span>
                        </label>
                    </div>
                {% else %}
                    <!-- Show info that same username will be used -->
                    <div class="bg-success/10 border border-success/20 rounded-lg p-3">
                        <div class="flex items-start gap-2">
                            <i class="fa-solid fa-check-circle text-success text-sm mt-0.5"></i>
                            <div class="text-sm">
                                <p class="font-medium text-success mb-1">Using Local Account Username</p>
                                <p class="text-base-content/80">
                                    Your local account username "{{ default_username }}" will be used for {{ current_step.server_name }}.
                                </p>
                            </div>
                        </div>
                    </div>
                    <!-- Hidden field to pass the username -->
                    <input type="hidden" name="jellyfin_username" value="{{ default_username }}">
                {% endif %}
                
                <!-- Password fields (only show if not using same password or if username was taken) -->
                {% if not use_same_password or server_username_taken %}
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium text-sm">Set a password for {{ current_step.server_name }}</span>
                        </label>
                        <input type="password" name="jellyfin_password" placeholder="Enter password" 
                               class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100" required>
                        <label class="label">
                            <span class="label-text-alt text-xs text-base-content/60">Choose a secure password for your account</span>
                        </label>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium text-sm">Confirm password</span>
                        </label>
                        <input type="password" name="jellyfin_password_confirm" placeholder="Confirm password" 
                               class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100" required>
                        <label class="label">
                            <span class="label-text-alt text-xs text-base-content/60">Re-enter your password to confirm</span>
                        </label>
                    </div>
                {% else %}
                    <!-- Show info that same password will be used -->
                    <div class="bg-success/10 border border-success/20 rounded-lg p-3">
                        <div class="flex items-start gap-2">
                            <i class="fa-solid fa-check-circle text-success text-sm mt-0.5"></i>
                            <div class="text-sm">
                                <p class="font-medium text-success mb-1">Using Local Account Password</p>
                                <p class="text-base-content/80">
                                    Your local account password will be used for {{ current_step.server_name }}.
                                </p>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endif %}

        <button name="action" value="setup_server_access" type="submit" 
                class="btn btn-primary w-full h-12 text-base font-medium" 
                {% if current_step.server_type != 'PLEX' %}onclick="return validatePasswords()"{% endif %}>
            <i class="fa-solid fa-user-plus mr-2"></i>
            {% if current_step.server_type == 'PLEX' %}
                Grant Access to {{ current_step.server_name }}
            {% else %}
                Create Account on {{ current_step.server_name }}
            {% endif %}
        </button>
    </form>

    <!-- Include server access details partial -->
    {% include 'invite/steps/_server_access_details.html' %}
</div>