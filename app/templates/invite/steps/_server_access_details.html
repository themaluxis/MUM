<!-- Server Access Details (collapsible section) app\templates\invite\steps\_server_access_details.html -->
{% if current_step and current_step.id.startswith('server_access_') and (not discord_sso_is_mandatory or already_authenticated_discord_user) %}
    <div class="bg-base-200/30 border border-base-300 rounded-lg mt-6 overflow-hidden">
        <details class="group">
            <summary class="flex items-center justify-between p-4 cursor-pointer hover:bg-base-200/50 transition-colors">
                <div class="flex items-center gap-3">
                    <div class="w-6 h-6 rounded-full bg-info/20 flex items-center justify-center flex-shrink-0">
                        <i class="fa-solid fa-info text-info text-xs"></i>
                    </div>
                    <span class="font-medium text-base-content">{{ current_step.server_name }} Access Details</span>
                </div>
                <i class="fa-solid fa-chevron-down text-base-content/60 transition-transform group-open:rotate-180"></i>
            </summary>
            
            <div class="border-t border-base-300 p-4 space-y-4">
                <!-- Server Information -->
                <div class="bg-info/10 border border-info/20 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <div class="w-6 h-6 rounded-full bg-info/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fa-solid fa-server text-info text-xs"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-info mb-2">Server Information</h4>
                            <div class="space-y-1 text-sm text-base-content/80">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium">Name:</span>
                                    <span>{{ current_step.server_name }}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="font-medium">Type:</span>
                                    <span>{{ current_step.server_type }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Library Access -->
                {% if invite.grant_library_ids|length > 0 %}
                    {# Get libraries for current server #}
                    {% set current_server_libraries = servers_with_libraries.get(current_step.server_id|int, {}).get('libraries', {}) if servers_with_libraries else {} %}
                    
                    {# Find matching libraries #}
                    {% set matching_libraries = [] %}
                    {% for lib_id in invite.grant_library_ids %}
                        {% if lib_id in current_server_libraries %}
                            {% set _ = matching_libraries.append(current_server_libraries[lib_id]) %}
                        {% endif %}
                    {% endfor %}
                    
                    <div class="bg-primary/10 border border-primary/20 rounded-lg p-4">
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                <i class="fa-solid fa-folder text-primary text-xs"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-primary mb-2">Library Access</h4>
                                {% if matching_libraries %}
                                    <p class="text-sm text-base-content/80 mb-2">
                                        You will have access to <strong>{{ matching_libraries|length }}</strong> selected libraries:
                                    </p>
                                    <div class="space-y-1">
                                        {% for lib_name in matching_libraries %}
                                            <div class="flex items-center gap-2 text-sm">
                                                <div class="w-3 h-3 rounded-full bg-primary/20 flex items-center justify-center">
                                                    <i class="fa-solid fa-check text-primary text-xs"></i>
                                                </div>
                                                <span class="text-base-content/80">{{ lib_name }}</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="text-sm text-base-content/80">
                                        Selected libraries (no matching libraries found for this server)
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="bg-primary/10 border border-primary/20 rounded-lg p-4">
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                <i class="fa-solid fa-folder text-primary text-xs"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-primary mb-2">Library Access</h4>
                                <p class="text-sm text-base-content/80">
                                    All available libraries on this server
                                </p>
                            </div>
                        </div>
                    </div>
                {% endif %}
                
                <!-- Server-Specific Features -->
                <div class="bg-success/10 border border-success/20 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <div class="w-6 h-6 rounded-full bg-success/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fa-solid fa-star text-success text-xs"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-success mb-2">Features & Permissions</h4>
                            <div class="space-y-1 text-sm text-base-content/80">
                                {% if current_step.server_type == 'PLEX' %}
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-download w-4 text-success"></i>
                                        <span>Downloads/Sync: <strong>{{ "Enabled" if invite.allow_downloads else "Disabled" }}</strong></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-house-user w-4 text-success"></i>
                                        <span>Plex Home Invite: <strong>{{ "Yes" if invite.invite_to_plex_home else "No" }}</strong></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-tv w-4 text-success"></i>
                                        <span>Live TV Access: <strong>{{ "Enabled" if invite.allow_live_tv else "Disabled" }}</strong></span>
                                    </div>
                                {% elif current_step.server_type == 'JELLYFIN' %}
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-user w-4 text-success"></i>
                                        <span>Account Type: <strong>New user account will be created</strong></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-key w-4 text-success"></i>
                                        <span>Authentication: <strong>Username and password (required)</strong></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-download w-4 text-success"></i>
                                        <span>Downloads: <strong>Available through Jellyfin apps</strong></span>
                                    </div>
                                {% elif current_step.server_type == 'EMBY' %}
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-user w-4 text-success"></i>
                                        <span>Account Type: <strong>New user account will be created</strong></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-key w-4 text-success"></i>
                                        <span>Authentication: <strong>Username and password</strong></span>
                                    </div>
                                {% else %}
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-user w-4 text-success"></i>
                                        <span>Account Type: <strong>New user account will be created</strong></span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Invite Information -->
                <div class="bg-secondary/10 border border-secondary/20 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <div class="w-6 h-6 rounded-full bg-secondary/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fa-solid fa-calendar text-secondary text-xs"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-secondary mb-2">Invite Details</h4>
                            <div class="space-y-1 text-sm text-base-content/80">
                                <div class="flex items-center gap-2">
                                    <i class="fa-regular fa-clock w-4 text-base-content/60"></i>
                                    <span>Expires: <strong>{{ invite.expires_at | format_datetime_user if invite.expires_at else "Never" }}</strong></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-users w-4 text-base-content/60"></i>
                                    <span>Uses Left: <strong>{{ (invite.max_uses - invite.current_uses) if invite.max_uses is not none else "Unlimited" }}</strong></span>
                                </div>
                                {% if invite.membership_duration_days %}
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-user-clock w-4 text-base-content/60"></i>
                                        <span>Membership Duration: <strong>{{ invite.membership_duration_days }} day{{'s' if invite.membership_duration_days != 1 else ''}} after acceptance</strong></span>
                                    </div>
                                {% else %}
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-user-check w-4 text-base-content/60"></i>
                                        <span>Membership: <strong>Permanent</strong></span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Info Footer -->
                <div class="bg-base-100/50 border border-base-300/50 rounded-lg p-3">
                    <div class="flex items-start gap-2">
                        <i class="fa-solid fa-info-circle text-base-content/60 text-xs mt-0.5"></i>
                        <p class="text-xs text-base-content/60">
                            This information shows what access you'll receive after completing the setup.
                        </p>
                    </div>
                </div>
            </div>
        </details>
    </div>
{% endif %}