<!-- File: app/templates/roles/create.html -->
{% extends "settings/index.html" %}

{% block title %}{{ super() }} - {{ title }}{% endblock %}

{% block settings_content %}
    <!-- Navigation -->
    <div class="flex items-center mb-8">
        <a href="{{ url_for('role_management.index') }}" class="btn btn-ghost btn-sm">
            <i class="fa-solid fa-arrow-left mr-2"></i> Back to Role List
        </a>
    </div>

    <!-- Clean Header -->
    <div class="mb-8">
        <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0">
                <i class="fa-solid fa-plus text-primary text-xl"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-base-content mb-1">Create New Role</h1>
                <p class="text-sm text-base-content/70">Define a new role with custom permissions and appearance</p>
            </div>
        </div>
    </div>

    <!-- Progress Tabs -->
    <div class="mb-6">
        <div class="overflow-x-auto">
            <div role="tablist" class="tabs tabs-bordered">
                <a role="tab" class="tab tab-active">
                    <i class="fa-solid fa-palette mr-2"></i>
                    Display Settings
                </a>
                <div class="tooltip tooltip-top" data-tip="Save the role first to set permissions">
                    <a role="tab" class="tab tab-disabled opacity-50">
                        <i class="fa-solid fa-key mr-2"></i>
                        Permissions
                    </a>
                </div>
                <div class="tooltip tooltip-top" data-tip="Save the role first to manage members">
                    <a role="tab" class="tab tab-disabled opacity-50">
                        <i class="fa-solid fa-users mr-2"></i>
                        Members
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Description Card -->
    <div class="bg-info/10 border border-info/20 rounded-lg p-4 mb-6">
        <div class="flex items-start gap-3">
            <div class="w-6 h-6 rounded-full bg-info/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                <i class="fa-solid fa-info text-info text-xs"></i>
            </div>
            <div>
                <h4 class="font-medium text-info mb-1">Role Configuration</h4>
                <p class="text-sm text-base-content/80">
                    Customize the role's name, description, and visual appearance. After creating the role, you'll be able to configure permissions and add members.
                </p>
            </div>
        </div>
    </div>

    <form method="POST" id="createRoleForm">
        {{ form.hidden_tag() }}
        
        <!-- Basic Settings Section -->
        <div class="space-y-4 mb-6">
            <h4 class="font-medium text-base-content text-lg mb-3">
                <i class="fa-solid fa-id-badge text-primary text-sm mr-2"></i>
                Basic Settings
            </h4>
            
            <!-- Role Name -->
            <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-tag text-primary text-sm"></i>
                        <h5 class="font-medium text-base-content">{{ form.name.label.text }}</h5>
                        <span class="inline-flex items-center rounded-full bg-red-50 dark:bg-red-400/10 px-2 py-1 text-xs font-medium text-red-700 dark:text-red-400 ring-1 ring-inset ring-red-600/20 dark:ring-red-500/20">
                            Required
                        </span>
                    </div>
                </div>
                {{ form.name(class="input input-bordered w-full " + ("input-error" if form.name.errors else ""), id="create_role_name") }}
                {% if form.name.errors %}
                    <span class="text-error text-xs mt-1 block">{{ form.name.errors[0] }}</span>
                {% else %}
                    <span class="text-base-content/60 text-xs mt-1 block">A unique name for this role</span>
                {% endif %}
            </div>

            <!-- Description -->
            <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-align-left text-secondary text-sm"></i>
                        <h5 class="font-medium text-base-content">{{ form.description.label.text }}</h5>
                        <span class="inline-flex items-center rounded-full bg-yellow-50 dark:bg-yellow-400/10 px-2 py-1 text-xs font-medium text-yellow-700 dark:text-yellow-400 ring-1 ring-inset ring-yellow-600/20 dark:ring-yellow-500/20">
                            Optional
                        </span>
                    </div>
                </div>
                {{ form.description(class="input input-bordered w-full " + ("input-error" if form.description.errors else "")) }}
                {% if form.description.errors %}
                    <span class="text-error text-xs mt-1 block">{{ form.description.errors[0] }}</span>
                {% else %}
                    <span class="text-base-content/60 text-xs mt-1 block">Optional description of what this role does</span>
                {% endif %}
            </div>
        </div>

        <!-- Visual Appearance Section -->
        <div class="space-y-4 mb-6">
            <h4 class="font-medium text-base-content text-lg mb-3">
                <i class="fa-solid fa-palette text-secondary text-sm mr-2"></i>
                Visual Appearance
            </h4>
            
            <!-- Color -->
            <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-paint-brush text-warning text-sm"></i>
                        <h5 class="font-medium text-base-content">{{ form.color.label.text }}</h5>
                    </div>
                </div>
                
                <!-- Color Input and Presets -->
                <div class="flex gap-4 mb-4">
                    <!-- Color Preview and Hidden Picker -->
                    <div class="relative">
                        <div class="w-12 h-11 rounded-lg border border-base-300 overflow-hidden cursor-pointer" id="create_color_preview" style="background-color: {{ form.color.data or '#808080' }}"></div>
                        <input type="color" value="{{ form.color.data or '#808080' }}" 
                               class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" id="create_color_picker">
                        {{ form.color(class="hidden", id="create_color_text") }}
                    </div>
                    
                    <!-- Preset Colors -->
                    <div class="flex-1">
                        <span class="text-xs font-medium text-base-content/70 mb-2 block">Preset Colors</span>
                        <div class="flex gap-2 flex-wrap">
                            <div class="w-8 h-8 rounded-full cursor-pointer border-2 border-transparent hover:border-base-300 transition-colors preset-color" 
                                 style="background-color: #f04747" data-color="#f04747" title="Red"></div>
                            <div class="w-8 h-8 rounded-full cursor-pointer border-2 border-transparent hover:border-base-300 transition-colors preset-color" 
                                 style="background-color: #faa61a" data-color="#faa61a" title="Orange"></div>
                            <div class="w-8 h-8 rounded-full cursor-pointer border-2 border-transparent hover:border-base-300 transition-colors preset-color" 
                                 style="background-color: #fee75c" data-color="#fee75c" title="Yellow"></div>
                            <div class="w-8 h-8 rounded-full cursor-pointer border-2 border-transparent hover:border-base-300 transition-colors preset-color" 
                                 style="background-color: #57f287" data-color="#57f287" title="Green"></div>
                            <div class="w-8 h-8 rounded-full cursor-pointer border-2 border-transparent hover:border-base-300 transition-colors preset-color" 
                                 style="background-color: #5865f2" data-color="#5865f2" title="Blurple"></div>
                            <div class="w-8 h-8 rounded-full cursor-pointer border-2 border-transparent hover:border-base-300 transition-colors preset-color" 
                                 style="background-color: #eb459e" data-color="#eb459e" title="Pink"></div>
                            <div class="w-8 h-8 rounded-full cursor-pointer border-2 border-transparent hover:border-base-300 transition-colors preset-color" 
                                 style="background-color: #9c84ef" data-color="#9c84ef" title="Purple"></div>
                            <div class="w-8 h-8 rounded-full cursor-pointer border-2 border-transparent hover:border-base-300 transition-colors preset-color" 
                                 style="background-color: #808080" data-color="#808080" title="Gray"></div>
                        </div>
                    </div>
                </div>
                
                {% if form.color.errors %}
                    <span class="text-error text-xs mt-1 block">{{ form.color.errors[0] }}</span>
                {% else %}
                    <span class="text-base-content/60 text-xs block">Choose a color for role badges and highlights</span>
                {% endif %}
            </div>

            <!-- Icon -->
            <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-icons text-accent text-sm"></i>
                        <h5 class="font-medium text-base-content">{{ form.icon.label.text }}</h5>
                        <span class="inline-flex items-center rounded-full bg-yellow-50 dark:bg-yellow-400/10 px-2 py-1 text-xs font-medium text-yellow-700 dark:text-yellow-400 ring-1 ring-inset ring-yellow-600/20 dark:ring-yellow-500/20">
                            Optional
                        </span>
                    </div>
                </div>
                {{ form.icon(class="input input-bordered w-full " + ("input-error" if form.icon.errors else ""), id="create_role_icon", placeholder="e.g., fa-solid fa-star") }}
                {% if form.icon.errors %}
                    <span class="text-error text-xs mt-1 block">{{ form.icon.errors[0] }}</span>
                {% else %}
                    <span class="text-base-content/60 text-xs mt-1 block">
                        Find icons on <a href="https://fontawesome.com/search" target="_blank" class="link link-primary">Font Awesome</a>
                    </span>
                {% endif %}
            </div>
        </div>

        <!-- Live Preview Section -->
        <div class="space-y-4 mb-6">
            <h4 class="font-medium text-base-content text-lg mb-3">
                <i class="fa-solid fa-eye text-success text-sm mr-2"></i>
                Live Preview
            </h4>
            
            <div class="bg-base-200/30 rounded-lg p-6 border border-base-300">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-8 h-8 rounded-full bg-success/20 flex items-center justify-center flex-shrink-0">
                        <i class="fa-solid fa-sparkles text-success text-sm"></i>
                    </div>
                    <div>
                        <h5 class="font-medium text-base-content">Badge Preview</h5>
                        <p class="text-xs text-base-content/60">How the role badge will appear throughout the interface</p>
                    </div>
                </div>
                <div class="bg-base-100 border border-base-300 rounded-lg p-6 text-center">
                    <span class="badge text-sm px-3 py-2" id="create_badge_preview">
                        <i id="create_badge_icon_preview" class="mr-1"></i>
                        <span id="create_badge_text_preview">New Role</span>
                    </span>
                </div>
                <div class="text-center mt-3">
                    <span class="text-base-content/60 text-xs">Preview updates automatically as you make changes</span>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center justify-end gap-3 pt-6 border-t border-base-300">
            <button type="submit" class="btn btn-primary h-12 gap-2">
                <i class="fa-solid fa-plus"></i>
                Create Role and Continue
            </button>
        </div>
    </form>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Helper function for calculating text color based on background
    function getTextColorForBg(hexColor) {
        if (!hexColor || hexColor.length !== 7) return '#FFFFFF';
        try {
            const r = parseInt(hexColor.substr(1, 2), 16);
            const g = parseInt(hexColor.substr(3, 2), 16);
            const b = parseInt(hexColor.substr(5, 2), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5 ? '#000000' : '#FFFFFF';
        } catch (e) { return '#FFFFFF'; }
    }
    
    const createPicker = document.getElementById('create_color_picker');
    const createText = document.getElementById('create_color_text');
    const createColorPreview = document.getElementById('create_color_preview');
    const createName = document.getElementById('create_role_name');
    const createBadgePreview = document.getElementById('create_badge_preview');
    const createIconInput = document.getElementById('create_role_icon');
    const createBadgeIcon = document.getElementById('create_badge_icon_preview');
    const createBadgeText = document.getElementById('create_badge_text_preview');
    const presetColors = document.querySelectorAll('.preset-color');

    function updateCreatePreview() {
        if (!createBadgePreview || !createName || !createIconInput || !createBadgeIcon || !createBadgeText) return;
        const name = createName.value.trim() || 'New Role';
        const color = createPicker ? createPicker.value : '#808080';
        const iconClasses = createIconInput.value.trim();

        // Update the text and icon independently
        createBadgeText.textContent = name;
        createBadgeIcon.className = iconClasses ? `${iconClasses}` : '';

        // Update the parent badge's style
        createBadgePreview.style.backgroundColor = color;
        createBadgePreview.style.borderColor = color;
        createBadgePreview.style.color = getTextColorForBg(color);
        
        // Update the color preview
        if (createColorPreview) {
            createColorPreview.style.backgroundColor = color;
        }
        
        // Update the hidden form field
        if (createText) {
            createText.value = color;
        }
    }

    function updateColorInputs(color) {
        if (createPicker) createPicker.value = color;
        if (createText) createText.value = color;
        updateCreatePreview();
    }

    // Preset color click handlers
    presetColors.forEach(colorDiv => {
        colorDiv.addEventListener('click', () => {
            const color = colorDiv.getAttribute('data-color');
            updateColorInputs(color);
        });
    });

    // Attach event listeners
    if (createPicker) {
        createPicker.addEventListener('input', () => { 
            updateCreatePreview(); 
        });
        createPicker.addEventListener('change', () => { 
            updateCreatePreview(); 
        });
    }
    if (createName) {
        createName.addEventListener('input', updateCreatePreview);
    }
    if (createIconInput) {
        createIconInput.addEventListener('input', updateCreatePreview);
    }
    
    // Set the initial state of the preview on page load
    updateCreatePreview();
</script>
{% endblock %}