<!-- File: app/templates/settings/partials/_plugin_configure.html -->
<div class="mb-6">
    <a href="{{ url_for('plugin_management.index') }}" class="btn btn-ghost">
        <i class="fas fa-arrow-left mr-2"></i>
        Back to Plugins
    </a>
</div>

<div class="card bg-base-100 shadow-xl">
    <div class="card-body">
        <div class="flex items-center mb-4">
            <h2 class="card-title text-2xl">{{ title }}</h2>
            {% if plugin.is_enabled %}
                <span class="badge badge-success ml-4">Enabled</span>
            {% else %}
                <span class="badge badge-ghost ml-4">Disabled</span>
            {% endif %}
        </div>
        <p>{{ plugin.description }}</p>

        <div class="divider"></div>

        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Configured Servers</h3>
            <div class="flex gap-2">
                {% if servers_with_details|length > 0 and not plugin.is_enabled %}
                <form method="POST" action="{{ url_for('plugins.enable_plugin', plugin_id=plugin.plugin_id) }}" class="inline"
                      hx-post="{{ url_for('plugins.enable_plugin', plugin_id=plugin.plugin_id) }}"
                      hx-trigger="submit"
                      hx-indicator=".htmx-indicator">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-power-off mr-2"></i>Enable Plugin
                        <span class="htmx-indicator loading loading-spinner loading-sm ml-2"></span>
                    </button>
                </form>
                {% endif %}
                <a href="{{ url_for('plugin_management.add_server', plugin_id=plugin.plugin_id) }}" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>
                    Add Server
                </a>
            </div>
        </div>

        {% if servers_with_details %}
        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {% for details in servers_with_details %}
            {% set server = details.server %}
            <div class="card bg-base-200 shadow-xl">
                <div class="card-body">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title">{{ server.name }}</h2>
                        <div class="badge badge-{{ 'success' if server.is_active else 'error' }}">
                            {{ 'Active' if server.is_active else 'Inactive' }}
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <i class="fas fa-server mr-2 text-gray-500"></i>
                            <span class="text-sm">{{ details.actual_server_name or server.service_type.value.title() }}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-link mr-2 text-gray-500"></i>
                            <span class="text-sm truncate">{{ server.url }}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-clock mr-2 text-gray-500"></i>
                            <span class="text-sm">
                                {% if server.last_sync_at %}
                                    Last sync: {{ server.last_sync_at|format_datetime_user(False) }}
                                {% else %}
                                    Never synced
                                {% endif %}
                            </span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-users mr-2 text-gray-500"></i>
                            <span class="text-sm">
                                {{ details.member_count }} members
                            </span>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-list-ul mr-2 text-gray-500 mt-1"></i>
                            <div class="text-sm">
                                {% if details.libraries %}
                                    <div id="libraries-{{ server.id }}" class="flex flex-wrap gap-1">
                                        {% for lib in details.libraries[:5] %}
                                            <span class="badge badge-outline">{{ lib }}</span>
                                        {% endfor %}
                                        {% if details.libraries|length > 5 %}
                                            <button id="more-libs-{{ server.id }}" onclick='showMoreLibraries({{ server.id }}, {{ details.libraries|tojson|safe }})' class="btn btn-info btn-xs">+{{ details.libraries|length - 5 }} more</button>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    No libraries found.
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {% if details.error %}
                    <div class="alert alert-warning mt-4">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>{{ details.error }}</span>
                    </div>
                    {% endif %}

                    <div class="card-actions justify-end mt-4">
                        {% if server.is_active %}
                        <form method="POST" action="{{ url_for('plugin_management.disable_server', plugin_id=plugin.plugin_id, server_id=server.id) }}" class="inline mr-2">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-warning btn-sm">
                                <i class="fas fa-pause mr-1"></i>Disable
                            </button>
                        </form>
                        {% else %}
                        <form method="POST" action="{{ url_for('plugin_management.enable_server', plugin_id=plugin.plugin_id, server_id=server.id) }}" class="inline mr-2">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-success btn-sm">
                                <i class="fas fa-play mr-1"></i>Enable
                            </button>
                        </form>
                        {% endif %}
                        
                        <!-- Edit Button -->
                        <a href="{{ url_for('plugin_management.edit_server', plugin_id=plugin.plugin_id, server_id=server.id) }}" 
                           class="btn btn-ghost btn-sm" title="Edit Server">
                            <i class="fas fa-edit"></i>
                        </a>
                        
                        <!-- Delete Button -->
                        <button onclick="deleteServer({{ server.id }}, '{{ server.name }}')" 
                                class="btn btn-ghost btn-sm text-error hover:bg-error/10" title="Delete Server">
                            <i class="fas fa-trash"></i>
                        </button>
                        
                        <!-- Actions Dropdown (for remaining actions) -->
                        <div class="dropdown dropdown-end">
                            <label tabindex="0" class="btn btn-ghost btn-sm" title="More Actions">
                                <i class="fas fa-ellipsis-v"></i>
                            </label>
                            <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                                <li>
                                    <button onclick="testConnection({{ server.id }})" class="text-blue-600">
                                        <i class="fas fa-plug mr-2"></i>Test Connection
                                    </button>
                                </li>
                                <li>
                                    <button onclick="syncLibraries({{ server.id }})" class="text-green-600">
                                        <i class="fas fa-sync mr-2"></i>Sync Libraries
                                    </button>
                                </li>
                                <li>
                                    <button onclick="syncUsers({{ server.id }})" class="text-purple-600">
                                        <i class="fas fa-users mr-2"></i>Sync Users
                                    </button>
                                </li>
                                <li>
                                    <button onclick="showRawServerInfo({{ server.id }}, '{{ server.name }}')" class="text-gray-600">
                                        <i class="fas fa-code mr-2"></i>Raw Server Info
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <span>No servers have been configured for this service yet.</span>
        </div>
        {% endif %}
    </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Delete Server</h3>
        <p class="py-4">Are you sure you want to delete the server "<span id="serverName"></span>"?</p>
        <div class="modal-action">
            <form id="deleteForm" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="return_to" value="plugin_config"/>
                <input type="hidden" name="plugin_id" value="{{ plugin.plugin_id }}"/>
                <button type="submit" class="btn btn-error">Delete</button>
                <button type="button" class="btn" onclick="closeDeleteModal()">Cancel</button>
            </form>
        </div>
    </div>
</div>

<!-- Raw Server Info Modal -->
<dialog id="rawServerInfoModal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-5xl bg-base-100 border border-base-300 shadow-2xl p-0">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-base-300">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-secondary/20 flex items-center justify-center">
                    <i class="fa-solid fa-server text-secondary text-lg"></i>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-base-content">Raw Server Information</h3>
                    <p class="text-sm text-base-content/60">Debug data from <span id="rawServerInfoName" class="font-mono"></span></p>
                </div>
            </div>
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost hover:bg-base-200" onclick="closeRawServerInfoModal()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </form>
        </div>

        <!-- Content -->
        <div class="p-6">
            <!-- Loading State -->
            <div id="rawServerInfoLoading" class="text-center p-8">
                <span class="loading loading-lg loading-spinner"></span>
                <p class="text-sm text-base-content/60 mt-4">Fetching server information...</p>
            </div>

            <!-- Content Container -->
            <div id="rawServerInfoContentContainer" class="hidden">
                <!-- Server Info Card -->
                <div class="bg-base-200/50 rounded-lg p-4 mb-6 border border-base-300/50">
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-info/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fa-solid fa-database text-info text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-medium text-base-content mb-1">Server Debug Information</h4>
                            <p class="text-sm text-base-content/70 leading-relaxed">
                                Raw API response data (structured in JSON format) from the media server API. This information is useful for debugging connection issues and understanding server capabilities.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Raw Data Section -->
                <div class="space-y-4 mb-6">

                    <!-- Code Display -->
                    <div class="bg-base-200/30 rounded-lg border border-base-300/30">
                        <div class="flex items-center justify-between p-3 border-b border-base-300/30 bg-base-200/50">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-brackets-curly text-secondary text-sm"></i>
                                <span class="font-medium text-sm">Server Response Data</span>
                            </div>
                            <div class="text-xs text-base-content/60" id="rawServerInfoSize">
                                <!-- Size will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="p-4">
                            <div class="mockup-code bg-base-300/50 border border-base-300/50">
                                <pre id="rawServerInfoContent" class="text-xs max-h-96 overflow-auto"><code></code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center justify-end gap-3 mt-8 pt-6 border-t border-base-300">
                    <button type="button" class="btn btn-ghost" onclick="closeRawServerInfoModal()">
                        Close
                    </button>
                    <button type="button" class="btn btn-secondary gap-2" onclick="copyRawServerInfo()">
                        <i class="fa-solid fa-copy"></i>
                        Copy to Clipboard
                    </button>
                </div>
            </div>

            <!-- Error State -->
            <div id="rawServerInfoError" class="hidden">
                <div class="bg-error/10 rounded-lg p-8 border border-error/30 text-center">
                    <div class="w-16 h-16 rounded-full bg-error/20 flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-exclamation-triangle text-error text-2xl"></i>
                    </div>
                    <h5 class="font-medium text-base-content mb-2">Failed to Fetch Server Information</h5>
                    <p id="rawServerInfoErrorMessage" class="text-sm text-base-content/70 mb-4">
                        <!-- Error message will be populated by JavaScript -->
                    </p>
                </div>
                
                <!-- Action Buttons for Error State -->
                <div class="flex items-center justify-end gap-3 mt-8 pt-6 border-t border-base-300">
                    <button type="button" class="btn btn-ghost" onclick="closeRawServerInfoModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

<script>
function showMoreLibraries(serverId, libraries) {
    const container = document.getElementById(`libraries-${serverId}`);
    const button = document.getElementById(`more-libs-${serverId}`);
    container.innerHTML = ''; // Clear existing badges
    libraries.forEach(lib => {
        const badge = document.createElement('span');
        badge.className = 'badge badge-outline';
        badge.textContent = lib;
        container.appendChild(badge);
    });
    button.style.display = 'none';
}

function testConnection(serverId) {
    // Find the button and show loading state
    const button = document.querySelector(`[onclick*="testConnection(${serverId})"]`);
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Testing...';
    button.disabled = true;
    
    fetch(`{{ url_for('plugin_management.test_existing_server_connection', plugin_id=plugin.plugin_id, server_id=999) }}`.replace('999', serverId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Connection test successful!', 'success');
            } else {
                showToast(`Connection test failed: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            showToast('Error testing connection', 'error');
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

function syncLibraries(serverId) {
    // Find the button and show loading state
    const button = document.querySelector(`[onclick*="syncLibraries(${serverId})"]`);
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Syncing...';
    button.disabled = true;
    
    fetch(`/api/servers/${serverId}/sync/libraries`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(`Sync failed: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            showToast('Error syncing libraries', 'error');
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

function syncUsers(serverId) {
    // Find the button and show loading state
    const button = document.querySelector(`[onclick*="syncUsers(${serverId})"]`);
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Syncing...';
    button.disabled = true;
    
    fetch(`/api/servers/${serverId}/sync/users`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(`Sync failed: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            showToast('Error syncing users', 'error');
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

function deleteServer(serverId, serverName) {
    document.getElementById('serverName').textContent = serverName;
    document.getElementById('deleteForm').action = `/settings/plugins/{{ plugin.plugin_id }}/${serverId}/delete`;
    document.getElementById('deleteModal').classList.add('modal-open');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('modal-open');
}

function showRawServerInfo(serverId, serverName) {
    // Show modal and set server name
    document.getElementById('rawServerInfoName').textContent = serverName;
    document.getElementById('rawServerInfoModal').showModal();
    
    // Show loading state
    document.getElementById('rawServerInfoLoading').classList.remove('hidden');
    document.getElementById('rawServerInfoContentContainer').classList.add('hidden');
    document.getElementById('rawServerInfoError').classList.add('hidden');
    
    // Fetch raw server info
    fetch(`{{ url_for('plugin_management.get_raw_server_info', plugin_id=plugin.plugin_id, server_id=999) }}`.replace('999', serverId), {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('rawServerInfoLoading').classList.add('hidden');
        
        if (data.success) {
            const jsonString = JSON.stringify(data.info, null, 2);
            document.getElementById('rawServerInfoContent').querySelector('code').textContent = jsonString;
            document.getElementById('rawServerInfoSize').textContent = `Size: ${jsonString.length} characters`;
            document.getElementById('rawServerInfoContentContainer').classList.remove('hidden');
        } else {
            document.getElementById('rawServerInfoErrorMessage').textContent = data.message || 'Failed to fetch server information';
            document.getElementById('rawServerInfoError').classList.remove('hidden');
        }
    })
    .catch(error => {
        document.getElementById('rawServerInfoLoading').classList.add('hidden');
        document.getElementById('rawServerInfoErrorMessage').textContent = 'Error fetching server information: ' + error.message;
        document.getElementById('rawServerInfoError').classList.remove('hidden');
    });
}

function closeRawServerInfoModal() {
    document.getElementById('rawServerInfoModal').close();
}

function copyRawServerInfo() {
    const contentElement = document.getElementById('rawServerInfoContent').querySelector('code');
    if (contentElement && contentElement.textContent) {
        const textToCopy = contentElement.textContent;
        
        // Try modern clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(textToCopy).then(() => {
                showServerInfoCopySuccess();
            }).catch(err => {
                console.error('Clipboard API failed:', err);
                fallbackCopyServerInfo(textToCopy);
            });
        } else {
            // Fallback for older browsers or non-secure contexts
            fallbackCopyServerInfo(textToCopy);
        }
    }
}

function fallbackCopyServerInfo(text) {
    try {
        // Create a temporary textarea element
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        
        // Select and copy the text
        textArea.focus();
        textArea.select();
        
        const successful = document.execCommand('copy');
        document.body.removeChild(textArea);
        
        if (successful) {
            showServerInfoCopySuccess();
        } else {
            showServerInfoCopyError();
        }
    } catch (err) {
        console.error('Fallback copy failed:', err);
        showServerInfoCopyError();
    }
}

function showServerInfoCopySuccess() {
    const copyButton = document.querySelector('button[onclick="copyRawServerInfo()"]');
    if (copyButton) {
        const originalHTML = copyButton.innerHTML;
        copyButton.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
        copyButton.classList.add('btn-success');
        copyButton.classList.remove('btn-secondary');
        
        setTimeout(() => {
            copyButton.innerHTML = originalHTML;
            copyButton.classList.remove('btn-success');
            copyButton.classList.add('btn-secondary');
        }, 2000);
    }
}

function showServerInfoCopyError() {
    const copyButton = document.querySelector('button[onclick="copyRawServerInfo()"]');
    if (copyButton) {
        const originalHTML = copyButton.innerHTML;
        copyButton.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i> Copy Failed';
        copyButton.classList.add('btn-error');
        copyButton.classList.remove('btn-secondary');
        
        setTimeout(() => {
            copyButton.innerHTML = originalHTML;
            copyButton.classList.remove('btn-error');
            copyButton.classList.add('btn-secondary');
        }, 2000);
        
        // Also show the text in a prompt as a last resort
        const contentElement = document.getElementById('rawServerInfoContent').querySelector('code');
        if (contentElement && contentElement.textContent) {
            prompt('Copy failed. Please manually copy this text:', contentElement.textContent);
        }
    }
}

</script>
