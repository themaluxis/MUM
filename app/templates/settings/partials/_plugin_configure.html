<!-- File: app/templates/settings/partials/_plugin_configure.html -->
<div class="mb-6">
    <a href="{{ url_for('dashboard.settings_plugins') }}" class="btn btn-ghost">
        <i class="fas fa-arrow-left mr-2"></i>
        Back to Plugins
    </a>
</div>

<div class="card bg-base-100 shadow-xl">
    <div class="card-body">
        <div class="flex items-center mb-4">
            <h2 class="card-title text-2xl">{{ title }}</h2>
            {% if plugin.is_enabled %}
                <span class="badge badge-success ml-4">Enabled</span>
            {% else %}
                <span class="badge badge-ghost ml-4">Disabled</span>
            {% endif %}
        </div>
        <p>{{ plugin.description }}</p>

        <div class="divider"></div>

        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Configured Servers</h3>
            <div class="flex gap-2">
                {% if servers_with_details|length > 0 and not plugin.is_enabled %}
                <form method="POST" action="{{ url_for('plugins.enable_plugin', plugin_id=plugin.plugin_id) }}" class="inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-power-off mr-2"></i>Enable Plugin
                    </button>
                </form>
                {% endif %}
                <a href="{{ url_for('media_servers.add_server', service_type=plugin.plugin_id) }}" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>
                    Add Server
                </a>
            </div>
        </div>

        {% if servers_with_details %}
        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {% for details in servers_with_details %}
            {% set server = details.server %}
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title">{{ server.name }}</h2>
                        <div class="badge badge-{{ 'success' if server.is_active else 'error' }}">
                            {{ 'Active' if server.is_active else 'Inactive' }}
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <i class="fas fa-server mr-2 text-gray-500"></i>
                            <span class="text-sm">{{ server.service_type.value.title() }}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-link mr-2 text-gray-500"></i>
                            <span class="text-sm truncate">{{ server.url }}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-clock mr-2 text-gray-500"></i>
                            <span class="text-sm">
                                {% if server.last_sync_at %}
                                    Last sync: {{ server.last_sync_at|format_datetime_user(False) }}
                                {% else %}
                                    Never synced
                                {% endif %}
                            </span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-users mr-2 text-gray-500"></i>
                            <span class="text-sm">
                                {{ details.member_count }} members
                            </span>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-list-ul mr-2 text-gray-500 mt-1"></i>
                            <div class="text-sm">
                                {% if details.libraries %}
                                    <div id="libraries-{{ server.id }}" class="flex flex-wrap gap-1">
                                        {% for lib in details.libraries[:5] %}
                                            <span class="badge badge-outline">{{ lib }}</span>
                                        {% endfor %}
                                        {% if details.libraries|length > 5 %}
                                            <button id="more-libs-{{ server.id }}" onclick='showMoreLibraries({{ server.id }}, {{ details.libraries|tojson|safe }})' class="btn btn-info btn-xs">+{{ details.libraries|length - 5 }} more</button>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    No libraries found.
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {% if details.error %}
                    <div class="alert alert-warning mt-4">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>{{ details.error }}</span>
                    </div>
                    {% endif %}

                    <div class="card-actions justify-end mt-4">
                        {% if server.is_active %}
                        <form method="POST" action="{{ url_for('media_servers.disable_server', server_id=server.id) }}" class="inline mr-2">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-warning btn-sm">
                                <i class="fas fa-pause mr-1"></i>Disable
                            </button>
                        </form>
                        {% else %}
                        <form method="POST" action="{{ url_for('media_servers.enable_server', server_id=server.id) }}" class="inline mr-2">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-success btn-sm">
                                <i class="fas fa-play mr-1"></i>Enable
                            </button>
                        </form>
                        {% endif %}
                        
                        <!-- Edit Button -->
                        <a href="{{ url_for('dashboard.settings_plugin_edit_server', plugin_id=plugin.plugin_id, server_id=server.id) }}" 
                           class="btn btn-ghost btn-sm" title="Edit Server">
                            <i class="fas fa-edit"></i>
                        </a>
                        
                        <!-- Delete Button -->
                        <button onclick="deleteServer({{ server.id }}, '{{ server.name }}')" 
                                class="btn btn-ghost btn-sm text-error hover:bg-error/10" title="Delete Server">
                            <i class="fas fa-trash"></i>
                        </button>
                        
                        <!-- Actions Dropdown (for remaining actions) -->
                        <div class="dropdown dropdown-end">
                            <label tabindex="0" class="btn btn-ghost btn-sm" title="More Actions">
                                <i class="fas fa-ellipsis-v"></i>
                            </label>
                            <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                                <li>
                                    <button onclick="testConnection({{ server.id }})" class="text-blue-600">
                                        <i class="fas fa-plug mr-2"></i>Test Connection
                                    </button>
                                </li>
                                <li>
                                    <button onclick="syncLibraries({{ server.id }})" class="text-green-600">
                                        <i class="fas fa-sync mr-2"></i>Sync Libraries
                                    </button>
                                </li>
                                <li>
                                    <button onclick="syncUsers({{ server.id }})" class="text-purple-600">
                                        <i class="fas fa-users mr-2"></i>Sync Users
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <span>No servers have been configured for this service yet.</span>
        </div>
        {% endif %}
    </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Delete Server</h3>
        <p class="py-4">Are you sure you want to delete the server "<span id="serverName"></span>"?</p>
        <div class="modal-action">
            <form id="deleteForm" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="return_to" value="plugin_config"/>
                <input type="hidden" name="plugin_id" value="{{ plugin.plugin_id }}"/>
                <button type="submit" class="btn btn-error">Delete</button>
                <button type="button" class="btn" onclick="closeDeleteModal()">Cancel</button>
            </form>
        </div>
    </div>
</div>

<script>
function showMoreLibraries(serverId, libraries) {
    const container = document.getElementById(`libraries-${serverId}`);
    const button = document.getElementById(`more-libs-${serverId}`);
    container.innerHTML = ''; // Clear existing badges
    libraries.forEach(lib => {
        const badge = document.createElement('span');
        badge.className = 'badge badge-outline';
        badge.textContent = lib;
        container.appendChild(badge);
    });
    button.style.display = 'none';
}

function testConnection(serverId) {
    fetch(`/admin/api/servers/${serverId}/test`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Connection test successful!', 'success');
            } else {
                showToast(`Connection test failed: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            showToast('Error testing connection', 'error');
        });
}

function syncLibraries(serverId) {
    fetch(`/admin/api/servers/${serverId}/sync/libraries`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(`Sync failed: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            showToast('Error syncing libraries', 'error');
        });
}

function syncUsers(serverId) {
    fetch(`/admin/api/servers/${serverId}/sync/users`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(`Sync failed: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            showToast('Error syncing users', 'error');
        });
}

function deleteServer(serverId, serverName) {
    document.getElementById('serverName').textContent = serverName;
    document.getElementById('deleteForm').action = `/admin/servers/${serverId}/delete`;
    document.getElementById('deleteModal').classList.add('modal-open');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('modal-open');
}

function showToast(message, type) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} fixed top-4 right-4 w-auto z-50`;
    toast.innerHTML = `
        <div>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}
</script>
