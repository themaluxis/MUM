<!-- File: app/templates/settings/partials/_plugin_edit_server.html -->

<!-- Navigation -->
<div class="flex items-center mb-8">
    <a href="{{ url_for('plugin_management.configure', plugin_id=plugin.plugin_id) }}" class="btn btn-ghost btn-sm">
        <i class="fa-solid fa-arrow-left mr-2"></i> Back to {{ plugin.name }}
    </a>
</div>

<!-- Clean Header -->
<div class="mb-8">
    <div class="flex items-center gap-4 mb-4">
        <div class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0">
            <i class="fa-solid fa-server text-primary text-xl"></i>
        </div>
        <div>
            <h1 class="text-2xl font-bold text-base-content mb-1">Edit Server</h1>
            <p class="text-base-content/70 text-sm">Configure settings for <strong>{{ server.server_nickname }}</strong></p>
        </div>
    </div>
</div>

<!-- Description Card -->
<div class="bg-info/10 border border-info/20 rounded-lg p-4 mb-6">
    <div class="flex items-start gap-3">
        <div class="w-6 h-6 rounded-full bg-info/20 flex items-center justify-center flex-shrink-0 mt-0.5">
            <i class="fa-solid fa-info text-info text-xs"></i>
        </div>
        <div>
            <h4 class="font-medium text-info mb-1">Server Configuration</h4>
            <p class="text-sm text-base-content/80">
                Update connection details and settings for this {{ plugin.name }} server. Changes will be applied immediately.
            </p>
        </div>
    </div>
</div>

<form method="POST" 
      hx-post="{{ url_for('plugin_management.edit_server', plugin_id=plugin.plugin_id, server_id=server.id) }}"
      hx-trigger="submit"
      hx-swap="none"
      hx-on::after-request="if(event.detail.xhr.status === 200) { window.location.href = '{{ url_for('plugin_management.configure', plugin_id=plugin.plugin_id) }}'; }">
    {{ form.hidden_tag() }}

    <!-- Basic Settings Section -->
    <div class="space-y-4 mb-6">
        <h4 class="font-medium text-base-content text-lg mb-3">
            <i class="fa-solid fa-cog text-primary text-sm mr-2"></i>
            Basic Settings
        </h4>
        
        <!-- Server Name -->
        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-tag text-primary text-sm"></i>
                    <h5 class="font-medium text-base-content">{{ form.name.label.text }}</h5>
                    <span class="inline-flex items-center rounded-full bg-red-50 dark:bg-red-400/10 px-2 py-1 text-xs font-medium text-red-700 dark:text-red-400 ring-1 ring-inset ring-red-600/20 dark:ring-red-500/20">Required</span>
                </div>
            </div>
            {{ form.name(class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100 " + ("input-error" if form.name.errors else "")) }}
            {% if form.name.errors %}
                <span class="text-error text-xs mt-1 block">{{ form.name.errors[0] }}</span>
            {% else %}
                <span class="text-base-content/60 text-xs mt-1 block">A friendly name for this server</span>
            {% endif %}
        </div>

        <!-- Server URL -->
        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-link text-secondary text-sm"></i>
                    <h5 class="font-medium text-base-content">{{ form.url.label.text }}</h5>
                    <span class="inline-flex items-center rounded-full bg-red-50 dark:bg-red-400/10 px-2 py-1 text-xs font-medium text-red-700 dark:text-red-400 ring-1 ring-inset ring-red-600/20 dark:ring-red-500/20">Required</span>
                </div>
            </div>
            {{ form.url(class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100 " + ("input-error" if form.url.errors else "")) }}
            {% if form.url.errors %}
                <span class="text-error text-xs mt-1 block">{{ form.url.errors[0] }}</span>
            {% else %}
                <span class="text-base-content/60 text-xs mt-1 block">Full URL including protocol (http:// or https://)</span>
            {% endif %}
        </div>
    </div>

    <!-- Authentication Section -->
    <div class="space-y-4 mb-6">
        <h4 class="font-medium text-base-content text-lg mb-3">
            <i class="fa-solid fa-key text-warning text-sm mr-2"></i>
            Authentication
        </h4>
        
        {% if form.api_key %}
        <!-- API Key -->
        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-shield-halved text-warning text-sm"></i>
                    <h5 class="font-medium text-base-content">{{ form.api_key.label.text }}</h5>
                    <span class="inline-flex items-center rounded-full bg-yellow-50 dark:bg-yellow-400/10 px-2 py-1 text-xs font-medium text-yellow-700 dark:text-yellow-400 ring-1 ring-inset ring-yellow-600/20 dark:ring-yellow-500/20">Optional</span>
                </div>
            </div>
            {{ form.api_key(class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100 " + ("input-error" if form.api_key.errors else ""), placeholder="Leave blank to keep current") }}
            {% if form.api_key.errors %}
                <span class="text-error text-xs mt-1 block">{{ form.api_key.errors[0] }}</span>
            {% else %}
                <span class="text-base-content/60 text-xs mt-1 block">Leave blank to keep current API key</span>
            {% endif %}
        </div>
        {% endif %}

        {% if form.username %}
        <!-- Username -->
        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-user text-accent text-sm"></i>
                    <h5 class="font-medium text-base-content">{{ form.username.label.text }}</h5>
                    <span class="inline-flex items-center rounded-full bg-yellow-50 dark:bg-yellow-400/10 px-2 py-1 text-xs font-medium text-yellow-700 dark:text-yellow-400 ring-1 ring-inset ring-yellow-600/20 dark:ring-yellow-500/20">Optional</span>
                </div>
            </div>
            {{ form.username(class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100 " + ("input-error" if form.username.errors else "")) }}
            {% if form.username.errors %}
                <span class="text-error text-xs mt-1 block">{{ form.username.errors[0] }}</span>
            {% else %}
                <span class="text-base-content/60 text-xs mt-1 block">Username for server authentication</span>
            {% endif %}
        </div>
        {% endif %}

        {% if form.password %}
        <!-- Password -->
        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-lock text-accent text-sm"></i>
                    <h5 class="font-medium text-base-content">{{ form.password.label.text }}</h5>
                    <span class="inline-flex items-center rounded-full bg-yellow-50 dark:bg-yellow-400/10 px-2 py-1 text-xs font-medium text-yellow-700 dark:text-yellow-400 ring-1 ring-inset ring-yellow-600/20 dark:ring-yellow-500/20">Optional</span>
                </div>
            </div>
            {{ form.password(class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100 " + ("input-error" if form.password.errors else ""), placeholder="Leave blank to keep current") }}
            {% if form.password.errors %}
                <span class="text-error text-xs mt-1 block">{{ form.password.errors[0] }}</span>
            {% else %}
                <span class="text-base-content/60 text-xs mt-1 block">Leave blank to keep current password</span>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Public URL Section (for non-Plex services) -->
    {% if plugin.plugin_id != 'plex' %}
    <div class="space-y-4 mb-6">
        <h4 class="font-medium text-base-content text-lg mb-3">
            <i class="fa-solid fa-globe text-info text-sm mr-2"></i>
            Public Access
        </h4>
        
        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-external-link text-info text-sm"></i>
                    <h5 class="font-medium text-base-content">{{ form.public_url.label.text }}</h5>
                    <span class="inline-flex items-center rounded-full bg-blue-50 dark:bg-blue-400/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-400 ring-1 ring-inset ring-blue-600/20 dark:ring-blue-500/20">Optional</span>
                </div>
            </div>
            {{ form.public_url(class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100 " + ("input-error" if form.public_url.errors else "")) }}
            {% if form.public_url.errors %}
                <span class="text-error text-xs mt-1 block">{{ form.public_url.errors[0] }}</span>
            {% else %}
                <span class="text-base-content/60 text-xs mt-1 block">{{ form.public_url.description }}</span>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Server Status Section -->
    <div class="space-y-4 mb-6">
        <h4 class="font-medium text-base-content text-lg mb-3">
            <i class="fa-solid fa-toggle-on text-success text-sm mr-2"></i>
            Server Status
        </h4>
        
        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-power-off text-success text-sm"></i>
                    <div>
                        <h5 class="font-medium text-base-content">{{ form.is_active.label.text }}</h5>
                        <span class="text-base-content/60 text-xs">Enable or disable this server</span>
                    </div>
                </div>
                {{ form.is_active(class="toggle toggle-success") }}
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex items-center justify-end gap-3 pt-6 border-t border-base-300">
        <a href="{{ url_for('plugin_management.configure', plugin_id=plugin.plugin_id) }}" class="btn btn-ghost h-12">
            <i class="fa-solid fa-times mr-2"></i>
            Cancel
        </a>
        <button type="button" onclick="testConnection()" class="btn btn-outline h-12">
            <i class="fa-solid fa-wifi mr-2"></i>
            Test Connection
        </button>
        {{ form.submit(class="btn btn-primary h-12 gap-2") }}
    </div>
</form>

<script>
function testConnection() {
    const form = document.querySelector('form');
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    // Collect form data
    const requestData = {
        service_type: '{{ plugin.plugin_id }}',
        url: document.querySelector('input[name="url"]').value,
        api_key: document.querySelector('input[name="api_key"]').value
    };
    
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';
    btn.disabled = true;
    
    // Test the current server using the plugin management endpoint
    fetch("{{ url_for('plugin_management.test_existing_server_connection', plugin_id=plugin.plugin_id, server_id=server.id) }}", {
        method: 'POST',
        body: JSON.stringify(requestData),
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Connection successful: ' + data.message, 'success');
        } else {
            showToast('Connection failed: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showToast('Error testing connection: ' + error.message, 'error');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

</script>