{# File: app/templates/settings/partials/_plugin_add_server.html #}

<!-- Navigation -->
<div class="flex items-center mb-8">
    <a href="{{ url_for('plugin_management.configure', plugin_id=plugin.plugin_id) }}" class="btn btn-ghost btn-sm">
        <i class="fa-solid fa-arrow-left mr-2"></i> Back to {{ plugin.name }}
    </a>
</div>

<!-- Clean Header -->
<div class="mb-8">
    <div class="flex items-center gap-4 mb-4">
        <div class="w-12 h-12 rounded-full bg-success/20 flex items-center justify-center flex-shrink-0">
            <i class="fa-solid fa-plus text-success text-xl"></i>
        </div>
        <div>
            <h1 class="text-2xl font-bold text-base-content mb-1">Add New Server</h1>
            <p class="text-base-content/70 text-sm">Configure a new {{ plugin.name }} server for media management</p>
        </div>
    </div>
</div>

<!-- Description Card -->
<div class="bg-info/10 border border-info/20 rounded-lg p-4 mb-6">
    <div class="flex items-start gap-3">
        <div class="w-6 h-6 rounded-full bg-info/20 flex items-center justify-center flex-shrink-0 mt-0.5">
            <i class="fa-solid fa-info text-info text-xs"></i>
        </div>
        <div>
            <h4 class="font-medium text-info mb-1">Server Setup</h4>
            <p class="text-sm text-base-content/80">
                Enter your {{ plugin.name }} server connection details. Test the connection before adding to ensure proper configuration.
            </p>
        </div>
    </div>
</div>

<form method="POST" action="{{ url_for('plugin_management.add_server', plugin_id=plugin.plugin_id) }}">
    {{ form.hidden_tag() }}

    <!-- Basic Settings Section -->
    <div class="space-y-4 mb-6">
        <h4 class="font-medium text-base-content text-lg mb-3">
            <i class="fa-solid fa-cog text-primary text-sm mr-2"></i>
            Basic Settings
        </h4>
        
        <!-- Server Name -->
        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-tag text-primary text-sm"></i>
                    <h5 class="font-medium text-base-content">{{ form.name.label.text }}</h5>
                    <span class="inline-flex items-center rounded-full bg-red-50 dark:bg-red-400/10 px-2 py-1 text-xs font-medium text-red-700 dark:text-red-400 ring-1 ring-inset ring-red-600/20 dark:ring-red-500/20">Required</span>
                </div>
            </div>
            {{ form.name(class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100 " + ("input-error" if form.name.errors else "")) }}
            {% if form.name.errors %}
                <span class="text-error text-xs mt-1 block">{{ form.name.errors[0] }}</span>
            {% else %}
                <span class="text-base-content/60 text-xs mt-1 block">A friendly name for this server</span>
            {% endif %}
        </div>

        <!-- Server URL -->
        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-link text-secondary text-sm"></i>
                    <h5 class="font-medium text-base-content">{{ form.url.label.text }}</h5>
                    <span class="inline-flex items-center rounded-full bg-red-50 dark:bg-red-400/10 px-2 py-1 text-xs font-medium text-red-700 dark:text-red-400 ring-1 ring-inset ring-red-600/20 dark:ring-red-500/20">Required</span>
                </div>
            </div>
            {{ form.url(class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100 " + ("input-error" if form.url.errors else ""), placeholder="https://your-server.com:32400") }}
            {% if form.url.errors %}
                <span class="text-error text-xs mt-1 block">{{ form.url.errors[0] }}</span>
            {% else %}
                <span class="text-base-content/60 text-xs mt-1 block">Full URL including protocol (http:// or https://)</span>
            {% endif %}
        </div>
    </div>

    <!-- Authentication Section -->
    <div class="space-y-4 mb-6">
        <h4 class="font-medium text-base-content text-lg mb-3">
            <i class="fa-solid fa-key text-warning text-sm mr-2"></i>
            Authentication
        </h4>
        
        {% if plugin.plugin_id in ['komga', 'romm'] %}
        <!-- Username -->
        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-user text-warning text-sm"></i>
                    <h5 class="font-medium text-base-content">{{ form.username.label.text }}</h5>
                    <span class="inline-flex items-center rounded-full bg-red-50 dark:bg-red-400/10 px-2 py-1 text-xs font-medium text-red-700 dark:text-red-400 ring-1 ring-inset ring-red-600/20 dark:ring-red-500/20">Required</span>
                </div>
            </div>
            {{ form.username(class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100 " + ("input-error" if form.username.errors else "")) }}
            {% if form.username.errors %}
                <span class="text-error text-xs mt-1 block">{{ form.username.errors[0] }}</span>
            {% else %}
                <span class="text-base-content/60 text-xs mt-1 block">Username for {{ plugin.name }} authentication</span>
            {% endif %}
        </div>

        <!-- Password -->
        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-lock text-warning text-sm"></i>
                    <h5 class="font-medium text-base-content">{{ form.password.label.text }}</h5>
                    <span class="inline-flex items-center rounded-full bg-red-50 dark:bg-red-400/10 px-2 py-1 text-xs font-medium text-red-700 dark:text-red-400 ring-1 ring-inset ring-red-600/20 dark:ring-red-500/20">Required</span>
                </div>
            </div>
            {{ form.password(class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100 " + ("input-error" if form.password.errors else "")) }}
            {% if form.password.errors %}
                <span class="text-error text-xs mt-1 block">{{ form.password.errors[0] }}</span>
            {% else %}
                <span class="text-base-content/60 text-xs mt-1 block">Password for {{ plugin.name }} authentication</span>
            {% endif %}
        </div>
        {% else %}
        <!-- API Key -->
        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300 hover:border-base-300/60 transition-colors">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-shield-halved text-warning text-sm"></i>
                    <h5 class="font-medium text-base-content">{{ form.api_key.label.text }}</h5>
                    {% if plugin.plugin_id in ['jellyfin', 'emby', 'kavita', 'audiobookshelf'] %}
                        <span class="inline-flex items-center rounded-full bg-red-50 dark:bg-red-400/10 px-2 py-1 text-xs font-medium text-red-700 dark:text-red-400 ring-1 ring-inset ring-red-600/20 dark:ring-red-500/20">Required</span>
                    {% else %}
                        <span class="inline-flex items-center rounded-full bg-yellow-50 dark:bg-yellow-400/10 px-2 py-1 text-xs font-medium text-yellow-700 dark:text-yellow-400 ring-1 ring-inset ring-yellow-600/20 dark:ring-yellow-500/20">Optional</span>
                    {% endif %}
                </div>
            </div>
            {{ form.api_key(class="input input-bordered w-full h-11 bg-base-100 border-base-300 focus:border-primary focus:bg-base-100 " + ("input-error" if form.api_key.errors else "")) }}
            {% if form.api_key.errors %}
                <span class="text-error text-xs mt-1 block">{{ form.api_key.errors[0] }}</span>
            {% else %}
                {% if plugin.plugin_id in ['jellyfin', 'emby', 'kavita', 'audiobookshelf'] %}
                    <span class="text-base-content/60 text-xs mt-1 block">API key required for {{ plugin.name }} authentication</span>
                {% else %}
                    <span class="text-base-content/60 text-xs mt-1 block">API key for server authentication (optional for some services)</span>
                {% endif %}
            {% endif %}
        </div>
        {% endif %}

    </div>

    <!-- Server Status Section -->
    <div class="space-y-4 mb-6">
        <h4 class="font-medium text-base-content text-lg mb-3">
            <i class="fa-solid fa-toggle-on text-success text-sm mr-2"></i>
            Server Status
        </h4>
        
        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-power-off text-success text-sm"></i>
                    <div>
                        <h5 class="font-medium text-base-content">{{ form.is_active.label.text }}</h5>
                        <span class="text-base-content/60 text-xs">Enable this server after adding</span>
                    </div>
                </div>
                {{ form.is_active(class="toggle toggle-success", checked=true) }}
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex items-center justify-end gap-3 pt-6 border-t border-base-300">
        <a href="{{ url_for('plugin_management.configure', plugin_id=plugin.plugin_id) }}" class="btn btn-ghost h-12">
            <i class="fa-solid fa-times mr-2"></i>
            Cancel
        </a>
        <button type="button" id="test-connection-btn" class="btn btn-outline h-12">
            <i class="fa-solid fa-wifi mr-2"></i>
            Test Connection
        </button>
        <button type="submit" id="add-server-btn" class="btn btn-primary h-12 gap-2" disabled>
            <i class="fa-solid fa-plus"></i>
            Add Server
        </button>
    </div>
</form>

<script>
let connectionTested = false;

function testConnection() {
    const testBtn = document.getElementById('test-connection-btn');
    const addBtn = document.getElementById('add-server-btn');
    const originalText = testBtn.innerHTML;
    
    // Get form data as JSON
    const formData = {
        name: document.querySelector('input[name="name"]').value,
        url: document.querySelector('input[name="url"]').value,
        service_type: '{{ plugin.plugin_id }}'
    };
    
    // Add authentication fields based on plugin type
    {% if plugin.plugin_id in ['komga', 'romm'] %}
    formData.username = document.querySelector('input[name="username"]').value;
    formData.password = document.querySelector('input[name="password"]').value;
    {% else %}
    formData.api_key = document.querySelector('input[name="api_key"]').value;
    {% endif %}
    
    
    // Update button state
    testBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Testing...';
    testBtn.disabled = true;
    
    fetch("{{ url_for('plugin_management.test_connection', plugin_id=plugin.plugin_id) }}", {
        method: 'POST',
        body: JSON.stringify(formData),
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            testBtn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>Connection Successful';
            testBtn.className = 'btn btn-success';
            addBtn.disabled = false;
            connectionTested = true;
            showToast('Connection test successful!', 'success');
        } else {
            testBtn.innerHTML = '<i class="fa-solid fa-times mr-2"></i>Connection Failed';
            testBtn.className = 'btn btn-error';
            addBtn.disabled = true;
            connectionTested = false;
            showToast('Connection test failed: ' + data.message, 'error');
        }
    })
    .catch(error => {
        testBtn.innerHTML = '<i class="fa-solid fa-times mr-2"></i>Test Failed';
        testBtn.className = 'btn btn-error';
        addBtn.disabled = true;
        connectionTested = false;
        showToast('Error testing connection: ' + error.message, 'error');
    })
    .finally(() => {
        testBtn.disabled = false;
        
        // Reset button after 3 seconds if successful
        if (connectionTested) {
            setTimeout(() => {
                testBtn.innerHTML = originalText;
                testBtn.className = 'btn btn-outline';
            }, 3000);
        }
    });
}

// Prevent form submission if connection not tested
document.querySelector('form').addEventListener('submit', function(e) {
    if (!connectionTested) {
        e.preventDefault();
        showToast('Please test the connection successfully before adding the server.', 'error');
        return false;
    }
});

// Reset connection test status when form fields change
{% if plugin.plugin_id in ['komga', 'romm'] %}
document.querySelectorAll('input[name="url"], input[name="username"], input[name="password"]').forEach(input => {
{% else %}
document.querySelectorAll('input[name="url"], input[name="api_key"]').forEach(input => {
{% endif %}
    input.addEventListener('input', function() {
        if (connectionTested) {
            connectionTested = false;
            const testBtn = document.getElementById('test-connection-btn');
            const addBtn = document.getElementById('add-server-btn');
            testBtn.innerHTML = '<i class="fa-solid fa-plug mr-2"></i>Test Connection';
            testBtn.className = 'btn btn-outline';
            addBtn.disabled = true;
        }
    });
});

// Add event listener to test button
document.getElementById('test-connection-btn').addEventListener('click', testConnection);
</script>