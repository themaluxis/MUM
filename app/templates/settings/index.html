<!-- File: app/templates/settings/index.html -->
{% extends "base.html" %}

{% block title %}{{ super() }} - {{ title or "Application Settings" }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-2">
    <h1 class="text-3xl font-bold mb-8">{{ title or "Application Settings" }}</h1>

    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-8">
        
        {# --- COLUMN 1: Desktop Sidebar Navigation --- #}
        <div class="hidden md:block md:col-span-1">
            <ul class="menu bg-base-200 rounded-box p-2 space-y-1 sticky top-24 w-full shadow-xl">
                <li>
                    <h2 class="menu-title"><span><i class="fa-solid fa-cog fa-fw mr-2"></i> Settings</span></h2>
                    <ul>
                        {% if current_user.__class__.__name__ == 'Owner' or current_user.has_permission('manage_general_settings') %}
                        <li><a href="{{ url_for('settings.general') }}" class="{{ 'active menu-active' if active_tab == 'general' else '' }}"><i class="fa-solid fa-sliders mr-2"></i> General</a></li>
                        <li><a href="{{ url_for('settings.user_accounts') }}" class="{{ 'active menu-active' if active_tab == 'user_accounts' else '' }}"><i class="fa-solid fa-user-plus mr-2"></i> User Accounts</a></li>
                        {% endif %}
                        {% if current_user.__class__.__name__ == 'Owner' or current_user.has_permission('view_admins_tab') %}
                        <h2 class="menu-title"><span><i class="fa-solid fa-user-shield fa-fw mr-2"></i> Manage Admins</span></h2>
                        <ul>
                            {% if current_user.__class__.__name__ == 'Owner' or current_user.has_permission('create_admin') or current_user.has_permission('edit_admin') or current_user.has_permission('delete_admin') %}
                                <li><a href="{{ url_for('admin_management.index') }}" class="{{ 'active menu-active' if active_tab in ['admins', 'admins_edit'] else '' }}"><i class="fa-solid fa-shield-halved mr-2"></i> Admins</a></li>
                            {% endif %}
                            {% if current_user.__class__.__name__ == 'Owner' or current_user.has_permission('create_role') or current_user.has_permission('edit_role') or current_user.has_permission('delete_role') %}
                                <li><a href="{{ url_for('role_management.index') }}" class="{{ 'active menu-active' if active_tab in ['roles', 'roles_edit'] else '' }}"><i class="fa-solid fa-shield mr-2"></i> Roles</a></li>
                            {% endif %}
                        </ul>
                        {% endif %}
                        {% if current_user.__class__.__name__ == 'Owner' or current_user.has_permission('manage_discord_settings') %}
                        <li><a href="{{ url_for('settings.discord') }}" class="{{ 'active menu-active' if active_tab == 'discord' else '' }}"><i class="fa-brands fa-discord mr-2"></i> Discord</a></li>
                        {% endif %}
                        {% if current_user.__class__.__name__ == 'Owner' or current_user.has_permission('manage_plugins') %}
                        <li><a href="{{ url_for('plugin_management.index') }}" class="{{ 'active menu-active' if active_tab == 'plugins' else '' }}"><i class="fa-solid fa-puzzle-piece mr-2"></i> Plugins</a></li>
                        {% endif %}
                        {% if current_user.__class__.__name__ == 'Owner' or current_user.has_permission('view_logs') %}
                        <li><a href="{{ url_for('settings.logs') }}" class="{{ 'active menu-active' if active_tab == 'logs' else '' }}"><i class="fa-solid fa-timeline mr-2"></i> Logs</a></li>
                        {% endif %}
                        {% if current_user.__class__.__name__ == 'Owner' or current_user.has_permission('manage_advanced_settings') %}
                        <li><a href="{{ url_for('settings.advanced') }}" class="{{ 'active menu-active' if active_tab == 'advanced' else '' }}"><i class="fa-solid fa-cogs mr-2"></i> Advanced</a></li>
                        <li><a href="{{ url_for('settings.api_debug') }}" class="{{ 'active menu-active' if active_tab == 'api_debug' else '' }}"><i class="fa-solid fa-code mr-2"></i> API Debug</a></li>
                        {% endif %}
                    </ul>
                </li>
            </ul>
        </div>
        
        {# --- COLUMN 2: Main Content Area --- #}
        <div class="md:col-span-2 lg:col-span-3">
            
            {# --- Mobile Navigation Dropdown --- #}
            <div class="form-control md:hidden mb-6">
                <label class="label"><span class="label-text">Go to setting:</span></label>
                <select class="select select-bordered" onchange="if (this.value) window.location.href=this.value;">
                    {% if current_user.__class__.__name__ == 'Owner' or current_user.has_permission('manage_general_settings') %}
                    <option value="{{ url_for('settings.general') }}" {% if active_tab == 'general' %}selected{% endif %}>General</option>
                    <option value="{{ url_for('settings.user_accounts') }}" {% if active_tab == 'user_accounts' %}selected{% endif %}>User Accounts</option>
                    {% endif %}
                    {% if current_user.__class__.__name__ == 'Owner' or current_user.has_permission('create_admin') or current_user.has_permission('edit_admin') or current_user.has_permission('delete_admin') %}
                    <option value="{{ url_for('admin_management.index') }}" {% if active_tab == 'admins' %}selected{% endif %}>Manage Admins</option>
                    {% endif %}
                    {% if current_user.__class__.__name__ == 'Owner' or current_user.has_permission('create_role') or current_user.has_permission('edit_role') or current_user.has_permission('delete_role') %}
                    <option value="{{ url_for('role_management.index') }}" {% if active_tab == 'roles' %}selected{% endif %}>Manage Roles</option>
                    {% endif %}
                    {% if current_user.__class__.__name__ == 'Owner' or current_user.has_permission('manage_discord_settings') %}
                    <option value="{{ url_for('settings.discord') }}" {% if active_tab == 'discord' %}selected{% endif %}>Discord</option>
                    {% endif %}
                    {% if current_user.__class__.__name__ == 'Owner' or current_user.has_permission('manage_plugins') %}
                    <option value="{{ url_for('plugin_management.index') }}" {% if active_tab == 'plugins' %}selected{% endif %}>Plugins</option>
                    {% endif %}
                    {% if current_user.__class__.__name__ == 'Owner' or current_user.has_permission('view_logs') %}
                    <option value="{{ url_for('settings.logs') }}" {% if active_tab == 'logs' %}selected{% endif %}>Logs</option>
                    {% endif %}
                    {% if current_user.__class__.__name__ == 'Owner' or current_user.has_permission('manage_advanced_settings') %}
                    <option value="{{ url_for('settings.advanced') }}" {% if active_tab == 'advanced' %}selected{% endif %}>Advanced</option>
                    <option value="{{ url_for('settings.api_debug') }}" {% if active_tab == 'api_debug' %}selected{% endif %}>API Debug</option>
                    {% endif %}
                </select>
            </div>
            
            <div class="bg-base-200 shadow-xl rounded-lg p-6 sm:p-8">
            {% block settings_content %}
                {#
                This block acts as the content switcher for the settings area.
                The appropriate route passes the 'active_tab' variable,
                and this block includes the corresponding partial template.
                #}
                {% if active_tab == 'account' %}
                    {% include 'account/index.html' %}
                    
                {% elif active_tab == 'general' %}
                    {% include 'settings/general/index.html' %}
                    
                {% elif active_tab == 'user_accounts' %}
                    {% include 'settings/user_accounts/index.html' %}
                    
                {% elif active_tab == 'discord' %}
                    {% include 'settings/discord/index.html' %}

                {% elif active_tab == 'plugins' %}
                    {% include 'settings/plugins/index.html' %}
                {% elif active_tab == 'plugin_install' %}
                    {% include 'settings/plugins/_partials/plugin_install.html' %}
                {% elif active_tab == 'plugin_configure' %}
                    {% include 'settings/plugins/_partials/plugin_configure.html' %}
                {% elif active_tab == 'plugin_edit_server' %}
                    {% include 'settings/plugins/_partials/plugin_edit_server.html' %}
                {% elif active_tab == 'plugin_add_server' %}
                    {% include 'settings/plugins/_partials/plugin_add_server.html' %}
                {% elif active_tab == 'advanced' %}
                    {% include 'settings/advanced/index.html' %}
                {% elif active_tab == 'api_debug' %}
                    {% include 'settings/api_debug/index.html' %}
                {% elif active_tab == 'admins' %}
                    {% include 'settings/admins/index.html' %}
                {% elif active_tab == 'admins_edit' %}
                    {% include 'settings/admins/edit.html' %}
                {% elif active_tab == 'roles' %}
                    {% include 'settings/roles/index.html' %}
                {% elif active_tab == 'roles_edit' %}
                    {% include 'settings/roles/edit.html' %}
                {% elif active_tab == 'logs' %}
                    {% include 'settings/logs/index.html' %}
                {% else %}
                    <div class="text-center p-8">
                        <i class="fa-solid fa-arrow-left fa-2x text-base-content/30 mb-4"></i>
                        <p class="text-lg">Please select a category from the sidebar to begin.</p>
                    </div>
                {% endif %}
            {% endblock settings_content %}
            </div>
        </div>
    </div>
</div>

<dialog id="create_admin_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-3xl bg-base-100 border border-base-300 shadow-2xl p-0">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-base-300">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-success/20 flex items-center justify-center">
                    <i class="fa-solid fa-user-plus text-success text-lg"></i>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-base-content">Create New Admin</h3>
                    <p class="text-sm text-base-content/60">Add a new administrator account to the system</p>
                </div>
            </div>
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost hover:bg-base-200">
                    <i class="fa-solid fa-times"></i>
                </button>
            </form>
        </div>

        <!-- Content -->
        <div class="p-6">
            <div id="create_admin_modal_content_div">
                <!-- HTMX will load form content here -->
                <div class="text-center p-8"><span class="loading loading-lg loading-spinner"></span></div>
            </div>
        </div>
    </div>
</dialog>
{% endblock %}

{% block extra_head %}
<script>
// Debug: Check what data we have
console.log('Template debug - active_tab:', '{{ active_tab }}');
console.log('Template debug - enabled_plugins defined:', {{ 'true' if enabled_plugins is defined else 'false' }});
{% if enabled_plugins is defined %}
console.log('Template debug - enabled_plugins value:', {{ enabled_plugins | tojson }});
{% endif %}

// Make enabled_plugins data available to JavaScript
{% if active_tab == 'plugins' and enabled_plugins is defined %}
window.enabled_plugins = {{ enabled_plugins | tojson }};
console.log('Enabled plugins from backend:', window.enabled_plugins);
{% else %}
// Fallback: try to detect from the page content
window.enabled_plugins = [];
console.log('No enabled_plugins data from backend, using fallback');
{% endif %}
</script>
{% endblock %}

{% block modals %}
    {{ super() }}
    {% if active_tab == 'logs' %}
        <dialog id="clear_logs_modal" class="modal modal-bottom sm:modal-middle">
            <div class="modal-box max-w-2xl bg-base-100 border border-base-300 shadow-2xl p-0">
                <!-- Header -->
                <div class="flex items-center justify-between p-6 border-b border-base-300">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-error/20 flex items-center justify-center">
                            <i class="fa-solid fa-triangle-exclamation text-error text-lg"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-base-content">Clear Application Logs</h3>
                            <p class="text-sm text-base-content/60">This action cannot be undone</p>
                        </div>
                    </div>
                    <form method="dialog">
                        <button class="btn btn-sm btn-circle btn-ghost hover:bg-base-200" type="button" onclick="clear_logs_modal.close()">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </form>
                </div>

                <!-- Content -->
                <div class="p-6">
                    <!-- Warning Card -->
                    <div class="bg-error/10 border border-error/20 rounded-lg p-4 mb-6">
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 rounded-full bg-error/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                <i class="fa-solid fa-exclamation text-error text-xs"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-error mb-1">Permanent Action</h4>
                                <p class="text-sm text-base-content/80">
                                    Once cleared, log entries cannot be recovered. Choose which event types to clear or select all.
                                </p>
                            </div>
                        </div>
                    </div>

                    <form id="confirmClearLogsForm" 
                          hx-post="{{ url_for('settings.clear_logs') }}"
                          hx-indicator="#clear-logs-loader"
                          hx-on::after-request="if(event.detail.successful) { clear_logs_modal.close(); }"
                          class="space-y-6"> 
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <!-- Clear All Toggle -->
                        <div class="bg-base-200/30 border border-base-300 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-warning/20 flex items-center justify-center flex-shrink-0">
                                        <i class="fa-solid fa-trash text-warning text-sm"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-base-content">Clear All Event Types</h4>
                                        <p class="text-sm text-base-content/70">Remove all log entries regardless of type</p>
                                    </div>
                                </div>
                                <input type="checkbox" 
                                       name="clear_all_types" 
                                       value="true" 
                                       class="toggle toggle-error" 
                                       id="clear_all_history_types_checkbox" 
                                       checked 
                                       onchange="toggleEventTypeCheckboxesDisabled(this.checked)">
                            </div>
                        </div>
                        
                        <!-- Specific Event Types -->
                        <div id="specific_event_types_for_clear" class="opacity-50 transition-opacity">
                            <div class="flex items-center gap-2 mb-4">
                                <h4 class="font-medium text-base-content">Select Specific Event Types</h4>
                                <span class="inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-400/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-400 ring-1 ring-inset ring-blue-600/20 dark:ring-blue-500/20">
                                    {{ event_types|length }} types available
                                </span>
                            </div>
                            
                            <div class="bg-base-100 border border-base-300 rounded-lg max-h-60 overflow-y-auto">
                                <div class="p-3 space-y-2">
                                    {% for type in event_types %}
                                    <label class="flex items-center gap-3 p-2 rounded hover:bg-base-200/50 cursor-pointer transition-colors">
                                        <input type="checkbox" 
                                               name="event_types_to_clear[]" 
                                               value="{{ type.name }}" 
                                               class="checkbox checkbox-sm checkbox-error event-type-clear-checkbox" 
                                               checked 
                                               disabled>
                                        <div class="flex-1">
                                            <span class="text-sm font-medium text-base-content">{{ type.name | title | replace('_', ' ') }}</span>
                                        </div>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Footer -->
                <div class="flex items-center justify-end gap-3 p-6 bg-base-200/30 border-t border-base-300">
                    <button type="button" class="btn btn-ghost" onclick="clear_logs_modal.close()">
                        <i class="fa-solid fa-times mr-2"></i>
                        Cancel
                    </button>
                    <button type="submit" form="confirmClearLogsForm" class="btn btn-error">
                        <span id="clear-logs-loader" class="htmx-indicator loading loading-spinner loading-xs mr-2"></span>
                        <i class="fa-solid fa-trash mr-2"></i>
                        Clear Logs
                    </button>
                </div>
            </div>
            <form method="dialog" class="modal-backdrop"><button>close</button></form>
        </dialog>
    {% endif %}
{% endblock modals %}

{% block scripts %}
{{ super() }}
{# Scripts specific to settings pages, e.g., for Plex connection test or Discord admin link #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.body.addEventListener('htmx:afterSwap', function(event) {
        const targetId = event.detail.target.id;
        if (targetId === 'plex_settings_connection_status_message') { // Assuming this ID
            const statusElement = event.detail.target.querySelector('[data-connection-status]');
            if (statusElement && plexSettingsConnTestedInput) {
                plexSettingsConnTestedInput.value = (statusElement.dataset.connectionStatus === 'success') ? "true" : "false";
                updatePlexSettingsSaveButtonState();
            }
        }
        // Handle Discord Admin Link status update if done via HTMX
        else if (targetId === 'discord_admin_link_status') { // Assuming this ID in _discord_settings.html
            // Potentially update UI based on the new content of discord_admin_link_status
            // e.g. change button text or visibility
        }
    });

});

// Clear Logs Modal Functions
function toggleEventTypeCheckboxesDisabled(clearAllChecked) {
    const specificTypesContainer = document.getElementById('specific_event_types_for_clear');
    const eventTypeCheckboxes = document.querySelectorAll('.event-type-clear-checkbox');
    
    if (clearAllChecked) {
        // Clear All is checked - disable and grey out individual checkboxes
        specificTypesContainer.classList.add('opacity-50');
        eventTypeCheckboxes.forEach(checkbox => {
            checkbox.disabled = true;
            checkbox.checked = true; // Check all when clearing all
        });
    } else {
        // Clear All is unchecked - enable individual checkboxes
        specificTypesContainer.classList.remove('opacity-50');
        eventTypeCheckboxes.forEach(checkbox => {
            checkbox.disabled = false;
            checkbox.checked = false; // Uncheck all when allowing selection
        });
    }
}

// Plugin Info Modal Functions (for plugins tab)
function showPluginInfo(pluginId) {
    fetch(`/admin/plugins/${pluginId}/info?t=${Date.now()}`, {
        cache: 'no-cache'
    })
        .then(response => response.json())
        .then(data => {
            document.getElementById('pluginInfoTitle').textContent = data.name || 'Unknown Plugin';
            document.getElementById('pluginInfoContent').innerHTML = `
                <!-- Plugin Overview Card -->
                <div class="bg-info/10 border border-info/20 rounded-lg p-4 mb-6">
                    <div class="flex items-start gap-3">
                        <div class="w-6 h-6 rounded-full bg-info/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fa-solid fa-info text-info text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-medium text-info mb-1">Plugin Overview</h4>
                            <p class="text-sm text-base-content/80 leading-relaxed">
                                ${data.description || 'No description available for this plugin.'}
                            </p>
                            <div class="flex items-center gap-3 mt-3">
                                ${data.enabled ? 
                                    `<span class="inline-flex items-center rounded-md bg-green-50 dark:bg-green-400/10 px-2 py-1 text-xs font-medium text-green-700 dark:text-green-400 ring-1 ring-inset ring-green-600/20 dark:ring-green-500/20 gap-1">
                                        <i class="fa-solid fa-check-circle"></i>
                                        Enabled
                                    </span>` : 
                                    `<span class="inline-flex items-center rounded-md bg-gray-50 dark:bg-gray-400/10 px-2 py-1 text-xs font-medium text-gray-700 dark:text-gray-400 ring-1 ring-inset ring-gray-600/20 dark:ring-gray-500/20 gap-1">
                                        <i class="fa-solid fa-circle"></i>
                                        Disabled
                                    </span>`
                                }
                                ${data.plugin_type ? 
                                    `<span class="inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-400/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-400 ring-1 ring-inset ring-blue-600/20 dark:ring-blue-500/20">${data.plugin_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>` : 
                                    ''
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Plugin Details Section -->
                <div class="space-y-4 mb-6">
                    <h4 class="font-medium text-base-content text-lg mb-3">
                        <i class="fa-solid fa-cog text-primary text-sm mr-2"></i>
                        Plugin Details
                    </h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Version Card -->
                        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/30 hover:border-base-300/60 transition-colors">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fa-solid fa-tag text-primary text-sm"></i>
                                <h5 class="font-medium text-base-content">Version</h5>
                            </div>
                            <p class="text-sm text-base-content/80 font-mono">${data.version || 'Unknown'}</p>
                        </div>

                        <!-- Servers Card -->
                        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/30 hover:border-base-300/60 transition-colors">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fa-solid fa-server text-info text-sm"></i>
                                <h5 class="font-medium text-base-content">Active Servers</h5>
                            </div>
                            <p class="text-sm text-base-content/80">
                                ${data.servers_count > 0 ? `${data.servers_count} server(s) configured` : 'No servers configured'}
                            </p>
                        </div>
                    </div>

                    ${data.supported_features && data.supported_features.length > 0 ? `
                    <!-- Features Card -->
                    <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/30 hover:border-base-300/60 transition-colors">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fa-solid fa-star text-warning text-sm"></i>
                            <h5 class="font-medium text-base-content">Supported Features</h5>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${data.supported_features.map(feature => 
                                `<span class="inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-400/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-400 ring-1 ring-inset ring-blue-600/20 dark:ring-blue-500/20">${feature.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>`
                            ).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>

                ${(data.author || data.license || data.homepage) ? `
                <!-- Developer Information Section -->
                <div class="space-y-4 mb-6">
                    <h4 class="font-medium text-base-content text-lg mb-3">
                        <i class="fa-solid fa-code text-secondary text-sm mr-2"></i>
                        Developer Information
                    </h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${data.author ? `
                        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/30 hover:border-base-300/60 transition-colors">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fa-solid fa-users text-secondary text-sm"></i>
                                <h5 class="font-medium text-base-content">Author</h5>
                            </div>
                            <p class="text-sm text-base-content/80">${data.author}</p>
                        </div>
                        ` : ''}

                        ${data.license ? `
                        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/30 hover:border-base-300/60 transition-colors">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fa-solid fa-certificate text-secondary text-sm"></i>
                                <h5 class="font-medium text-base-content">License</h5>
                            </div>
                            <p class="text-sm text-base-content/80">${data.license}</p>
                        </div>
                        ` : ''}

                        ${data.homepage ? `
                        <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/30 hover:border-base-300/60 transition-colors md:col-span-2">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fa-solid fa-globe text-secondary text-sm"></i>
                                <h5 class="font-medium text-base-content">Homepage</h5>
                            </div>
                            <a href="${data.homepage}" target="_blank" class="link link-primary text-sm break-all">${data.homepage}</a>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                ${data.last_error ? `
                <!-- Error Information -->
                <div class="space-y-4 mb-6">
                    <h4 class="font-medium text-base-content text-lg mb-3">
                        <i class="fa-solid fa-exclamation-triangle text-error text-sm mr-2"></i>
                        Error Information
                    </h4>
                    
                    <div class="bg-error/10 rounded-lg p-4 border border-error/30">
                        <div class="flex items-start gap-3">
                            <i class="fa-solid fa-exclamation-triangle text-error text-sm mt-0.5"></i>
                            <div>
                                <h5 class="font-medium text-base-content mb-1">Last Error</h5>
                                <p class="text-sm text-base-content/80">${data.last_error}</p>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}

                ${data.installed_at ? `
                <!-- Installation Information -->
                <div class="bg-base-200/30 rounded-lg p-3 border border-base-300/30 mb-6">
                    <div class="flex items-center gap-2 text-sm text-base-content/60">
                        <i class="fa-solid fa-calendar text-sm"></i>
                        <span>Installed: ${new Date(data.installed_at).toLocaleString()}</span>
                    </div>
                </div>
                ` : ''}

                <!-- Action Buttons -->
                <div class="flex items-center justify-end gap-3 mt-8 pt-6 border-t border-base-300">
                    <button type="button" class="btn btn-ghost" onclick="closePluginInfoModal()">
                        Close
                    </button>
                </div>
            `;
            
            document.getElementById('pluginInfoModal').showModal();
        })
        .catch(error => {
            console.error('Error loading plugin info:', error);
            // You could add a toast notification here if you have one
        });
}

function closePluginInfoModal() {
    document.getElementById('pluginInfoModal').close();
}

// Check if at least one plugin is enabled
function hasEnabledPlugins() {
    console.log('=== hasEnabledPlugins() Debug ===');
    
    // TEMPORARY FIX: Always return true if we're on the plugins page
    // This bypasses the validation entirely while we have Plex configured
    if (window.location.pathname.includes('/settings/plugins')) {
        console.log('TEMPORARY FIX: Bypassing validation on plugins page');
        console.log('Final result: true (bypassed)');
        console.log('=== End Debug ===');
        return true;
    }
    
    // Look for "Disable" buttons which indicate enabled plugins
    const disableButtons = document.querySelectorAll('button.btn-warning');
    const hasDisableButtons = disableButtons.length > 0;
    
    console.log('Found disable buttons:', disableButtons.length);
    console.log('Disable buttons:', disableButtons);
    console.log('Has disable buttons:', hasDisableButtons);
    
    // Also check if we're passed the enabled_plugins data from the backend
    const enabledPluginsFromBackend = window.enabled_plugins || [];
    const hasEnabledPluginsData = enabledPluginsFromBackend.length > 0;
    console.log('enabled_plugins from window:', enabledPluginsFromBackend);
    console.log('enabled_plugins.length:', enabledPluginsFromBackend.length);
    console.log('Has enabled plugins data:', hasEnabledPluginsData);
    
    // Check for any buttons with "Disable" text
    const allButtons = document.querySelectorAll('button');
    const disableTextButtons = Array.from(allButtons).filter(btn => btn.textContent.includes('Disable'));
    console.log('Buttons with "Disable" text:', disableTextButtons.length);
    console.log('Disable text buttons:', disableTextButtons);
    
    // Check for enabled status indicators
    const enabledIndicators = document.querySelectorAll('[data-plugin-enabled="true"], .plugin-enabled, .status-enabled');
    console.log('Found enabled indicators:', enabledIndicators.length);
    
    const result = hasDisableButtons || hasEnabledPluginsData;
    console.log('Final result:', result);
    console.log('=== End Debug ===');
    
    return result;
}

// Prevent navigation away from plugins page if no plugins are enabled
function checkPluginRequirement() {
    if (window.location.pathname.includes('/settings/plugins') && !hasEnabledPlugins()) {
        return 'You must have at least one plugin enabled before leaving this page. Please enable a plugin or configure servers for an existing plugin.';
    }
}

// Add event listeners when on plugins page
document.addEventListener('DOMContentLoaded', function() {
    if (window.location.pathname.includes('/settings/plugins')) {
        // Prevent page unload if no plugins enabled
        window.addEventListener('beforeunload', function(e) {
            const message = checkPluginRequirement();
            if (message) {
                e.preventDefault();
                e.returnValue = message;
                return message;
            }
        });
        
        // Intercept navigation clicks
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a');
            if (link && link.href && !link.href.includes('/settings/plugins')) {
                const message = checkPluginRequirement();
                if (message) {
                    e.preventDefault();
                    alert(message);
                    return false;
                }
            }
        });
        
        // Intercept form submissions that would navigate away
        document.addEventListener('submit', function(e) {
            const form = e.target;
            if (form && form.action && !form.action.includes('/settings/plugins') && !form.action.includes('/plugins/')) {
                const message = checkPluginRequirement();
                if (message) {
                    e.preventDefault();
                    alert(message);
                    return false;
                }
            }
        });
    }
});

// Reload plugins function (for plugins tab)
function reloadPlugins() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Reloading...';
    btn.disabled = true;
    
    fetch('/api/plugins/reload')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                if (typeof showToast === 'function') {
                    showToast('Plugins reloaded successfully', 'success');
                } else {
                    alert('Plugins reloaded successfully');
                }
                setTimeout(() => location.reload(), 1000);
            } else {
                // Show error message
                if (typeof showToast === 'function') {
                    showToast('Failed to reload plugins: ' + data.message, 'error');
                } else {
                    alert('Failed to reload plugins: ' + data.message);
                }
            }
        })
        .catch(error => {
            // Show error message
            if (typeof showToast === 'function') {
                showToast('Error reloading plugins: ' + error.message, 'error');
            } else {
                alert('Error reloading plugins: ' + error.message);
            }
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}
</script>

<!-- Plugin Info Modal -->
<dialog id="pluginInfoModal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-4xl bg-base-100 border border-base-300 shadow-2xl p-0">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-base-300">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-accent/20 flex items-center justify-center">
                    <i class="fa-solid fa-puzzle-piece text-accent text-lg"></i>
                </div>
                <div>
                    <h3 id="pluginInfoTitle" class="text-xl font-semibold text-base-content">Plugin Information</h3>
                    <p class="text-sm text-base-content/60">Details and configuration information</p>
                </div>
            </div>
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost hover:bg-base-200" onclick="closePluginInfoModal()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </form>
        </div>

        <!-- Content -->
        <div class="p-6">
            <div id="pluginInfoContent">
                <!-- Content will be populated by JavaScript -->
                <div class="text-center p-8"><span class="loading loading-lg loading-spinner"></span></div>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

{% endblock %}